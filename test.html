<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <!--
    test.html（互動式甘特圖沙盒 v0.4.0 - 最終穩定版）
    - 重寫捲動同步邏輯，改用單一事件監聽，徹底解決當機與版面錯亂問題。
    - 實作三欄式佈局（垂直階段 + 任務列表 + 時間軸）。
    - 修正假日標示、對齊與畫面超出問題。
    - 預設載入後自動捲動至今日日期。
  -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>互動式甘特圖沙盒（test.html v0.4.0）</title>

  <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.css">

  <style>
    :root { --bg:#f3f4f6; --fg:#1f2937; --card:#fff; --muted:#6b7280; --primary:#3b82f6; --green:#16a34a; --shadow:0 1px 3px rgba(0,0,0,.1),0 1px 2px -1px rgba(0,0,0,.1); --radius:.6rem; }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:1.25rem}
    
    .gantt-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:2000}
    .gantt-modal-content{background:#fff;border-radius:var(--radius);width:95%;max-width:1400px;height:90vh;display:flex;flex-direction:column;box-shadow:0 4px 20px rgba(0,0,0,.35);padding:1rem}
    .gantt-modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem;flex-shrink:0;}
    .toolbar{display:flex;gap:.5rem;align-items:center}
    .right{margin-left:auto;display:flex;gap:.5rem}
    
    .gantt-host { display: grid; grid-template-columns: 50px 280px 1fr; gap: 0; flex-grow: 1; min-height: 0; border: 1px solid #e2e8f0; border-radius: var(--radius); }
    
    .phase-lane, .task-lane, .gantt-pane { overflow: hidden; position: relative; }
    .phase-lane { background-color: #f8fafc; border-right: 1px solid #e2e8f0;}
    .task-lane { background-color: #fff; border-right: 1px solid #e2e8f0;}

    .lane-header { font-weight: 600; padding: 0 .75rem; border-bottom: 1px solid #e2e8f0; height: 50px; display:flex; align-items:center; background-color:#f8fafc;}
    .lane-content { position: absolute; width: 100%; top: 50px; left:0; right:0; bottom:0; overflow: hidden;}
    .lane-content-inner { position: relative; width:100%; height: 100%; }

    .phase-label { writing-mode: vertical-rl; text-orientation: mixed; font-weight: 600; font-size: 1rem; color: var(--muted); text-align: center; height: 100%; display: flex; align-items: center; justify-content: center; letter-spacing: 2px; position:absolute; width:100%;}

    .task-lane .row { padding: 0 .75rem; border-bottom:1px solid #f1f5f9; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; font-size:.9rem; position: absolute; width:100%; display: flex; align-items: center;}
    
    .gantt-pane { display:flex; flex-direction:column; min-width: 0; }
    .gantt-chart-wrapper{ flex: 1; overflow: auto; }
    .xscroller { height: 18px; background:#e5e7eb; border-radius: 9px; position: relative; overflow:auto; margin-top: .5rem; flex-shrink: 0;}
    .xscroller .spacer { height: 1px; }
    
    .gantt .grid .nonwork-rect { fill: #fecaca; opacity: .4; }
    .gantt .bar-progress { fill: var(--primary); opacity: 0.8; }
    .gantt .bar-handle { fill: var(--primary); cursor: ew-resize; opacity: 0.6; }
    .gantt .bar-wrapper:hover .bar-handle { opacity: 1; }

    .legend { display:flex; align-items:center; gap:.5rem; font-size:.85rem; color:var(--muted); }
    .legend .swatch { width:12px; height:12px; background:#fecaca; border:1px solid #fca5a5; border-radius:2px }
  </style>
</head>
<body>
  <div class="container">
    <h1>互動式甘特圖沙盒</h1>
    <!-- 其他按鈕與區塊將由 JS 動態生成 -->
  </div>
  <div id="gantt-modal" class="gantt-modal-overlay">
    <div class="gantt-modal-content">
      <div class="gantt-modal-header">
        <h2 id="gantt-modal-title">專案甘特圖</h2>
        <div class="legend"><span class="swatch"></span><span>週末／國定假日</span></div>
        <div class="toolbar">
          <select id="modal-view-mode-select"><option selected>Day</option><option>Week</option><option>Month</option></select>
          <button id="modal-close-btn" style="background:#6b7280">關閉</button>
        </div>
      </div>
      <div class="gantt-host">
        <div class="phase-lane">
            <div class="lane-header">階段</div>
            <div class="lane-content"><div id="phase-lane-inner" class="lane-content-inner"></div></div>
        </div>
        <div class="task-lane">
            <div class="lane-header">任務項目</div>
            <div class="lane-content"><div id="task-lane-inner" class="lane-content-inner"></div></div>
        </div>
        <div class="gantt-pane">
          <div class="gantt-chart-wrapper" id="gantt-wrapper"><svg id="gantt-chart"></svg></div>
          <div id="gantt-scroll-x" class="xscroller"><div class="spacer"></div></div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwbEVAfoO9eRzcUSfESIwih1Poub657h_9jz5UcqTXbxsDQOZ3mjLm1nHZfn_WM2K8/exec';
    let currentScheduleData = [];
    let gantt = null;
    let TAIWAN_HOLIDAYS = new Set();

    const phaseNameMapping = { '前置作業': 'P1. 設計籌備', '泥作工程': 'P2. 基礎工程', '木作工程': 'P2. 基礎工程', '後期裝修階段': 'P3. 裝修工程', '室內精裝階段': 'P4. 細部安裝', '驗收': 'P5. 驗收收尾' };
    const getPhaseDisplayName = (phase) => phaseNameMapping[phase] || phase;

    function initGanttFromSchedule(schedule, viewMode = 'Day'){
      const tasks = scheduleToGanttTasks(schedule);
      if (tasks.length === 0) { return; }
      
      const svg = document.getElementById('gantt-chart');
      svg.innerHTML = '';
      
      gantt = new Gantt(svg, tasks, {
        view_mode: viewMode, language: 'zh', bar_height: 28, padding: 8, header_height: 50,
        on_date_change: (task, start, end) => {
             const idx = task.custom.index;
             const iso = d => new Date(d).toISOString().slice(0,10);
             currentScheduleData[idx]['預計開始日'] = iso(start);
             currentScheduleData[idx]['預計完成日'] = iso(end);
        },
        on_progress_change: (task, progress) => {
             const idx = task.custom.index;
             currentScheduleData[idx]['狀態'] = progressToStatus(progress);
        }
      });
      
      setTimeout(() => {
        paintNonWorking(gantt);
        syncLeftPanes(gantt.bars);
        setupScrollers();
        scrollToToday();
      }, 150); // 增加延遲確保渲染完成
    }
    
    function scrollToToday() {
        if (!gantt) return;
        const wrapper = document.getElementById('gantt-wrapper');
        try {
            const today_x = gantt.get_x(new Date());
            const container_width = wrapper.offsetWidth;
            wrapper.scrollLeft = today_x - container_width / 2;
        } catch(e) {
            console.warn("無法捲動至今日:", e.message);
        }
    }

    function paintNonWorking(g){
      try{
        const gridLayer = g.$svg.querySelector('.grid');
        if(!gridLayer) return;
        const taskAreaHeight = g.bars.length * (g.options.bar_height + g.options.padding);
        gridLayer.querySelectorAll('.nonwork-rect').forEach(n => n.remove());
        const start = new Date(g.gantt_start);
        const end = new Date(g.gantt_end);
        for(let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)){
          if(!isWeekend(d) && !isHoliday(d)) continue;
          const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
          rect.setAttribute('class','nonwork-rect');
          rect.setAttribute('x', g.get_x(d));
          rect.setAttribute('y', g.options.header_height);
          rect.setAttribute('width', g.options.column_width);
          rect.setAttribute('height', taskAreaHeight);
          gridLayer.insertBefore(rect, gridLayer.firstChild);
        }
      }catch(e){ console.warn('paintNonWorking error', e); }
    }
    
    function syncLeftPanes(bars) {
        const phaseLane = document.getElementById('phase-lane-inner');
        const taskLane = document.getElementById('task-lane-inner');
        phaseLane.innerHTML = '';
        taskLane.innerHTML = '';
        if (!bars || bars.length === 0) return;

        let lastPhase = null;
        let groupStartY = bars[0].y;
        let groupTasks = [];

        function renderGroup(groupName, startY, tasks) {
            if (tasks.length === 0) return;
            const endY = tasks[tasks.length-1].y + tasks[tasks.length-1].height;
            const groupHeight = endY - startY;

            const phaseDiv = document.createElement('div');
            phaseDiv.className = 'phase-label';
            phaseDiv.textContent = getPhaseDisplayName(groupName);
            phaseDiv.style.top = startY + 'px';
            phaseDiv.style.height = groupHeight + 'px';
            phaseLane.appendChild(phaseDiv);

            tasks.forEach(bar => {
                const taskDiv = document.createElement('div');
                taskDiv.className = 'row';
                taskDiv.textContent = bar.task.name;
                taskDiv.style.top = bar.y + 'px';
                taskDiv.style.height = bar.height + 'px';
                taskLane.appendChild(taskDiv);
            });
        }
        
        bars.forEach((bar) => {
            const currentPhase = bar.task.custom.raw['階段'];
            if (currentPhase !== lastPhase && groupTasks.length > 0) {
                renderGroup(lastPhase, groupStartY, groupTasks);
                groupStartY = bar.y;
                groupTasks = [];
            }
            groupTasks.push(bar);
            lastPhase = currentPhase;
        });
        if (groupTasks.length > 0) {
            renderGroup(lastPhase, groupStartY, groupTasks);
        }
    }

    function setupScrollers(){
      const wrapper = document.getElementById('gantt-wrapper');
      const scrollerX = document.getElementById('gantt-scroll-x');
      const phaseInner = document.getElementById('phase-lane-inner');
      const taskInner = document.getElementById('task-lane-inner');
      
      const spacer = scrollerX.querySelector('.spacer');
      spacer.style.width = wrapper.scrollWidth + 'px';
      
      wrapper.addEventListener('scroll', () => {
        scrollerX.scrollLeft = wrapper.scrollLeft;
        const transformValue = `translateY(-${wrapper.scrollTop}px)`;
        phaseInner.style.transform = transformValue;
        taskInner.style.transform = transformValue;
      });
      
      scrollerX.addEventListener('scroll', () => {
        wrapper.scrollLeft = scrollerX.scrollLeft;
      });
    }

    // --- Utility functions ---
    const toYYYYMMDD = (dateString) => { if (!dateString) return null; try { const d = new Date(dateString); if (isNaN(d.getTime())) return null; return d.toISOString().slice(0, 10); } catch (e) { return null; } };
    function statusToProgress(status){ if(status === '已完成') return 100; if(status === '施工中') return 50; return 0; }
    function progressToStatus(p){ if(p >= 100) return '已完成'; if(p > 0) return '施工中'; return '未完成'; }
    function isWeekend(d){ const day = d.getDay(); return day === 0 || day === 6; }
    function isHoliday(d){ return TAIWAN_HOLIDAYS.has(d.toISOString().slice(0,10)); }
    function scheduleToGanttTasks(schedule){ return schedule.map((t, i) => { const startDate = toYYYYMMDD(t['預計開始日']); const endDate = toYYYYMMDD(t['預計完成日']); if (!startDate || !endDate) return null; return { id: `task-${i}`, name: t['任務項目'] || `任務${i+1}`, start: startDate, end: endDate, progress: statusToProgress(t['狀態']), custom: { index: i, raw: t } }; }).filter(Boolean); }
    
    // --- App initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('gantt-modal').style.display = 'flex'; // 直接顯示 Modal 以利測試
        const demoData = [
            { '任務項目':'丈量與放樣', '階段': '前置作業', '預計開始日':'2025-09-16','預計完成日':'2025-09-18','狀態':'未完成' },
            { '任務項目':'拆除工程', '階段': '前置作業', '預計開始日':'2025-09-19','預計完成日':'2025-09-21','狀態':'施工中' },
            { '任務項目':'木作進場', '階段': '木作工程', '預計開始日':'2025-09-22','預計完成日':'2025-09-28','狀態':'未完成' },
            { '任務項目':'油漆工程', '階段': '後期裝修階段', '預計開始日':'2025-09-29','預計完成日':'2025-10-05','狀態':'未完成' }
        ];
        TAIWAN_HOLIDAYS = new Set(['2025-10-10']); // 假設的假日
        initGanttFromSchedule(demoData);

        document.getElementById('modal-close-btn').onclick = () => {
            document.getElementById('gantt-modal').style.display = 'none';
        };
    });
  </script>
</body>
</html>
