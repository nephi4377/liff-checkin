<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <!--
    test.html（互動式甘特圖沙盒 v0.2）
    目的：
    1) 在獨立沙盒頁面驗證「彈出式甘特圖」可視化與互動（拖曳、調整長度、進度）。
    2) 與現有資料結構（currentScheduleData / ?page=project）對接。
    3) 驗證回寫策略：在甘特互動後同步更新 currentScheduleData，
       交由既有的「儲存排程」流程（POST ?page=project）統一送出。

    使用方式：
    A. Demo 模式（無 id 參數）
       直接開啟檔案或以 http(s) 方式載入，頁面會用內建的 demoTasks 陣列示範。
    B. 實戰模式（帶 id 參數）
       以 URL 參數 ?id=專案案號 開啟，例如：
       test.html?id=715
       頁面會透過 JSONP 呼叫 API_BASE_URL?page=project&id=<id> 取得 schedule，並渲染甘特圖。

    注意：
    - 本頁僅為沙盒，無需完整的日誌/照片模組。
    - 正式版請把「甘特圖按鈕 + Modal + 三支核心函式」移植到 managementconsole.html。
    - CDN：使用 frappe-gantt（與 v11.22 測試版一致），避免 CORS 問題。
  -->

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>互動式甘特圖沙盒（test.html v0.2）</title>

  <!-- 甘特圖套件（與正式頁一致的 CDN 版本） -->
  <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.css">

  <style>
    :root { --bg:#f3f4f6; --fg:#1f2937; --card:#fff; --muted:#6b7280; --primary:#3b82f6; --green:#16a34a; --shadow:0 1px 3px rgba(0,0,0,.1),0 1px 2px -1px rgba(0,0,0,.1); --radius:.6rem; }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:1.25rem}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;margin-bottom:1rem}
    h1{font-size:1.6rem;margin:0}
    .muted{color:var(--muted)}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:1rem;margin:.5rem 0}
    button{background:var(--primary);color:#fff;border:0;padding:.5rem .9rem;border-radius:.45rem;cursor:pointer;font-weight:600}
    button:hover{opacity:.9}

    /* 甘特 Modal */
    .gantt-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:2000}
    .gantt-modal-content{background:#fff;border-radius:var(--radius);width:95%;max-width:1200px;height:80vh;display:flex;flex-direction:column;box-shadow:0 4px 20px rgba(0,0,0,.35);padding:1rem}
    .gantt-modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem}
    .gantt-modal-header h2{margin:0;font-size:1.1rem}
    .gantt-chart-wrapper{flex:1;overflow:auto}
    .toolbar{display:flex;gap:.5rem;align-items:center}
    .toolbar select{padding:.35rem .5rem;border:1px solid #d1d5db;border-radius:.4rem;background:#fff}
    .right{margin-left:auto;display:flex;gap:.5rem}
    pre#debug-log{background:#0b1020;color:#e5e7eb;border-radius:.5rem;padding:.75rem;height:12rem;overflow:auto;white-space:pre-wrap}
      /* 左側任務名稱固定欄（與甘特圖垂直同步） */
    .gantt-host { display: grid; grid-template-columns: 260px 1fr; gap: .75rem; height: 100%; }
    .left-rail { background:#fff; border-radius: var(--radius); box-shadow: var(--shadow); overflow: auto; }
    .left-rail .row { padding:.5rem .75rem; border-bottom:1px solid #f1f5f9; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; font-size:.9rem }
    .left-rail .row:nth-child(odd){ background:#fafafa }
    .gantt-pane { display:flex; flex-direction:column; }
    .gantt-chart-wrapper{ flex: 1; overflow: auto; border-radius: var(--radius); background:#fff; box-shadow: var(--shadow) }
    /* 底部水平滑桿（不需把頁面滾到最底） */
    .xscroller { height: 18px; background:#e5e7eb; border-radius: 9px; position: relative; overflow:auto; }
    .xscroller .spacer { height: 1px; }
    /* 週末/國定假日色塊提示 */
    .gantt .grid .nonwork-rect { fill: #fecaca; /* 紅色淡化 */ opacity: .35; }
    .legend { display:flex; align-items:center; gap:.5rem; font-size:.85rem; color:var(--muted); }
    .legend .swatch { width:12px; height:12px; background:#fecaca; border:1px solid #fca5a5; border-radius:2px }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>互動式甘特圖沙盒</h1>
        <div class="muted" id="subtitle">Demo 模式</div>
      </div>
      <div class="right">
        <!-- 只在本頁示範：直接在 header 放檢視鈕，也可改為列表區右上角放置 -->
        <button id="view-gantt-btn" style="background:var(--green);display:none">📊 檢視甘特圖</button>
      </div>
    </header>

    <section class="card">
      <div class="toolbar">
        <label>案號：<input id="project-id-input" type="text" placeholder="例如：715" style="padding:.35rem .5rem;border:1px solid #d1d5db;border-radius:.4rem"></label>
        <button id="load-btn">載入排程</button>
        <button id="use-demo-btn" style="background:#6b7280">使用 Demo 資料</button>
        <div class="right">
          <label>視圖：
            <select id="view-mode-select">
              <option>Day</option>
              <option>Week</option>
              <option selected>Month</option>
            </select>
          </label>
          <button id="save-btn">儲存排程變更</button>
        </div>
      </div>
      <div id="schedule-brief" class="muted" style="margin-top:.5rem"></div>
    </section>

    <section class="card">
      <h3 style="margin:.25rem 0 .75rem">除錯訊息</h3>
      <pre id="debug-log"></pre>
    </section>
  </div>

  <!-- 甘特圖 Modal -->
    <div id="gantt-modal" class="gantt-modal-overlay" aria-hidden="true">
    <div class="gantt-modal-content" role="dialog" aria-modal="true" aria-labelledby="gantt-modal-title">
      <div class="gantt-modal-header">
        <h2 id="gantt-modal-title">專案甘特圖</h2>
        <div class="legend"><span class="swatch"></span><span>週末／國定假日</span></div>
        <div class="toolbar">
          <select id="modal-view-mode-select">
            <option>Day</option>
            <option selected>Week</option>
          </select>
          <button id="modal-close-btn" style="background:#6b7280">關閉</button>
        </div>
      </div>
      <div class="gantt-host">
        <!-- 左側任務名稱固定欄：與右側圖一起垂直滾動、但不受水平滾動影響 -->
        <div id="left-rail" class="left-rail" aria-hidden="false"></div>
        <div class="gantt-pane">
          <div class="gantt-chart-wrapper" id="gantt-wrapper">
            <svg id="gantt-chart"></svg>
          </div>
          <!-- 底部水平滑桿：同步控制上方 SVG 的水平位移 -->
          <div id="gantt-scroll-x" class="xscroller" aria-label="水平捲動控制"><div class="spacer"></div></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* =========================================================
       全域狀態（與正式頁對齊的命名）
       ========================================================= */
    const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwbEVAfoO9eRzcUSfESIwih1Poub657h_9jz5UcqTXbxsDQOZ3mjLm1nHZfn_WM2K8/exec';
    let currentScheduleData = [];   // 從 API 或 Demo 取得的排程列表（物件陣列）
    let gantt = null;               // frappe-gantt 實例

    /* =========================================================
       公用：頁面訊息 & JSONP 讀取器（與正式頁一致設計）
       ========================================================= */
    function logToPage(msg){
      const t = new Date().toLocaleTimeString('zh-TW');
      const el = document.getElementById('debug-log');
      el.textContent += `[${t}] ${msg}\n`;
      el.scrollTop = el.scrollHeight;
    }

    function loadJsonp(url){
      return new Promise((resolve, reject) => {
        const cb = 'jsonp_' + Math.random().toString(36).slice(2);
        const timer = setTimeout(() => { cleanup(); reject(new Error('請求逾時 (15s)')); }, 15000);
        function cleanup(){ clearTimeout(timer); delete window[cb]; script.remove(); }
        window[cb] = (data) => { cleanup(); resolve(data); };
        const script = document.createElement('script');
        script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
        script.onerror = () => { cleanup(); reject(new Error('載入失敗')); };
        document.body.appendChild(script);
      });
    }

    /* =========================================================
       映射：把你的 schedule[] 轉為甘特 tasks[]
       ---------------------------------------------------------
       你的欄位：
       - 任務項目、工種、預計開始日(YYYY-MM-DD)、預計完成日(YYYY-MM-DD)、狀態(未完成/施工中/已完成)
       - 其餘欄位（例如工班、備註）保持在 raw 內以便回寫。
       ========================================================= */
    function statusToProgress(status){
      if(status === '已完成') return 100;
      if(status === '施工中') return 50;
      return 0; // 未完成
    }

    function progressToStatus(p){
      if(p >= 100) return '已完成';
      if(p > 0) return '施工中';
      return '未完成';
    }

    function scheduleToGanttTasks(schedule){
      return schedule
        .filter(t => t['預計開始日'] && t['預計完成日'])
        .map((t, i) => ({
          id: `task-${i}`,
          name: t['任務項目'] ? String(t['任務項目']) : (t['工種'] ? String(t['工種']) : `任務${i+1}`),
          start: t['預計開始日'],
          end:   t['預計完成日'],
          progress: statusToProgress(t['狀態']),
          custom: { index: i, raw: t }
        }));
    }

    /* =========================================================
       甘特：初始化、互動事件、視圖切換
       ========================================================= */
    function openGanttModal(){ document.getElementById('gantt-modal').style.display = 'flex'; }
    function closeGanttModal(){ document.getElementById('gantt-modal').style.display = 'none'; }

    function initGanttFromSchedule(schedule, viewMode = 'Week'){
      const tasks = scheduleToGanttTasks(schedule);
      const svg = document.getElementById('gantt-chart');
      const wrapper = document.getElementById('gantt-wrapper');
      const leftRail = document.getElementById('left-rail');
      svg.innerHTML = '';
      leftRail.innerHTML = '';

      gantt = new Gantt(svg, tasks, {
        view_mode: viewMode, // 僅提供 Day/Week，預設 Week
        language: 'zh',
        custom_popup_html: (task) => (
          `<div class="details-container" style="padding:.5rem .75rem">
            <div style="font-weight:700;margin-bottom:.25rem">${task.name}</div>
            <div>開始：${task.start}</div>
            <div>結束：${task.end}</div>
            <div>進度：${task.progress}%</div>
          </div>`
        ),
        on_date_change: (task, start, end) => {
          const idx = task.custom.index;
          const iso = d => new Date(d).toISOString().slice(0,10);
          currentScheduleData[idx]['預計開始日'] = iso(start);
          currentScheduleData[idx]['預計完成日'] = iso(end);
          logToPage(`日期變更：#${idx+1} → ${iso(start)} ~ ${iso(end)}`);
          // 重新著色非工作日
          paintNonWorking(gantt);
        },
        on_progress_change: (task, progress) => {
          const idx = task.custom.index;
          currentScheduleData[idx]['狀態'] = progressToStatus(progress);
          logToPage(`進度變更：#${idx+1} → ${progress}%（狀態：${currentScheduleData[idx]['狀態']}）`);
        }
      });

      // 1) 左側任務欄：依圖上每個 bar 的 Y 座標建立對齊的列
      requestAnimationFrame(() => {
        const bars = gantt.bars || [];
        const rows = bars.map(b => ({ y: b.group.getBBox().y, h: b.group.getBBox().height, label: b.task.name }));
        rows.sort((a,b)=>a.y-b.y);
        rows.forEach(r => {
          const div = document.createElement('div');
          div.className = 'row';
          div.style.height = Math.max(28, Math.round(r.h)) + 'px';
          div.textContent = r.label; // 預設 name 已含「工種｜任務項目」
          leftRail.appendChild(div);
        });
        // 左右兩側垂直同步
        leftRail.scrollTop = wrapper.scrollTop;
      });

      // 2) 加入週末與國定假日底色
      paintNonWorking(gantt);

      // 3) 設定底部水平滑桿同步
      syncHorizontalScroller();
    }

    // 建立非工作日標記（週末 + 可選國定假日）
    const TAIWAN_HOLIDAYS = window.TAIWAN_HOLIDAYS || new Set(); // 允許外部注入：如 new Set(['2025-01-01','2025-02-28'])
    function isWeekend(d){ const day = d.getDay(); return day === 0 || day === 6; }
    function isHoliday(d){ return TAIWAN_HOLIDAYS.has(d.toISOString().slice(0,10)); }
    function paintNonWorking(g){
      try{
        const gridLayer = g.layers.grid;
        const contentHeight = g.canvas.getBBox().height; // 含所有列的高度
        // 先清空既有標記（避免重複堆疊）
        gridLayer.querySelectorAll('.nonwork-rect').forEach(n => n.remove());
        // 取甘特起迄範圍
        const start = new Date(g.start);
        const end   = new Date(g.end);
        for(let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)){
          const nonwork = isWeekend(d) || isHoliday(d);
          if(!nonwork) continue;
          const x = g.get_x(d); // 以 frappe-gantt 的座標換算
          const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
          rect.setAttribute('class','nonwork-rect');
          rect.setAttribute('x', x);
          rect.setAttribute('y', 0);
          rect.setAttribute('width', g.options.column_width);
          rect.setAttribute('height', contentHeight);
          gridLayer.appendChild(rect);
        }
      }catch(e){ console.warn('paintNonWorking error', e); }
    }

    function syncHorizontalScroller(){
      const wrapper = document.getElementById('gantt-wrapper');
      const scroller = document.getElementById('gantt-scroll-x');
      const spacer = scroller.querySelector('.spacer');
      // 設定 spacer 寬度等於 SVG 內容寬度，以產生捲軸
      const contentWidth = wrapper.scrollWidth;
      spacer.style.width = contentWidth + 'px';
      // 雙向同步：滑桿 ↔ 圖
      let lock = false;
      scroller.onscroll = () => { if(lock) return; lock = true; wrapper.scrollLeft = scroller.scrollLeft; lock = false; };
      wrapper.onscroll  = () => {
        // 水平同步
        if(!lock){ lock = true; scroller.scrollLeft = wrapper.scrollLeft; lock = false; }
        // 垂直同步：左欄
        document.getElementById('left-rail').scrollTop = wrapper.scrollTop;
      };
    }
      });
    }

    function enableGanttButton(){
      const btn = document.getElementById('view-gantt-btn');
      if(!btn) return;
      btn.style.display = '';
      btn.onclick = () => {
        const mode = document.getElementById('view-mode-select').value || 'Month';
        initGanttFromSchedule(currentScheduleData, mode);
        openGanttModal();
      };
    }

    /* =========================================================
       資料載入：Demo / API(JSONP)
       ========================================================= */
    const demoTasks = [
      { '任務項目':'丈量與放樣','工種':'行政','預計開始日':'2025-09-16','預計完成日':'2025-09-18','狀態':'未完成','工班':'','備註':'' },
      { '任務項目':'拆除工程','工種':'拆除','預計開始日':'2025-09-19','預計完成日':'2025-09-21','狀態':'施工中','工班':'A 隊','備註':'同步清運' },
      { '任務項目':'水電配管','工種':'水電','預計開始日':'2025-09-22','預計完成日':'2025-09-26','狀態':'未完成','工班':'','備註':'' },
      { '任務項目':'泥作粉光','工種':'泥作','預計開始日':'2025-09-27','預計完成日':'2025-10-01','狀態':'未完成','工班':'','備註':'' },
      { '任務項目':'木作進場','工種':'木作','預計開始日':'2025-10-02','預計完成日':'2025-10-08','狀態':'未完成','工班':'','備註':'' },
      { '任務項目':'油漆收尾','工種':'油漆','預計開始日':'2025-10-09','預計完成日':'2025-10-11','狀態':'未完成','工班':'','備註':'' },
      { '任務項目':'清潔點交','工種':'行政','預計開始日':'2025-10-12','預計完成日':'2025-10-12','狀態':'未完成','工班':'','備註':'' }
    ];

    async function loadScheduleById(projectId){
      const url = `${API_BASE_URL}?page=project&id=${encodeURIComponent(projectId)}`;
      logToPage('呼叫 API：' + url);
      const data = await loadJsonp(url);
      if(!data || !Array.isArray(data.schedule)) throw new Error('API 回傳無 schedule');
      currentScheduleData = data.schedule;
      document.getElementById('subtitle').textContent = `實戰模式（案號：${projectId}）`;
      document.getElementById('schedule-brief').textContent = `已載入 ${currentScheduleData.length} 筆任務。`;
      enableGanttButton();
    }

    function useDemoData(){
      currentScheduleData = JSON.parse(JSON.stringify(demoTasks)); // 深拷貝避免汙染
      document.getElementById('subtitle').textContent = 'Demo 模式';
      document.getElementById('schedule-brief').textContent = `已載入 ${currentScheduleData.length} 筆 Demo 任務。`;
      enableGanttButton();
    }

    /* =========================================================
       回寫：呼叫既有的 updateSchedule API（可選）
       ---------------------------------------------------------
       - 本沙盒提供一顆「儲存排程變更」按鈕，直接 POST 到
         ?page=project（action: 'updateSchedule'）。
       - Apps Script Web App 若無 CORS 設定，維持 no-cors 並以後台記錄為主。
       - 正式頁仍以你的 handleSaveSchedule() 為準。
       ========================================================= */
    async function saveScheduleChanges(projectId){
      if(!projectId){ alert('請先輸入案號'); return; }
      const payload = { action:'updateSchedule', projectId, scheduleData: currentScheduleData };
      const endpoint = `${API_BASE_URL}?page=project`;
      logToPage('POST → ' + endpoint);
      try{
        await fetch(endpoint, {
          method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        logToPage('已送出更新（no-cors，不讀回應）。請至 Apps Script 日誌確認。');
        alert('已送出更新！');
      }catch(err){
        logToPage('送出失敗：' + err.message);
        alert('送出失敗：' + err.message);
      }
    }

    /* =========================================================
       事件綁定 & 啟動流程
       ========================================================= */
    document.addEventListener('DOMContentLoaded', () => {
      // URL 參數
      const params = new URLSearchParams(location.search);
      const idParam = params.get('id');
      const projectInput = document.getElementById('project-id-input');
      if(idParam){ projectInput.value = idParam; loadScheduleById(idParam).catch(e => logToPage(e.message)); }
      else { useDemoData(); }

      // Header 檢視鈕在 enableGanttButton() 內才會顯示
      document.getElementById('modal-close-btn').onclick = closeGanttModal;

      document.getElementById('view-mode-select').addEventListener('change', (e) => {
        // 僅變更預設視圖；實際 Modal 內另有一個選擇器
      });
      document.getElementById('modal-view-mode-select').addEventListener('change', (e) => {
        const mode = e.target.value; // 限定 Day / Week
        if(gantt){ gantt.change_view_mode(mode); paintNonWorking(gantt); syncHorizontalScroller(); }
      }); }
      });

      document.getElementById('load-btn').onclick = () => {
        const pid = projectInput.value.trim();
        if(!pid){ alert('請輸入案號'); return; }
        loadScheduleById(pid).catch(err => alert(err.message));
      };
      document.getElementById('use-demo-btn').onclick = useDemoData;
      document.getElementById('save-btn').onclick = () => {
        const pid = projectInput.value.trim();
        saveScheduleChanges(pid);
      };
    });
  </script>
</body>
</html>
