<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>專案日誌管理主控台</title>

    <script>
        // 全域設定
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwbEVAfoO9eRzcUSfESIwih1Poub657h_9jz5UcqTXbxsDQOZ3mjLm1nHZfn_WM2K8/exec';
        const FRONTEND_VERSION = 'v1.0-sandbox';
    </script>

    <style>
        :root {
          --bg: #f3f4f6; --fg: #1f2937; --muted: #6b7280; --muted-2: #9ca3af;
          --card: #ffffff; --primary: #3b82f6; --shadow: 0 1px 3px 0 rgba(0,0,0,.1), 0 1px 2px -1px rgba(0,0,0,.1);
          --radius: .5rem;
        }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: var(--bg); color: var(--fg); margin: 0; padding: 1rem; }
        .container { max-width: 900px; margin: 0 auto; }
        header { margin-bottom: 2rem; }
        h1 { font-size: 1.875rem; font-weight: bold; margin: 0; }
        h3 { font-size: 1.125rem; font-weight: 600; margin-top: 2rem; border-bottom: 1px solid #e5e7eb; padding-bottom: .5rem; }
        .spinner { margin: 2rem auto; width: 3rem; height: 3rem; border-radius: 50%; border: 4px solid #e5e7eb; border-top-color: var(--primary); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg) } }
        #debug-log { background: #111827; color: #e5e7eb; font-family: monospace; font-size: .75rem; padding: 1rem; border-radius: var(--radius); margin-top: 1rem; height: 16rem; overflow-y: auto; white-space: pre-wrap; word-break: break-all; }
        .card { background: var(--card); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1rem; box-shadow: var(--shadow); }
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: .75rem; margin-top: 1rem; }
        .photo-thumb { width: 100%; aspect-ratio: 4/3; object-fit: cover; background: #e5e7eb; border-radius: var(--radius); display: block; cursor: zoom-in; }
        button { background: var(--primary); color: #fff; border: 0; padding: .5rem .75rem; border-radius: .375rem; cursor: pointer; font-weight: 600; transition: background-color .2s; }
        button:hover { background-color: #2563eb; }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .button-group { display: flex; gap: 0.5rem; justify-content: flex-end; flex-wrap: wrap; margin-top: 1.5rem; }
        
        /* Modal Styles */
        #photo-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: var(--radius); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem; margin-bottom: 1rem; }
        .close-modal-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        #modal-photo-grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: .75rem; max-height: 50vh; overflow-y: auto; padding: .5rem; background: #f9fafb; border-radius: .375rem; }
        .modal-photo-item { position: relative; }
        .modal-photo-item img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: .375rem; }
        .delete-photo-btn { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 16px; line-height: 24px; text-align: center; cursor: pointer; padding: 0; }
        .modal-footer { margin-top: 1rem; text-align: right; }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>專案日誌管理主控台</h1>
        </header>
        <main id="main-content">
            <div id="status-message">
                <div class="spinner"></div>
                <p style="text-align:center;">正在載入資料...</p>
            </div>
            <div id="logs-container"></div>
            <div>
                <h3>執行狀態日誌：</h3>
                <pre id="debug-log"></pre>
            </div>
        </main>
    </div>

    <div id="photo-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>管理相片</h2>
                <span class="close-modal-btn" onclick="closePhotoModal()">&times;</span>
            </div>
            <div id="modal-photo-grid-container"></div>
            <div class="modal-footer">
                <input type="file" id="photo-file-input" multiple accept="image/*" style="display: none;" />
                <button id="add-photos-button" style="background-color: #059669;">新增照片...</button>
                <button id="save-photos-button">儲存變更</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentLogsData = [];
        let currentEditingLogId = null;

        // 統一的日誌記錄函式
        function logToPage(message) {
            const el = document.getElementById('debug-log');
            if (!el) return;
            const t = new Date().toLocaleTimeString('zh-TW', { hour12: false });
            el.textContent += `[${t}] ${message}\n`;
            el.scrollTop = el.scrollHeight;
        }

        // 統一的 JSONP 請求函式
        function loadJsonp(url) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Math.random().toString(36).substr(2, 9);
                const timeoutId = setTimeout(() => {
                    cleanup();
                    reject(new Error('請求後端資料超時 (15秒)，請檢查後端日誌。'));
                }, 15000);
                function cleanup() {
                    clearTimeout(timeoutId);
                    delete window[callbackName];
                    if (script.parentNode) script.parentNode.removeChild(script);
                }
                window[callbackName] = (data) => {
                    cleanup();
                    resolve(data);
                };
                const script = document.createElement('script');
                script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + callbackName;
                script.onerror = () => {
                    cleanup();
                    reject(new Error('載入後端資料失敗，請檢查網路或後端日誌。'));
                };
                document.body.appendChild(script);
            });
        }
        
        // 從 Drive 連結提取 File ID
        function driveFileId(u) {
            if (!u) return '';
            const m = String(u).match(/[\/=&](?:id|fileId|ids)=([a-zA-Z0-9_-]{20,})/);
            return m ? m[1] : '';
        }

        // 建立照片網格
        function buildPhotoGrid(linksCsv) {
            const grid = document.createElement('div');
            grid.className = 'photo-grid';
            const urls = (linksCsv || '').split(',').map(s => s.trim()).filter(Boolean);

            urls.forEach(url => {
                const a = document.createElement('a');
                a.href = url.replace(/&export=view$/, '');
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                
                const img = document.createElement('img');
                img.className = 'photo-thumb';
                img.loading = 'lazy';
                const fileId = driveFileId(url);
                img.src = fileId ? `${API_BASE_URL}?img=${fileId}&w=300` : url; // 統一使用代理
                a.appendChild(img);
                grid.appendChild(a);
            });
            return grid;
        }

        // 建立單一筆日誌卡片
        function buildLogCard(log, isDraftMode) {
            const card = document.createElement('div');
            card.className = 'card';
            card.id = 'log-' + log.LogID;

            const timestamp = new Date(log.Timestamp).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' });
            const updatedTimestampMatch = (log.Content || '').match(/^\[更新 (.*?)\]\n/);
            const displayContent = (log.Content || '無內容').replace(/^\[更新 .*?\]\n/, '');
            const lastModifiedDisplay = updatedTimestampMatch ? updatedTimestampMatch[1] : '無';

            card.innerHTML = `
                <h3>${log.Title || '無標題'}</h3>
                <small class="muted">案場: ${log.ProjectName || '未知'}｜回報人: ${log.UserName || '未知'}</small>
                <div style="font-size: 0.75rem; color: var(--muted-2); margin-top: 4px;">建立: ${timestamp}｜最後更新: ${lastModifiedDisplay}</div>
                <hr style="margin: 1rem 0;">
                <div id="content-${log.LogID}" style="white-space:pre-wrap;">${displayContent}</div>
            `;

            if (log.PhotoLinks) {
                card.appendChild(buildPhotoGrid(log.PhotoLinks));
            }

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'button-group';
            
            buttonContainer.innerHTML = `
                <button class="btn-manage-photos" style="background-color: #f59e0b;">管理相片</button>
                <button class="btn-edit-text">編輯文字</button>
                ${isDraftMode ? `<button class="btn-publish" style="background-color: #16a34a;">審核與發布</button>` : ''}
            `;
            
            buttonContainer.querySelector('.btn-manage-photos').onclick = () => openPhotoModal(log.LogID, log.PhotoLinks);
            buttonContainer.querySelector('.btn-edit-text').onclick = () => handleEditText(log.LogID);
            if (isDraftMode) {
                buttonContainer.querySelector('.btn-publish').onclick = (e) => handlePublish(log.LogID, e.target);
            }

            card.appendChild(buttonContainer);
            return card;
        }

        // 渲染所有日誌到頁面
        function displayLogs(logs, isDraftMode) {
            logToPage(`➡️ displayLogs: 開始渲染畫面...`);
            const container = document.getElementById('logs-container');
            const statusMessage = document.getElementById('status-message');

            if (statusMessage) statusMessage.remove();
            container.innerHTML = '';

            if (!Array.isArray(logs) || logs.length === 0) {
                logToPage('⚠️ 偵測到沒有日誌資料，停止渲染。');
                container.innerHTML = '<div class="card"><p class="muted" style="text-align:center;">沒有可顯示的日誌。</p></div>';
                return;
            }
            
            logToPage(`...偵測到 ${logs.length} 筆日誌，開始遍歷處理...`);
            currentLogsData = logs;
            logs.forEach((log, index) => {
                const card = buildLogCard(log, isDraftMode);
                container.appendChild(card);
            });
            logToPage('✅ 所有日誌渲染完畢。');
        }

        // 編輯文字功能
        function handleEditText(logId) {
            const contentDiv = document.getElementById(`content-${logId}`);
            const buttonContainer = contentDiv.closest('.card').querySelector('.button-group');
            const originalButtonsHTML = buttonContainer.innerHTML;

            contentDiv.dataset.originalContent = contentDiv.innerText;
            contentDiv.contentEditable = true;
            contentDiv.focus();
            contentDiv.style.cssText += 'border: 1px solid #3b82f6; padding: 0.5rem; border-radius: 0.25rem; background: #f9fafb;';

            buttonContainer.innerHTML = `
                <button style="background-color: #6b7280;">取消</button>
                <button style="background-color: #16a34a;">儲存文字</button>
            `;
            buttonContainer.children[0].onclick = () => { // Cancel
                contentDiv.contentEditable = false;
                contentDiv.style.border = 'none';
                contentDiv.style.padding = '0';
                contentDiv.style.background = 'transparent';
                contentDiv.innerText = contentDiv.dataset.originalContent;
                buttonContainer.innerHTML = originalButtonsHTML;
                 // 重新綁定事件
                buttonContainer.querySelector('.btn-manage-photos').onclick = () => openPhotoModal(logId, currentLogsData.find(l=>l.LogID === logId).PhotoLinks);
                buttonContainer.querySelector('.btn-edit-text').onclick = () => handleEditText(logId);
                const publishBtn = buttonContainer.querySelector('.btn-publish');
                if (publishBtn) publishBtn.onclick = (e) => handlePublish(logId, e.target);
            };
            buttonContainer.children[1].onclick = () => { // Save
                const newContent = contentDiv.innerText.trim();
                const params = new URLSearchParams({ page: 'updateLogText', id: logId, content: newContent });
                loadJsonp(`${API_BASE_URL}?${params.toString()}`)
                    .then(response => {
                        if (response && response.success) {
                            reloadSingleLogCard(logId);
                        } else {
                            alert('儲存失敗：' + (response ? response.message : '未知錯誤'));
                        }
                    })
                    .catch(err => alert('儲存請求失敗: ' + err.message));
            };
        }

        // 發布日誌功能
        function handlePublish(logId, button) {
            if (button) { button.disabled = true; button.textContent = '發布中...'; }
            const params = new URLSearchParams({ page: 'publish', logId: logId, newStatus: '已發布' });
            loadJsonp(`${API_BASE_URL}?${params.toString()}`)
                .then(response => {
                    if (response && response.success) {
                        const card = document.getElementById('log-' + logId);
                        if (card) {
                            card.style.transition = 'opacity .5s ease';
                            card.style.opacity = '0';
                            setTimeout(() => card.remove(), 500);
                        }
                    } else {
                         alert('發布失敗：' + (response ? response.message : '未知原因'));
                         if (button) { button.disabled = false; button.textContent = '審核與發布'; }
                    }
                })
                .catch(err => {
                    alert('發布請求失敗！');
                    if (button) { button.disabled = false; button.textContent = '審核與發布'; }
                });
        }
        
        // 重新載入單張卡片
        function reloadSingleLogCard(logId) {
            const params = new URLSearchParams({ page: 'getSingleLog', id: logId });
            loadJsonp(`${API_BASE_URL}?${params.toString()}`)
                .then(newLogData => {
                    if (newLogData) {
                        const index = currentLogsData.findIndex(log => log.LogID === logId);
                        if (index !== -1) currentLogsData[index] = newLogData;
                        
                        const newCard = buildLogCard(newLogData, newLogData.Status === '草稿');
                        const oldCard = document.getElementById('log-' + logId);
                        if (oldCard) oldCard.replaceWith(newCard);
                        logToPage(`卡片 ${logId} 已成功局部更新。`);
                    }
                });
        }

        // 照片管理 Modal 功能
        function openPhotoModal(logId, photoLinksCsv) {
            currentEditingLogId = logId;
            const modal = document.getElementById('photo-modal');
            const grid = document.getElementById('modal-photo-grid-container');
            grid.innerHTML = '';
            
            const links = photoLinksCsv ? photoLinksCsv.split(',').filter(link => link.trim()) : [];
            links.forEach(link => {
                const item = document.createElement('div');
                item.className = 'modal-photo-item';
                item.dataset.link = link;
                const img = document.createElement('img');
                
                // 【修正】統一使用 Apps Script 代理
                const fileId = driveFileId(link);
                img.src = fileId ? `${API_BASE_URL}?img=${fileId}&w=200` : link;
                img.loading = 'lazy';
                
                const delBtn = document.createElement('button');
                delBtn.className = 'delete-photo-btn';
                delBtn.innerHTML = '&times;';
                delBtn.onclick = () => {
                    item.style.opacity = '0.3';
                    item.dataset.deleted = 'true';
                };
                item.appendChild(img);
                item.appendChild(delBtn);
                grid.appendChild(item);
            });
            modal.style.display = 'flex';
        }
        
        function closePhotoModal() {
            document.getElementById('photo-modal').style.display = 'none';
            currentEditingLogId = null;
        }

        document.getElementById('save-photos-button').onclick = function() {
            const saveButton = this;
            saveButton.textContent = '儲存中...';
            saveButton.disabled = true;
            const grid = document.getElementById('modal-photo-grid-container');
            
            const remainingLinks = Array.from(grid.querySelectorAll('.modal-photo-item:not([data-new])'))
                .filter(item => item.dataset.deleted !== 'true')
                .map(item => item.dataset.link);
                
            const newPhotosBase64Array = Array.from(grid.querySelectorAll('.modal-photo-item[data-new]'))
                .map(item => item.dataset.base64);

            google.script.run
                .withSuccessHandler(response => {
                    if (response.success) {
                        closePhotoModal();
                        reloadSingleLogCard(currentEditingLogId);
                    } else {
                        alert('儲存失敗: ' + (response.message || '未知錯誤'));
                    }
                    saveButton.textContent = '儲存變更';
                    saveButton.disabled = false;
                })
                .withFailureHandler(err => {
                    alert('上傳失敗: ' + err.message);
                    saveButton.textContent = '儲存變更';
                    saveButton.disabled = false;
                })
                .updateLogPhotosWithUploads(currentEditingLogId, remainingLinks.join(','), newPhotosBase64Array);
        };
        
        document.getElementById('add-photos-button').onclick = () => document.getElementById('photo-file-input').click();
        document.getElementById('photo-file-input').onchange = (event) => {
            const files = event.target.files;
            const grid = document.getElementById('modal-photo-grid-container');
            for (const file of files) {
                if (!file.type.startsWith('image/')) continue;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64String = e.target.result;
                    const item = document.createElement('div');
                    item.className = 'modal-photo-item';
                    item.dataset.new = 'true';
                    item.dataset.base64 = base64String;
                    const img = document.createElement('img');
                    img.src = base64String;
                    const delBtn = document.createElement('button');
                    delBtn.className = 'delete-photo-btn';
                    delBtn.innerHTML = '&times;';
                    delBtn.onclick = () => item.remove();
                    item.appendChild(img);
                    item.appendChild(delBtn);
                    grid.appendChild(item);
                };
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        };

        // 頁面載入主函式
        window.addEventListener('load', function(){
            logToPage(`頁面載入完成 (v${FRONTEND_VERSION})，開始讀取 URL 參數...`);
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            logToPage('URL id=' + (id || '(未帶入)'));
            
            if (!id) {
                displayError({ message:'未指定 id。請在網址加上 ?id=0（草稿）或 ?id=案號。' });
                return;
            }
            
            // 【修正】使用正確的 API 路由 'project_test'
            const fetchUrl = `${API_BASE_URL}?page=project_test&id=${id}`;
            logToPage('準備呼叫 API(JSONP): ' + fetchUrl);
            
            loadJsonp(fetchUrl)
                .then(data => {
                    // 【修正】處理後端回傳的物件結構
                    logToPage('✅ 成功從後端取得資料。');
                    const logs = data.dailyLogs; // 從回傳的物件中，只取出日誌陣列
                    const isDraftMode = (id === '0');
                    displayLogs(logs, isDraftMode);
                })
                .catch(displayError);
        });

        // 顯示錯誤訊息
        function displayError(error){
            const msg = (error && error.message) ? error.message : '發生未知錯誤。';
            logToPage('PAGE ERROR: ' + msg);
            const status = document.getElementById('status-message');
            if(status){
                status.innerHTML = `<div style="border:1px solid red;background:#ffebee;color:#c62828;padding:1rem;white-space:pre-wrap;"><strong>載入失敗！</strong>\n\n${msg}</div>`;
            }
        }
    </script>
</body>
</html>
