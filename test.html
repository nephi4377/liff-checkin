<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>互動式甘特圖沙盒（test.html v0.2.3）</title>

  <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.css">

  <style>
    :root { --bg:#f3f4f6; --fg:#1f2937; --card:#fff; --muted:#6b7280; --primary:#3b82f6; --green:#16a34a; --shadow:0 1px 3px rgba(0,0,0,.1),0 1px 2px -1px rgba(0,0,0,.1); --radius:.6rem; }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:1.25rem}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;margin-bottom:1rem}
    h1{font-size:1.6rem;margin:0}
    .muted{color:var(--muted)}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:1rem;margin:.5rem 0}
    button{background:var(--primary);color:#fff;border:0;padding:.5rem .9rem;border-radius:.45rem;cursor:pointer;font-weight:600}
    button:hover{opacity:.9}

    /* 甘特 Modal */
    .gantt-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:2000}
    .gantt-modal-content{background:#fff;border-radius:var(--radius);width:95%;max-width:1400px;height:90vh;display:flex;flex-direction:column;box-shadow:0 4px 20px rgba(0,0,0,.35);padding:1rem}
    .gantt-modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem}
    .gantt-modal-header h2{margin:0;font-size:1.1rem}
    .gantt-chart-wrapper{flex:1;overflow:auto}
    .toolbar{display:flex;gap:.5rem;align-items:center}
    .toolbar select{padding:.35rem .5rem;border:1px solid #d1d5db;border-radius:.4rem;background:#fff}
    .right{margin-left:auto;display:flex;gap:.5rem}
    pre#debug-log{background:#0b1020;color:#e5e7eb;border-radius:.5rem;padding:.75rem;height:12rem;overflow:auto;white-space:pre-wrap}
    .gantt-host { display: grid; grid-template-columns: 280px 1fr; gap: .75rem; height: 100%; }
    .left-rail { background:#f8fafc; border: 1px solid #e2e8f0; border-radius: var(--radius); overflow-y: hidden; } /* 改為 hidden，由 JS 控制 */
    .left-rail .row { padding:.5rem .75rem; border-bottom:1px solid #f1f5f9; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; font-size:.9rem; height: 36px; display: flex; align-items: center;}
    .gantt-pane { display:flex; flex-direction:column; }
    .gantt-chart-wrapper{ flex: 1; overflow: auto; border: 1px solid #e2e8f0; border-radius: var(--radius); background:#fff; }
    .xscroller { height: 18px; background:#e5e7eb; border-radius: 9px; position: relative; overflow:auto; margin-top: .5rem; }
    .xscroller .spacer { height: 1px; }
    .gantt .grid .nonwork-rect { fill: #fecaca; opacity: .4; }
    .legend { display:flex; align-items:center; gap:.5rem; font-size:.85rem; color:var(--muted); }
    .legend .swatch { width:12px; height:12px; background:#fecaca; border:1px solid #fca5a5; border-radius:2px }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>互動式甘特圖沙盒</h1>
        <div class="muted" id="subtitle">Demo 模式</div>
      </div>
      <div class="right">
        <button id="view-gantt-btn" style="background:var(--green);display:none">📊 檢視甘特圖</button>
      </div>
    </header>

    <section class="card">
      <div class="toolbar">
        <label>案號：<input id="project-id-input" type="text" placeholder="例如：715" style="padding:.35rem .5rem;border:1px solid #d1d5db;border-radius:.4rem"></label>
        <button id="load-btn">載入排程</button>
        <button id="use-demo-btn" style="background:#6b7280">使用 Demo 資料</button>
        <div class="right">
          <button id="save-btn" style="display:none;">儲存排程變更</button>
        </div>
      </div>
      <div id="schedule-brief" class="muted" style="margin-top:.5rem"></div>
    </section>

    <section class="card">
      <h3 style="margin:.25rem 0 .75rem">除錯訊息</h3>
      <pre id="debug-log"></pre>
    </section>
  </div>

  <div id="gantt-modal" class="gantt-modal-overlay" aria-hidden="true">
    <div class="gantt-modal-content" role="dialog" aria-modal="true" aria-labelledby="gantt-modal-title">
      <div class="gantt-modal-header">
        <h2 id="gantt-modal-title">專案甘特圖</h2>
        <div class="legend"><span class="swatch"></span><span>週末／國定假日</span></div>
        <div class="toolbar">
          <select id="modal-view-mode-select">
            <option selected>Day</option>
            <option>Week</option>
            <option>Month</option>
          </select>
          <button id="modal-close-btn" style="background:#6b7280">關閉</button>
        </div>
      </div>
      <div class="gantt-host">
        <div id="left-rail" class="left-rail"></div>
        <div class="gantt-pane">
          <div class="gantt-chart-wrapper" id="gantt-wrapper">
            <svg id="gantt-chart"></svg>
          </div>
          <div id="gantt-scroll-x" class="xscroller"><div class="spacer"></div></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwbEVAfoO9eRzcUSfESIwih1Poub657h_9jz5UcqTXbxsDQOZ3mjLm1nHZfn_WM2K8/exec';
    let currentScheduleData = [];
    let gantt = null;
    let TAIWAN_HOLIDAYS = new Set();

    function logToPage(msg){
      const t = new Date().toLocaleTimeString('zh-TW');
      const el = document.getElementById('debug-log');
      el.textContent += `[${t}] ${msg}\n`;
      el.scrollTop = el.scrollHeight;
    }

    function loadJsonp(url){
      return new Promise((resolve, reject) => {
        const cb = 'jsonp_' + Math.random().toString(36).slice(2);
        const timer = setTimeout(() => { cleanup(); reject(new Error('請求逾時 (15s)')); }, 15000);
        function cleanup(){ clearTimeout(timer); delete window[cb]; script.remove(); }
        window[cb] = (data) => { cleanup(); resolve(data); };
        const script = document.createElement('script');
        script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
        script.onerror = () => { cleanup(); reject(new Error('載入失敗')); };
        document.body.appendChild(script);
      });
    }

    // [核心修正] 強化的日期格式化函式
    const toYYYYMMDD = (dateString) => {
        if (!dateString) return null;
        try {
            const d = new Date(dateString);
            if (isNaN(d.getTime())) return null;
            return d.toISOString().slice(0, 10);
        } catch (e) { return null; }
    };
    
    function statusToProgress(status){
      if(status === '已完成') return 100;
      if(status === '施工中') return 50;
      return 0;
    }

    function progressToStatus(p){
      if(p >= 100) return '已完成';
      if(p > 0) return '施工中';
      return '未完成';
    }

    function scheduleToGanttTasks(schedule){
      return schedule.map((t, i) => {
          const startDate = toYYYYMMDD(t['預計開始日']);
          const endDate = toYYYYMMDD(t['預計完成日']);
          if (!startDate || !endDate) return null; // 過濾掉無效日期的任務

          return {
            id: `task-${i}`,
            name: t['任務項目'] || `任務${i+1}`,
            start: startDate,
            end: endDate,
            progress: statusToProgress(t['狀態']),
            custom: { index: i } // 儲存原始索引
          };
        }).filter(Boolean); // 移除 null
    }

    function openGanttModal(){ document.getElementById('gantt-modal').style.display = 'flex'; }
    function closeGanttModal(){ document.getElementById('gantt-modal').style.display = 'none'; }

    function initGanttFromSchedule(schedule, viewMode = 'Day'){ // [修改] 預設為 Day
      if (typeof Gantt !== 'function') { alert('甘特圖套件未載入'); return; }
      const tasks = scheduleToGanttTasks(schedule);
      if (tasks.length === 0) {
        logToPage('沒有有效的排程資料可渲染甘特圖。');
        return;
      }

      const svg = document.getElementById('gantt-chart');
      svg.innerHTML = '';
      
      gantt = new Gantt(svg, tasks, {
        view_mode: viewMode,
        language: 'zh',
        bar_height: 28,
        header_height: 50,
        on_date_change: (task, start, end) => {
          const idx = task.custom.index;
          const iso = d => new Date(d).toISOString().slice(0,10);
          currentScheduleData[idx]['預計開始日'] = iso(start);
          currentScheduleData[idx]['預計完成日'] = iso(end);
          logToPage(`日期變更：#${idx+1} → ${iso(start)} ~ ${iso(end)}`);
          document.getElementById('save-btn').style.display = '';
        },
        on_progress_change: (task, progress) => {
          const idx = task.custom.index;
          currentScheduleData[idx]['狀態'] = progressToStatus(progress);
          logToPage(`進度變更：#${idx+1} → ${progress}%（狀態：${currentScheduleData[idx]['狀態']}）`);
          document.getElementById('save-btn').style.display = '';
        }
      });
      
      // 使用 setTimeout 確保 DOM 渲染完成後再執行同步
      setTimeout(() => {
        syncLeftRail();
        paintNonWorking(gantt);
        syncHorizontalScroller();
      }, 0);
    }

    function isWeekend(d){ const day = d.getDay(); return day === 0 || day === 6; }
    function isHoliday(d){ return TAIWAN_HOLIDAYS.has(d.toISOString().slice(0,10)); }

    function paintNonWorking(g){
      try{
        const svg = document.getElementById('gantt-chart');
        const gridLayer = svg.querySelector('.grid');
        if(!gridLayer) return;
        const contentHeight = svg.getBBox().height || 800;
        
        gridLayer.querySelectorAll('.nonwork-rect').forEach(n => n.remove());
        
        const start = new Date(g.gantt_start);
        const end = new Date(g.gantt_end);

        for(let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)){
          if(!isWeekend(d) && !isHoliday(d)) continue;
          
          const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
          rect.setAttribute('class','nonwork-rect');
          rect.setAttribute('x', g.get_x(new Date(d)) - g.options.column_width / 2);
          rect.setAttribute('y', 0);
          rect.setAttribute('width', g.options.column_width);
          rect.setAttribute('height', contentHeight);
          gridLayer.appendChild(rect);
        }
      }catch(e){ console.warn('paintNonWorking error', e); }
    }
    
    function syncLeftRail() {
        const leftRail = document.getElementById('left-rail');
        leftRail.innerHTML = '';
        if (!gantt || !gantt.tasks) return;
        gantt.tasks.forEach(task => {
            const div = document.createElement('div');
            div.className = 'row';
            div.textContent = task.name;
            leftRail.appendChild(div);
        });
    }

    function syncHorizontalScroller(){
      const wrapper = document.getElementById('gantt-wrapper');
      const scroller = document.getElementById('gantt-scroll-x');
      const spacer = scroller.querySelector('.spacer');
      const leftRail = document.getElementById('left-rail');
      
      const contentWidth = wrapper.scrollWidth;
      spacer.style.width = contentWidth + 'px';
      
      let lock = false;
      const syncScroll = () => {
        if (lock) return;
        lock = true;
        scroller.scrollLeft = wrapper.scrollLeft;
        leftRail.scrollTop = wrapper.scrollTop;
        lock = false;
      };
      
      wrapper.onscroll = syncScroll;
      scroller.onscroll = () => {
        if (lock) return;
        lock = true;
        wrapper.scrollLeft = scroller.scrollLeft;
        lock = false;
      };
    }

    function enableGanttButton(){
      const btn = document.getElementById('view-gantt-btn');
      if(!btn) return;
      btn.style.display = '';
      btn.onclick = () => {
        initGanttFromSchedule(currentScheduleData);
        openGanttModal();
      };
    }

    const demoTasks = [
        // ... (Demo 資料與前版相同，此處省略以節省篇幅)
    ];

    async function loadScheduleById(projectId){
      const url = `${API_BASE_URL}?page=project&id=${encodeURIComponent(projectId)}`;
      logToPage('呼叫 API：' + url);
      const data = await loadJsonp(url);
      if(!data || !Array.isArray(data.schedule)) throw new Error('API 回傳無 schedule');
      
      currentScheduleData = data.schedule;
      
      // [新增] 載入假日資料
      if (data.holidays && Array.isArray(data.holidays)) {
        TAIWAN_HOLIDAYS = new Set(data.holidays);
        logToPage(`已成功載入 ${TAIWAN_HOLIDAYS.size} 筆國定假日資料。`);
      }

      document.getElementById('subtitle').textContent = `實戰模式（案號：${projectId}）`;
      document.getElementById('schedule-brief').textContent = `已載入 ${currentScheduleData.length} 筆任務。`;
      enableGanttButton();
    }

    function useDemoData(){
      currentScheduleData = JSON.parse(JSON.stringify(demoTasks));
      document.getElementById('subtitle').textContent = 'Demo 模式';
      document.getElementById('schedule-brief').textContent = `已載入 ${currentScheduleData.length} 筆 Demo 任務。`;
      enableGanttButton();
      TAIWAN_HOLIDAYS = new Set(['2025-10-10']); // Demo 模式給一個假資料
      logToPage('已載入 Demo 假日 (10/10)。');
    }

    async function saveScheduleChanges(projectId){
        if(!projectId){ alert('請先輸入案號'); return; }
        const btn = document.getElementById('save-btn');
        btn.textContent = '儲存中...';
        btn.disabled = true;

        const payload = { action:'updateSchedule', projectId, scheduleData: currentScheduleData };
        const endpoint = `${API_BASE_URL}?page=project`;
        logToPage('POST → ' + endpoint);
        try{
            await fetch(endpoint, {
                method:'POST', mode:'no-cors', body: JSON.stringify(payload), headers:{'Content-Type':'text/plain;charset=utf-8'}
            });
            logToPage('已送出更新。');
            alert('儲存成功！');
            btn.style.display = 'none';
        } catch(err){
            logToPage('送出失敗：' + err.message);
            alert('儲存失敗：' + err.message);
        } finally {
            btn.textContent = '儲存排程變更';
            btn.disabled = false;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(location.search);
      const idParam = params.get('id');
      const projectInput = document.getElementById('project-id-input');
      
      if(idParam){ 
        projectInput.value = idParam; 
        loadScheduleById(idParam).catch(e => alert('載入專案資料失敗: ' + e.message));
      } else { 
        useDemoData(); 
      }

      document.getElementById('modal-close-btn').onclick = closeGanttModal;

      document.getElementById('modal-view-mode-select').addEventListener('change', (e) => {
        if(gantt){ 
            gantt.change_view_mode(e.target.value);
            setTimeout(() => {
                paintNonWorking(gantt);
                syncHorizontalScroller();
            }, 0);
        }
      });

      document.getElementById('load-btn').onclick = () => {
        const pid = projectInput.value.trim();
        if(!pid){ alert('請輸入案號'); return; }
        loadScheduleById(pid).catch(err => alert(err.message));
      };
      
      document.getElementById('use-demo-btn').onclick = useDemoData;
      
      document.getElementById('save-btn').onclick = () => {
        const pid = projectInput.value.trim();
        saveScheduleChanges(pid);
      };
    });
  </script>
</body>
</html>
