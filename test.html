<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>專案日誌管理主控台（test_v11_進度修正版）</title>
  <script>
    // 前端版本：test-v11.1（進度條自動推算＋範本按鈕）
    // Asia/Taipei
    const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwbEVAfoO9eRzcUSfESIwih1Poub657h_9jz5UcqTXbxsDQOZ3mjLm1nHZfn_WM2K8/exec';
    const FRONTEND_VERSION = 'test-v11.1';
  </script>
  <style>
    :root {
      --bg:#f3f4f6; --fg:#1f2937; --muted:#6b7280; --muted-2:#9ca3af; --card:#ffffff;
      --primary:#3b82f6; --green:#16a34a; --red:#dc2626; --yellow:#f59e0b;
      --shadow:0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --radius:.5rem;
    }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:1.5rem}
    .container{max-width:900px;margin:0 auto}
    header{margin-bottom:1.5rem;display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
    h1{font-size:1.75rem;font-weight:700;margin:0}
    .muted{color:var(--muted);font-size:.9rem}
    .card{background:var(--card);border-radius:var(--radius);padding:1.5rem;margin-bottom:1rem;box-shadow:var(--shadow)}
    .spinner{margin:2rem auto;width:3rem;height:3rem;border-radius:50%;border:4px solid #e5e7eb;border-top-color:var(--primary);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    pre#debug-log{background:#111827;color:#e5e7eb;font-family:monospace;font-size:.75rem;padding:1rem;border-radius:var(--radius);margin-top:1rem;height:16rem;overflow-y:auto;white-space:pre-wrap}
    button{background:var(--primary);color:#fff;border:0;padding:.5rem .75rem;border-radius:.375rem;cursor:pointer;font-weight:600;transition:opacity .2s}
    button:hover{opacity:.85}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .button-group{display:flex;gap:.5rem;flex-wrap:wrap}
    /* 進度總覽 */
    details.schedule-accordion{border-radius:var(--radius);overflow:hidden}
    details.schedule-accordion>summary{list-style:none;cursor:pointer;padding:1rem;background:#f9fafb;transition:background-color .2s;border:1px solid #e5e7eb;border-radius:var(--radius)}
    details.schedule-accordion>summary::-webkit-details-marker{display:none}
    details.schedule-accordion[open]>summary{border-bottom-left-radius:0;border-bottom-right-radius:0}
    .progress-timeline{position:relative;width:100%;height:18px;background:#e5e7eb;border-radius:9px;overflow:hidden;margin:.5rem 0}
    .progress-segment{position:absolute;height:100%}
    .today-marker{position:absolute;top:-5px;width:3px;height:28px;background:var(--red);border-radius:2px;box-shadow:0 0 5px rgba(0,0,0,.3)}
    .today-marker::after{content:'今天';position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:12px;color:var(--red);font-weight:700;background:#fff;padding:0 3px;border-radius:3px}
    .progress-label{font-size:.9rem}
    .schedule-details{max-height:300px;overflow-y:auto;border:1px solid #e5e7eb;border-top:none;border-bottom-left-radius:var(--radius);border-bottom-right-radius:var(--radius)}
    .schedule-table{width:100%;border-collapse:collapse;font-size:14px}
    .schedule-table th,.schedule-table td{padding:.75rem;text-align:left;border-bottom:1px solid #e5e7eb}
    .schedule-table th{background:#f9fafb;font-weight:600;position:sticky;top:0;z-index:1}
    .status-badge{font-weight:700;padding:.25rem .5rem;border-radius:99px;font-size:12px;display:inline-block}
    .clickable-work-type{cursor:pointer;text-decoration:underline;color:var(--primary)}
    .tpl-bar{display:flex;justify-content:space-between;align-items:center;gap:.75rem;margin:.5rem 0 0}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 id="project-title">專案日誌管理主控台</h1>
      <p id="version-display" class="muted"></p>
    </header>
    <main id="main-content">
      <div id="status-message"><div class="spinner"></div><p style="text-align:center;">正在載入資料...</p></div>
      <div id="schedule-container" class="card" style="display:none;"></div>
      <div id="logs-container"></div>
      <div><h3 style="margin-top:2rem;font-weight:600;">執行狀態日誌：</h3><pre id="debug-log"></pre></div>
    </main>
  </div>

  <script>
    let currentLogsData = [];
    let currentScheduleData = [];
    function logToPage(message){
      const el = document.getElementById('debug-log'); if(!el) return;
      const t = new Date().toLocaleTimeString('zh-TW'); el.textContent += '['+t+'] '+message+'\\n'; el.scrollTop = el.scrollHeight;
    }
    function loadJsonp(url){
      return new Promise((resolve,reject)=>{
        const cb='jsonp_'+Math.random().toString(36).slice(2); const timer=setTimeout(()=>{cleanup();reject(new Error('請求後端資料超時 (15秒)。'));},15000);
        function cleanup(){clearTimeout(timer); delete window[cb]; if(script.parentNode) script.parentNode.removeChild(script);}
        window[cb]=(data)=>{cleanup(); resolve(data)};
        const script=document.createElement('script'); script.src=url+(url.includes('?')?'&':'?')+'callback='+cb; script.onerror=()=>{cleanup();reject(new Error('載入後端資料失敗。'));}; document.body.appendChild(script);
      });
    }
    function displayError(err){
      const msg=(err&&err.message)?err.message:'發生未知錯誤。'; logToPage('PAGE ERROR: '+msg);
      const status=document.getElementById('status-message'); if(status){ status.innerHTML='<div style="border:1px solid red;background:#ffebee;color:#c62828;padding:1rem;">'+
        '<strong>載入失敗！</strong><br>'+msg+'<br>請檢查 Apps Script 路由（project_test）。</div>'; }
    }

    // 日期工具：容錯
    function normalizeDateStr(s){
      if(!s) return null; const str=String(s).trim();
      if(/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(str)){ const [y,m,d]=str.split('/'); return [y,m.padStart(2,'0'),d.padStart(2,'0')].join('-'); }
      return str;
    }
    function parseDate(s){
      const n=normalizeDateStr(s);
      if(!n) return null;
      const d=new Date(n);
      return isNaN(d)?null:d;
    }

    // 進度總覽（自動推算起訖；若全無則以今天為中心建立「假設進度條」）
    function displaySchedule(overview, schedule){
      const container = document.getElementById('schedule-container');
      if(!Array.isArray(schedule) || schedule.length===0){ container.style.display='none'; container.innerHTML=''; return; }

      // 從 overview（若存在）或 schedule 自動推算
      const ovStart = overview && (overview['專案起始日'] || overview.startDate);
      const ovEnd   = overview && (overview['預計完工日'] || overview.endDate);

      let minStart = parseDate(ovStart);
      let maxEnd   = parseDate(ovEnd);

      schedule.forEach(t=>{
        const s = parseDate(t['預計開始日'] || t.startDate);
        const e = parseDate(t['預計完成日'] || t.dueDate || t.endDate);
        if(s && (!minStart || s < minStart)) minStart = s;
        if(e && (!maxEnd   || e > maxEnd))   maxEnd   = e;
      });

      const today = new Date();
      if(!minStart || !maxEnd || maxEnd - minStart <= 0){
        // 假設進度條：以今天為中心，左右各 15 天
        minStart = new Date(today.getTime() - 15*24*60*60*1000);
        maxEnd   = new Date(today.getTime() + 15*24*60*60*1000);
      }

      container.style.display='block'; container.innerHTML='';

      // 整體完成度（狀態：已完成 / 完成 / done）
      const doneCount = schedule.filter(t=>{
        const st = t['狀態'] || t.status || '';
        return st==='已完成' || st==='完成' || String(st).toLowerCase()==='done';
      }).length;
      const overall = Math.round((doneCount / schedule.length) * 100);

      // 目前任務：找第一個「未完成」且預計完成日最早
      const pending = schedule.filter(t=>{
        const st = t['狀態'] || t.status || '';
        return !(st==='已完成' || st==='完成' || String(st).toLowerCase()==='done');
      }).sort((a,b)=>{
        const da = parseDate(a['預計完成日'] || a.dueDate) || new Date(8640000000000000);
        const db = parseDate(b['預計完成日'] || b.dueDate) || new Date(8640000000000000);
        return da - db;
      });
      const currentTask = pending[0] || {'任務項目':'已全數完工'};

      const total     = maxEnd - minStart;
      const elapsed   = today - minStart;
      const todayPct  = Math.max(0, Math.min(100, (elapsed/total)*100));

      const details = document.createElement('details'); details.className='schedule-accordion'; details.open=true;
      const summary = document.createElement('summary');
      summary.innerHTML =
        '<div class="progress-label"><strong>整體進度: '+overall+'%</strong></div>'+
        '<div class="progress-timeline">'+
        '  <div class="progress-segment" style="width:'+overall+'%; background-color: var(--primary);"></div>'+
        '  <div class="today-marker" style="left:'+todayPct+'%;"></div>'+
        '</div>'+
        '<div class="progress-label">目前任務: '+(currentTask['任務項目']||currentTask.item||'-')+'</div>';

      // 範本按鈕列
      const tplBar = document.createElement('div'); tplBar.className='tpl-bar';
      const rangeNote = document.createElement('div'); rangeNote.className='muted';
      rangeNote.textContent = '時程範圍：' + minStart.toLocaleDateString() + ' ～ ' + maxEnd.toLocaleDateString();
      const btns = document.createElement('div'); btns.className='button-group';
      const btnOld = document.createElement('button'); btnOld.textContent='載入老屋範本';
      const btnNew = document.createElement('button'); btnNew.textContent='載入新屋範本';
      btnOld.style.background='#6b7280'; btnNew.style.background='#6b7280';
      btnOld.onclick = () => applyScheduleTemplate('old');
      btnNew.onclick = () => applyScheduleTemplate('new');
      btns.appendChild(btnOld); btns.appendChild(btnNew);
      tplBar.appendChild(rangeNote); tplBar.appendChild(btns);

      const tableWrap = document.createElement('div'); tableWrap.className='schedule-details';
      const table = document.createElement('table'); table.className='schedule-table';
      table.innerHTML = '<thead><tr><th>工種</th><th>任務項目</th><th>預計開始</th><th>預計完成</th><th>狀態</th></tr></thead>';
      const tbody = document.createElement('tbody');

      schedule.forEach(task=>{
        const row = tbody.insertRow();
        const wt  = task['工種'] || task.workType || '-';
        const item= task['任務項目'] || task.item || '-';
        const s   = parseDate(task['預計開始日'] || task.startDate);
        const e   = parseDate(task['預計完成日'] || task.dueDate || task.endDate);
        const st  = task['狀態'] || task.status || '未設定';

        const wtCell = row.insertCell(); wtCell.textContent = wt; wtCell.className='clickable-work-type'; wtCell.onclick=()=>filterLogsByWorkType(wt);
        row.insertCell().textContent = item;
        row.insertCell().textContent = s ? s.toLocaleDateString() : '-';
        row.insertCell().textContent = e ? e.toLocaleDateString() : '-';
        const statusCell = row.insertCell(); const badge = document.createElement('span'); badge.className='status-badge'; badge.textContent=st; statusCell.appendChild(badge);
      });

      table.appendChild(tbody); tableWrap.appendChild(table);
      details.appendChild(summary);
      container.appendChild(details);
      container.appendChild(tplBar);
      container.appendChild(tableWrap);
    }

    // 範本套用（預設路由：applyScheduleTemplate；可依您後端改名）
    function applyScheduleTemplate(kind){
      const id = new URLSearchParams(location.search).get('id') || '';
      if(!id) return alert('未帶入 id，無法套用範本');
      const route = 'applyScheduleTemplate'; // 若您後端名稱不同，告訴我我會改
      const url = API_BASE_URL + '?page=' + route + '&id=' + encodeURIComponent(id) + '&type=' + encodeURIComponent(kind);
      const btns = document.querySelectorAll('.tpl-bar .button-group button'); btns.forEach(b=>{b.disabled=true; b.textContent='處理中...';});
      loadJsonp(url).then(resp=>{
        if(resp && resp.success){
          // 重新抓資料
          const fetchUrl = API_BASE_URL + '?page=project_test&id=' + encodeURIComponent(id);
          return loadJsonp(fetchUrl).then(handleDataResponse);
        }else{
          alert('套用範本失敗：' + (resp ? (resp.message||'未知原因') : '未知原因'));
        }
      }).catch(err=>alert('套用範本錯誤：' + err.message)).finally(()=>{
        btns.forEach(b=>{ b.disabled=false; b.textContent = (b===btns[0]?'載入老屋範本':'載入新屋範本'); });
      });
    }

    // 日誌呈現（與您先前版本一致）
    function _buildLogCard(log, isDraftMode){
      const card=document.createElement('div'); card.className='card'; card.id='log-'+log.LogID;
      const timestamp=log.Timestamp?new Date(log.Timestamp).toLocaleString('zh-TW',{timeZone:'Asia/Taipei'}):'-';
      const updatedMatch=(log.Content||'').match(/^\[更新 (.*?)\]\n/);
      const displayContent=(log.Content||'無內容').replace(/^\[更新 .*?\]\n/,'');
      const lastModifiedDisplay=updatedMatch?updatedMatch[1]:'無';

      const h3=document.createElement('h3'); h3.textContent=log.Title||'無標題';
      const info1=document.createElement('small'); info1.className='muted'; info1.textContent='案場: '+(log.ProjectName||'未知')+'｜回報人: '+(log.UserName||'未知');
      const info2=document.createElement('small'); info2.className='muted'; info2.style.display='block'; info2.style.marginTop='.25rem'; info2.textContent='建立: '+timestamp+'｜最後更新: '+lastModifiedDisplay;
      const hr=document.createElement('hr');

      const contentDiv=document.createElement('div'); contentDiv.id='content-'+log.LogID; contentDiv.style.whiteSpace='pre-wrap'; contentDiv.textContent=displayContent;
      const photoContainer=document.createElement('div');
      const btns=document.createElement('div'); btns.className='button-group'; btns.style.marginTop='1rem';

      card.appendChild(h3); card.appendChild(info1); card.appendChild(info2); card.appendChild(hr);
      card.appendChild(contentDiv); card.appendChild(photoContainer); card.appendChild(btns);

      if(log.PhotoLinks){ photoContainer.appendChild(buildPhotoGrid(log.PhotoLinks)); logToPage('...['+log.LogID+'] 照片牆已建立'); }
      const btnEdit=document.createElement('button'); btnEdit.textContent='編輯文字'; btnEdit.onclick=()=>alert('此示範版僅展示進度條修正；文字編輯功能與您 v11 相同，若需要我可原樣帶入。');
      const btnManage=document.createElement('button'); btnManage.textContent='管理相片'; btnManage.style.background='#f59e0b'; btnManage.onclick=()=>alert('此示範版僅展示進度條修正；相片管理功能可依您先前版本套入。');
      btns.appendChild(btnManage); btns.appendChild(btnEdit);
      return card;
    }
    function buildPhotoGrid(htmlLinksCsv){
      const container=document.createElement('div'); container.className='photo-grid';
      if(!htmlLinksCsv) return container;
      String(htmlLinksCsv).split(',').forEach(link=>{
        const u=(link||'').trim(); if(!u) return;
        const wrap=document.createElement('div'); wrap.className='photo-item';
        const img=document.createElement('img'); img.className='photo-thumb';
        img.src = u; img.dataset.full=u; img.addEventListener('click', ()=>window.open(u,'_blank')); wrap.appendChild(img); container.appendChild(wrap);
      });
      return container;
    }
    function displayLogs(logs,isDraftMode){
      const container=document.getElementById('logs-container'); document.getElementById('status-message')?.remove();
      container.innerHTML=''; if(!Array.isArray(logs)||!logs.length){ container.innerHTML='<div class="card"><p class="muted" style="text-align:center;">沒有可顯示的日誌。</p></div>'; return; }
      currentLogsData=logs; logs.forEach((log,i)=>{ container.appendChild(_buildLogCard(log,isDraftMode)); });
      logToPage('✅ 日誌渲染完畢');
    }
    function filterLogsByWorkType(workType){
      const filtered = currentLogsData.filter(log => (log.Tags && String(log.Tags).includes(workType)) || (log.Title && log.Title.includes(workType)));
      const container=document.getElementById('logs-container'); container.innerHTML='';
      (filtered.length?filtered:currentLogsData).forEach(log=>container.appendChild(_buildLogCard(log,false)));
    }

    // 入口
    function handleDataResponse(data){
      window.lastData = data; // 方便您除錯
      logToPage('✅ 後端回應成功');
      if(data && data.error){ displayError({message:data.error}); return; }
      currentLogsData = data.dailyLogs || [];
      currentScheduleData = data.schedule || [];
      displaySchedule(data.overview, currentScheduleData);
      displayLogs(currentLogsData, false);
      const titleEl=document.getElementById('project-title');
      const site = (data.overview && (data.overview.siteName || data.overview['案場名稱'])) || '';
      if(site) titleEl.textContent='主控台: '+site;
    }
    window.addEventListener('load',()=>{
      document.getElementById('version-display').textContent = '版本：'+FRONTEND_VERSION;
      const params = new URLSearchParams(location.search); const id=params.get('id');
      if(!id){ displayError({message:'未指定 id'}); return; }
      const fetchUrl = API_BASE_URL + '?page=project_test&id=' + encodeURIComponent(id);
      logToPage('呼叫 API：'+fetchUrl);
      loadJsonp(fetchUrl).then(handleDataResponse).catch(displayError);
    });
  </script>
</body>
</html>
