<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>添心設計 | 整合主控台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .spinner { border-top-color: #3498db; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">

    <!-- 載入中畫面 -->
    <div id="loading-screen" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
        <div class="spinner w-12 h-12 border-4 border-gray-200 rounded-full"></div>
        <p class="mt-4 text-gray-600">正在驗證您的身分...</p>
    </div>

    <!-- 主內容 (預設隱藏) -->
    <div id="main-content" class="container mx-auto p-4 max-w-2xl hidden">
        <header class="text-center my-6">
            <h1 class="text-3xl font-bold text-gray-800">添心設計 整合主控台</h1>
            <p id="welcome-message" class="text-gray-500 mt-2">歡迎，<span class="font-semibold">使用者</span>！</p>
        </header>
        
        <!-- 【v72.0 核心改造】主分頁導覽 -->
        <div class="border-b border-gray-200 mb-6">
            <nav id="main-tab-nav" class="-mb-px flex gap-6" aria-label="Tabs">
                <button type="button" data-tab="dashboard" class="main-tab active py-3 px-1 text-base font-medium">主控台</button> 
                <button type="button" data-tab="project-board" class="main-tab py-3 px-1 text-base font-medium">專案看板</button>
            </nav>
        </div>
 
        <!-- 主控台分頁內容 -->
        <div id="dashboard-content" class="tab-content active">
            <!-- 【v72.0 新增】個人工作台 (智慧通知中心) -->
            <div id="personal-workbench" class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-6">
                <div class="lg:col-span-5 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-700">智慧通知中心</h2>
                        <button id="clear-all-notifications-btn" class="text-sm text-blue-600 hover:underline">全部清除</button>
                    </div>
                    <div id="notification-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                        <p id="notification-placeholder" class="text-center text-gray-500 py-8">正在載入通知...</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
            <!-- 專案主控台 -->
            <div class="col-span-1 md:col-span-2 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h2 class="text-xl font-bold mb-4 text-blue-700">專案主控台</h2>
                <div class="flex flex-col sm:flex-row gap-2 items-center">
                    <input type="text" id="project-id-input" inputmode="numeric" pattern="[0-9]*" class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="請輸入案號 (例如: 715)">
                    <button id="open-project-console-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">開啟</button>
                </div>
            </div>

            <!-- 靜態連結 -->
            <a href="https://info.tanxin.space/onboardingflow.html" target="_blank" class="card bg-white p-6 rounded-lg shadow-md border border-gray-200 block">
                <h2 class="text-xl font-bold mb-2 text-green-700">客戶接洽流程</h2>
                <p class="text-gray-600">查看標準化的互動式客戶溝通劇本。</p>
            </a>
            
            <a href="https://info.tanxin.space/FAQ.html" target="_blank" class="card bg-white p-6 rounded-lg shadow-md border border-gray-200 block">
                <h2 class="text-xl font-bold mb-2 text-green-700">新客戶常見問答 (FAQ)</h2>
                <p class="text-gray-600">快速查詢與回覆客戶的常見問題。</p>
            </a>

            <!-- [核心新增] 出勤管理主控台 (預設隱藏) -->
            <a id="attendance-console-link" href="https://info.tanxin.space/attendance_report.html" target="_blank" class="card bg-white p-6 rounded-lg shadow-md border border-gray-200 block hidden">
                <h2 class="text-xl font-bold mb-2 text-green-700">出勤管理主控台</h2>
                <p class="text-gray-600">查詢所有員工的出勤、遲到、早退與缺勤紀錄。</p>
            </a>

            <!-- 【⭐️ 核心新增：假勤審核儀表板 (預設隱藏) ⭐️】 -->
            <a id="approval-dashboard-link" href="#" class="card bg-white p-6 rounded-lg shadow-md border border-gray-200 block hidden">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold mb-2 text-red-700">假勤審核儀表板</h2>
                    <!-- 【v31.0 新增】待審核計數標籤 -->
                    <span id="approval-badge" class="hidden h-6 w-6 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
                </div>
                <p class="text-gray-600">集中審核所有員工的請假與加班申請。</p>
            </a>

            <a href="https://liff.line.me/2007974938-jVxn6y37" target="_blank" class="card bg-white p-6 rounded-lg shadow-md border border-gray-200 block">
                <h2 class="text-xl font-bold mb-2 text-purple-700">員工打卡</h2>
                <p class="text-gray-600">開啟 LIFF 頁面進行每日出勤打卡。</p>
            </a>

            <a href="https://liff.line.me/2007974938-gOrjlzna" target="_blank" class="card bg-white p-6 rounded-lg shadow-md border border-gray-200 block">
                <h2 class="text-xl font-bold mb-2 text-purple-700">施工回報</h2>
                <p class="text-gray-600">開啟 LIFF 頁面上傳每日施工進度與照片。</p>
            </a>
            
            <!-- 【⭐️ 核心改造：線上假勤申請，改為由 Hub 傳遞認證資訊 ⭐️】 -->
            <a id="open-leave-request-link" href="#" class="card bg-white p-6 rounded-lg shadow-md border border-gray-200 block">
                <h2 class="text-xl font-bold mb-2 text-purple-700">線上假勤申請</h2>
                <p class="text-gray-600">申請特休、病假、事假或回報加班。</p>
            </a>

            <!-- [架構改造] 員工排班系統，改為由 Hub 傳遞認證資訊 -->
            <a id="open-shift-schedule-link" href="#" class="card bg-white p-6 rounded-lg shadow-md border border-gray-200 block">
                <h2 class="text-xl font-bold mb-2 text-purple-700">員工排班系統</h2>
                <p class="text-gray-600">設定排班制員工的休假日期。</p>
            </a>

            </div>

            <!-- 【v72.0 新增】任務交辦中心 -->
            <div id="task-sender-wrapper" class="bg-white p-6 rounded-lg shadow-md border border-gray-200 mt-4 hidden">
                <h2 class="text-xl font-bold text-gray-700 mb-4">任務交辦中心</h2>
                <form id="notification-form" class="space-y-4">
                    <div>
                        <button type="button" id="recipient-toggle-btn" class="w-full text-left p-2 border rounded-md bg-gray-50 hover:bg-gray-100 flex justify-between items-center"><span id="recipient-summary" class="text-sm text-gray-600">選擇收件人</span><svg id="recipient-arrow" class="w-5 h-5 text-gray-500 transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>
                        <div id="recipient-collapsible" class="collapsible-content mt-2"><div id="recipient-list" class="border rounded-md max-h-40 overflow-y-auto p-2 space-y-1"></div></div>
                        <div id="send-to-all-wrapper" class="mt-2 hidden"><label class="flex items-center"><input type="checkbox" id="send-to-all-checkbox" class="h-4 w-4 rounded border-gray-300"><span class="ml-2 text-sm text-red-600 font-semibold">發送給所有員工</span></label></div>
                    </div>
                    <div><label for="notification-content" class="block text-sm font-medium text-gray-700">交辦內容<span class="text-red-500">*</span></label><textarea id="notification-content" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></textarea></div>
                    <div><label for="related-project-id" class="block text-sm font-medium text-gray-700">相關案號 (選填)</label><input type="text" id="related-project-id" inputmode="numeric" pattern="[0-9]*" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="例如: 715"></div>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">要求動作</label><div id="action-type-group" class="mt-2 flex flex-wrap items-center gap-x-4 gap-y-2"><label><input type="radio" name="actionType" value="None" checked> 無</label><label><input type="radio" name="actionType" value="ReplyText"> 文字回覆</label><label class="flex items-center gap-2"><input type="radio" name="actionType" value="ConfirmCompletion"> 完成回報 (時限: <input type="date" id="completion-deadline-date" class="text-sm p-1 border rounded-md" disabled> <input type="time" id="completion-deadline-time" class="text-sm p-1 border rounded-md" disabled>)</label></div></div>
                        <button type="submit" id="notification-submit-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-md">發送任務</button>
                    </div>
                    <div id="notification-status" class="text-sm text-center min-h-[20px]"></div>
                </form>
            </div>
        </div>

        <!-- 【v72.0 新增】專案看板分頁內容 -->
        <div id="project-board-content" class="tab-content hidden">
            <div id="project-board-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            <p id="project-board-placeholder" class="text-center text-gray-500 py-12 hidden">正在載入專案資料...</p>
        </div>
    </div>

    <script>
        // ===============================================================
        // ========================= 環境設定 ============================
        const LIFF_ID = '2007974938-2nPKg3J0'; // 這是這個 hub.html 自己的 LIFF ID
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwbEVAfoO9eRzcUSfESIwih1Poub657h_9jz5UcqTXbxsDQOZ3mjLm1nHZfn_WM2K8/exec';
        const PROJECT_CONSOLE_LIFF_ID = '2007974938-7yKM9EqL'; // 專案主控台的 LIFF ID
        const ATTENDANCE_GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz5-DUPNNciVdvE5wrOogNgxYt8EpDZppAe9f2cUh8pW9y3i29fB6n0RA5r-A5KuAiz/exec'; // 出勤系統的後端 URL
        // ===============================================================

        // 【v72.0 新增】樣式與動畫相關
        const STYLE_CLASSES = {
            collapsibleContent: 'max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out;',
            mainTab: 'border-bottom: 3px solid transparent; transition: all 0.2s ease-in-out;',
            mainTabActive: 'color: #1d4ed8; border-bottom-color: #1d4ed8;',
        };
        const dynamicStyleSheet = document.createElement("style");
        dynamicStyleSheet.innerText = `
            .collapsible-content { ${STYLE_CLASSES.collapsibleContent} }
            .main-tab { ${STYLE_CLASSES.mainTab} }
            .main-tab.active { ${STYLE_CLASSES.mainTabActive} }
        `;
        document.head.appendChild(dynamicStyleSheet);
        // ===============================================================

        let userProfile = null;
        let allEmployees = []; // 將員工資料提升至全域，以便共用

        // 【v71.0 核心新增】快取管理函式
        function saveCache(key, data, days = 1) {
            const cache = {
                data: data,
                expires: Date.now() + days * 24 * 60 * 60 * 1000
            };
            try {
                localStorage.setItem(key, JSON.stringify(cache));
            } catch (e) {
                console.error('儲存快取失敗:', e);
            }
        }

        function loadCache(key) {
            const cached = localStorage.getItem(key);
            if (!cached) return null;
            const cache = JSON.parse(cached);
            if (cache.expires < Date.now()) {
                localStorage.removeItem(key);
                return null;
            }
            return cache.data;
        }

        async function main() {
            // 本地測試模式
            const isLocalTest = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
            const urlParams = new URLSearchParams(window.location.search);

            if (isLocalTest) {
                console.warn('⚡️ 本地測試模式啟用，跳過 LIFF 認證。');
                userProfile = {
                    userId: urlParams.get('uid') || 'Ud58333430513b7527106fa71d2e30151',
                    displayName: '俊豪 (本地測試)'
                };
                // 本地模式也採用快取優先策略
                const cachedEmployees = loadCache('hub_employees');
                if (cachedEmployees) {
                    allEmployees = cachedEmployees;
                    console.log('⚡️ 本地模式從快取載入員工資料。');
                }
                showMainContent();
                // 在背景獲取最新資料
                fetchInitialData();
                return;
            }

            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                userProfile = await liff.getProfile();

                // 【v71.0 核心改造】快取優先策略
                // 1. 嘗試從快取載入員工資料並立即顯示畫面
                const cachedEmployees = loadCache('hub_employees');
                if (cachedEmployees) {
                    allEmployees = cachedEmployees;
                    console.log('✅ 從快取載入員工資料，執行樂觀更新。');
                }
                showMainContent();

                // 2. 在背景非同步獲取最新資料
                fetchInitialData();

            } catch (error) {
                console.error('LIFF Initialization Error:', error);
                document.getElementById('loading-screen').innerHTML = '<p class="text-red-500 font-semibold">驗證失敗，請在 LINE App 中開啟此頁面。</p>';
            }
        }

        function showMainContent() {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('welcome-message').querySelector('span').textContent = userProfile.displayName;
            // 使用現有 (可能來自快取) 的員工資料，先更新一次權限相關的UI
            updatePermissionUI();
            initializeEventListeners();
        }

        // 根據權限更新 UI 的共用函式
        function updatePermissionUI() {
            if (!userProfile || allEmployees.length === 0) return;

            const currentUser = allEmployees.find(emp => emp.userId === userProfile.userId);
            const isLocalTest = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
            // 【v78.0 修正】將本地測試模式的權限直接視為 5，確保所有管理者功能可見。
            const permission = isLocalTest ? 5 : (currentUser ? currentUser.permission : 1);
            const hasAdminRights = permission >= 4;

            if (hasAdminRights || isLocalTest) {
                document.getElementById('attendance-console-link').classList.remove('hidden');
                document.getElementById('approval-dashboard-link').classList.remove('hidden');
                // 【v72.0 新增】顯示任務交辦中心
                document.getElementById('task-sender-wrapper').classList.remove('hidden');
                populateRecipientOptions();
            }
        }

        async function fetchInitialData() {
            try {
                // 【v83.0 核心改造】前端現在只需要發送兩個請求：
                // 1. 獲取通知 (來自 project-console)
                // 2. 獲取所有核心資料 (來自 CheckinSystem)
                const notificationsPromise = fetchNotifications();
                const coreDataPromise = fetchCoreData();

                const [notificationsResult, coreDataResult] = await Promise.all([
                    notificationsPromise,
                    coreDataPromise
                ]);

                // 智慧更新員工資料
                if (coreDataResult.success && coreDataResult.employees) {
                    const oldDataString = JSON.stringify(allEmployees);
                    const newDataString = JSON.stringify(coreDataResult.employees);

                    if (oldDataString !== newDataString) {
                        console.log('🔄 員工資料已在背景更新，重新整理權限與UI。');
                        allEmployees = coreDataResult.employees;
                        saveCache('hub_employees', allEmployees, 1); // 快取1天
                        updatePermissionUI(); // 使用最新資料重新執行權限判斷
                    }
                }

                // 【v76.0 新增】處理智慧通知
                if (notificationsResult.success) {
                    renderNotifications(notificationsResult.data);
                } else {
                    renderNotifications([]); // 即使失敗也清空範例
                }

                // 處理待審核項目
                if (coreDataResult.success && coreDataResult.pendingRequests) {
                    updateApprovalBadge(coreDataResult.pendingRequests.data.length);
                }

                // 【v72.0 新增】處理專案資料
                if (coreDataResult.success && coreDataResult.projectsData && coreDataResult.projectsData.success) {
                    const currentUser = allEmployees.find(emp => emp.userId === userProfile.userId);
                    filterAndRenderProjects(coreDataResult.projectsData.data, currentUser);
                } else {
                    document.getElementById('project-board-placeholder').textContent = '載入專案資料失敗。';
                }

            } catch (error) {
                console.warn('載入初始資料時發生錯誤:', error);
            }
        }

        // 【v83.0 新增】獲取核心資料的函式
        async function fetchCoreData() {
            if (!userProfile) return { success: false, message: '無使用者 Profile' };
            try {
                const url = new URL(ATTENDANCE_GAS_WEB_APP_URL);
                url.searchParams.append('page', 'attendance_api');
                url.searchParams.append('action', 'get_hub_core_data');
                url.searchParams.append('userId', userProfile.userId);
                console.log(`[CONSOLE] 請求核心整合資料: ${url.toString()}`);
                const response = await fetch(url);
                const result = await response.json();
                console.log(`[CONSOLE] 收到核心整合資料:`, result);
                return result;
            } catch (error) {
                return { success: false, message: error.message };
            }
        }
        
        // 【v76.0 新增】獲取智慧通知中心的通知
        async function fetchNotifications() {
            if (!userProfile) return { success: false, data: [] };
            const url = new URL(GAS_WEB_APP_URL); // 使用專案主控台的後端
            url.searchParams.append('page', 'get_notifications');
            url.searchParams.append('userId', userProfile.userId);
            // 【v78.0 新增】增加 CONSOLE 日誌
            console.log(`[CONSOLE] 請求通知: ${url.toString()}`);
            // 【v82.0 核心修正】改用 loadJsonp 函式，以正確處理後端回傳的 JSONP 格式
            const data = await loadJsonp(url.toString());
            console.log(`[CONSOLE] 收到通知:`, data);
            return data;
        }

        // 【v76.0 新增】渲染智慧通知
        function renderNotifications(notifications) {
            const container = document.getElementById('notification-list');
            const placeholder = document.getElementById('notification-placeholder');
            container.innerHTML = ''; // 清空現有內容

            if (!notifications || notifications.length === 0) {
                placeholder.textContent = '目前沒有任何通知。';
                container.appendChild(placeholder);
                return;
            }

            const typeStyles = {
                // 【v76.1 核心修正】將 key 改為與後端回傳的 Type 值一致 (首字母大寫)
                'Task': { bg: 'bg-yellow-50', border: 'border-yellow-500', text: 'text-yellow-800', subtext: 'text-yellow-700' },
                'Approval': { bg: 'bg-green-50', border: 'border-green-500', text: 'text-green-800', subtext: 'text-green-700' },
                'Info': { bg: 'bg-blue-50', border: 'border-blue-500', text: 'text-blue-800', subtext: 'text-blue-700' },
                default: { bg: 'bg-gray-50', border: 'border-gray-400', text: 'text-gray-800', subtext: 'text-gray-700' }
            };

            notifications.forEach(item => {
                // 【v76.1 核心修正】將讀取的屬性改為與後端一致的大小寫 (item.Type, item.Title, item.Content)
                const styles = typeStyles[item.Type] || typeStyles.default;
                const card = document.createElement('div');
                // 【v77.0 修正】補上遺失的 border-l-4 class，讓左側邊框能正確顯示
                card.className = `notification-card relative p-3 rounded-md ${styles.bg} border-l-4 ${styles.border}`;
                card.innerHTML = `
                    <h4 class="font-semibold ${styles.text}">${item.Title || '系統通知'}</h4>
                    <p class="text-sm ${styles.subtext}">${item.Content || ''}</p>
                `;
                container.appendChild(card);
            });
        }

        // 【v81.0 核心改造】改為呼叫新的整合 API，一次性取得所有專案的詳細資料
        async function fetchHubProjectsData() {
            if (!userProfile) return { success: false, data: [] };
            try {
                const url = new URL(ATTENDANCE_GAS_WEB_APP_URL); // 使用出勤系統的後端
                url.searchParams.append('page', 'attendance_api');
                url.searchParams.append('action', 'get_hub_projects_data');
                url.searchParams.append('userId', userProfile.userId);
                
                // 【v78.0 新增】增加 CONSOLE 日誌
                console.log(`[CONSOLE] 請求專案看板整合資料: ${url.toString()}`);
                const response = await fetch(url);
                const result = await response.json();
                console.log(`[CONSOLE] 收到專案看板整合資料:`, result);
                return result; // 直接回傳 { success: true, data: [...] }
            } catch (error) {
                console.error('獲取專案看板整合資料失敗:', error);
                return { success: false, message: error.message, data: [] };
            }
        }

        async function loadJsonp(url) {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
            const text = await response.text();
            const firstParen = text.indexOf('(');
            const lastParen = text.lastIndexOf(')');
            if (firstParen === -1 || lastParen === -1 || lastParen < firstParen) {
                try { 
                    const jsonData = JSON.parse(text);
                    console.log('[CONSOLE] 解析為純 JSON:', jsonData);
                    return jsonData;
                } catch (e) { throw new Error('Invalid JSONP or JSON format'); }
            }
            const parsedData = JSON.parse(text.substring(firstParen + 1, lastParen));
            console.log('[CONSOLE] 從 JSONP 回應中解析出的資料:', parsedData);
            return parsedData;
        }

        function filterAndRenderProjects(allProjects, currentUser) {
            const isLocalTest = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
            // 【v78.0 修正】將本地測試模式的權限直接視為 5
            const permission = isLocalTest ? 5 : (currentUser ? currentUser.permission : 1);
            const userName = currentUser ? currentUser.userName : '本地測試員';
            let projectsToShow = [];
            // 【v77.0 修正】將權限判斷從 === 2 改為 <= 2，確保權限為 1 的使用者也能看到自己負責的專案。
            if (permission >= 4) { 
                projectsToShow = allProjects; 
            } else if (permission <= 2) { 
                projectsToShow = allProjects.filter(p => (p.responsiblePerson || '').split(',').map(name => name.trim()).includes(userName));
            }
            renderProjectCards(projectsToShow);
        }

        function renderProjectCards(projects) {
            const grid = document.getElementById('project-board-grid');
            const placeholder = document.getElementById('project-board-placeholder');
            grid.innerHTML = '';
            if (projects.length === 0) {
                placeholder.textContent = '沒有符合條件的專案。';
                placeholder.classList.remove('hidden');
                return;
            }
            placeholder.classList.add('hidden');
            projects.forEach(p => {
                if (!p || !p.id || !p.name) { console.warn('偵測到不完整的專案資料，已跳過渲染:', p); return; }
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-md border border-gray-200 flex flex-col gap-4';
                // 【v72.1 修正】確保 '預計開始日' 存在才進行排序，避免無效日期導致的錯誤
                const allTasks = (p.tasks || []).sort((a, b) => 
                    (a['預計開始日'] && b['預計開始日']) ? new Date(a['預計開始日']) - new Date(b['預計開始日']) : 0);
                const completedTasks = allTasks.filter(task => task['狀態'] === '已完成');
                const uncompletedTasks = allTasks.filter(task => task['狀態'] !== '已完成');
                const scheduleHtml = [...completedTasks.slice(-1), ...uncompletedTasks.slice(0, 2)].map(task => {
                    const isDone = task['狀態'] === '已完成';
                    return `<li><span class="font-medium ${isDone ? 'text-gray-500' : 'text-red-600'}">${isDone ? '[已完成]' : '[未完成]'}</span> ${task['任務項目'] || '未命名任務'}</li>`;
                }).join('') || '<li>無排程資料</li>';
                const recentLogs = (p.dailyLogs || []).slice(0, 3);
                const logsHtml = recentLogs.length > 0 ? recentLogs.map(log => {
                    const titleMatch = (log.Title || '').match(/(\d{4}-\d{2}-\d{2})\s(.+?)\s/);
                    const logDate = titleMatch ? titleMatch[1].substring(5) : '';
                    const workType = titleMatch ? titleMatch[2] : '日誌';
                    const logContent = (log.Content || '').trim();
                    const contentHtml = logContent ? `<p class="text-xs text-gray-600 pl-4 mt-1 whitespace-pre-wrap">${logContent}</p>` : '';
                    return `<li><span class="text-gray-500">${logDate}</span> <span class="font-medium text-blue-700">${workType}</span> by ${log.UserName}${contentHtml}</li>`;
                }).join('') : '<li>無施工回報</li>';
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        {/* 【v72.1 修正】如果 p.name 為空，則只顯示案號，避免多餘的空格 */}
                        <h3 class="font-bold text-lg text-gray-800">#${p.id}${p.name ? ' ' + p.name : ''}</h3>
                        <div><button data-action="open-console" data-project-id="${p.id}" class="bg-blue-100 text-blue-700 text-xs font-bold py-1 px-3 rounded-full hover:bg-blue-200">開啟主控台</button></div>
                    </div>
                    <div><h4 class="font-semibold text-gray-600 text-sm mb-2">工程進度</h4><ul class="text-sm space-y-1 text-gray-700">${scheduleHtml}</ul></div>
                    <div><h4 class="font-semibold text-gray-600 text-sm mb-2">近期回報</h4><ul class="text-sm space-y-1 text-gray-700">${logsHtml}</ul></div>
                `;
                grid.appendChild(card);
            });
        }

        // 【v72.0 新增】任務交辦相關函式
        function populateRecipientOptions() {
            const recipientList = document.getElementById('recipient-list');
            if (!recipientList) return;
            recipientList.innerHTML = '';
            allEmployees.filter(emp => emp.permission < 5).forEach(emp => {
                const id = `recipient-${emp.userId}`;
                recipientList.insertAdjacentHTML('beforeend', `<label for="${id}" class="flex items-center p-1 rounded hover:bg-gray-100 cursor-pointer"><input type="checkbox" id="${id}" name="recipients" value="${emp.userId}" class="h-4 w-4 rounded border-gray-300"><span class="ml-2 text-sm text-gray-800" data-name="${emp.userName}">${emp.userName}</span></label>`);
            });
            document.getElementById('send-to-all-wrapper').classList.remove('hidden');
        }

        async function handleSendNotification(event) {
            event.preventDefault();
            const statusEl = document.getElementById('notification-status');
            const submitBtn = document.getElementById('notification-submit-btn');
            const sendToAll = document.getElementById('send-to-all-checkbox').checked;
            const selectedRecipients = Array.from(document.querySelectorAll('#recipient-list input[type="checkbox"]:checked')).map(cb => cb.value);
            if (!sendToAll && selectedRecipients.length === 0) { statusEl.textContent = '錯誤：請至少選擇一位收件人。'; return; }
            submitBtn.disabled = true;
            statusEl.textContent = '發送中...';
            const deadlineDate = document.getElementById('completion-deadline-date').value;
            const deadlineTime = document.getElementById('completion-deadline-time').value;
            let deadline = (deadlineDate && deadlineTime) ? `${deadlineDate}T${deadlineTime}` : '';
            const payload = { action: 'sendNotification', senderId: userProfile.userId, senderName: userProfile.displayName, recipients: sendToAll ? ['ALL'] : selectedRecipients, content: document.getElementById('notification-content').value, projectId: document.getElementById('related-project-id').value, actionType: document.querySelector('input[name="actionType"]:checked').value, deadline: deadline };
            try {
                const response = await fetch(GAS_WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'text/plain' } });
                const result = await response.json();
                if (!result.success) throw new Error(result.message || '後端處理失敗');
                statusEl.textContent = '任務已成功發送！';
                document.getElementById('notification-form').reset();
                updateRecipientSummary();
            } catch (error) { statusEl.textContent = `發送失敗: ${error.message}`; } finally {
                submitBtn.disabled = false;
                setTimeout(() => { statusEl.textContent = ''; }, 5000);
            }
        }

        function updateRecipientSummary() {
            const summaryEl = document.getElementById('recipient-summary');
            if (document.getElementById('send-to-all-checkbox').checked) { summaryEl.textContent = '已選擇：所有員工'; return; }
            const selectedCheckboxes = Array.from(document.querySelectorAll('#recipient-list input[type="checkbox"]:checked'));
            if (selectedCheckboxes.length === 0) { summaryEl.textContent = '選擇收件人'; } 
            else if (selectedCheckboxes.length <= 2) { summaryEl.textContent = '已選擇：' + selectedCheckboxes.map(cb => cb.nextElementSibling.textContent).join('、'); } 
            else { summaryEl.textContent = `已選擇：${selectedCheckboxes.length} 位員工`; }
        }

        function setupMainTabs() {
            const tabContainer = document.getElementById('main-tab-nav');
            if (!tabContainer) return;
            tabContainer.addEventListener('click', (e) => {
                const button = e.target.closest('.main-tab');
                if (!button) return;
                const tabName = button.dataset.tab;
                tabContainer.querySelectorAll('.main-tab').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('hidden', content.id !== `${tabName}-content`);
                });
            });
        }

        function initializeEventListeners() {
            // 開啟專案主控台按鈕
            document.getElementById('open-project-console-btn').addEventListener('click', (e) => {
                e.preventDefault();
                const projectId = document.getElementById('project-id-input').value.trim();
                openProjectConsole(projectId);
            });

            // [架構改造] 員工排班系統連結
            document.getElementById('open-shift-schedule-link').addEventListener('click', (e) => {
                e.preventDefault(); // 防止直接跳轉
                if (!userProfile || !userProfile.userId) {
                    alert('無法取得您的使用者資訊，請重新載入頁面。');
                    return;
                }
                // [核心改造] 根據當前環境，動態產生排班系統的 URL
                const isLocal = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
                const baseUrl = isLocal 
                    ? 'http://127.0.0.1:5500/shift_schedule.html' 
                    : 'https://info.tanxin.space/shift_schedule.html';
                
                // 【v84.0 核心修正】補上遺失的班表時間參數，確保非管理者也能看到自己的班表
                const currentUserData = allEmployees.find(emp => emp.userId === userProfile.userId);
                const params = new URLSearchParams({
                    uid: userProfile.userId,
                    name: userProfile.displayName
                });
                if (currentUserData && currentUserData.shiftStart && currentUserData.shiftEnd) {
                    params.set('shiftStart', currentUserData.shiftStart);
                    params.set('shiftEnd', currentUserData.shiftEnd);
                }
                window.open(`${baseUrl}?${params.toString()}`, '_blank');
            });

            // 【⭐️ 核心新增：線上假勤申請連結 ⭐️】
            document.getElementById('open-leave-request-link').addEventListener('click', (e) => {
                e.preventDefault();
                if (!userProfile || !userProfile.userId) {
                    alert('無法取得您的使用者資訊，請重新載入頁面。');
                    return;
                }
                // 根據當前環境，動態產生假勤申請系統的 URL
                const isLocal = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
                const baseUrl = isLocal 
                    ? 'http://127.0.0.1:5500/leave_request.html' 
                    : 'https://info.tanxin.space/leave_request.html';

                // 【⭐️ 核心改造：從已取得的員工資料中找出班表時間，並加入 URL 參數 ⭐️】
                const currentUserData = allEmployees.find(emp => emp.userId === userProfile.userId);
                const params = new URLSearchParams({
                    uid: userProfile.userId,
                    name: userProfile.displayName
                });
                if (currentUserData && currentUserData.shiftStart && currentUserData.shiftEnd) {
                    params.set('shiftStart', currentUserData.shiftStart);
                    params.set('shiftEnd', currentUserData.shiftEnd);
                }
                const leaveRequestUrl = `${baseUrl}?${params.toString()}`;
                
                // 在新分頁中開啟
                window.open(leaveRequestUrl, '_blank');
            });

            // 【⭐️ 核心新增：假勤審核儀表板連結 ⭐️】
            document.getElementById('approval-dashboard-link').addEventListener('click', (e) => {
                e.preventDefault();
                if (!userProfile || !userProfile.userId) {
                    alert('無法取得您的使用者資訊，請重新載入頁面。');
                    return;
                }
                const isLocal = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
                const baseUrl = isLocal 
                    ? 'http://127.0.0.1:5500/approval_dashboard.html' 
                    : 'https://info.tanxin.space/approval_dashboard.html';

                const params = new URLSearchParams({
                    uid: userProfile.userId,
                    name: userProfile.displayName
                });
                window.open(`${baseUrl}?${params.toString()}`, '_blank');
            });

            // 【v72.0 新增】任務交辦中心相關事件
            const notificationForm = document.getElementById('notification-form');
            if (notificationForm) {
                notificationForm.addEventListener('submit', handleSendNotification);
                document.getElementById('send-to-all-checkbox').addEventListener('change', (e) => {
                    document.querySelectorAll('#recipient-list input[type="checkbox"]').forEach(checkbox => {
                        checkbox.disabled = e.target.checked;
                        if (e.target.checked) checkbox.checked = false;
                    });
                    updateRecipientSummary();
                });
                document.getElementById('action-type-group').addEventListener('change', (e) => {
                    const deadlineDate = document.getElementById('completion-deadline-date');
                    const deadlineTime = document.getElementById('completion-deadline-time');
                    const enabled = e.target.value === 'ConfirmCompletion';
                    deadlineDate.disabled = !enabled;
                    deadlineTime.disabled = !enabled;
                    if (enabled) {
                        const now = new Date();
                        deadlineDate.value = now.toLocaleDateString('sv');
                        now.setHours(now.getHours() + 1); now.setMinutes(0);
                        deadlineTime.value = `${now.getHours().toString().padStart(2, '0')}:00`;
                    } else { deadlineDate.value = ''; deadlineTime.value = ''; }
                });
                document.getElementById('recipient-list').addEventListener('change', updateRecipientSummary);
                document.getElementById('recipient-toggle-btn').addEventListener('click', () => {
                    const collapsible = document.getElementById('recipient-collapsible');
                    const arrow = document.getElementById('recipient-arrow');
                    if (collapsible.style.maxHeight) { collapsible.style.maxHeight = null; arrow.classList.remove('rotate-180'); } 
                    else { collapsible.style.maxHeight = collapsible.scrollHeight + "px"; arrow.classList.add('rotate-180'); }
                });
            }

            // 【v72.0 新增】專案看板相關事件
            document.getElementById('project-board-grid').addEventListener('click', (e) => {
                const button = e.target.closest('button[data-action="open-console"]');
                if (button) { openProjectConsole(button.dataset.projectId); }
            });
            setupMainTabs();
        }

        // 【v31.0 新增】提供給子視窗呼叫的函式，用以更新待審核標籤
        window.updateApprovalBadge = (count) => {
            const badge = document.getElementById('approval-badge');
            if (!badge) return;
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        };

        // 【v72.0 新增】開啟專案主控台的共用函式
        function openProjectConsole(projectId) {
            if (!projectId || !/^\d+$/.test(projectId)) { alert('請輸入純數字的案號！'); return; }
            if (!userProfile || !userProfile.userId) { alert('無法取得您的使用者資訊，請重新載入頁面。'); return; }
            const isLocal = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
            let targetUrl;
            if (isLocal) {
                targetUrl = `http://127.0.0.1:5500/managementconsole.html?id=${projectId}&uid=${userProfile.userId}`;
            } else {
                targetUrl = `https://liff.line.me/${PROJECT_CONSOLE_LIFF_ID}?id=${projectId}&uid=${userProfile.userId}`;
            }
            window.open(targetUrl, '_blank');
        }

        window.onload = main;
    </script>
</body>
</html>