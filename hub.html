<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>添心設計 | 整合主控台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .spinner { border-top-color: #3498db; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">

    <!-- 載入中畫面 -->
    <div id="loading-screen" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
        <div class="spinner w-12 h-12 border-4 border-gray-200 rounded-full"></div>
        <p class="mt-4 text-gray-600">正在驗證您的身分...</p>
    </div>

    <!-- 主內容 (預設隱藏) -->
    <div id="main-content" class="container mx-auto p-4 max-w-2xl hidden">
        <header class="text-center my-6">
            <h1 class="text-3xl font-bold text-gray-800">添心設計 整合主控台</h1>
            <p id="welcome-message" class="text-gray-500 mt-2">歡迎，<span class="font-semibold">使用者</span>！</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            
            <!-- 專案主控台 -->
            <div class="col-span-1 md:col-span-2 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h2 class="text-xl font-bold mb-4 text-blue-700">專案主控台</h2>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="project-id-input" inputmode="numeric" pattern="[0-9]*" class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="請輸入案號 (例如: 715)">
                    <button id="open-project-console-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">開啟</button>
                </div>
            </div>

            <!-- 靜態連結 -->
            <a href="https://info.tanxin.space/onboardingflow.html" target="_blank" class="card bg-white p-6 rounded-lg shadow-md border border-gray-200 block">
                <h2 class="text-xl font-bold mb-2 text-green-700">客戶接洽流程</h2>
                <p class="text-gray-600">查看標準化的互動式客戶溝通劇本。</p>
            </a>
            
            <a href="https://info.tanxin.space/FAQ.html" target="_blank" class="card bg-white p-6 rounded-lg shadow-md border border-gray-200 block">
                <h2 class="text-xl font-bold mb-2 text-green-700">新客戶常見問答 (FAQ)</h2>
                <p class="text-gray-600">快速查詢與回覆客戶的常見問題。</p>
            </a>

            <!-- [核心新增] 出勤管理主控台 (預設隱藏) -->
            <a id="attendance-console-link" href="https://info.tanxin.space/attendance_report.html" target="_blank" class="card bg-white p-6 rounded-lg shadow-md border border-gray-200 block hidden">
                <h2 class="text-xl font-bold mb-2 text-green-700">出勤管理主控台</h2>
                <p class="text-gray-600">查詢所有員工的出勤、遲到、早退與缺勤紀錄。</p>
            </a>

            <!-- 【⭐️ 核心新增：假勤審核儀表板 (預設隱藏) ⭐️】 -->
            <a id="approval-dashboard-link" href="#" class="card bg-white p-6 rounded-lg shadow-md border border-gray-200 block hidden">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold mb-2 text-red-700">假勤審核儀表板</h2>
                    <!-- 【v31.0 新增】待審核計數標籤 -->
                    <span id="approval-badge" class="hidden h-6 w-6 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
                </div>
                <p class="text-gray-600">集中審核所有員工的請假與加班申請。</p>
            </a>

            <a href="https://liff.line.me/2007974938-jVxn6y37" target="_blank" class="card bg-white p-6 rounded-lg shadow-md border border-gray-200 block">
                <h2 class="text-xl font-bold mb-2 text-purple-700">員工打卡</h2>
                <p class="text-gray-600">開啟 LIFF 頁面進行每日出勤打卡。</p>
            </a>

            <a href="https://liff.line.me/2007974938-gOrjlzna" target="_blank" class="card bg-white p-6 rounded-lg shadow-md border border-gray-200 block">
                <h2 class="text-xl font-bold mb-2 text-purple-700">施工回報</h2>
                <p class="text-gray-600">開啟 LIFF 頁面上傳每日施工進度與照片。</p>
            </a>
            
            <!-- 【⭐️ 核心改造：線上假勤申請，改為由 Hub 傳遞認證資訊 ⭐️】 -->
            <a id="open-leave-request-link" href="#" class="card bg-white p-6 rounded-lg shadow-md border border-gray-200 block">
                <h2 class="text-xl font-bold mb-2 text-purple-700">線上假勤申請</h2>
                <p class="text-gray-600">申請特休、病假、事假或回報加班。</p>
            </a>

            <!-- [架構改造] 員工排班系統，改為由 Hub 傳遞認證資訊 -->
            <a id="open-shift-schedule-link" href="#" class="card bg-white p-6 rounded-lg shadow-md border border-gray-200 block">
                <h2 class="text-xl font-bold mb-2 text-purple-700">員工排班系統</h2>
                <p class="text-gray-600">設定排班制員工的休假日期。</p>
            </a>

            <!-- 後端互動功能 -->
            <div class="col-span-1 md:col-span-2 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h2 class="text-xl font-bold mb-4 text-red-700">後端管理</h2>
                <div class="flex items-center justify-between">
                    <p class="text-gray-600">手動觸發後端處理已上傳的施工回報。</p>
                    <button id="process-queue-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700">立即處理回報</button>
                </div>
                <p id="process-status" class="text-sm text-gray-500 mt-3 min-h-[20px]"></p>
            </div>

        </div>
    </div>

    <script>
        // ===============================================================
        // ========================= 環境設定 ============================
        const LIFF_ID = '2007974938-2nPKg3J0'; // 這是這個 hub.html 自己的 LIFF ID
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwbEVAfoO9eRzcUSfESIwih1Poub657h_9jz5UcqTXbxsDQOZ3mjLm1nHZfn_WM2K8/exec';
        const PROJECT_CONSOLE_LIFF_ID = '2007974938-7yKM9EqL'; // 專案主控台的 LIFF ID
        const ATTENDANCE_GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz5-DUPNNciVdvE5wrOogNgxYt8EpDZppAe9f2cUh8pW9y3i29fB6n0RA5r-A5KuAiz/exec'; // 出勤系統的後端 URL
        // ===============================================================

        let userProfile = null;
        let allEmployees = []; // 【⭐️ 核心新增：將員工資料提升至全域，以便共用 ⭐️】

        async function main() {
            // 【⭐️ 核心新增：本地測試模式 ⭐️】
            // 檢查是否為本地環境，且網址中是否提供了 uid 參數
            const isLocalTest = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
            const urlParams = new URLSearchParams(window.location.search);
            const localTestUid = urlParams.get('uid');

            if (isLocalTest && localTestUid) {
                console.warn('⚡️ 本地測試模式啟用，跳過 LIFF 認證。');
                // 模擬一個 userProfile 物件
                userProfile = {
                    userId: localTestUid,
                    displayName: '本地測試員'
                };
                // 直接顯示主畫面並綁定事件
                showMainContent();
                return; // 中斷後續的 LIFF 流程
            }

            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                userProfile = await liff.getProfile();

                // 驗證成功，顯示主畫面
                showMainContent();

                // 【v32.0 核心改造】在背景中非同步取得員工資料與待審核項目
                try {
                    // 使用 Promise.allSettled 來並行處理多個請求，即使其中一個失敗也不會中斷
                    const [employeesResult, pendingResult] = await Promise.allSettled([
                        fetch(`${ATTENDANCE_GAS_WEB_APP_URL}?page=attendance_api&action=get_employees`).then(res => res.json()),
                        fetch(`${ATTENDANCE_GAS_WEB_APP_URL}?page=attendance_api&action=get_pending_requests`).then(res => res.json())
                    ]);

                    if (employeesResult.status === 'fulfilled') {
                        allEmployees = employeesResult.value;
                        const currentUser = allEmployees.find(emp => emp.userId === userProfile.userId);
                        if (currentUser && currentUser.permission >= 4) {
                            document.getElementById('attendance-console-link').classList.remove('hidden');
                            document.getElementById('approval-dashboard-link').classList.remove('hidden');
                            if (pendingResult.status === 'fulfilled' && pendingResult.value.success) {
                                updateApprovalBadge(pendingResult.value.data.length);
                            }
                        }
                    }
                } catch (authError) {
                    console.warn('無法取得使用者權限:', authError);
                }

            } catch (error) {
                console.error('LIFF Initialization Error:', error);
                document.getElementById('loading-screen').innerHTML = '<p class="text-red-500 font-semibold">驗證失敗，請在 LINE App 中開啟此頁面。</p>';
            }
        }
        
        function showMainContent() {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('welcome-message').querySelector('span').textContent = userProfile.displayName;
            initializeEventListeners();
        }

        function initializeEventListeners() {
            // 開啟專案主控台按鈕
            document.getElementById('open-project-console-btn').addEventListener('click', () => {
                const projectId = document.getElementById('project-id-input').value.trim();
                if (!projectId || !/^\d+$/.test(projectId)) {
                    alert('請輸入純數字的案號！');
                    return;
                }
                if (!userProfile || !userProfile.userId) {
                    alert('無法取得您的使用者資訊，請重新載入頁面。');
                    return;
                }
                const consoleUrl = `https://liff.line.me/${PROJECT_CONSOLE_LIFF_ID}?id=${projectId}&uid=${userProfile.userId}`;
                window.open(consoleUrl, '_blank');
            });

            // [架構改造] 員工排班系統連結
            document.getElementById('open-shift-schedule-link').addEventListener('click', (e) => {
                e.preventDefault(); // 防止直接跳轉
                if (!userProfile || !userProfile.userId) {
                    alert('無法取得您的使用者資訊，請重新載入頁面。');
                    return;
                }
                // [核心改造] 根據當前環境，動態產生排班系統的 URL
                const isLocal = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
                const baseUrl = isLocal 
                    ? 'http://127.0.0.1:5500/shift_schedule.html' 
                    : 'https://info.tanxin.space/shift_schedule.html';

                const scheduleUrl = `${baseUrl}?uid=${userProfile.userId}&name=${encodeURIComponent(userProfile.displayName)}`;
                
                window.open(scheduleUrl, '_blank');
            });

            // 【⭐️ 核心新增：線上假勤申請連結 ⭐️】
            document.getElementById('open-leave-request-link').addEventListener('click', (e) => {
                e.preventDefault();
                if (!userProfile || !userProfile.userId) {
                    alert('無法取得您的使用者資訊，請重新載入頁面。');
                    return;
                }
                // 根據當前環境，動態產生假勤申請系統的 URL
                const isLocal = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
                const baseUrl = isLocal 
                    ? 'http://127.0.0.1:5500/leave_request.html' 
                    : 'https://info.tanxin.space/leave_request.html';

                // 【⭐️ 核心改造：從已取得的員工資料中找出班表時間，並加入 URL 參數 ⭐️】
                const currentUserData = allEmployees.find(emp => emp.userId === userProfile.userId);
                const params = new URLSearchParams({
                    uid: userProfile.userId,
                    name: userProfile.displayName
                });
                if (currentUserData && currentUserData.shiftStart && currentUserData.shiftEnd) {
                    params.set('shiftStart', currentUserData.shiftStart);
                    params.set('shiftEnd', currentUserData.shiftEnd);
                }
                const leaveRequestUrl = `${baseUrl}?${params.toString()}`;
                
                // 在新分頁中開啟
                window.open(leaveRequestUrl, '_blank');
            });

            // 【⭐️ 核心新增：假勤審核儀表板連結 ⭐️】
            document.getElementById('approval-dashboard-link').addEventListener('click', (e) => {
                e.preventDefault();
                if (!userProfile || !userProfile.userId) {
                    alert('無法取得您的使用者資訊，請重新載入頁面。');
                    return;
                }
                const isLocal = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
                const baseUrl = isLocal 
                    ? 'http://127.0.0.1:5500/approval_dashboard.html' 
                    : 'https://info.tanxin.space/approval_dashboard.html';

                const params = new URLSearchParams({
                    uid: userProfile.userId,
                    name: userProfile.displayName
                });
                window.open(`${baseUrl}?${params.toString()}`, '_blank');
            });

            // 立即處理回報按鈕
            document.getElementById('process-queue-btn').addEventListener('click', async () => {
                const btn = document.getElementById('process-queue-btn');
                const statusEl = document.getElementById('process-status');

                if (!confirm('確定要立即處理所有待辦的施工回報嗎？')) {
                    return;
                }

                btn.disabled = true;
                btn.textContent = '處理中...';
                statusEl.textContent = '正在向後端發送指令...';
                statusEl.className = 'text-sm text-blue-600 mt-3 min-h-[20px]';

                try {
                    const response = await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        cache: 'no-cache',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'process_queue',
                            triggerUser: userProfile.displayName
                        })
                    });

                    // 由於後端是 302 重導向，我們無法直接讀取 response.json()
                    // 因此，只要 fetch 沒有拋出錯誤，我們就假設指令已成功發送
                    statusEl.textContent = '指令已成功發送！後端正在背景處理中。';
                    statusEl.className = 'text-sm text-green-600 mt-3 min-h-[20px]';

                } catch (error) {
                    // 處理 fetch 本身的錯誤 (例如網路問題)
                    console.error('Fetch error:', error);
                    statusEl.textContent = `指令發送失敗: ${error.message}`;
                    statusEl.className = 'text-sm text-red-600 mt-3 min-h-[20px]';
                } finally {
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = '立即處理回報';
                    }, 3000);
                }
            });
        }

        // 【v31.0 新增】提供給子視窗呼叫的函式，用以更新待審核標籤
        window.updateApprovalBadge = (count) => {
            const badge = document.getElementById('approval-badge');
            if (!badge) return;
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        };

        window.onload = main;
    </script>
</body>
</html>