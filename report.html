<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>添心設計 | 施工回報 v7.5</title>

  <!-- UI / SDK -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js"></script>

  <script>
    // ⚠️請確認為最新設定
    const LIFF_ID = '2007974938-gOrjlzna';
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwbEVAfoO9eRzcUSfESIwih1Poub657h_9jz5UcqTXbxsDQOZ3mjLm1nHZfn_WM2K8/exec';
  </script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    .spinner { border-top-color: #3498db; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .file-input-label { display: inline-block; background-color: #3b82f6; color: white; border: 1px solid #3b82f6; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s; font-weight: 600; }
    .file-input-label:hover { background-color: #2563eb; }
    .file-input-label.selected { background-color: #6b7280; border-color: #6b7280; cursor: default; }
  </style>
</head>

<body class="bg-gray-100">
  <div class="container mx-auto p-4 max-w-lg">
    <div class="bg-white rounded-lg shadow-md p-6">
      <div class="text-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">添心設計｜施工回報</h1>
      </div>

      <!-- 表單 -->
      <form id="report-form" novalidate>
        <!-- 案號：限制純數字 + 範例 + 非案場=9999 -->
        <div class="mb-4">
          <label for="projectId" class="block text-gray-700 font-semibold mb-2">
            案號 <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="projectId"
            class="w-full px-3 py-2 border border-gray-300 rounded-md"
            inputmode="numeric"
            pattern="[0-9]+"
            placeholder="例如：715；非案場請填 9999"
            required
          >
          <p class="text-sm text-gray-500 mt-1">
            僅允許數字（例：<span class="font-semibold">715</span>）。若為非案場，請填 <span class="font-semibold">9999</span>。
          </p>
          <p id="projectIdError" class="text-sm text-red-600 mt-1 hidden"></p>
        </div>

        <div class="mb-4">
          <label for="workType" class="block text-gray-700 font-semibold mb-2">
            今日施工項目 <span class="text-red-500">*</span>
          </label>
          <select id="workType" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white" required>
            <option value="" disabled selected>請選擇施工項目</option>
            <option value="保護工程-進退場項目">1. 保護工程-進退場項目</option>
            <option value="木作工程">2. 木作工程</option>
            <option value="系統工程">3. 系統工程</option>
            <option value="水電工程">4. 水電工程</option>
            <option value="油漆工程">5. 油漆工程</option>
            <option value="泥作工程">6. 泥作工程</option>
            <option value="清潔工程">7. 清潔工程</option>
            <option value="玻璃工程">8. 玻璃工程</option>
            <option value="其他工程">9. 其他工程</option>
          </select>
        </div>

        <div class="mb-4">
          <label for="workDescription" class="block text-gray-700 font-semibold mb-2">當日施工內容說明</label>
          <textarea id="workDescription" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 font-semibold mb-2">現場照片 (可多選)</label>
          <div class="flex items-center">
            <label for="sitePhotos" id="sitePhotosLabel" class="file-input-label">選擇檔案</label>
            <span id="sitePhotosCount" class="ml-3 text-gray-600">未選取檔案</span>
            <input type="file" id="sitePhotos" multiple accept="image/*" class="hidden" />
          </div>
        </div>

        <div class="mb-4">
          <label for="problemDescription" class="block text-gray-700 font-semibold mb-2">問題回報</label>
          <textarea id="problemDescription" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
        </div>

        <div class="mb-6">
          <label class="block text-gray-700 font-semibold mb-2">問題照片 (可多選)</label>
          <div class="flex items-center">
            <label for="problemPhotos" id="problemPhotosLabel" class="file-input-label">選擇檔案</label>
            <span id="problemPhotosCount" class="ml-3 text-gray-600">未選取檔案</span>
            <input type="file" id="problemPhotos" multiple accept="image/*" class="hidden" />
          </div>
        </div>

        <div class="flex items-center mb-4">
          <input id="compressImages" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"/>
          <label for="compressImages" class="ml-2 block text-sm text-gray-900">壓縮相片以加快上傳</label>
        </div>

        <div id="status-message" class="text-center mb-4 min-h-[24px]"></div>

        <button type="submit" id="submit-button" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-blue-700 disabled:bg-gray-400">
          <span id="button-text">提交回報</span>
          <div id="button-spinner" class="spinner w-6 h-6 border-4 border-white rounded-full mx-auto hidden"></div>
        </button>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('report-form');
      const submitButton = document.getElementById('submit-button');
      const buttonText = document.getElementById('button-text');
      const buttonSpinner = document.getElementById('button-spinner');
      const statusMessage = document.getElementById('status-message');
      let userProfile = null;

      // === 初始化 ===
      async function main() {
        try {
          await liff.init({ liffId: LIFF_ID });
          if (!liff.isLoggedIn()) { liff.login(); return; }
          userProfile = await liff.getProfile();
          initializeEventListeners();
        } catch (error) {
          console.error('初始化失敗', error);
          updateStatus('頁面初始化失敗，請在 LINE 中開啟或重新載入。', 'error');
          submitButton.disabled = true;
        }
      }

      // === 綁定 UI 事件 ===
      function initializeEventListeners() {
        setupFileInputUI('sitePhotos', 'sitePhotosLabel', 'sitePhotosCount');
        setupFileInputUI('problemPhotos', 'problemPhotosLabel', 'problemPhotosCount');

        // 案號輸入：即時只留數字；失焦再清一次
        const projectIdEl = document.getElementById('projectId');
        projectIdEl.addEventListener('input', () => enforceDigits(projectIdEl));
        projectIdEl.addEventListener('blur',  () => enforceDigits(projectIdEl));

        form.addEventListener('submit', handleFormSubmit);
      }

      // === 僅允許數字：即時過濾 ===
      function enforceDigits(el) {
        const digits = (el.value || '').replace(/\D+/g, '');
        if (el.value !== digits) el.value = digits;
      }

      // === 錯誤訊息顯示/隱藏 ===
      function showProjectIdError(msg) {
        const err = document.getElementById('projectIdError');
        const input = document.getElementById('projectId');
        err.textContent = msg || '案號僅能輸入數字；非案場請填 9999。';
        err.classList.remove('hidden');
        input.classList.add('border-red-500');
      }
      function hideProjectIdError() {
        const err = document.getElementById('projectIdError');
        const input = document.getElementById('projectId');
        err.textContent = '';
        err.classList.add('hidden');
        input.classList.remove('border-red-500');
      }

      // === 取得並驗證案號（通過回傳純數字字串；失敗回傳 null） ===
      function getValidProjectId() {
        const input = document.getElementById('projectId');
        enforceDigits(input);
        const v = (input.value || '').trim();
        if (!v || !/^\d+$/.test(v)) {
          showProjectIdError('請輸入純數字案號；非案場請填 9999。');
          return null;
        }
        hideProjectIdError();
        return v;
      }

      // === 送出處理 ===
      async function handleFormSubmit(event) {
        event.preventDefault();
        setLoadingState(true);

        if (!userProfile) {
          updateStatus('無法取得使用者資訊，請重新載入頁面。', 'error');
          setLoadingState(false);
          return;
        }

        // 1) 先驗證案號（純數字；非案場請填 9999）
        const cleanProjectId = getValidProjectId();
        if (!cleanProjectId) {
          setLoadingState(false);
          return; // 中止提交
        }

        try {
          const shouldCompress = document.getElementById('compressImages').checked;

          const siteFiles = Array.from(document.getElementById('sitePhotos').files);
          const problemFiles = Array.from(document.getElementById('problemPhotos').files);
          const allPhotosInfo = [
            ...siteFiles.map(file => ({ file, isProblem: false })),
            ...problemFiles.map(file => ({ file, isProblem: true }))
          ];

          if (allPhotosInfo.length === 0) {
            updateStatus('請至少選擇一張照片。', 'error');
            setLoadingState(false);
            return;
          }

          // 批次設定
          const batchId = `${userProfile.userId}-${Date.now()}`;
          const SUBMIT_CHUNK_SIZE = 10;
          const totalChunks = Math.ceil(allPhotosInfo.length / SUBMIT_CHUNK_SIZE);

          // 基本表單資料（案號使用清洗後的純數字）
          const baseFormData = {
            source: 'liff_report_form_chunk',
            batchId,
            totalChunks,
            userId: userProfile.userId,
            userName: userProfile.displayName,
            projectId: cleanProjectId,          // ✅ 只送乾淨數字（含 9999）
            projectNameRaw: cleanProjectId,     // 如需保留原輸入可另設欄位
            workType: document.getElementById('workType').value,
            workDescription: document.getElementById('workDescription').value,
            problemDescription: document.getElementById('problemDescription').value,
          };

          // 逐批處理與送出
          for (let i = 0; i < totalChunks; i++) {
            const chunkStart = i * SUBMIT_CHUNK_SIZE;
            const chunkEnd = chunkStart + SUBMIT_CHUNK_SIZE;
            const photoChunk = allPhotosInfo.slice(chunkStart, chunkEnd);

            updateStatus(`正在處理第 ${i + 1} / ${totalChunks} 批照片...`, 'info');
            const processedPhotos = await processPhotoChunk(photoChunk, shouldCompress);

            const chunkFormData = { ...baseFormData, chunkIndex: i + 1, photos: processedPhotos };

            updateStatus(`正在提交第 ${i + 1} / ${totalChunks} 批資料...`, 'info');
            await fetch(GAS_WEB_APP_URL, {
              method: 'POST',
              cache: 'no-cache',
              headers: { 'Content-Type': 'text/plain;charset=utf-8' },
              body: JSON.stringify(chunkFormData)
            }).catch(error => {
              // LIFF+GAS 在某些裝置會出現 fetch 類型錯誤但實際已送達
              if (error instanceof TypeError && String(error.message || '').toLowerCase().includes('failed to fetch')) {
                console.log(`批次 ${i + 1} 提交成功 (預期性錯誤)。`);
                return;
              }
              throw error;
            });
          }

          handleSuccess();

        } catch (error) {
          console.error('表單處理失敗', error);
          updateStatus(`提交失敗：${error.message}`, 'error');
          setLoadingState(false);
        }
      }

      // === 成功後處理 ===
      function handleSuccess() {
        updateStatus('所有批次皆已提交！後續處理完成後您會收到 LINE 通知。', 'success');
        setTimeout(() => { liff.closeWindow(); }, 1500);
      }

      // === 單批相片處理（壓縮→轉 Base64） ===
      async function processPhotoChunk(photoInfoChunk, shouldCompress) {
        const photoArray = [];
        const options = { maxSizeMB: 1, maxWidthOrHeight: 1920, useWebWorker: true };
        for (const photoInfo of photoInfoChunk) {
          let processedFile = photoInfo.file;
          try {
            if (shouldCompress) {
              processedFile = await imageCompression(photoInfo.file, options);
            }
            const base64 = await readFileAsBase64(processedFile);
            photoArray.push({
              name: photoInfo.file.name,
              type: processedFile.type,
              data: base64,
              isProblem: photoInfo.isProblem
            });
          } catch (error) {
            console.error(`圖片 ${photoInfo.file.name} 處理失敗:`, error);
          }
        }
        return photoArray;
      }

      // === File → Base64 ===
      function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      // === 載入狀態 ===
      function setLoadingState(isLoading, message = '處理中...') {
        submitButton.disabled = isLoading;
        if (isLoading) {
          buttonText.classList.add('hidden');
          buttonSpinner.classList.remove('hidden');
          updateStatus(message, 'info');
        } else {
          buttonText.classList.remove('hidden');
          buttonSpinner.classList.add('hidden');
          updateStatus('', 'info');
        }
      }

      // === 狀態顯示 ===
      function updateStatus(message, type) {
        statusMessage.textContent = message;
        if (type === 'success')      statusMessage.className = 'text-green-600 font-semibold';
        else if (type === 'error')   statusMessage.className = 'text-red-500 font-semibold';
        else                         statusMessage.className = 'text-gray-600';
      }

      // === 檔案選擇 UI ===
      function setupFileInputUI(inputId, labelId, countId) {
        const input = document.getElementById(inputId);
        const label = document.getElementById(labelId);
        const count = document.getElementById(countId);
        input.addEventListener('change', () => {
          if (input.files.length > 0) {
            label.classList.add('selected');
            count.textContent = `已選擇 ${input.files.length} 張照片`;
          } else {
            label.classList.remove('selected');
            count.textContent = '未選取檔案';
          }
        });
      }

      // 啟動
      main();
    });
  </script>
</body>
</html>
