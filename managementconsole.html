<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>專案日誌管理主控台</title>

  <script>
    // 【全域設定】請確認此網址為您最新部署的 Apps Script 網址
    const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwbEVAfoO9eRzcUSfESIwih1Poub657h_9jz5UcqTXbxsDQOZ3mjLm1nHZfn_WM2K8/exec';
    const FRONTEND_VERSION = 'v7.15'; // 前端版本號
  </script>

  <style>
    /* ========== 您原有的優秀樣式 (完整保留) ========== */
    :root{
      --bg:#f3f4f6; --fg:#1f2937; --muted:#6b7280; --muted-2:#9ca3af;
      --card:#ffffff; --primary:#3b82f6; --shadow:0 1px 2px rgba(0,0,0,.06);
      --radius:.5rem;
    }
    *{ box-sizing: border-box; }
    body{ font-family: Arial, sans-serif; background:var(--bg); color:var(--fg); margin:0; padding:2rem; }
    .container{ max-width:900px; margin:0 auto; }
    header{ margin-bottom:2rem; display:flex; align-items:center; gap:.75rem; flex-wrap:wrap; }
    h1{ font-size:1.875rem; font-weight:bold; margin:0; }
    .muted{ color:var(--muted); font-size:.9rem; }
    .spinner{ margin:2rem auto; width:3rem; height:3rem; border-radius:50%; border:4px solid #e5e7eb; border-top-color:var(--primary); animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    #debug-log{ background:#111827; color:#e5e7eb; font-family:monospace; font-size:.75rem; padding:1rem; border-radius:var(--radius); margin-top:1rem; height:16rem; overflow-y:auto; white-space:pre-wrap; }
    .card{ background:var(--card); border-radius:var(--radius); padding:1.5rem; margin-bottom:1rem; box-shadow:var(--shadow); }
    .photo-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:.75rem; margin-top: 1rem; }
    .photo-item{ display:flex; flex-direction:column; gap:.25rem; }
    .photo-thumb{ width:100%; aspect-ratio:4/3; object-fit:cover; background:#e5e7eb; border-radius:var(--radius); display:block; cursor:zoom-in; }
    .photo-placeholder{ width:100%; aspect-ratio:4/3; border-radius:var(--radius); background:#f3f4f6; display:flex; align-items:center; justify-content:center; color:var(--muted-2); font-size:.9rem; text-align:center; padding:0 .5rem; }
    button{ background:var(--primary); color:#fff; border:0; padding:.5rem .75rem; border-radius:.375rem; cursor:pointer; font-weight: 600; transition: opacity .2s; }
    button:hover { opacity: 0.85; }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    .button-group { display:flex; gap:0.5rem; justify-content:flex-end; flex-wrap:wrap; }
    @media (max-width:640px){ body{ padding:1rem } .photo-grid{ gap:.5rem } }
    
    /* Lightbox (您原有的樣式) */
    #lightbox{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:9999;padding:1rem;}
    #lightbox.open{display:flex}
    #lightbox .lb-wrap{position:relative;max-width:98vw;max-height:95vh;display:flex;align-items:center;justify-content:center;}
    #lightbox img.lb-img{display:block;max-width:98vw;max-height:95vh;object-fit:contain;border-radius:.5rem;background:#fff;box-shadow:0 4px 20px rgba(0,0,0,.6);}
    #lightbox button.lb-close{position:absolute;top:-.5rem;right:-.5rem;background:rgba(0,0,0,.6);color:#fff;border:0;border-radius:9999px;width:40px;height:40px;cursor:pointer;font-size:20px;line-height:40px;text-align:center;}

    /* ========== 【⭐️ 新增功能所需的樣式 ⭐️】 ========== */
    /* 照片管理 Modal */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
    .modal-content { background-color: #fefefe; padding: 20px; border-radius: 0.5rem; width: 90%; max-width: 800px; box-shadow: 0 4px 20px rgba(0,0,0,.4); }
    .modal-photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; max-height: 60vh; overflow-y: auto; padding: 1rem; background: #f3f4f6; border-radius: var(--radius); }
    .modal-photo-item { position: relative; }
    .modal-photo-item img { width: 100%; aspect-ratio: 4/3; object-fit: cover; border-radius: 0.25rem; }
    .delete-photo-btn { position: absolute; top: 5px; right: 5px; background: rgba(239, 68, 68, 0.8); color: white; border: 2px solid white; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-weight: bold; font-size: 16px; display: flex; align-items: center; justify-content: center; line-height: 1; transition: transform .2s; }
    .delete-photo-btn:hover { transform: scale(1.1); }
  </style>
</head>


<body>
  <div class="container">
    <main id="main-content">
      <div id="status-message">
        <div class="spinner"></div>
        <p style="text-align:center;">正在載入資料...</p>
      </div>
      <div id="logs-container"></div> <div>
        <h3 style="margin-top:2rem;font-weight:600;">執行狀態日誌：</h3>
        <pre id="debug-log"></pre>
      </div>
    </main>
  </div>

  <div id="photo-modal" class="modal">
    <div class="modal-content">
      <h2 class="text-xl font-semibold mb-4">管理照片</h2>
      <div id="modal-photo-grid-container" class="modal-photo-grid mb-4"></div>
      <div class="text-right space-x-2 mt-4">
        <button onclick="closePhotoModal()" class="bg-gray-500 hover:bg-gray-600">取消</button>
        <button id="save-photos-button" class="bg-blue-600 hover:bg-blue-700">儲存變更</button>
      </div>
    </div>
  </div>

  <div id="lightbox" aria-hidden="true"> </div>

  <script>
    /* ---------- 縮圖偵錯 ---------- */
    var DEBUG_THUMBS = true;
    function thumbLog(msg){
      if(!DEBUG_THUMBS) return;
      console.log('[THUMB]', msg);
      const el = document.getElementById('debug-log');
      if(!el) return;
      const t = new Date().toLocaleTimeString('zh-TW');
      el.textContent += `[${t}][THUMB] ${msg}\n`;
      el.scrollTop = el.scrollHeight;
    }
    function logToPage(message){
      const el = document.getElementById('debug-log');
      if(!el) return;
      const t = new Date().toLocaleTimeString('zh-TW');
      el.textContent += `[${t}] ${message}\n`;
      el.scrollTop = el.scrollHeight;
    }

    /* ---------- Drive 工具 ---------- */
    function driveFileId(u){
      if(!u) return '';
      u = String(u).trim();
      let m;
      m = u.match(/[?&](?:id|fileId)=([a-zA-Z0-9_-]+)/); if(m) return m[1];
      m = u.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);       if(m) return m[1];
      m = u.match(/\/open\?id=([a-zA-Z0-9_-]+)/);       if(m) return m[1];
      return '';
    }
    function buildPublicThumbUrls(fileId, w){
      const W = Math.max(64, w|0 || 300);
      return [
        `https://drive.google.com/thumbnail?id=${fileId}&sz=w${W}-h${W}`,
        `https://drive.usercontent.google.com/uc?id=${fileId}&export=view`,
        `https://drive.google.com/uc?export=download&id=${fileId}`,
      ];
    }

    /* ---------- 渲染：Drive 縮圖（帶候選/備援 + 點擊 Lightbox） ---------- */
    function renderSmartImg(urls) {
      const wrap = document.createElement('div');
      wrap.className = 'photo-item';
    
      const img = document.createElement('img');
      img.className = 'photo-thumb';
    
      let i = 0;
      function use(idx) {
        if (idx >= urls.length) {
          const ph = document.createElement('div');
          ph.className = 'photo-placeholder';
          ph.textContent = '無法載入縮圖（點此開啟原圖）';
          ph.style.cursor = 'pointer';
          ph.onclick = () => window.open(urls[0], '_blank', 'noopener,noreferrer');
          wrap.replaceChildren(ph);
          return;
        }
        // 防快取可加可不加
        img.src = urls[idx];
        img.dataset.full = urls[0]; // 以第一個當大圖 / 原圖
      }
    
      img.onload  = () => {
        // ✅ 點縮圖開 lightbox，並把同組 URL 帶進去（讓 ← → 可切換）
        img.onclick = () => window.__openLightbox__(img.dataset.full, urls);
      };
      img.onerror = () => { use(++i); };
    
      wrap.appendChild(img);
      use(0);
      return wrap; // ✅ 回傳 DOM 節點
    }


    /* ---------- 渲染：一般圖片（非 Drive） ---------- */
    function renderDirectImg(src){
      const wrap = document.createElement('div');
      wrap.className = 'photo-item';

      const img = document.createElement('img');
      img.className  = 'photo-thumb';
      img.src        = src + (src.includes('?') ? '&' : '?') + '_=' + Date.now();
      img.dataset.full = src;

      // 成功/失敗處理
      img.onload  = () => { thumbLog('IMG OK ' + img.src); };
      img.onerror = () => {
        const ph = document.createElement('div');
        ph.className = 'photo-placeholder';
        ph.textContent = '無法載入縮圖（點此開啟原圖）';
        ph.style.cursor = 'pointer';
        ph.onclick = () => window.open(src, '_blank', 'noopener,noreferrer');
        wrap.replaceChildren(ph);
        thumbLog('IMG ERROR ' + img.src);
      };

      // 點擊看大圖（優先 Lightbox）
      img.addEventListener('click', () => {
        if(window.__openLightbox__) window.__openLightbox__(img.dataset.full);
        else window.open(img.dataset.full, '_blank', 'noopener,noreferrer');
      });

      wrap.appendChild(img);
      return wrap;
    }

    /* ---------- JSONP ---------- */
    function loadJsonp(url, cbName){
      return new Promise((resolve, reject) => {
        const name = cbName || ('cb_' + Math.random().toString(36).slice(2));
        const s = document.createElement('script');
        s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + name;
        s.async = true;

        const t0 = Date.now();
        const timer = setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout ('+(Date.now()-t0)+'ms)')); }, 15000);

        function cleanup(){ clearTimeout(timer); s.remove(); try{ delete window[name]; }catch(_){ window[name] = undefined; } }
        window[name] = (data)=>{ cleanup(); resolve(data); };
        s.onerror = ()=>{ cleanup(); reject(new Error('JSONP load error')); };
        document.head.appendChild(s);
      });
    }

    /* ---------- UI：草稿 / 已發布 ---------- */
    function buildPhotoGrid(htmlLinksCsv){
      const container = document.createElement('div');
      container.className = 'photo-grid';

      if(!htmlLinksCsv) return container;
      String(htmlLinksCsv).split(',').forEach(link => {
        const u = (link || '').trim();
        if(!u) return;
        if(u.charAt(0) === '/'){
          const ph = document.createElement('div');
          ph.className = 'photo-placeholder';
          ph.textContent = '此為 Dropbox 路徑（非網址），僅顯示佔位';
          container.appendChild(ph);
          return;
        }
        const id = driveFileId(u);
        if(id){
          container.appendChild( renderSmartImg( buildPublicThumbUrls(id, 300) ) );
        }else{
          container.appendChild( renderDirectImg(u) );
        }
      });
      return container;
    }

    /* ====================== 【⭐️ 核心修改：渲染與編輯邏輯 ⭐️】 ====================== */

    // --- 渲染主函式 (已整合編輯按鈕) ---
    function displayLogs(logs, isDraftMode) {
      const container = document.getElementById('logs-container');
      const statusMessage = document.getElementById('status-message');
      if (statusMessage) statusMessage.style.display = 'none';
      container.innerHTML = '';
      if (!Array.isArray(logs) || logs.length === 0) { /* ... */ return; }

      logs.forEach(function(log) {
        const card = document.createElement('div');
        card.className = 'card';
        card.id = 'log-' + log.LogID;
        
        const timestamp = log.Timestamp ? new Date(log.Timestamp).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' }) : '未知';
        const lastModified = log.LastModified ? new Date(log.LastModified).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' }) : '無';

        const head = document.createElement('div');
        head.innerHTML =
          `<h3>${log.Title || '無標題'}</h3>
           <small class="muted">案場: ${log.ProjectName || '未知'}｜回報人: ${log.UserName || '未知'}</small>
           <small class="muted block text-xs mt-1">建立: ${timestamp}｜最後更新: ${lastModified}</small>
           <hr class="my-3">
           <div id="content-${log.LogID}" style="white-space:pre-wrap;">${log.Content || '無內容'}</div>`;
        card.appendChild(head);

        if (log.PhotoLinks) {
          card.appendChild(buildPhotoGrid(log.PhotoLinks));
        }

        const actions = document.createElement('div');
        actions.className = 'button-group';
        actions.style.marginTop = '1rem';
        
        // 建立編輯按鈕
        const btnEditText = document.createElement('button');
        btnEditText.textContent = '編輯文字';
        btnEditText.onclick = () => handleEditText(log.LogID);
        actions.appendChild(btnEditText);

        const btnManagePhotos = document.createElement('button');
        btnManagePhotos.textContent = '管理照片';
        btnManagePhotos.onclick = () => openPhotoModal(log.LogID, log.PhotoLinks || '');
        actions.appendChild(btnManagePhotos);

        if (isDraftMode) {
          const btnPublish = document.createElement('button');
          btnPublish.id = 'btn-' + log.LogID;
          btnPublish.textContent = '審核與發布';
          btnPublish.style.backgroundColor = '#16a34a'; // 綠色
          btnPublish.onclick = () => handlePublish(log.LogID);
          actions.appendChild(btnPublish);
        }
        
        card.appendChild(actions);
        container.appendChild(card);
      });
    }
    // --- [新增] 原地編輯文字 ---
    function handleEditText(logId) {
      const contentDiv = document.getElementById(`content-${logId}`);
      const buttonContainer = contentDiv.parentElement.parentElement.querySelector('.button-group');
      const originalContent = contentDiv.innerText;
      const originalButtons = buttonContainer.innerHTML;

      contentDiv.contentEditable = true;
      contentDiv.focus();
      contentDiv.style.cssText += 'border: 1px solid #3b82f6; padding: 0.5rem; border-radius: 0.25rem;';

      buttonContainer.innerHTML = `
          <button class="bg-gray-500">取消</button>
          <button class="bg-green-600">儲存文字</button>
      `;
      buttonContainer.querySelector('.bg-gray-500').onclick = () => handleCancelEdit(logId, originalContent, originalButtons);
      buttonContainer.querySelector('.bg-green-600').onclick = () => handleSaveText(logId, originalButtons);
    }
    
    function handleCancelEdit(logId, originalContent, originalButtons) {
      const contentDiv = document.getElementById(`content-${logId}`);
      contentDiv.contentEditable = false;
      contentDiv.style.border = 'none';
      contentDiv.style.padding = '0';
      contentDiv.innerText = originalContent;
      contentDiv.parentElement.parentElement.querySelector('.button-group').innerHTML = originalButtons;
    }

    function handleSaveText(logId, originalButtons) {
      const contentDiv = document.getElementById(`content-${logId}`);
      const newContent = contentDiv.innerText;
      const buttonContainer = contentDiv.parentElement.parentElement.querySelector('.button-group');
      buttonContainer.querySelector('.bg-green-600').textContent = '儲存中...';
      
      const params = new URLSearchParams({ page: 'updateLogText', id: logId, content: newContent });
      loadJsonp(`${API_BASE_URL}?${params.toString()}`, 'editTextCallback')
        .catch(err => alert('儲存失敗: ' + err.message));
    }

    function editTextCallback(response) {
        alert(response.message);
        if (response.success) window.location.reload();
    }

    // --- [新增] 照片管理 Modal ---
    function openPhotoModal(logId, photoLinksCsv) {
      currentEditingLogId = logId;
      const modal = document.getElementById('photo-modal');
      const grid = document.getElementById('modal-photo-grid-container');
      grid.innerHTML = '';
      
      const links = photoLinksCsv ? photoLinksCsv.split(',').filter(link => link.trim()) : [];
      if (links.length > 0) {
        links.forEach(link => {
          const item = document.createElement('div');
          item.className = 'modal-photo-item';
          item.dataset.link = link;
          const img = document.createElement('img');
          img.src = toEmbeddableImageUrl(link);
          img.loading = 'lazy';
          const delBtn = document.createElement('button');
          delBtn.className = 'delete-photo-btn';
          delBtn.innerHTML = '&times;';
          delBtn.title = '標記為刪除';
          delBtn.onclick = () => {
              item.style.opacity = '0.3'; // 標記為刪除的視覺效果
              item.classList.add('deleted');
          };
          item.appendChild(img);
          item.appendChild(delBtn);
          grid.appendChild(item);
        });
      } else {
        grid.innerHTML = '<p class="muted">目前沒有照片可供管理。</p>';
      }
      modal.style.display = 'flex';
    }

    function closePhotoModal() {
        document.getElementById('photo-modal').style.display = 'none';
        currentEditingLogId = null;
    }

    document.getElementById('save-photos-button').onclick = function() {
        const grid = document.getElementById('modal-photo-grid-container');
        const items = grid.querySelectorAll('.modal-photo-item');
        const remainingLinks = [];
        items.forEach(item => {
            if (!item.classList.contains('deleted')) {
                remainingLinks.push(item.dataset.link);
            }
        });
        const updatedPhotoLinksCsv = remainingLinks.join(',');
        
        const params = new URLSearchParams({ page: 'updateLogPhotos', id: currentEditingLogId, links: updatedPhotoLinksCsv });
        loadJsonp(`${API_BASE_URL}?${params.toString()}`, 'editPhotosCallback')
            .catch(err => alert('儲存照片變更失敗: ' + err.message));
    };

    function editPhotosCallback(response) {
        alert(response.message);
        if (response.success) window.location.reload();
    }
    // --- 發布日誌 (已升級為使用 loadJsonp) ---
    function handlePublish(logId) {
      const button = document.getElementById('btn-' + logId);
      if (button) { button.disabled = true; button.textContent = '發布中...'; }
      const params = new URLSearchParams({ page: 'publish', logId: logId, newStatus: '已發布' });
      const requestUrl = `${API_BASE_URL}?${params.toString()}`;
      logToPage(`發起發布請求: ${requestUrl}`);
      
      loadJsonp(requestUrl, 'publishCallback').catch(err => {
        alert('發布請求失敗！請檢查網路連線或後端日誌。');
        if (button) { button.disabled = false; button.textContent = '審核與發布'; }
      });
    }

/**
 * [新增] 發布動作的回呼函式 (類似 checkin.html 中的 handleGasResponse)
 * 當後端 doGet 執行完畢後，會回傳並執行這個函式
 */
function publishCallback(response) {
  logToPage('收到發布回覆: ' + JSON.stringify(response));
  const logId = response.logId;
  var button = document.getElementById('btn-' + logId);

  if (response && response.success) {
    var card = document.getElementById('log-' + logId);
    if (card) {
      card.style.transition = 'opacity .5s ease';
      card.style.opacity = '0';
      setTimeout(function(){ card.parentNode && card.parentNode.removeChild(card); }, 500);
    }
  } else {
    alert('發布失敗：\n' + (response && response.message ? response.message : '未知原因'));
    if (button) { button.disabled = false; button.textContent = '審核與發布'; }
  }
}

    /* ====================== 【⭐️ 核心修改：入口函式 ⭐️】 ====================== */
    window.addEventListener('load', function(){
      document.getElementById('version-display').textContent = '版本: ' + (typeof FRONTEND_VERSION !== 'undefined' ? FRONTEND_VERSION : '未知');
      logToPage('頁面載入完成，開始讀取 URL 參數');
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get('id');
      logToPage('URL id=' + (id || '(未帶入)'));
      
      if (!id) {
        displayError({ message:'未指定 id。請在網址加上 ?id=0（草稿）或 ?id=案號。' });
        return;
      }

      const fetchUrl = `${API_BASE_URL}?page=project&id=${id}`;
      logToPage('準備呼叫 API(JSONP): ' + fetchUrl);
      
      // 統一呼叫新的 loadJsonp 工具
      loadJsonp(fetchUrl, 'loadDataCallback')
        .catch(err => displayError(err));
    });

    // 唯一的資料載入回呼函式
    function loadDataCallback(data) {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        if (data && data.success === false) { // 檢查後端是否回報業務邏輯錯誤
            displayError({ message: '後端 API 回報錯誤: ' + data.message });
        } else {
            // 【⭐️ 核心修改 ⭐️】
            // 不論 id 為何，都呼叫唯一的 displayLogs 函式
            displayLogs(data, id === '0'); 
        }
    }
    function displayError(error){
      const msg = (error && error.message) ? error.message : '發生未知錯誤。';
      logToPage('PAGE ERROR: ' + msg);
      const status = document.getElementById('status-message');
      if(status){
        status.innerHTML =
          '<div style="border:1px solid red;background:#ffebee;color:#c62828;padding:1rem;white-space:pre-wrap;">' +
          '<strong>載入失敗！</strong>\n\n' +
          '<strong>錯誤訊息：</strong>\n' + msg + '\n\n' +
          '<strong>可能原因與建議：</strong>\n請檢查 Apps Script 後端日誌是否有錯誤紀錄。\n' +
          '</div>';
      }
    }

    /* ---------- 診斷 ---------- */
    function runDiagnostics(){
      const base = API_BASE_URL;
      logToPage('=== 開始診斷 ===');
      logToPage('API_BASE_URL = ' + base);

      const url = base + '?page=project&id=0';
      logToPage('[JSONP] 測試 URL: ' + url);
      const t0 = Date.now();
      loadJsonp(url).then(d => {
        logToPage('[JSONP] OK，用時 ' + (Date.now()-t0) + 'ms，回傳筆數=' + (Array.isArray(d)?d.length:0));
      }).catch(err => {
        logToPage('[JSONP] 失敗：' + err.message);
      }).finally(() => {
        const testId = '1kl1GWuBEE-AKS4e4tdHGz8_90Au04vua';
        const imgUrl = base + '?img=' + encodeURIComponent(testId) + '&w=300';
        logToPage('[IMG] 測試代理：' + imgUrl);
        const img = new Image();
        const t1 = Date.now();
        img.onload  = ()=> logToPage('[IMG] OK，用時 ' + (Date.now()-t1) + 'ms，尺寸=' + img.naturalWidth + 'x' + img.naturalHeight);
        img.onerror = ()=> logToPage('[IMG] 失敗（可能是權限或非圖片格式）');
        img.src = imgUrl + '&_=' + Date.now();
      });
    }
  </script>

  <!-- Lightbox -->
  <div id="lightbox" aria-hidden="true">
    <div class="lb-wrap">
      <img class="lb-img" alt="preview">
      <button class="lb-close" aria-label="關閉">✕</button>
    </div>
  </div>
<script>
(function(){
  const lb = document.getElementById('lightbox');
  if(!lb){ console.warn('[Lightbox] #lightbox not found'); return; }
  const img = lb.querySelector('.lb-img');
  const btn = lb.querySelector('.lb-close');

  let gallery = [];   // 目前相簿的大圖 URL 清單
  let current = -1;   // 目前索引

  function openFromThumb(thumbEl){
    // 在同一張卡片（.photo-grid）內收集所有縮圖的大圖連結
    const grid = thumbEl.closest('.photo-grid');
    gallery = Array.from(grid.querySelectorAll('img.photo-thumb'))
                   .map(el => el.dataset.full || el.src)
                   .filter(Boolean);
    current = Math.max(0, gallery.indexOf(thumbEl.dataset.full || thumbEl.src));
    show(current);
    lb.classList.add('open'); lb.setAttribute('aria-hidden','false');
  }

  function show(idx){
    if(!gallery.length) return;
    if(idx < 0) idx = gallery.length - 1;
    if(idx >= gallery.length) idx = 0;
    current = idx;
    img.src = '';              // 先清掉避免殘影
    img.src = gallery[current];
  }

  function close(){
    lb.classList.remove('open');
    lb.setAttribute('aria-hidden','true');
    img.src = '';
    gallery = []; current = -1;
  }

  // 事件委派：點任何縮圖開啟 Lightbox
  window.addEventListener('click', (e)=>{
    const t = e.target;
    if(t && t.matches('img.photo-thumb')){
      e.preventDefault();
      openFromThumb(t);
    }
  });

  // 背景點擊 / 關閉鈕 / 鍵盤操作
  lb.addEventListener('click', (e)=>{ if(e.target === lb) close(); });
  btn.addEventListener('click', close);
  window.addEventListener('keydown', (e)=>{
    if(!lb.classList.contains('open')) return;
    if(e.key === 'Escape') close();
    if(e.key === 'ArrowLeft') show(current - 1);
    if(e.key === 'ArrowRight') show(current + 1);
  });

  // 若你其他地方需要手動開啟，也可呼叫這個：
  window.__openLightbox__ = function(srcListOrSingle){
    gallery = Array.isArray(srcListOrSingle) ? srcListOrSingle : [String(srcListOrSingle)];
    current = 0; show(0);
    lb.classList.add('open'); lb.setAttribute('aria-hidden','false');
  };
})();
</script>

</body>
</html>
