<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>專案日誌管理主控台</title>
  <script>
    // 【全域設定】請換成你的正式網址
    const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwbEVAfoO9eRzcUSfESIwih1Poub657h_9jz5UcqTXbxsDQOZ3mjLm1nHZfn_WM2K8/exec';
    const FRONTEND_VERSION = 'v7.12-beta';
  </script>

  <style>
    :root{
      --bg:#f3f4f6; --fg:#1f2937; --muted:#6b7280; --muted-2:#9ca3af;
      --card:#ffffff; --primary:#3b82f6; --shadow:0 1px 2px rgba(0,0,0,.06);
      --radius:.5rem;
    }
    *{ box-sizing: border-box; }
    body{ font-family: Arial, sans-serif; background:var(--bg); color:var(--fg); margin:0; padding:2rem; }
    .container{ max-width:900px; margin:0 auto; }
    header{ margin-bottom:2rem; display:flex; align-items:center; gap:.75rem; flex-wrap:wrap; }
    h1{ font-size:1.875rem; font-weight:bold; margin:0; }
    .muted{ color:var(--muted); font-size:.9rem; }

    .spinner{ margin:2rem auto; width:3rem; height:3rem; border-radius:50%; border:4px solid #e5e7eb; border-top-color:var(--primary); animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    #debug-log{ background:#111827; color:#e5e7eb; font-family:monospace; font-size:.75rem; padding:1rem; border-radius:var(--radius); margin-top:1rem; height:16rem; overflow-y:auto; white-space:pre-wrap; }

    .card{ background:var(--card); border-radius:var(--radius); padding:1rem; margin-bottom:1rem; box-shadow:var(--shadow); }

    .photo-grid{
      display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:.75rem;
    }
    .photo-item{ display:flex; flex-direction:column; gap:.25rem; }
    .photo-thumb{ width:100%; aspect-ratio:4/3; object-fit:cover; background:#e5e7eb; border-radius:var(--radius); display:block; cursor:zoom-in; }
    .photo-placeholder{ width:100%; aspect-ratio:4/3; border-radius:var(--radius); background:#f3f4f6; display:flex; align-items:center; justify-content:center; color:var(--muted-2); font-size:.9rem; text-align:center; padding:0 .5rem; }
    button{ background:var(--primary); color:#fff; border:0; padding:.5rem .75rem; border-radius:.375rem; cursor:pointer; }
    button[disabled]{ opacity:.6; cursor:not-allowed; }

    @media (max-width:640px){ body{ padding:1rem } .photo-grid{ gap:.5rem } }
    
    /* Lightbox */
    #lightbox{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:9999;padding:1rem;}
    #lightbox.open{display:flex}
    #lightbox .lb-wrap{position:relative;max-width:98vw;max-height:95vh;display:flex;align-items:center;justify-content:center;}
    #lightbox img.lb-img{display:block;max-width:98vw;max-height:95vh;object-fit:contain;border-radius:.5rem;background:#fff;box-shadow:0 4px 20px rgba(0,0,0,.6);}
    #lightbox button.lb-close{position:absolute;top:-.5rem;right:-.5rem;background:rgba(0,0,0,.6);color:#fff;border:0;border-radius:9999px;width:40px;height:40px;cursor:pointer;font-size:20px;line-height:40px;text-align:center;}

  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>專案日誌管理主控台</h1>
      <button onclick="runDiagnostics()">執行連線診斷</button>
      <span class="muted">（測試 JSONP 與圖片代理）</span>
    </header>
    <p class="muted" id="version-display"></p>
    <p class="muted">用 <code>?id=</code> 分流：<code>id=0</code>＝草稿審核；其他＝依案號顯示已發布內容。</p>

    <main id="main-content">
      <div id="status-message">
        <div class="spinner"></div>
        <p style="text-align:center;">正在載入資料...</p>
      </div>
      <div id="drafts-container"></div>

      <div>
        <h3 style="margin-top:2rem;font-weight:600;">執行狀態日誌：</h3>
        <pre id="debug-log"></pre>
      </div>
    </main>
  </div>

  <script>
    /* ---------- 縮圖偵錯 ---------- */
    var DEBUG_THUMBS = true;
    function thumbLog(msg){
      if(!DEBUG_THUMBS) return;
      console.log('[THUMB]', msg);
      const el = document.getElementById('debug-log');
      if(!el) return;
      const t = new Date().toLocaleTimeString('zh-TW');
      el.textContent += `[${t}][THUMB] ${msg}\n`;
      el.scrollTop = el.scrollHeight;
    }
    function logToPage(message){
      const el = document.getElementById('debug-log');
      if(!el) return;
      const t = new Date().toLocaleTimeString('zh-TW');
      el.textContent += `[${t}] ${message}\n`;
      el.scrollTop = el.scrollHeight;
    }

    /* ---------- Drive 工具 ---------- */
    function driveFileId(u){
      if(!u) return '';
      u = String(u).trim();
      let m;
      m = u.match(/[?&](?:id|fileId)=([a-zA-Z0-9_-]+)/); if(m) return m[1];
      m = u.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);       if(m) return m[1];
      m = u.match(/\/open\?id=([a-zA-Z0-9_-]+)/);       if(m) return m[1];
      return '';
    }
    function buildPublicThumbUrls(fileId, w){
      const W = Math.max(64, w|0 || 300);
      return [
        `https://drive.google.com/thumbnail?id=${fileId}&sz=w${W}-h${W}`,
        `https://drive.usercontent.google.com/uc?id=${fileId}&export=view`,
        `https://drive.google.com/uc?export=download&id=${fileId}`,
      ];
    }

    /* ---------- 渲染：Drive 縮圖（帶候選/備援 + 點擊 Lightbox） ---------- */
    function renderSmartImg(urls) {
      const wrap = document.createElement('div');
      wrap.className = 'photo-item';
    
      const img = document.createElement('img');
      img.className = 'photo-thumb';
    
      let i = 0;
      function use(idx) {
        if (idx >= urls.length) {
          const ph = document.createElement('div');
          ph.className = 'photo-placeholder';
          ph.textContent = '無法載入縮圖（點此開啟原圖）';
          ph.style.cursor = 'pointer';
          ph.onclick = () => window.open(urls[0], '_blank', 'noopener,noreferrer');
          wrap.replaceChildren(ph);
          return;
        }
        // 防快取可加可不加
        img.src = urls[idx];
        img.dataset.full = urls[0]; // 以第一個當大圖 / 原圖
      }
    
      img.onload  = () => {
        // ✅ 點縮圖開 lightbox，並把同組 URL 帶進去（讓 ← → 可切換）
        img.onclick = () => window.__openLightbox__(img.dataset.full, urls);
      };
      img.onerror = () => { use(++i); };
    
      wrap.appendChild(img);
      use(0);
      return wrap; // ✅ 回傳 DOM 節點
    }


    /* ---------- 渲染：一般圖片（非 Drive） ---------- */
    function renderDirectImg(src){
      const wrap = document.createElement('div');
      wrap.className = 'photo-item';

      const img = document.createElement('img');
      img.className  = 'photo-thumb';
      img.src        = src + (src.includes('?') ? '&' : '?') + '_=' + Date.now();
      img.dataset.full = src;

      // 成功/失敗處理
      img.onload  = () => { thumbLog('IMG OK ' + img.src); };
      img.onerror = () => {
        const ph = document.createElement('div');
        ph.className = 'photo-placeholder';
        ph.textContent = '無法載入縮圖（點此開啟原圖）';
        ph.style.cursor = 'pointer';
        ph.onclick = () => window.open(src, '_blank', 'noopener,noreferrer');
        wrap.replaceChildren(ph);
        thumbLog('IMG ERROR ' + img.src);
      };

      // 點擊看大圖（優先 Lightbox）
      img.addEventListener('click', () => {
        if(window.__openLightbox__) window.__openLightbox__(img.dataset.full);
        else window.open(img.dataset.full, '_blank', 'noopener,noreferrer');
      });

      wrap.appendChild(img);
      return wrap;
    }

    /* ---------- JSONP ---------- */
    function loadJsonp(url, cbName){
      return new Promise((resolve, reject) => {
        const name = cbName || ('cb_' + Math.random().toString(36).slice(2));
        const s = document.createElement('script');
        s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + name;
        s.async = true;

        const t0 = Date.now();
        const timer = setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout ('+(Date.now()-t0)+'ms)')); }, 15000);

        function cleanup(){ clearTimeout(timer); s.remove(); try{ delete window[name]; }catch(_){ window[name] = undefined; } }
        window[name] = (data)=>{ cleanup(); resolve(data); };
        s.onerror = ()=>{ cleanup(); reject(new Error('JSONP load error')); };
        document.head.appendChild(s);
      });
    }

    /* ---------- UI：草稿 / 已發布 ---------- */
    function buildPhotoGrid(htmlLinksCsv){
      const container = document.createElement('div');
      container.className = 'photo-grid';

      if(!htmlLinksCsv) return container;
      String(htmlLinksCsv).split(',').forEach(link => {
        const u = (link || '').trim();
        if(!u) return;
        if(u.charAt(0) === '/'){
          const ph = document.createElement('div');
          ph.className = 'photo-placeholder';
          ph.textContent = '此為 Dropbox 路徑（非網址），僅顯示佔位';
          container.appendChild(ph);
          return;
        }
        const id = driveFileId(u);
        if(id){
          container.appendChild( renderSmartImg( buildPublicThumbUrls(id, 300) ) );
        }else{
          container.appendChild( renderDirectImg(u) );
        }
      });
      return container;
    }

function displayDrafts(drafts) {
  logToPage('displayDrafts：收到 ' + (Array.isArray(drafts) ? drafts.length : 0) + ' 筆草稿');
  const container = document.getElementById('drafts-container');
  const statusMessage = document.getElementById('status-message');
  if (statusMessage) statusMessage.style.display = 'none';
  container.innerHTML = '';

  if (!Array.isArray(drafts) || drafts.length === 0) {
    container.innerHTML = '<p style="text-align:center;">目前沒有任何可處理的日誌草稿。</p>';
    return;
  }

  drafts.forEach(log => {
    const card = document.createElement('div');
    card.className = 'card';
    card.id = 'log-' + log.LogID;

    const timestamp = log.Timestamp ? new Date(log.Timestamp).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' }) : '';

    // 上半部文字
    const head = document.createElement('div');
    head.innerHTML =
      '<h3>' + (log.Title || '無標題') + '</h3>' +
      '<small>案場: ' + (log.ProjectName || '未知') + '｜回報人: ' + (log.UserName || '未知') + (timestamp ? '｜' + timestamp : '') + '</small>' +
      '<hr>' +
      '<p style="white-space:pre-wrap;">' + (log.Content || '無內容') + '</p>';
    card.appendChild(head);

    // ✅ 照片牆：用 DOM 建一個容器，把每張圖 append 進來
    if (log.PhotoLinks) {
      const links = String(log.PhotoLinks).split(',').map(s => s.trim()).filter(Boolean);
      if (links.length) {
        const grid = document.createElement('div');
        grid.className = 'photo-grid';

        links.forEach(trimmed => {
          if (trimmed.charAt(0) === '/') {
            const ph = document.createElement('div');
            ph.className = 'photo-placeholder';
            ph.textContent = '此為 Dropbox 路徑（非網址），僅顯示佔位';
            grid.appendChild(ph);
            return;
          }

          const id = driveFileId(trimmed);
          if (id) {
            const urls = buildPublicThumbUrls(id, 1200); // 給大一點尺寸
            grid.appendChild(renderSmartImg(urls));      // ✅ 直接 append DOM
          } else {
            // 非 Drive 的（Dropbox/raw/外站），用原本的轉換
            const embed = toEmbeddableImageUrl(trimmed);
            if (embed) {
              const a = document.createElement('a');
              a.href = trimmed; a.target = '_blank'; a.rel = 'noopener noreferrer';

              const img = document.createElement('img');
              img.className = 'photo-thumb';
              img.src = embed;
              img.onload = () => thumbOk(img, embed);
              img.onerror = () => thumbError(img, trimmed, embed);
              // 也可開 lightbox：img.onclick = () => window.__openLightbox__(trimmed, [trimmed]);

              a.appendChild(img);
              grid.appendChild(a);
            } else {
              const a = document.createElement('a');
              a.href = trimmed; a.target = '_blank'; a.rel = 'noopener noreferrer';
              a.textContent = '🔗 照片';
              grid.appendChild(a);
            }
          }
        });

        card.appendChild(grid);
      }
    }

    // 底部按鈕
    const actions = document.createElement('div');
    actions.style.textAlign = 'right';
    actions.style.marginTop = '1rem';
    actions.innerHTML = '<button id="btn-' + log.LogID + '" onclick="handlePublish(\'' + log.LogID + '\')">審核與發布</button>';
    card.appendChild(actions);

    container.appendChild(card);
  });
}


function displayPublished(logs) {
  logToPage('displayPublished：收到 ' + (Array.isArray(logs) ? logs.length : 0) + ' 筆公開資料');
  const container = document.getElementById('drafts-container');
  const status = document.getElementById('status-message');
  if (status) status.style.display = 'none';
  container.innerHTML = '';

  if (!Array.isArray(logs) || logs.length === 0) {
    container.innerHTML = '<p style="text-align:center;">目前尚無已發布內容。</p>';
    return;
  }

  logs.forEach(log => {
    const card = document.createElement('div');
    card.className = 'card';

    const ts = log.Timestamp ? new Date(log.Timestamp).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' }) : '';
    const head = document.createElement('div');
    head.innerHTML =
      '<h3>' + (log.Title || '無標題') + '</h3>' +
      '<small>案場：' + (log.ProjectName || '未填') + (ts ? '｜' + ts : '') + '</small>' +
      '<hr>' +
      '<p style="white-space:pre-wrap;">' + (log.Content || '') + '</p>';
    card.appendChild(head);

    if (log.PhotoLinks) {
      const links = String(log.PhotoLinks).split(',').map(s => s.trim()).filter(Boolean);
      if (links.length) {
        const grid = document.createElement('div');
        grid.className = 'photo-grid';

        links.forEach(trimmed => {
          if (trimmed.charAt(0) === '/') {
            const ph = document.createElement('div');
            ph.className = 'photo-placeholder';
            ph.textContent = '此為 Dropbox 路徑（非網址），僅顯示佔位';
            grid.appendChild(ph);
            return;
          }

          const id = driveFileId(trimmed);
          if (id) {
            const urls = buildPublicThumbUrls(id, 1200);
            grid.appendChild(renderSmartImg(urls));
          } else {
            const embed = toEmbeddableImageUrl(trimmed);
            if (embed) {
              const a = document.createElement('a');
              a.href = trimmed; a.target = '_blank'; a.rel = 'noopener noreferrer';
              const img = document.createElement('img');
              img.className = 'photo-thumb';
              img.src = embed;
              img.onload = () => thumbOk(img, embed);
              img.onerror = () => thumbError(img, trimmed, embed);
              a.appendChild(img);
              grid.appendChild(a);
            } else {
              const a = document.createElement('a');
              a.href = trimmed; a.target = '_blank'; a.rel = 'noopener noreferrer';
              a.textContent = '🔗 照片';
              grid.appendChild(a);
            }
          }
        });

        card.appendChild(grid);
      }
    }

    container.appendChild(card);
  });
}


    /* ---------- 發布 ---------- */
    function handlePublish(logId) {
      const button = document.getElementById('btn-' + logId);
      if (button) { button.disabled = true; button.textContent = '發布中...'; }
    
      const postUrl = `${API_BASE_URL}?page=publish`;
    
      fetch(postUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json;charset=utf-8' },
        body: JSON.stringify({ logId, newStatus: '已發布' })
      })
      .then(r => r.json())
      .then(data => {
        if (data && data.success) {
          const card = document.getElementById('log-' + logId);
          if (card) {
            card.style.transition = 'opacity .5s ease';
            card.style.opacity = '0';
            setTimeout(() => card.parentNode && card.parentNode.removeChild(card), 500);
          }
          alert(`日誌 ${logId} 已成功發布！`);
        } else {
          throw new Error(data && data.message ? data.message : '未知原因');
        }
      })
      .catch(err => {
        alert('發布失敗：' + err.message);
      })
      .finally(() => {
        if (button) { button.disabled = false; button.textContent = '審核與發布'; }
      });
    }

    /* ---------- 入口 ---------- */
    window.addEventListener('load', function(){
      document.getElementById('version-display').textContent = '版本: ' + (typeof FRONTEND_VERSION !== 'undefined' ? FRONTEND_VERSION : '未知');

      logToPage('頁面載入完成，開始讀取 URL 參數');
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get('id') || '';
      logToPage('URL id=' + (id || '(未帶入)'));

      const status = document.getElementById('status-message');
      if(status) status.style.display = 'block';

      const fetchUrl = `${API_BASE_URL}?page=project&id=${id}`;
      if(id === '0' || id){
        logToPage('準備呼叫 API(JSONP): ' + fetchUrl);
        loadJsonp(fetchUrl)
          .then(data => { if(id === '0') displayDrafts(data); else displayPublished(data); })
          .catch(err => displayError(err));
      }else{
        displayError({ message:'未指定 id。請在網址加上 ?id=0（草稿）或 ?id=案號。' });
      }
    });

    function displayError(error){
      const msg = (error && error.message) ? error.message : '發生未知錯誤。';
      logToPage('PAGE ERROR: ' + msg);
      const status = document.getElementById('status-message');
      if(status){
        status.innerHTML =
          '<div style="border:1px solid red;background:#ffebee;color:#c62828;padding:1rem;white-space:pre-wrap;">' +
          '<strong>載入失敗！</strong>\n\n' +
          '<strong>錯誤訊息：</strong>\n' + msg + '\n\n' +
          '<strong>可能原因與建議：</strong>\n請檢查 Apps Script 後端日誌是否有錯誤紀錄。\n' +
          '</div>';
      }
    }

    /* ---------- 診斷 ---------- */
    function runDiagnostics(){
      const base = API_BASE_URL;
      logToPage('=== 開始診斷 ===');
      logToPage('API_BASE_URL = ' + base);

      const url = base + '?page=project&id=0';
      logToPage('[JSONP] 測試 URL: ' + url);
      const t0 = Date.now();
      loadJsonp(url).then(d => {
        logToPage('[JSONP] OK，用時 ' + (Date.now()-t0) + 'ms，回傳筆數=' + (Array.isArray(d)?d.length:0));
      }).catch(err => {
        logToPage('[JSONP] 失敗：' + err.message);
      }).finally(() => {
        const testId = '1kl1GWuBEE-AKS4e4tdHGz8_90Au04vua';
        const imgUrl = base + '?img=' + encodeURIComponent(testId) + '&w=300';
        logToPage('[IMG] 測試代理：' + imgUrl);
        const img = new Image();
        const t1 = Date.now();
        img.onload  = ()=> logToPage('[IMG] OK，用時 ' + (Date.now()-t1) + 'ms，尺寸=' + img.naturalWidth + 'x' + img.naturalHeight);
        img.onerror = ()=> logToPage('[IMG] 失敗（可能是權限或非圖片格式）');
        img.src = imgUrl + '&_=' + Date.now();
      });
    }
  </script>

  <!-- Lightbox -->
  <div id="lightbox" aria-hidden="true">
    <div class="lb-wrap">
      <img class="lb-img" alt="preview">
      <button class="lb-close" aria-label="關閉">✕</button>
    </div>
  </div>
<script>
(function(){
  const lb = document.getElementById('lightbox');
  if(!lb){ console.warn('[Lightbox] #lightbox not found'); return; }
  const img = lb.querySelector('.lb-img');
  const btn = lb.querySelector('.lb-close');

  let gallery = [];   // 目前相簿的大圖 URL 清單
  let current = -1;   // 目前索引

  function openFromThumb(thumbEl){
    // 在同一張卡片（.photo-grid）內收集所有縮圖的大圖連結
    const grid = thumbEl.closest('.photo-grid');
    gallery = Array.from(grid.querySelectorAll('img.photo-thumb'))
                   .map(el => el.dataset.full || el.src)
                   .filter(Boolean);
    current = Math.max(0, gallery.indexOf(thumbEl.dataset.full || thumbEl.src));
    show(current);
    lb.classList.add('open'); lb.setAttribute('aria-hidden','false');
  }

  function show(idx){
    if(!gallery.length) return;
    if(idx < 0) idx = gallery.length - 1;
    if(idx >= gallery.length) idx = 0;
    current = idx;
    img.src = '';              // 先清掉避免殘影
    img.src = gallery[current];
  }

  function close(){
    lb.classList.remove('open');
    lb.setAttribute('aria-hidden','true');
    img.src = '';
    gallery = []; current = -1;
  }

  // 事件委派：點任何縮圖開啟 Lightbox
  window.addEventListener('click', (e)=>{
    const t = e.target;
    if(t && t.matches('img.photo-thumb')){
      e.preventDefault();
      openFromThumb(t);
    }
  });

  // 背景點擊 / 關閉鈕 / 鍵盤操作
  lb.addEventListener('click', (e)=>{ if(e.target === lb) close(); });
  btn.addEventListener('click', close);
  window.addEventListener('keydown', (e)=>{
    if(!lb.classList.contains('open')) return;
    if(e.key === 'Escape') close();
    if(e.key === 'ArrowLeft') show(current - 1);
    if(e.key === 'ArrowRight') show(current + 1);
  });

  // 若你其他地方需要手動開啟，也可呼叫這個：
  window.__openLightbox__ = function(srcListOrSingle){
    gallery = Array.isArray(srcListOrSingle) ? srcListOrSingle : [String(srcListOrSingle)];
    current = 0; show(0);
    lb.classList.add('open'); lb.setAttribute('aria-hidden','false');
  };
})();
</script>

</body>
</html>
