<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>專案日誌管理主控台</title>

  <script>
    // 【全域設定】請確認此網址為您最新部署的 Apps Script 網址
    const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwbEVAfoO9eRzcUSfESIwih1Poub657h_9jz5UcqTXbxsDQOZ3mjLm1nHZfn_WM2K8/exec';
    const FRONTEND_VERSION = 'v7.27'; // 前端版本號
  </script>

  <style>
    /* ========== 樣式 (無變更) ========== */
    :root{
      --bg:#f3f4f6; --fg:#1f2937; --muted:#6b7280; --muted-2:#9ca3af;
      --card:#ffffff; --primary:#3b82f6; --shadow:0 1px 2px rgba(0,0,0,.06);
      --radius:.5rem;
    }
    *{ box-sizing: border-box; }
    body{ font-family: Arial, sans-serif; background:var(--bg); color:var(--fg); margin:0; padding:2rem; }
    .container{ max-width:900px; margin:0 auto; }
    header{ margin-bottom:2rem; display:flex; align-items:center; gap:.75rem; flex-wrap:wrap; }
    h1{ font-size:1.875rem; font-weight:bold; margin:0; }
    .muted{ color:var(--muted); font-size:.9rem; }
    .spinner{ margin:2rem auto; width:3rem; height:3rem; border-radius:50%; border:4px solid #e5e7eb; border-top-color:var(--primary); animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    #debug-log{ background:#111827; color:#e5e7eb; font-family:monospace; font-size:.75rem; padding:1rem; border-radius:var(--radius); margin-top:1rem; height:16rem; overflow-y:auto; white-space:pre-wrap; }
    .card{ background:var(--card); border-radius:var(--radius); padding:1.5rem; margin-bottom:1rem; box-shadow:var(--shadow); }
    .photo-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:.75rem; margin-top: 1rem; }
    .photo-item{ display:flex; flex-direction:column; gap:.25rem; }
    .photo-thumb{ width:100%; aspect-ratio:4/3; object-fit:cover; background:#e5e7eb; border-radius:var(--radius); display:block; cursor:zoom-in; }
    .photo-placeholder{ width:100%; aspect-ratio:4/3; border-radius:var(--radius); background:#f3f4f6; display:flex; align-items:center; justify-content:center; color:var(--muted-2); font-size:.9rem; text-align:center; padding:0 .5rem; }
    button{ background:var(--primary); color:#fff; border:0; padding:.5rem .75rem; border-radius:.375rem; cursor:pointer; font-weight: 600; transition: opacity .2s; }
    button:hover { opacity: 0.85; }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    .button-group { display:flex; gap:0.5rem; justify-content:flex-end; flex-wrap:wrap; }
    @media (max-width:640px){ body{ padding:1rem } .photo-grid{ gap:.5rem } }
    
/* Lightbox (您原有的樣式) */
#lightbox{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:9999;padding:1rem;}
#lightbox.open{display:flex}
    #lightbox .lb-wrap{position:relative;max-width:98vw;max-height:95vh;display:flex;align-items:center;justify-content:center;}
    #lightbox img.lb-img{display:block;max-width:98vw;max-height:95vh;object-fit:contain;border-radius:.5rem;background:#fff;box-shadow:0 4px 20px rgba(0,0,0,.6);}
    #lightbox button.lb-close{position:absolute;top:-.5rem;right:-.5rem;background:rgba(0,0,0,.6);color:#fff;border:0;border-radius:9999px;width:40px;height:40px;cursor:pointer;font-size:20px;line-height:40px;text-align:center;}

    /* ========== 【⭐️ 新增功能所需的樣式 ⭐️】 ========== */
    /* 照片管理 Modal */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
    .modal-content { background-color: #fefefe; padding: 20px; border-radius: 0.5rem; width: 90%; max-width: 800px; box-shadow: 0 4px 20px rgba(0,0,0,.4); }
    .modal-photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; max-height: 60vh; overflow-y: auto; padding: 1rem; background: #f3f4f6; border-radius: var(--radius); }
    .modal-photo-item { position: relative; }
    .modal-photo-item img { width: 100%; aspect-ratio: 4/3; object-fit: cover; border-radius: 0.25rem; }
    .delete-photo-btn { position: absolute; top: 5px; right: 5px; background: rgba(239, 68, 68, 0.8); color: white; border: 2px solid white; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-weight: bold; font-size: 16px; display: flex; align-items: center; justify-content: center; line-height: 1; transition: transform .2s; }
    .delete-photo-btn:hover { transform: scale(1.1); }
  </style>
</head>

<body>
      <header>
        <h1>專案日誌管理主控台</h1>
        <div>
            <p id="version-display" class="muted"></p>
        </div>
    </header>

  <div class="container">
    <main id="main-content">
      <div id="status-message">
        <div class="spinner"></div>
        <p style="text-align:center;">正在載入資料...</p>
      </div>
      <div id="logs-container"></div> <div>
        <h3 style="margin-top:2rem;font-weight:600;">執行狀態日誌：</h3>
        <pre id="debug-log"></pre>
      </div>
    </main>
  </div>

  <div id="photo-modal" class="modal">
    <div class="modal-content">
      <h2 class="text-xl font-semibold mb-4">管理照片</h2>
      <div id="modal-photo-grid-container" class="modal-photo-grid mb-4"></div>
      <div class="text-right space-x-2 mt-4">
        <button onclick="closePhotoModal()" class="bg-gray-500 hover:bg-gray-600">取消</button>
        <button id="save-photos-button" class="bg-blue-600 hover:bg-blue-700">儲存變更</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- 縮圖偵錯 ---------- */
    var DEBUG_THUMBS = true;
    let currentEditingLogId = null; // ✅ 請加上這一行
    function thumbLog(msg){
      if(!DEBUG_THUMBS) return;
      console.log('[THUMB]', msg);
      const el = document.getElementById('debug-log');
      if(!el) return;
      const t = new Date().toLocaleTimeString('zh-TW');
      el.textContent += `[${t}][THUMB] ${msg}\n`;
      el.scrollTop = el.scrollHeight;
    }
    function logToPage(message){
      const el = document.getElementById('debug-log');
      if(!el) return;
      const t = new Date().toLocaleTimeString('zh-TW');
      el.textContent += `[${t}] ${message}\n`;
      el.scrollTop = el.scrollHeight;
    }

    /* ---------- Drive 工具 ---------- */
    function driveFileId(u){
      if(!u) return '';
      u = String(u).trim();
      let m;
      m = u.match(/[?&](?:id|fileId)=([a-zA-Z0-9_-]+)/); if(m) return m[1];
      m = u.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);       if(m) return m[1];
      m = u.match(/\/open\?id=([a-zA-Z0-9_-]+)/);       if(m) return m[1];
      return '';
    }
    function buildPublicThumbUrls(fileId, w){
      const W = Math.max(64, w|0 || 300);
      return [
        `https://drive.google.com/thumbnail?id=${fileId}&sz=w${W}-h${W}`,
        `https://drive.usercontent.google.com/uc?id=${fileId}&export=view`,
        `https://drive.google.com/uc?export=download&id=${fileId}`,
      ];
    }

// 版本號：v3.0
    // 修改時間：2025-09-10 11:15 (Asia/Taipei)
    function renderSmartImg(fileId) {
      const wrap = document.createElement('div');
      wrap.className = 'photo-item';
    
      const img = document.createElement('img');
      img.className = 'photo-thumb';

      // 【⭐️ 核心修改 ⭐️】
      // 直接使用測試成功的「方案三」來組合圖片網址
      const thumbnailUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w300`;
      const largeImageUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w1200`;

      // 將大圖網址存入 data-full 屬性，供燈箱使用
      img.dataset.full = largeImageUrl;
      
      // 縮圖直接使用 thumbnail 連結
      img.src = thumbnailUrl;
      
      img.onerror = () => {
        const ph = document.createElement('div');
        ph.className = 'photo-placeholder';
        ph.textContent = '縮圖載入失敗';
        wrap.replaceChildren(ph);
      };
    
      wrap.appendChild(img);
      return wrap;
    }

    /* ---------- 渲染：一般圖片（非 Drive） ---------- */
    function renderDirectImg(src){
      const wrap = document.createElement('div');
      wrap.className = 'photo-item';

      const img = document.createElement('img');
      img.className  = 'photo-thumb';
      img.src        = src + (src.includes('?') ? '&' : '?') + '_=' + Date.now();
      img.dataset.full = src;

      // 成功/失敗處理
      img.onload  = () => { thumbLog('IMG OK ' + img.src); };
      img.onerror = () => {
        const ph = document.createElement('div');
        ph.className = 'photo-placeholder';
        ph.textContent = '無法載入縮圖（點此開啟原圖）';
        ph.style.cursor = 'pointer';
        ph.onclick = () => window.open(src, '_blank', 'noopener,noreferrer');
        wrap.replaceChildren(ph);
        thumbLog('IMG ERROR ' + img.src);
      };

      // 點擊看大圖（優先 Lightbox）
      img.addEventListener('click', () => {
        if(window.__openLightbox__) window.__openLightbox__(img.dataset.full);
        else window.open(img.dataset.full, '_blank', 'noopener,noreferrer');
      });

      wrap.appendChild(img);
      return wrap;
    }

    /* ---------- JSONP ---------- */
    function loadJsonp(url, cbName){
      return new Promise((resolve, reject) => {
        const name = cbName || ('cb_' + Math.random().toString(36).slice(2));
        const s = document.createElement('script');
        s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + name;
        s.async = true;

        const t0 = Date.now();
        const timer = setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout ('+(Date.now()-t0)+'ms)')); }, 15000);

        function cleanup(){ clearTimeout(timer); s.remove(); try{ delete window[name]; }catch(_){ window[name] = undefined; } }
        window[name] = (data)=>{ cleanup(); resolve(data); };
        s.onerror = ()=>{ cleanup(); reject(new Error('JSONP load error')); };
        document.head.appendChild(s);
      });
    }

    /* ---------- UI：草稿 / 已發布 ---------- */
    function buildPhotoGrid(htmlLinksCsv){
      const container = document.createElement('div');
      container.className = 'photo-grid';

      if(!htmlLinksCsv) return container;
      String(htmlLinksCsv).split(',').forEach(link => {
        const u = (link || '').trim();
        if(!u) return;
        if(u.charAt(0) === '/'){
          const ph = document.createElement('div');
          ph.className = 'photo-placeholder';
          ph.textContent = '此為 Dropbox 路徑（非網址），僅顯示佔位';
          container.appendChild(ph);
          return;
        }
        const id = driveFileId(u);
        if(id){
          // 版本號：v2.0
          // 修改時間：2025-09-10 11:15 (Asia/Taipei)
          container.appendChild( renderSmartImg(id) );
        }else{
          container.appendChild( renderDirectImg(u) );
        }
      });
      return container;
    }

    /* ====================== 【⭐️ 核心修改：渲染與編輯邏輯 ⭐️】 ====================== */

    // --- 渲染主函式 (偵錯強化版) ---
    function displayLogs(logs, isDraftMode) {
      logToPage('➡️ displayLogs: 開始渲染畫面...');

      const container = document.getElementById('logs-container');
      const statusMessage = document.getElementById('status-message');
      
      if (statusMessage) {
        statusMessage.style.display = 'none';
        logToPage('...已隱藏「載入中」訊息');
      }
      
      container.innerHTML = '';
      logToPage('...已清空舊內容');

      if (!Array.isArray(logs) || logs.length === 0) {
        logToPage('⚠️ 偵測到沒有日誌資料，已停止渲染。');
        container.innerHTML = '<div class="card"><p class="muted" style="text-align:center;">沒有可顯示的日誌。</p></div>';
        return; 
      }
      
      logToPage(`...偵測到 ${logs.length} 筆日誌，開始遍歷處理...`);

      logs.forEach(function(log, index) {
        logToPage(`[${index + 1}/${logs.length}] 正在處理 LogID: ${log.LogID}`);

        const card = document.createElement('div');
        card.className = 'card';
        card.id = 'log-' + log.LogID;
        
        const timestamp = log.Timestamp ? new Date(log.Timestamp).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' }) : '未知';
        const lastModified = log.LastModified ? new Date(log.LastModified).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' }) : '無';

        const head = document.createElement('div');
        head.innerHTML =
          `<h3>${log.Title || '無標題'}</h3>
           <small class="muted">案場: ${log.ProjectName || '未知'}｜回報人: ${log.UserName || '未知'}</small>
           <small class="muted block text-xs mt-1">建立: ${timestamp}｜最後更新: ${lastModified}</small>
           <hr class="my-3">
           <div id="content-${log.LogID}" style="white-space:pre-wrap;">${log.Content || '無內容'}</div>`;
        card.appendChild(head);
        logToPage(`...[${log.LogID}] 已建立文字內容`);

        if (log.PhotoLinks) {
          card.appendChild(buildPhotoGrid(log.PhotoLinks));
          logToPage(`...[${log.LogID}] 已建立照片牆`);
        }

        const actions = document.createElement('div');
        actions.className = 'button-group';
        actions.style.marginTop = '1rem';
        
        const btnEditText = document.createElement('button');
        btnEditText.textContent = '編輯文字';
        btnEditText.onclick = () => handleEditText(log.LogID);
        actions.appendChild(btnEditText);

        const btnManagePhotos = document.createElement('button');
        btnManagePhotos.textContent = '管理照片';
        btnManagePhotos.onclick = () => openPhotoModal(log.LogID, log.PhotoLinks || '');
        actions.appendChild(btnManagePhotos);

        if (isDraftMode) {
          const btnPublish = document.createElement('button');
          btnPublish.id = 'btn-' + log.LogID;
          btnPublish.textContent = '審核與發布';
          btnPublish.style.backgroundColor = '#16a34a';
          btnPublish.onclick = () => handlePublish(log.LogID);
          actions.appendChild(btnPublish);
        }
        
        card.appendChild(actions);
        logToPage(`...[${log.LogID}] 已建立操作按鈕`);

        container.appendChild(card);
        logToPage(`...✅ 已將 ${log.LogID} 的卡片插入頁面`);
      });
      
      logToPage('✅ displayLogs: 所有項目渲染完畢。');
    }
    // --- [新增] 原地編輯文字 ---
    function handleEditText(logId) {
      const contentDiv = document.getElementById(`content-${logId}`);
      const buttonContainer = contentDiv.parentElement.parentElement.querySelector('.button-group');
      const originalContent = contentDiv.innerText;
      const originalButtons = buttonContainer.innerHTML;

      contentDiv.contentEditable = true;
      contentDiv.focus();
      contentDiv.style.cssText += 'border: 1px solid #3b82f6; padding: 0.5rem; border-radius: 0.25rem;';

      buttonContainer.innerHTML = `
          <button class="bg-gray-500">取消</button>
          <button class="bg-green-600">儲存文字</button>
      `;
      buttonContainer.querySelector('.bg-gray-500').onclick = () => handleCancelEdit(logId, originalContent, originalButtons);
      buttonContainer.querySelector('.bg-green-600').onclick = () => handleSaveText(logId, originalButtons);
    }
    
    function handleCancelEdit(logId, originalContent, originalButtons) {
      const contentDiv = document.getElementById(`content-${logId}`);
      contentDiv.contentEditable = false;
      contentDiv.style.border = 'none';
      contentDiv.style.padding = '0';
      contentDiv.innerText = originalContent;
      contentDiv.parentElement.parentElement.querySelector('.button-group').innerHTML = originalButtons;
    }

// 版本號：v1.1
// 修改時間：2025-09-09 17:50 (Asia/Taipei)
// 版本號：v2.0
// 修改時間：2025-09-10 11:45 (Asia/Taipei)
function handleSaveText(logId, originalButtons) {
  const contentDiv = document.getElementById(`content-${logId}`);
  const newContent = contentDiv.innerText;
  const buttonContainer = contentDiv.parentElement.parentElement.querySelector('.button-group');
  const saveButton = buttonContainer.querySelector('.bg-green-600');
  saveButton.textContent = '儲存中...';
  saveButton.disabled = true;

  const params = new URLSearchParams({ page: 'updateLogText', id: logId, content: newContent });

  loadJsonp(`${API_BASE_URL}?${params.toString()}`)
    .then(response => {
      if (response.success) {
        // 【⭐️ 核心修改 ⭐️】
        // 1. 不再跳出 alert
        // 2. 使用後端回傳的 response.finalContent 來更新畫面，確保內容絕對正確
        handleCancelEdit(logId, response.finalContent, originalButtons);
      } else {
        alert('儲存失敗: ' + (response.message || '未知錯誤'));
        // 失敗時，恢復按鈕狀態，但不恢復文字內容，讓使用者可以重試
        saveButton.textContent = '儲存文字';
        saveButton.disabled = false;
      }
    })
    .catch(err => {
      alert('儲存失敗: ' + err.message);
      saveButton.textContent = '儲存文字';
      saveButton.disabled = false;
    });
}

// --- [新增] 照片管理 Modal (縮圖穩定版) ---
    // 版本號：v2.0
    // 修改時間：2025-09-09 17:00 (Asia/Taipei)
    function openPhotoModal(logId, photoLinksCsv) {
      currentEditingLogId = logId; // ✅ 請確保這一行是有效的 (沒有 // 在前面)
      const modal = document.getElementById('photo-modal');
      const grid = document.getElementById('modal-photo-grid-container');
      grid.innerHTML = '';
      
      const links = photoLinksCsv ? photoLinksCsv.split(',').filter(link => link.trim()) : [];
      if (links.length > 0) {
        links.forEach(link => {
          const item = document.createElement('div');
          item.className = 'modal-photo-item';
          item.dataset.link = link;
          const img = document.createElement('img');
          
          // 【⭐️ 核心修改 ⭐️】
          // 優先從原始連結中提取 fileId，並組合出更穩定的 thumbnail 網址
          const fileId = driveFileId(link);
          if (fileId) {
            img.src = `https://drive.google.com/thumbnail?id=${fileId}&sz=w300`; // 使用 300px 寬的縮圖
          } else {
            img.src = link; // 如果不是 Drive 連結，則保留原樣
          }

          img.loading = 'lazy';
          const delBtn = document.createElement('button');
          delBtn.className = 'delete-photo-btn';
          delBtn.innerHTML = '&times;';
          delBtn.title = '標記為刪除';
          delBtn.onclick = () => {
              item.style.opacity = '0.3';
              item.classList.add('deleted');
          };
          item.appendChild(img);
          item.appendChild(delBtn);
          grid.appendChild(item);
        });
      } else {
        grid.innerHTML = '<p class="muted">目前沒有照片可供管理。</p>';
      }
      modal.style.display = 'flex';
    }
    
    function closePhotoModal() {
        document.getElementById('photo-modal').style.display = 'none';
        currentEditingLogId = null;
    }

    // 版本號：v1.1
    // 修改時間：2025-09-09 17:50 (Asia/Taipei)
    // 版本號：v2.0
    // 修改時間：2025-09-10 11:30 (Asia/Taipei)
    document.getElementById('save-photos-button').onclick = function() {
        const saveButton = this;
        saveButton.textContent = '儲存中...';
        saveButton.disabled = true;
    
        const grid = document.getElementById('modal-photo-grid-container');
        const items = grid.querySelectorAll('.modal-photo-item');
        const remainingLinks = [];
        items.forEach(item => {
            if (!item.classList.contains('deleted')) {
                remainingLinks.push(item.dataset.link);
            }
        });
        const updatedPhotoLinksCsv = remainingLinks.join(',');
        
        const params = new URLSearchParams({ page: 'updateLogPhotos', id: currentEditingLogId, links: updatedPhotoLinksCsv });
    
        loadJsonp(`${API_BASE_URL}?${params.toString()}`)
            .then(response => {
                if (response.success) {
                    // 【⭐️ 核心修改 ⭐️】
                    // 1. 成功後不再跳出 alert
                    // 2. 關閉彈出視窗
                    closePhotoModal();
                    
                    // 3. 即時更新主頁面上的照片牆
                    const card = document.getElementById('log-' + currentEditingLogId);
                    if (card) {
                        // 先移除舊的照片牆
                        const oldGrid = card.querySelector('.photo-grid');
                        if (oldGrid) oldGrid.remove();
                        
                        // 如果還有照片，就建立並插入新的照片牆
                        if (updatedPhotoLinksCsv) {
                            const newGrid = buildPhotoGrid(updatedPhotoLinksCsv);
                            const actionsDiv = card.querySelector('.button-group');
                            // 將新照片牆插入到按鈕區塊的前面
                            if (actionsDiv) {
                                actionsDiv.parentNode.insertBefore(newGrid, actionsDiv);
                            }
                        }
                    }
                } else {
                    // 只在失敗時才跳出提示
                    alert('儲存失敗: ' + (response.message || '未知錯誤'));
                }
            })
            .catch(err => alert('儲存照片變更失敗: ' + err.message))
            .finally(() => {
                // 無論成功或失敗，最後都恢復按鈕狀態
                saveButton.textContent = '儲存變更';
                saveButton.disabled = false;
            });
    };

    function editPhotosCallback(response) {
        alert(response.message);
        if (response.success) window.location.reload();
    }
    // --- 發布日誌 (已升級為使用 loadJsonp) ---
    function handlePublish(logId) {
      const button = document.getElementById('btn-' + logId);
      if (button) { button.disabled = true; button.textContent = '發布中...'; }
      const params = new URLSearchParams({ page: 'publish', logId: logId, newStatus: '已發布' });
      const requestUrl = `${API_BASE_URL}?${params.toString()}`;
      logToPage(`發起發布請求: ${requestUrl}`);
      
      loadJsonp(requestUrl)
      .then(publishCallback)
      .catch(err => {
        alert('發布請求失敗！請檢查網路連線或後端日誌。');
        if (button) { button.disabled = false; button.textContent = '審核與發布'; }
      });
    }

/**
 * [新增] 發布動作的回呼函式 (類似 checkin.html 中的 handleGasResponse)
 * 當後端 doGet 執行完畢後，會回傳並執行這個函式
 */
function publishCallback(response) {
  logToPage('收到發布回覆: ' + JSON.stringify(response));
  const logId = response.logId;
  var button = document.getElementById('btn-' + logId);

  if (response && response.success) {
    var card = document.getElementById('log-' + logId);
    if (card) {
      card.style.transition = 'opacity .5s ease';
      card.style.opacity = '0';
      setTimeout(function(){ card.parentNode && card.parentNode.removeChild(card); }, 500);
    }
  } else {
    alert('發布失敗：\n' + (response && response.message ? response.message : '未知原因'));
    if (button) { button.disabled = false; button.textContent = '審核與發布'; }
  }
}

    /* ====================== 【⭐️ 核心修改：入口函式 ⭐️】 ====================== */
    window.addEventListener('load', function(){
      document.getElementById('version-display').textContent = '版本: ' + (typeof FRONTEND_VERSION !== 'undefined' ? FRONTEND_VERSION : '未知');
      logToPage('頁面載入完成，開始讀取 URL 參數');
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get('id');
      logToPage('URL id=' + (id || '(未帶入)'));
      
      if (!id) {
        displayError({ message:'未指定 id。請在網址加上 ?id=0（草稿）或 ?id=案號。' });
        return;
      }

      const fetchUrl = `${API_BASE_URL}?page=project&id=${id}`;
      logToPage('準備呼叫 API(JSONP): ' + fetchUrl);
      
      // 統一呼叫新的 loadJsonp 工具
      loadJsonp(fetchUrl)
        .then(loadDataCallback)
        .catch(displayError);
    });

// 版本號：v2.0
// 修改時間：2025-09-09 16:30 (Asia/Taipei)

    // 唯一的資料載入回呼函式 (偵錯強化版)
    function loadDataCallback(data) {
        // 將執行訊息顯示在頁面上
        logToPage('✅ 收到後端資料，準備呼叫 displayLogs 函式...');
        logToPage('收到的原始資料: ' + JSON.stringify(data, null, 2));

        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        if (data && data.success === false) { 
            logToPage('❌ 後端回報業務邏輯錯誤: ' + data.message);
            displayError({ message: '後端 API 回報錯誤: ' + data.message });
        } else {
            displayLogs(data, id === '0'); 
        }
    }
    function displayError(error){
      const msg = (error && error.message) ? error.message : '發生未知錯誤。';
      logToPage('PAGE ERROR: ' + msg);
      const status = document.getElementById('status-message');
      if(status){
        status.innerHTML =
          '<div style="border:1px solid red;background:#ffebee;color:#c62828;padding:1rem;white-space:pre-wrap;">' +
          '<strong>載入失敗！</strong>\n\n' +
          '<strong>錯誤訊息：</strong>\n' + msg + '\n\n' +
          '<strong>可能原因與建議：</strong>\n請檢查 Apps Script 後端日誌是否有錯誤紀錄。\n' +
          '</div>';
      }
    }

  </script>

  <div id="lightbox" aria-hidden="true">
    <div class="lb-wrap">
      <img class="lb-img" alt="preview">
      <button class="lb-close" aria-label="關閉">✕</button>
    </div>
  </div>
// 版本號：v2.0 (支援手機滑動)
// 修改時間：2025-09-10 11:31 (Asia/Taipei)
<script>
(function(){
  const lb = document.getElementById('lightbox');
  if(!lb){ console.warn('[Lightbox] #lightbox not found'); return; }
  const img = lb.querySelector('.lb-img');
  const btn = lb.querySelector('.lb-close');

  let gallery = [];
  let current = -1;
  
  // 【⭐️ 新增：滑動偵測所需變數 ⭐️】
  let touchstartX = 0;
  let touchendX = 0;

  function openFromThumb(thumbEl){
    const grid = thumbEl.closest('.photo-grid');
    gallery = Array.from(grid.querySelectorAll('img.photo-thumb'))
                   .map(el => el.dataset.full || el.src)
                   .filter(Boolean);
    current = Math.max(0, gallery.indexOf(thumbEl.dataset.full || thumbEl.src));
    show(current);
    lb.classList.add('open'); lb.setAttribute('aria-hidden','false');
  }

  function show(idx){
    if(!gallery.length) return;
    if(idx < 0) idx = gallery.length - 1;
    if(idx >= gallery.length) idx = 0;
    current = idx;
    img.src = '';
    img.src = gallery[current];
  }

  function close(){
    lb.classList.remove('open');
    lb.setAttribute('aria-hidden','true');
    img.src = '';
    gallery = []; current = -1;
  }
  
  // 【⭐️ 新增：處理滑動手勢的函式 ⭐️】
  function handleGesture() {
    const threshold = 50; // 滑動超過 50px 才觸發
    if (touchendX < touchstartX - threshold) {
      show(current + 1); // 向左滑，看下一張
    }
    if (touchendX > touchstartX + threshold) {
      show(current - 1); // 向右滑，看上一張
    }
  }

  // --- 事件監聽區 ---
  window.addEventListener('click', (e)=>{
    const t = e.target;
    if(t && t.matches('img.photo-thumb')){
      e.preventDefault();
      openFromThumb(t);
    }
  });

  lb.addEventListener('click', (e)=>{ if(e.target === lb) close(); });
  if (btn) {
      btn.addEventListener('click', close);
  }
  
  // 鍵盤左右鍵 (維持不變)
  window.addEventListener('keydown', (e)=>{
    if(!lb.classList.contains('open')) return;
    if(e.key === 'Escape') close();
    if(e.key === 'ArrowLeft') show(current - 1);
    if(e.key === 'ArrowRight') show(current + 1);
  });
  
  // 【⭐️ 新增：觸控事件監聽 ⭐️】
  lb.addEventListener('touchstart', e => {
    touchstartX = e.changedTouches[0].screenX;
  }, { passive: true });

  lb.addEventListener('touchend', e => {
    touchendX = e.changedTouches[0].screenX;
    handleGesture();
  });

  window.__openLightbox__ = function(srcListOrSingle){
    gallery = Array.isArray(srcListOrSingle) ? srcListOrSingle : [String(srcListOrSingle)];
    current = 0; show(0);
    lb.classList.add('open'); lb.setAttribute('aria-hidden','false');
  };
})();
</script>

</body>
</html>
