/*
 * 版本號: v1.1
 * 修改時間: 2025-09-26 20:00 (Asia/Taipei)
 * 說明:
 * - [修復] 移除此檔案中的 <script> 標籤與 HTML 註解，使其成為純粹的 JavaScript 檔案，
 * 以解決 'Unexpected token <' 的語法錯誤。
*/

/* ===== 工具：除錯輸出 ===== */
function logToPage(message){
  console.log(message);
}

/* ===== 工具：JSONP API 呼叫器 ===== */
function loadJsonp(url){
  return new Promise((resolve, reject) => {
    const cb = 'jsonp_' + Math.random().toString(36).slice(2);
    const timer = setTimeout(() => {
      cleanup();
      reject(new Error('請求後端資料超時 (15秒)。'));
    }, 15000);

    function cleanup(){
      clearTimeout(timer);
      delete window[cb];
      if(script.parentNode) script.parentNode.removeChild(script);
    }

    window[cb] = (data) => {
      cleanup();
      resolve(data);
    };

    const script = document.createElement('script');
    script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
    script.onerror = () => {
      cleanup();
      reject(new Error('載入後端資料失敗。可能是網路問題或後端指令碼錯誤。'));
    };
    document.body.appendChild(script);
  });
}

/* ===== 工具：錯誤顯示 ===== */
function displayError(err){
  const msg = (err && err.message) ? err.message : '發生未知錯誤。';
  logToPage('PAGE ERROR: ' + msg);
  const container = document.getElementById('main-content');
  container.innerHTML = `<div class="card" style="background-color:#fff1f2; color:#be123c;"><strong>載入失敗！</strong><br>${msg}</div>`;
}

/* ===== 工具：Drive 影像處理 ===== */
function driveFileId(u){
  if(!u) return '';
  u = String(u).trim();
  let m;
  m = u.match(/[?&](?:id|fileId)=([a-zA-Z0-9_-]+)/); if(m) return m[1];
  m = u.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);       if(m) return m[1];
  m = u.match(/\/open\?id=([a-zA-Z0-9_-]+)/);       if(m) return m[1];
  return '';
}

function renderSmartImg(fileId){
  const wrap = document.createElement('div');
  wrap.className = 'photo-item';
  const img = document.createElement('img');
  img.className = 'photo-thumb';
  const thumbnailUrl = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w300';
  const largeUrl     = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w1200';
  img.dataset.full = largeUrl;
  img.src = thumbnailUrl;
  img.onerror = () => {
    const ph = document.createElement('div');
    ph.className='photo-placeholder';
    ph.textContent='縮圖載入失敗';
    wrap.replaceChildren(ph);
  };
  img.addEventListener('click', () => window.__openLightbox__(largeUrl));
  wrap.appendChild(img);
  return wrap;
}

/* ===== 工具：Lightbox 效果 ===== */
// 使用 IIFE (立即調用函式表達式) 來封裝，避免污染全域變數
(function(){
  const lb = document.getElementById('lightbox');
  if(!lb) return;
  const img = lb.querySelector('.lb-img');
  const closeBtn = lb.querySelector('.lb-close');

  function show(src){
    img.src = ''; // 先清空，避免看到上一張的殘影
    img.src = src;
  }

  function openFromThumb(el){
    const fullSrc = el.dataset.full || el.src;
    show(fullSrc);
    lb.classList.add('open');
  }

  function close(){
    lb.classList.remove('open');
    img.src='';
  }

  // 事件綁定
  window.addEventListener('click', (e)=>{
    if(e.target && e.target.matches('img.photo-thumb')){
      e.preventDefault();
      openFromThumb(e.target);
    }
  });
  lb.addEventListener('click', (e)=>{ if(e.target===lb) close(); });
  closeBtn?.addEventListener('click', close);
  window.addEventListener('keydown', (e)=>{
    if(lb.classList.contains('open') && e.key==='Escape') close();
  });
  
  // 建立一個全域的接口，方便其他地方呼叫
  window.__openLightbox__ = (src) => {
    show(src);
    lb.classList.add('open');
  };
})();

/* ===== 工具：檔案轉 Base64 ===== */
const toBase64 = file => new Promise((resolve, reject) => {
  const reader = new FileReader();
  reader.readAsDataURL(file);
  reader.onload = () => resolve(reader.result);
  reader.onerror = error => reject(error);
});

