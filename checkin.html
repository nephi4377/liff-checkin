<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>添心設計 | 員工打卡 (偵錯模式)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script>
        const LIFF_ID = '2007974938-jVxn6y37';
        // 【重要】請務必將此處換成您部署「JSONP版本 checkin.gs」後產生的「新」網址
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfy.../exec';
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .btn-pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .spinner { border-top-color: #3498db; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #debug-log-container {
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
            line-height: 1.6;
            max-height: 200px;
        }
        .log-success { color: #22c55e; }
        .log-error { color: #ef4444; }
        .log-info { color: #6b7280; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-md mx-auto bg-white rounded-xl shadow-lg p-8 text-center">
        
        <div class="mb-6">
            <svg class="mx-auto h-12 w-auto text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <h1 class="text-2xl font-bold text-gray-800 mt-2">添心設計</h1>
            <p class="text-gray-500">員工專用打卡系統</p>
        </div>

        <div id="status-container" class="mb-8 p-4 rounded-lg bg-gray-50 min-h-[100px] flex items-center justify-center">
            <div id="message" class="text-gray-700">歡迎，<span id="displayName" class="font-semibold">員工</span>！<br>請點擊下方按鈕進行打卡。</div>
            <div id="loading" class="hidden">
                <div class="spinner w-8 h-8 border-4 border-gray-200 rounded-full"></div>
                <p id="loading-text" class="mt-2 text-gray-600">正在初始化...</p>
            </div>
        </div>

        <button id="checkin-button" class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-lg text-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none btn-pulse" disabled>上班打卡</button>
        
        <div class="mt-6 text-left">
            <h3 class="font-semibold text-gray-600 border-b pb-1 mb-2">執行日誌 (Debug Log)</h3>
            <div id="debug-log-container" class="bg-gray-800 text-white p-3 rounded-md overflow-y-auto">
                <div id="debug-log"></div>
            </div>
        </div>
    </div>

    <script>
        const displayNameElement = document.getElementById('displayName');
        const messageElement = document.getElementById('message');
        const loadingElement = document.getElementById('loading');
        const loadingTextElement = document.getElementById('loading-text');
        const checkinButton = document.getElementById('checkin-button');
        const debugLogElement = document.getElementById('debug-log');

        function pageLog(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEntry.classList.add(`log-${type}`);
            debugLogElement.appendChild(logEntry);
            debugLogElement.parentElement.scrollTop = debugLogElement.parentElement.scrollHeight;
        }

        async function main() {
            try {
                pageLog('程式開始執行...');
                showLoading('正在初始化 LIFF...');
                await liff.init({ liffId: LIFF_ID });
                pageLog('步驟: liff.init() 成功', 'success');

                if (!liff.isLoggedIn()) {
                    pageLog('狀態: 未登入，準備跳轉登入頁面', 'error');
                    liff.login();
                    return;
                }
                pageLog('狀態: 已登入');

                const profile = await liff.getProfile();
                pageLog('步驟: liff.getProfile() 成功', 'success');
                displayNameElement.textContent = profile.displayName;
                checkinButton.disabled = false;
                hideLoading();
                pageLog('初始化完成，等待使用者操作...');

            } catch (err) {
                pageLog(`嚴重錯誤: LIFF 初始化失敗 - ${err.message}`, 'error');
                console.error('LIFF Initialization Error:', err);
                showError('LIFF 初始化失敗，請在手機 LINE App 中開啟此頁面。');
            }
        }
        
        function getGeoLocationPromise() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject({ code: 'NOT_SUPPORTED', message: '您的瀏覽器不支援地理位置功能。' });
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => { resolve(position); },
                    (error) => {
                        let code = '';
                        switch(error.code) {
                            case error.PERMISSION_DENIED: code = 'PERMISSION_DENIED'; break;
                            case error.POSITION_UNAVAILABLE: code = 'POSITION_UNAVAILABLE'; break;
                            case error.TIMEOUT: code = 'TIMEOUT'; break;
                            default: code = 'UNKNOWN_ERROR';
                        }
                        reject({ code: code, message: error.message });
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        // ===============================================================
        // ======================= 【核心修改處】 ========================
        // ===============================================================

        /**
         * 【新增的函式】
         * 這是一個放在全域範圍的函式，專門用來接收後端 JSONP 的回應。
         * @param {object} result - 由後端 Apps Script 傳回的 JSON 物件
         */
        function handleGasResponse(result) {
            pageLog('步驟: 後端透過 JSONP 回應成功', 'success');
            hideLoading();
            handleCheckInResult(result);

            // 清理動態產生的 script 標籤，避免頁面殘留
            const scriptTag = document.getElementById('jsonp-script');
            if (scriptTag) {
                scriptTag.remove();
            }
        }

        /**
         * 【修改過的函式】
         * 打卡按鈕的點擊事件處理器。
         * 原本的 fetch 請求，已被替換為動態建立 <script> 標籤的 JSONP 請求方式。
         */
        checkinButton.addEventListener('click', async () => {
            checkinButton.disabled = true;
            pageLog('事件: 打卡按鈕被點擊');

            try {
                // --- 步驟 1 & 2: 取得 GPS 和 LINE Profile (這部分不變) ---
                showLoading('正在取得您的 GPS 位置...');
                const location = await getGeoLocationPromise();
                const { latitude, longitude } = location.coords;
                pageLog(`步驟: 取得 GPS 成功`, 'success');

                showLoading('正在驗證您的身分...');
                const profile = await liff.getProfile();
                pageLog(`步驟: liff.getProfile() 成功`, 'success');

                // --- 步驟 3: 發送 JSONP 請求 ---
                showLoading('正在傳送打卡資訊...');
                const callbackName = 'handleGasResponse'; // 對應到我們新增的全域函式
                let url = `${GAS_WEB_APP_URL}?userId=${profile.userId}&userName=${encodeURIComponent(profile.displayName)}&lat=${latitude}&lon=${longitude}&callback=${callbackName}`;
                pageLog(`目標 URL (JSONP): ${url}`);

                // 動態建立一個 script 標籤
                const script = document.createElement('script');
                script.id = 'jsonp-script';
                script.src = url;

                // 處理載入失敗的情況 (網路錯誤等)
                script.onerror = function() {
                    pageLog('嚴重錯誤: JSONP 腳本載入失敗 (網路問題)', 'error');
                    showError('無法連接到打卡主機。<br>請檢查您的網路連線。');
                    checkinButton.textContent = '重新打卡';
                    checkinButton.disabled = false;
                    script.remove();
                };
                
                // 將 script 標籤加入到頁面中，瀏覽器會自動發出請求
                document.head.appendChild(script);

            } catch (err) {
                // 這個 catch 區塊主要處理 getGeoLocationPromise 或 liff.getProfile 的錯誤
                pageLog(`嚴重錯誤: 打卡流程中斷 - ${err.message}`, 'error');
                console.error('Check-in Error:', err);
                let errorMessage = '打卡失敗，發生未知錯誤。';
                if (err.code === 'PERMISSION_DENIED') {
                    errorMessage = '您拒絕了位置資訊授權，無法進行打卡。';
                } else if (err.code === 'TIMEOUT') {
                    errorMessage = '取得位置資訊逾時，請檢查您的網路與 GPS 設定。';
                }
                showError(errorMessage);
                checkinButton.disabled = false;
            }
        });

        // ===============================================================
        // ==================== 以下為輔助函式 (不變) ====================
        // ===============================================================

        function handleCheckInResult(result) {
            const container = document.getElementById('status-container');
            container.classList.remove('bg-gray-50', 'bg-green-100', 'bg-red-100');
            pageLog(`處理後端結果: ${result.status}`);
            if (result.status === 'success') {
                container.classList.add('bg-green-100');
                updateMessage(result.message, 'text-green-800');
                checkinButton.textContent = '打卡完成';
                checkinButton.classList.remove('bg-blue-600', 'btn-pulse');
                checkinButton.classList.add('bg-green-600');
            } else {
                container.classList.add('bg-red-100');
                updateMessage(result.message || '後端回報了一個錯誤，但未提供詳細訊息。', 'text-red-800');
                checkinButton.textContent = '重新打卡';
                checkinButton.disabled = false;
            }
        }

        function showLoading(text) { messageElement.style.display = 'none'; loadingElement.style.display = 'block'; loadingTextElement.textContent = text; }
        function hideLoading() { loadingElement.style.display = 'none'; messageElement.style.display = 'block'; }
        function updateMessage(text, colorClass = 'text-gray-700') { messageElement.innerHTML = text.replace(/\n/g, '<br>'); messageElement.className = ''; messageElement.classList.add(colorClass); }
        function showError(text) { hideLoading(); const container = document.getElementById('status-container'); container.classList.add('bg-red-100'); updateMessage(text, 'text-red-800'); }

        main();
    </script>
</body>
</html>
