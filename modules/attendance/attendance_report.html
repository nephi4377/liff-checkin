<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å‡ºå‹¤å„€è¡¨æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .summary-card { transition: all 0.3s ease; }
        .summary-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        #map { height: 400px; width: 100%; border-radius: 0.5rem; margin-top: 1rem; }
        .modal { display: none; }
        .modal.is-open { display: flex; align-items: center; justify-content: center; }
        /* ã€â­ï¸ æ ¸å¿ƒæ–°å¢ï¼šå„ªåŒ–æ—¥æœŸ/æ™‚é–“è¼¸å…¥æ¡†é«”é©— â­ï¸ã€‘ */
        /* è®“æ•´å€‹è¼¸å…¥æ¡†éƒ½èƒ½é»æ“Šä»¥æ‰“é–‹é¸æ“‡å™¨ */
        /* [æ ¸å¿ƒé‡æ§‹] ä½¿ç”¨ :in-range å½é¡ä¾†æ™ºæ…§åœ°æ§åˆ¶æ–‡å­—é¡è‰²ï¼Œå¾¹åº•è§£æ±ºé è¨­å€¼é¡¯ç¤ºå•é¡Œ */
        input[type="date"],
        input[type="time"] {
            cursor: pointer; /* ç¶­æŒå¯é»æ“Šçš„æŒ‡æ¨™ */
            color: #1f2937;  /* é è¨­æ–‡å­—é¡è‰² (æ·±ç°è‰²) */
        }

        /* ç•¶è¼¸å…¥æ¡†æ²’æœ‰æœ‰æ•ˆå€¼æ™‚ï¼Œè®“æ–‡å­—é¡è‰²è®Šæ·¡ï¼Œæ¨¡æ“¬ placeholder æ•ˆæœ */
        input[type="date"]:out-of-range,
        input[type="time"]:out-of-range {
            color: #9ca3af; /* æ·¡ç°è‰² */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-700">å‡ºå‹¤å„€è¡¨æ¿</h1>
            <button id="add-checkin-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700">ï¼‹ æ‰‹å‹•è£œæ‰“å¡</button>
        </header>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">æŸ¥è©¢æ¢ä»¶</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div>
                    <label for="start-date" class="block text-sm font-medium text-gray-700">é–‹å§‹æ—¥æœŸ</label>
                    <input type="date" id="start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="end-date" class="block text-sm font-medium text-gray-700">çµæŸæ—¥æœŸ</label>
                    <input type="date" id="end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="employee-select" class="block text-sm font-medium text-gray-700">é¸æ“‡å“¡å·¥</label>
                    <select id="employee-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <option value="">æ‰€æœ‰å“¡å·¥</option>
                    </select>
                    <!-- ã€æ‚¨çš„è¦æ±‚ã€‘æ–°å¢ã€Œé¡¯ç¤ºæ‰€æœ‰æ­·å²å“¡å·¥ã€çš„æ ¸å–æ–¹å¡Š -->
                    <div class="mt-2 flex items-center">
                        <input id="show-all-employees-checkbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="show-all-employees-checkbox" class="ml-2 block text-sm text-gray-900">é¡¯ç¤ºæ‰€æœ‰æ­·å²å“¡å·¥</label>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="query-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300">æŸ¥è©¢</button>
                    <!-- ã€æ‚¨çš„è¦æ±‚ã€‘æ–°å¢åŒ¯å‡ºæŒ‰éˆ• -->
                    <button id="export-csv-btn" title="å°‡ç›®å‰æŸ¥è©¢çµæœåŒ¯å‡ºç‚º CSV æª”æ¡ˆ" class="p-2 bg-green-600 text-white rounded-md hover:bg-green-700 hidden"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>
                </div>
            </div>
        </div>

        <div id="summary-section" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow summary-card"><div class="text-sm font-medium text-gray-500">æ‡‰åˆ°å¤©æ•¸</div><div id="total-workdays" class="mt-1 text-3xl font-semibold text-gray-700">0</div></div>
            <div class="bg-white p-4 rounded-lg shadow summary-card"><div class="text-sm font-medium text-gray-500">å¯¦åˆ°å¤©æ•¸</div><div id="total-attended" class="mt-1 text-3xl font-semibold text-green-600">0</div></div>
            <div class="bg-white p-4 rounded-lg shadow summary-card"><div class="text-sm font-medium text-gray-500">ç¸½é²åˆ°(åˆ†)</div><div id="total-late" class="mt-1 text-3xl font-semibold text-orange-500">0</div></div>
            <div class="bg-white p-4 rounded-lg shadow summary-card"><div class="text-sm font-medium text-gray-500">ç¸½æ—©é€€(åˆ†)</div><div id="total-early" class="mt-1 text-3xl font-semibold text-blue-500">0</div></div>
            <div class="bg-white p-4 rounded-lg shadow summary-card"><div class="text-sm font-medium text-gray-500">ç¸½ç¼ºå‹¤(å¤©)</div><div id="total-absent" class="mt-1 text-3xl font-semibold text-red-600">0</div></div>
        </div>

        <div id="results-container" class="bg-white p-6 rounded-lg shadow-md">
             <div id="loading-spinner" class="text-center py-10" style="display: none;">è¼‰å…¥ä¸­...</div>
             <div id="report-table-container"></div>
             <div id="map-container" style="display: none;">
                 <h3 class="text-lg font-semibold mt-4">æ‰“å¡åœ°åœ–</h3>
                 <div id="map"></div>
             </div>
        </div>
    </div>
    
    <div id="checkin-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full">
      <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <h3 class="text-lg font-semibold">æ‰‹å‹•è£œæ‰“å¡</h3>
        <div class="mt-4 space-y-4">
          <div><label for="modal-employee-select" class="block text-sm font-medium text-gray-700">å“¡å·¥</label><select id="modal-employee-select" class="mt-1 block w-full rounded-md border-gray-300"></select></div>
          <div><label for="modal-date" class="block text-sm font-medium text-gray-700">æ—¥æœŸ</label><input type="date" id="modal-date" class="mt-1 block w-full rounded-md border-gray-300"></div>
          <div><label for="modal-time" class="block text-sm font-medium text-gray-700">æ™‚é–“ (HH:mm)</label><input type="time" id="modal-time" class="mt-1 block w-full rounded-md border-gray-300"></div>
          <!-- ã€â­ï¸ æ ¸å¿ƒæ–°å¢ï¼šå¿«é€Ÿå¸¶å…¥æ™‚é–“æŒ‰éˆ• â­ï¸ã€‘ -->
          <div id="shift-time-buttons" class="flex items-center gap-2 mt-1">
              <button id="btn-set-shift-start" class="text-xs bg-sky-100 text-sky-700 px-4 py-1 rounded-md hover:bg-sky-200">ä¸Šç­</button>
              <button id="btn-set-shift-end" class="text-xs bg-amber-100 text-amber-700 px-4 py-1 rounded-md hover:bg-amber-200">ä¸‹ç­</button>
          </div>
          <!-- ã€æ–°å¢çµæŸã€‘ -->
          <div><label for="modal-event-type" class="block text-sm font-medium text-gray-700">äº‹ä»¶</label><select id="modal-event-type" class="mt-1 block w-full rounded-md border-gray-300"><option value="ä¸Šç­">ä¸Šç­</option><option value="ä¸‹ç­">ä¸‹ç­</option></select></div>
        </div>
        <div class="mt-6 flex justify-end space-x-2">
          <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-md">å–æ¶ˆ</button>
          <button id="modal-submit-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md">é€å‡º</button>
        </div>
      </div>
    </div>

<!-- ã€â­ï¸ æ ¸å¿ƒæ”¹é€ ï¼šå°‡å…§è¯è…³æœ¬æ”¹ç‚ºæ¨¡çµ„ï¼Œä¸¦å¾ utils.js å¼•å…¥å‡½å¼ â­ï¸ã€‘ -->
<script type="module">
    import { showGlobalNotification } from '../../shared/js/utils.js';

    // ã€æ‚¨çš„è¦æ±‚ã€‘æ–°å¢å…¨åŸŸè®Šæ•¸ï¼Œç”¨æ–¼å„²å­˜ç•¶å‰å ±è¡¨è³‡æ–™ä»¥ä¾›åŒ¯å‡º
    let currentReportData = {};
    // ã€â­ï¸ æ ¸å¿ƒæ–°å¢ï¼šå…¨åŸŸè®Šæ•¸ï¼Œç”¨æ–¼å„²å­˜å“¡å·¥ç­è¡¨è³‡æ–™ â­ï¸ã€‘
    let employeeShiftData = {};

    const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbz5-DUPNNciVdvE5wrOogNgxYt8EpDZppAe9f2cUh8pW9y3i29fB6n0RA5r-A5KuAiz/exec';

    // ã€v32.0 æ ¸å¿ƒæ”¹é€ ã€‘å°‡ loadJsonp å‡ç´šç‚ºç¾ä»£çš„ fetch API
    async function fetchApi(params) {
        const url = new URL(API_BASE_URL);
        for (const key in params) {
            // [v396.0 æ–°å¢] ç‚ºæ‰€æœ‰ API è«‹æ±‚çµ±ä¸€åŠ ä¸Šä¾†æºåƒæ•¸ï¼Œä»¥ä¾¿å¾Œç«¯æ—¥èªŒè¿½è¹¤ã€‚
            url.searchParams.append('source', 'å‡ºå‹¤å„€è¡¨æ¿');
            url.searchParams.append(key, params[key]);
        }

        const response = await fetch(url);
        if (!response.ok) {
            // å¢åŠ è¶…æ™‚è™•ç†
            throw new Error(`å¾Œç«¯ä¼ºæœå™¨éŒ¯èª¤: ${response.status} ${response.statusText}`);
        }
        return response.json();
    }

    /**
     * ã€æ‚¨çš„è¦æ±‚ã€‘æ ¸å¿ƒä¿®æ­£ï¼šå¾ hub.html ç§»å…¥éºå¤±çš„å¿«å–ç®¡ç†å‡½å¼
     * å°‡è³‡æ–™å„²å­˜åˆ°ç€è¦½å™¨çš„ localStorageï¼Œä¸¦è¨­å®šåˆ°æœŸæ—¥ã€‚
     * @param {string} key - å¿«å–çš„éµå€¼ã€‚
     * @param {any} data - è¦å¿«å–çš„è³‡æ–™ã€‚
     * @param {number} [days=1] - å¿«å–æœ‰æ•ˆå¤©æ•¸ï¼Œé è¨­ç‚º 1 å¤©ã€‚
     */
    function saveCache(key, data, days = 1) {
        const cache = { data: data, expires: Date.now() + days * 24 * 60 * 60 * 1000 };
        try {
            localStorage.setItem(key, JSON.stringify(cache));
        } catch (e) {
            console.error('å„²å­˜å¿«å–å¤±æ•—:', e);
        }
    }

    function loadCache(key) {
        const cached = localStorage.getItem(key);
        if (!cached) return null;
        const cache = JSON.parse(cached);
        if (cache.expires < Date.now()) { localStorage.removeItem(key); return null; }
        return cache.data;
    }

    function loadGoogleMapsAPI(apiKey) {
        // [å„ªåŒ–] ä½¿ç”¨ Google æ¨è–¦çš„ Inline Bootstrap Loader æ–¹å¼è¼‰å…¥ APIï¼Œé¿å…æ•ˆèƒ½è­¦å‘Š
        if (window.google && window.google.maps) {
            return Promise.resolve(); // å¦‚æœå·²è¼‰å…¥ï¼Œç›´æ¥è¿”å›
        }
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            const url = new URL('https://maps.googleapis.com/maps/api/js');
            url.searchParams.set('key', apiKey);
            url.searchParams.set('libraries', 'marker');
            url.searchParams.set('v', 'weekly');
            // è¨­ç½®ä¸€å€‹å…¨åŸŸå›å‘¼å‡½å¼ï¼ŒAPI è¼‰å…¥å®Œæˆå¾Œæœƒå‘¼å«å®ƒ
            window.gm_authFailure = () => reject(new Error("Google Maps API é‡‘é‘°é©—è­‰å¤±æ•—ã€‚"));
            url.searchParams.set('callback', 'Function.prototype'); // ä½¿ç”¨æŠ€å·§é¿å…ç”¢ç”Ÿæ–°çš„å…¨åŸŸè®Šæ•¸
            script.src = url.toString();
            script.async = true;
            script.onload = resolve;
            script.onerror = () => reject(new Error("ç„¡æ³•è¼‰å…¥ Google Maps API è…³æœ¬ã€‚"));
            document.head.appendChild(script);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById('start-date').value = firstDayOfMonth.toLocaleDateString('sv');
        document.getElementById('end-date').value = today.toLocaleDateString('sv');

        // ã€â­ï¸ æ ¸å¿ƒä¿®æ­£ï¼šå°‡æ‰€æœ‰äº‹ä»¶ç¶å®šç§»è‡³æ­¤è™•ï¼Œç¢ºä¿ DOM å·²è¼‰å…¥ â­ï¸ã€‘
        document.getElementById('query-btn').onclick = fetchReportData;
        // ã€æ‚¨çš„è¦æ±‚ã€‘ç‚ºåŒ¯å‡ºæŒ‰éˆ•ç¶å®šäº‹ä»¶
        document.getElementById('export-csv-btn').onclick = exportToCsv;
        document.getElementById('add-checkin-btn').onclick = () => {
            document.getElementById('checkin-modal').classList.add('is-open');
            // ã€â­ï¸ æ ¸å¿ƒæ–°å¢ï¼šæ‰“é–‹è¦–çª—æ™‚ï¼Œè¨­å®šé è¨­æ—¥æœŸèˆ‡æ™‚é–“ â­ï¸ã€‘
            const today = new Date();
            document.getElementById('modal-date').value = today.toLocaleDateString('sv');
            const currentHour = today.getHours().toString().padStart(2, '0');
            document.getElementById('modal-time').value = `${currentHour}:00`;
        };
        document.getElementById('modal-cancel-btn').onclick = () => document.getElementById('checkin-modal').classList.remove('is-open');
        document.getElementById('modal-submit-btn').onclick = handleManualCheckinSubmit;
        document.getElementById('btn-set-shift-start').addEventListener('click', () => setShiftTime('start'));
        document.getElementById('btn-set-shift-end').addEventListener('click', () => setShiftTime('end'));

        // ã€â­ï¸ æ ¸å¿ƒæ–°å¢ï¼šç‚ºæ—¥æœŸèˆ‡æ™‚é–“è¼¸å…¥æ¡†åŠ ä¸Šæ‰‹å‹•è§¸ç™¼åŠŸèƒ½ â­ï¸ã€‘
        document.getElementById('modal-date').addEventListener('click', (e) => e.target.showPicker());
        document.getElementById('modal-time').addEventListener('click', (e) => e.target.showPicker());

        // ã€v175.0 æ ¸å¿ƒæ”¹é€ ã€‘å°‡ API è«‹æ±‚ç§»è‡³æ­¤è™•ï¼Œä¸¦çµ±ä¸€é™„ä¸Šä½¿ç”¨è€…è³‡è¨Š
        // ã€æ‚¨çš„è¦æ±‚ã€‘ç‚ºã€Œé¡¯ç¤ºæ‰€æœ‰æ­·å²å“¡å·¥ã€æ ¸å–æ–¹å¡Šç¶å®šäº‹ä»¶
        document.getElementById('show-all-employees-checkbox').addEventListener('change', loadAndRenderEmployees);

        const urlParams = new URLSearchParams(window.location.search);
        const uid = urlParams.get('uid') || 'unknown_user'; // ã€v175.0 æ ¸å¿ƒä¿®æ­£ã€‘å¾ URL å–å¾—æ“ä½œè€…è³‡è¨Š
        const name = urlParams.get('name') || 'Unknown User';

        const userParams = { userId: uid, userName: name }; // æº–å‚™è¦å‚³çµ¦å¾Œç«¯çš„é€šç”¨åƒæ•¸

        // ä¸¦è¡Œç™¼é€è«‹æ±‚ï¼Œæå‡è¼‰å…¥é€Ÿåº¦
        fetchApi({ page: 'attendance_api', action: 'get_config', ...userParams })
            .then(configResponse => {
                // æ­¥é©Ÿ 3: è™•ç†åœ°åœ–è¨­å®š
                if (configResponse && configResponse.googleMapsApiKey) {
                    loadGoogleMapsAPI(configResponse.googleMapsApiKey).catch(console.error);
                } else {
                    console.error('[DEBUG] ç„¡æ³•å–å¾— Google Maps API Key');
                }
            });

        // ç¨ç«‹è¼‰å…¥å“¡å·¥åˆ—è¡¨
        loadAndRenderEmployees();

        function loadAndRenderEmployees() {
            const showAll = document.getElementById('show-all-employees-checkbox').checked;
            const filter = showAll ? 'all' : 'active_with_recent_resigned';
            const cacheKey = `employees_cache_${filter}`;

            // å¿«å–å„ªå…ˆç­–ç•¥
            const cachedData = loadCache(cacheKey);
            if (cachedData) {
                console.log(`âš¡ï¸ å¾å¿«å–è¼‰å…¥å“¡å·¥åˆ—è¡¨ (æ¨¡å¼: ${filter})...`);
                renderEmployeeSelect(cachedData);
            }

            // ç„¡è«–æ˜¯å¦æœ‰å¿«å–ï¼Œéƒ½åœ¨èƒŒæ™¯è«‹æ±‚æœ€æ–°è³‡æ–™
            console.log(`ğŸ”„ æ­£åœ¨å¾å¾Œç«¯è«‹æ±‚å“¡å·¥åˆ—è¡¨ (æ¨¡å¼: ${filter})...`);
            fetchApi({ page: 'attendance_api', action: 'get_employees', filter: filter, ...userParams })
                .then(response => {
                    if (response && response.success) {
                        const newData = response.data;
                        // åªæœ‰åœ¨æ–°èˆŠè³‡æ–™ä¸åŒæ™‚ï¼Œæ‰æ›´æ–°ç•«é¢èˆ‡å¿«å–
                        if (JSON.stringify(cachedData) !== JSON.stringify(newData)) {
                            console.log(`ğŸ”„ åµæ¸¬åˆ°å“¡å·¥è³‡æ–™å·²æ›´æ–° (æ¨¡å¼: ${filter})ï¼Œæ­£åœ¨åˆ·æ–°ä¸‹æ‹‰é¸å–®...`);
                            saveCache(cacheKey, newData, 1); // å¿«å– 1 å¤©
                            renderEmployeeSelect(newData);
                            if (cachedData) { // åªæœ‰åœ¨æ˜¯èƒŒæ™¯æ›´æ–°æ™‚æ‰è·³é€šçŸ¥
                                showGlobalNotification('å“¡å·¥åˆ—è¡¨å·²è‡ªå‹•æ›´æ–°ã€‚', 3000, 'info');
                            }
                        } else {
                            console.log(`âœ… èƒŒæ™¯è³‡æ–™èˆ‡å¿«å–ä¸€è‡´ (æ¨¡å¼: ${filter})ï¼Œç„¡éœ€æ›´æ–°ã€‚`);
                        }
                    } else {
                        throw new Error(response.message || 'å¾Œç«¯æœªå›å‚³æœ‰æ•ˆè³‡æ–™');
                    }
                })
                .catch(error => {
                    console.error(`è¼‰å…¥å“¡å·¥åˆ—è¡¨ (æ¨¡å¼: ${filter}) å¤±æ•—:`, error);
                    if (!cachedData) { // å¦‚æœé€£å¿«å–éƒ½æ²’æœ‰ï¼Œæ‰é¡¯ç¤ºéŒ¯èª¤
                        showGlobalNotification(`è¼‰å…¥å“¡å·¥åˆ—è¡¨å¤±æ•—: ${error.message}`, 8000, 'error');
                    }
                });
        }

        function renderEmployeeSelect(employees) {
            const mainSelect = document.getElementById('employee-select');
            const modalSelect = document.getElementById('modal-employee-select');
            mainSelect.innerHTML = '<option value="">æ‰€æœ‰å“¡å·¥</option>';
            modalSelect.innerHTML = '';
            employeeShiftData = {};

            const activeEmployees = employees.filter(emp => emp.status !== 'é›¢è·');
            const resignedEmployees = employees.filter(emp => emp.status === 'é›¢è·');

            const activeGroup = document.createElement('optgroup');
            activeGroup.label = 'åœ¨è·å“¡å·¥';
            activeEmployees.forEach(emp => {
                activeGroup.innerHTML += `<option value="${emp.userId}">${emp.userName}</option>`;
                modalSelect.innerHTML += `<option value="${emp.userId}">${emp.userName}</option>`;
                employeeShiftData[emp.userId] = { shiftStart: emp.shiftStart, shiftEnd: emp.shiftEnd };
            });
            mainSelect.appendChild(activeGroup);

            if (resignedEmployees.length > 0) {
                const resignedGroup = document.createElement('optgroup');
                resignedGroup.label = 'é›¢è·å“¡å·¥';
                resignedEmployees.forEach(emp => {
                    resignedGroup.innerHTML += `<option value="${emp.userId}" class="text-gray-400">${emp.userName} (å·²é›¢è·)</option>`;
                    employeeShiftData[emp.userId] = { shiftStart: emp.shiftStart, shiftEnd: emp.shiftEnd };
                });
                mainSelect.appendChild(resignedGroup);
            }
        }
    });

    // ã€â­ï¸ æ ¸å¿ƒé‡æ§‹ï¼šç°¡åŒ–è¨­å®šæ™‚é–“çš„å‡½å¼ â­ï¸ã€‘
    function setShiftTime(type) {
        const userId = document.getElementById('modal-employee-select').value;
        const timeInput = document.getElementById('modal-time');
        const eventTypeSelect = document.getElementById('modal-event-type');

        // å¦‚æœæœ‰å“¡å·¥ä¸”æœ‰ç­è¡¨è³‡æ–™ï¼Œå°±å¸¶å…¥æ™‚é–“ï¼›å¦å‰‡å°±æ¸…ç©ºæ™‚é–“ã€‚
        const shiftData = employeeShiftData[userId];
        if (!shiftData) { timeInput.value = ''; return; }

        if (type === 'start') {
            timeInput.value = employeeShiftData[userId].shiftStart || '';
            eventTypeSelect.value = 'ä¸Šç­';
        } else {
            timeInput.value = employeeShiftData[userId].shiftEnd || '';
            eventTypeSelect.value = 'ä¸‹ç­';
        }
    }

    function handleManualCheckinSubmit() {
        const btn = document.getElementById('modal-submit-btn');
        const payload = {
            page: 'attendance_api', // ã€â­ï¸ æ ¸å¿ƒä¿®æ­£ 1/3ï¼šæŒ‡å®šæ­£ç¢ºçš„ page â­ï¸ã€‘
            action: 'add_manual_checkin',
            userId: document.getElementById('modal-employee-select').value,
            date: document.getElementById('modal-date').value,
            time: document.getElementById('modal-time').value,
            eventType: document.getElementById('modal-event-type').value,
        };

        if(!payload.date || !payload.time) {
            alert('è«‹å¡«å¯«å®Œæ•´çš„æ—¥æœŸèˆ‡æ™‚é–“ã€‚');
            return;
        }

        btn.disabled = true;
        btn.textContent = 'é€å‡ºä¸­...';

        // ã€â­ï¸ æ ¸å¿ƒä¿®æ­£ 2/3ï¼šæ”¹ç”¨ loadJsonp ä¸¦æŒ‡å‘æ­£ç¢ºçš„ API è·¯ç”± â­ï¸ã€‘
        fetchApi(payload)
            .then(response => {
                showGlobalNotification(response.message || 'è£œæ‰“å¡æˆåŠŸï¼', 10000, 'success');
                document.getElementById('checkin-modal').classList.remove('is-open');
                optimisticUpdate(payload); // åŸ·è¡Œæ¨‚è§€æ›´æ–°ï¼Œå–ä»£é‡æ–°æ•´ç†
            })
            .catch(error => {
                alert(`è£œæ‰“å¡å¤±æ•—ï¼š${error.message}`);
            })
            .finally(() => {
                // ã€â­ï¸ æ ¸å¿ƒä¿®æ­£ 3/3ï¼šæ¢å¾©æŒ‰éˆ•ç‹€æ…‹ â­ï¸ã€‘
                btn.disabled = false;
                btn.textContent = 'é€å‡º';
            });

    }

    /**
     * ã€â­ï¸ æ ¸å¿ƒæ–°å¢ï¼šæ¨‚è§€æ›´æ–°å‡½å¼ â­ï¸ã€‘
     * åœ¨ä¸é‡æ–°è¼‰å…¥æ‰€æœ‰è³‡æ–™çš„æƒ…æ³ä¸‹ï¼Œå°‡æ–°çš„æ‰“å¡ç´€éŒ„æ’å…¥åˆ°ç¾æœ‰çš„è¡¨æ ¼ä¸­ã€‚
     * @param {object} checkinData - åŒ…å« userId, date, time, eventType çš„ç‰©ä»¶
     */
    function optimisticUpdate(checkinData) {
        const tableBody = document.querySelector('#report-table-container tbody');
        if (!tableBody) return; // å¦‚æœè¡¨æ ¼ä¸å­˜åœ¨ï¼Œå‰‡ä¸åŸ·è¡Œä»»ä½•æ“ä½œ

        const { userId, date, time, eventType } = checkinData;
        const employeeSelect = document.getElementById('employee-select');
        const userName = employeeSelect.options[employeeSelect.selectedIndex].text;

        // å»ºç«‹æ–°çš„ä¸€åˆ— (tr)
        const newRow = document.createElement('tr');

        // åˆ¤æ–·æ—¥æœŸæ˜¯å¦ç‚ºå‡æ—¥/é€±æœ«
        const dateObj = new Date(date);
        dateObj.setMinutes(dateObj.getMinutes() + dateObj.getTimezoneOffset());
        const dayOfWeek = dateObj.getDay();
        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        const dateClass = isWeekend ? 'text-red-600 font-bold' : '';

        // çµ„åˆ HTML
        newRow.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap font-medium">${userName}</td>
            <td class="px-6 py-4 whitespace-nowrap ${dateClass}">${date} (${weekdays[dayOfWeek]})</td>
            <td class="px-6 py-4 whitespace-nowrap text-center">${eventType === 'ä¸Šç­' ? time : '---'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-center">${eventType === 'ä¸‹ç­' ? time : '---'}</td>
            <td class="px-6 py-4 whitespace-nowrap">æ‰‹å‹•è£œç™»</td>
            <td class="px-6 py-4 whitespace-nowrap text-center">0</td>
            <td class="px-6 py-4 whitespace-nowrap text-center">0</td>
            <td class="px-6 py-4 whitespace-nowrap">æ‰‹å‹•è£œç™»</td>
        `;

        // å°‹æ‰¾æ’å…¥é»ï¼šæ‰¾åˆ°æ‰€æœ‰åˆ—ï¼Œç„¶å¾Œæ ¹æ“šæ—¥æœŸæ’åºæ‰¾åˆ°åˆé©çš„ä½ç½®
        const allRows = Array.from(tableBody.querySelectorAll('tr'));
        let inserted = false;
        for (let i = 0; i < allRows.length; i++) {
            const rowDate = allRows[i].cells[1].textContent.split(' ')[0];
            if (date > rowDate) {
                tableBody.insertBefore(newRow, allRows[i]);
                inserted = true;
                break;
            }
        }
        // å¦‚æœæ–°æ—¥æœŸæ¯”æ‰€æœ‰ç¾æœ‰æ—¥æœŸéƒ½æ—©ï¼Œæˆ–è¡¨æ ¼ç‚ºç©ºï¼Œå‰‡åŠ åˆ°æœ€å¾Œ
        if (!inserted) {
            tableBody.appendChild(newRow);
        }
    }

    function fetchReportData() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        const userId = document.getElementById('employee-select').value;
        const spinner = document.getElementById('loading-spinner');
        
        spinner.style.display = 'block';
        document.getElementById('report-table-container').innerHTML = '';
        document.getElementById('summary-section').style.display = 'none';
        // ã€æ‚¨çš„è¦æ±‚ã€‘æŸ¥è©¢æ™‚å…ˆéš±è—åŒ¯å‡ºæŒ‰éˆ•
        document.getElementById('export-csv-btn').classList.add('hidden');
        document.getElementById('map-container').style.display = 'none';

        // ã€v175.0 æ ¸å¿ƒä¿®æ­£ã€‘åœ¨æŸ¥è©¢å ±è¡¨æ™‚ï¼Œä¹Ÿé™„ä¸Šç•¶å‰æ“ä½œè€…çš„è³‡è¨Š
        const urlParams = new URLSearchParams(window.location.search);
        const operatorUid = urlParams.get('uid') || 'unknown_user';
        const operatorName = urlParams.get('name') || 'Unknown User';

        const params = { page: 'attendance_api', action:'get_report', startDate, endDate, userId, operatorId: operatorUid, operatorName: operatorName };
        fetchApi(params)
            .then(data => {
                // [v342.0 æ ¸å¿ƒæ”¹é€ ] æ ¹æ“šä½¿ç”¨è€…å»ºè­°ï¼Œå¢åŠ å°å¾Œç«¯å›å‚³ä¹‹ success æ——æ¨™çš„åˆ¤æ–·ã€‚
                // å¦‚æœå¾Œç«¯æ˜ç¢ºå›å‚³æŸ¥è©¢å¤±æ•—ï¼Œå‰‡æ‹‹å‡ºéŒ¯èª¤ï¼Œç”±ä¸‹æ–¹çš„ catch å€å¡Šçµ±ä¸€é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ã€‚
                if (data && data.success === false) {
                    throw new Error(data.message || 'å¾Œç«¯å›å ±äº†ä¸€å€‹æœªçŸ¥çš„éŒ¯èª¤ã€‚');
                }

                // [æ ¸å¿ƒæ”¹é€ ] æ”¶åˆ°å¾Œç«¯å›å‚³çš„å®Œæ•´å ±è¡¨å¾Œï¼Œç«‹å³ä½¿ç”¨å·²éæ¿¾çš„å“¡å·¥åˆ—è¡¨ (employeeShiftData) é€²è¡Œç¯©é¸ã€‚
                // é€™æ¨£å¯ä»¥ç¢ºä¿ç„¡è«–å¾Œç«¯å›å‚³ä»€éº¼ï¼Œæœ€çµ‚é¡¯ç¤ºåœ¨ç•«é¢ä¸Šçš„éƒ½åªæœ‰æ¬Šé™ < 5 çš„å“¡å·¥ç´€éŒ„ã€‚
                const allowedUserIds = new Set(Object.keys(employeeShiftData));
                const records = data.records || {}; // å¢åŠ ä¿è­·ï¼Œå¦‚æœ data.records ç‚º null æˆ– undefinedï¼Œå‰‡ä½¿ç”¨ç©ºç‰©ä»¶
                // ã€æ‚¨çš„è¦æ±‚ã€‘å°‡éæ¿¾å¾Œçš„è³‡æ–™å­˜åˆ°å…¨åŸŸè®Šæ•¸
                currentReportData = Object.fromEntries(Object.entries(records).filter(([id]) => allowedUserIds.has(id)));

                const filteredRecords = Object.fromEntries(Object.entries(records).filter(([id]) => allowedUserIds.has(id)));

                spinner.style.display = 'none';
                renderSummary(data.summary);
                renderReportTable(filteredRecords, new Set(data.holidays || [])); // ä½¿ç”¨éæ¿¾å¾Œçš„è³‡æ–™é€²è¡Œæ¸²æŸ“
                if (typeof google !== 'undefined' && userId && filteredRecords[userId] && filteredRecords[userId].mapPoints.length > 0) {
                    initMap(data.records[userId].mapPoints).catch(console.error);
                }
                // ã€æ‚¨çš„è¦æ±‚ã€‘æŸ¥è©¢æˆåŠŸä¸”æœ‰è³‡æ–™æ™‚ï¼Œé¡¯ç¤ºåŒ¯å‡ºæŒ‰éˆ•
                if (Object.keys(filteredRecords).length > 0) {
                    document.getElementById('export-csv-btn').classList.remove('hidden');
                }
            })
            .catch(error => {
                spinner.style.display = 'none';
                console.error("æŸ¥è©¢å ±è¡¨è³‡æ–™å¤±æ•—:", error);
                document.getElementById('report-table-container').innerHTML = `<p class="text-center text-red-500">æŸ¥è©¢è³‡æ–™å¤±æ•—ï¼š${error.message}</p>`;
            });
    }

    /**
     * ã€æ‚¨çš„è¦æ±‚ã€‘å°‡ç•¶å‰å ±è¡¨è³‡æ–™åŒ¯å‡ºç‚º CSV æª”æ¡ˆ
     */
    function exportToCsv() {
        if (!currentReportData || Object.keys(currentReportData).length === 0) {
            alert('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™ã€‚');
            return;
        }

        let csvContent = "å“¡å·¥å§“å,æ—¥æœŸ,æ˜ŸæœŸ,ä¸Šç­æ™‚é–“,ä¸‹ç­æ™‚é–“,ç‹€æ…‹,é²åˆ°(åˆ†),æ—©é€€(åˆ†),æ‰“å¡åœ°é»\n";
        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

        // å–å¾—æ‰€æœ‰æ—¥æœŸä¸¦æ’åºï¼Œç¢ºä¿åŒ¯å‡ºé †åºæ­£ç¢º
        const allDates = new Set();
        Object.values(currentReportData).forEach(userData => {
            Object.keys(userData.dailyData).forEach(date => allDates.add(date));
        });
        const sortedDates = Array.from(allDates).sort();

        // éæ­·æ¯ä¸€ä½å“¡å·¥
        for (const userId in currentReportData) {
            const userData = currentReportData[userId];
            // éæ­·æ¯ä¸€å¤©
            for (const dateStr of sortedDates) {
                const day = userData.dailyData[dateStr];
                if (!day) continue; // å¦‚æœè©²å“¡å·¥ç•¶å¤©æ²’è³‡æ–™ï¼Œå‰‡è·³é

                const dateObj = new Date(dateStr);
                dateObj.setMinutes(dateObj.getMinutes() + dateObj.getTimezoneOffset());
                const dayOfWeek = weekdays[dateObj.getDay()];

                // è™•ç†åœ°é»ï¼Œå°‡å¤šè¡Œåœ°é»åˆä½µç‚ºä¸€è¡Œ
                const checkInPoint = userData.mapPoints.find(p => p.eventType === 'ä¸Šç­' && p.time.includes(dateStr.replace(/-/g, '/')) && p.time.endsWith(day.checkIn));
                const checkOutPoint = userData.mapPoints.find(p => p.eventType === 'ä¸‹ç­' && p.time.includes(dateStr.replace(/-/g, '/')) && p.time.endsWith(day.checkOut));
                let locationInfo = [];
                if (checkInPoint) locationInfo.push(`ä¸Šç­: ${checkInPoint.address || 'ç„¡'}`);
                if (checkOutPoint) locationInfo.push(`ä¸‹ç­: ${checkOutPoint.address || 'ç„¡'}`);
                // å°‡åœ°é»ä¸­çš„é€—è™Ÿæ›¿æ›ç‚ºå…¨å½¢é€—è™Ÿï¼Œé¿å… CSV æ ¼å¼éŒ¯äº‚
                const locationStr = locationInfo.join('; ').replace(/,/g, 'ï¼Œ');

                const row = [
                    userData.userName,
                    dateStr,
                    dayOfWeek,
                    day.checkIn || '',
                    day.checkOut || '',
                    `"${day.status.replace(/"/g, '""')}"`, // è™•ç†ç‹€æ…‹ä¸­å¯èƒ½åŒ…å«çš„å¼•è™Ÿ
                    day.late || 0,
                    day.early || 0,
                    `"${locationStr}"` // å°‡åœ°é»è³‡è¨ŠåŒ…åœ¨å¼•è™Ÿä¸­
                ].join(',');
                csvContent += row + "\n";
            }
        }

        // å»ºç«‹ä¸¦è§¸ç™¼ä¸‹è¼‰
        const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' }); // åŠ å…¥ BOM ä»¥æ”¯æ´ Excel
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        link.setAttribute("download", `å‡ºå‹¤ç´€éŒ„_${startDate}_to_${endDate}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function renderSummary(summary) {
        document.getElementById('summary-section').style.display = 'grid';
        document.getElementById('total-workdays').textContent = summary.totalWorkDays || 0;
        document.getElementById('total-attended').textContent = summary.totalAttendedDays || 0;
        document.getElementById('total-late').textContent = summary.totalLateMinutes || 0;
        document.getElementById('total-early').textContent = summary.totalEarlyMinutes || 0;
        document.getElementById('total-absent').textContent = summary.totalAbsentDays || 0;
    }
    
    function renderReportTable(recordsByUser, holidays) {
        const container = document.getElementById('report-table-container');
        // [æ ¸å¿ƒæ”¹é€ ] ç§»é™¤æ­¤è™•çš„éæ¿¾é‚è¼¯ï¼Œå› ç‚ºå‚³å…¥çš„ recordsByUser å·²ç¶“æ˜¯éæ¿¾å¾Œçš„è³‡æ–™ã€‚
        if (!recordsByUser || Object.keys(recordsByUser).length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500">æ­¤ç¯„åœå…§ç„¡å‡ºå‹¤ç´€éŒ„ã€‚</p>';
            return;
        }

        // ã€â­ï¸ æ ¸å¿ƒæ–°å¢ï¼šå–å¾—ä»Šå¤©çš„æ—¥æœŸå­—ä¸²èˆ‡ç•¶å‰æ™‚é–“ï¼Œç”¨æ–¼å¾ŒçºŒåˆ¤æ–· â­ï¸ã€‘
        const todayStr = new Date().toLocaleDateString('sv');
        const now = new Date();

        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        let html = '<div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-semibold mb-4">å‡ºå‹¤æ˜ç´°</h2><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">';
        html += '<thead class="bg-gray-50"><tr>' +
            '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å“¡å·¥å§“å</th>' +
            '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ—¥æœŸ</th>' +
            '<th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ä¸Šç­</th>' +
            '<th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ä¸‹ç­</th>' +
            '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç‹€æ…‹</th>' +
            '<th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">é²åˆ°(åˆ†)</th>' +
            '<th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">æ—©é€€(åˆ†)</th>' +
            '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ‰“å¡åœ°é»</th>' +
            '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
        
        for (const userId in recordsByUser) {
            const userData = recordsByUser[userId];
            const dailyData = userData.dailyData || {};
            // [ä¿®æ”¹] å–å¾—æ‰€æœ‰æ—¥æœŸçš„éµä¸¦æ’åºï¼Œç¢ºä¿é¡¯ç¤ºé †åºæ­£ç¢º
            const sortedDates = Object.keys(dailyData).sort();

            for (const dateStr of sortedDates) {
                const day = dailyData[dateStr];
                const dateObj = new Date(dateStr);
                dateObj.setMinutes(dateObj.getMinutes() + dateObj.getTimezoneOffset());
                const dayOfWeek = dateObj.getDay();

                const isHoliday = holidays.has(dateStr) || dayOfWeek === 0 || dayOfWeek === 6;
                const dateClass = isHoliday ? 'text-red-600 font-bold' : '';

                const lateClass = day.late > 0 ? 'text-orange-600 font-bold' : '';
                const earlyClass = day.early > 0 ? 'text-blue-600 font-bold' : '';
                // [æ ¸å¿ƒæ”¹é€ ] æ–°å¢ç•°å¸¸ç‹€æ…‹çš„ CSS classï¼Œä½¿å…¶é¡¯ç¤ºç‚ºç´…è‰²ç²—é«”
                let displayStatus = day.status;
                let displayCheckOut = day.checkOut || '---';

                // ã€â­ï¸ æ ¸å¿ƒæ–°å¢ï¼šæ ¹æ“šæ‚¨çš„éœ€æ±‚ï¼ŒåŠ å…¥ä¸‰å¤§åˆ¤æ–·é‚è¼¯ â­ï¸ã€‘
                if (dateStr === todayStr) {
                    // 1. å¦‚æœæ˜¯ä»Šå¤©ï¼Œä¸”ç‹€æ…‹ç‚ºã€Œåƒ…å–®æ¬¡æ‰“å¡ã€ï¼Œå‰‡æš«æ™‚é¡¯ç¤ºç‚ºã€Œå‡ºå‹¤ã€ã€‚
                    if (displayStatus === 'åƒ…å–®æ¬¡æ‰“å¡') {
                        displayStatus = 'å‡ºå‹¤';
                    }
                    // 2. å¦‚æœé‚„æ²’åˆ°ä¸‹ç­æ™‚é–“ï¼Œå‰‡ä¸é¡¯ç¤ºä¸‹ç­æ¬„ä½ã€‚
                    const shiftData = employeeShiftData[userId];
                    if (shiftData && shiftData.shiftEnd) {
                        const shiftEndHour = parseInt(shiftData.shiftEnd.split(':')[0], 10);
                        if (now.getHours() < shiftEndHour) {
                            displayCheckOut = '---';
                        }
                    }
                }
                // 3. å¦‚æœç‹€æ…‹ç‚ºã€Œç¼ºå‹¤ã€ï¼Œå‰‡å¥—ç”¨ç´…è‰²ç²—é«”æ¨£å¼ã€‚
                // ã€v42.0 æ ¸å¿ƒæ”¹é€ ã€‘ç‚ºä¸åŒçš„å‡åˆ¥ç‹€æ…‹æ–°å¢å°æ‡‰çš„ CSS Class
                let statusClass = '';
                if (displayStatus === 'ç¼ºå‹¤' || day.status === 'ç•°å¸¸') statusClass = 'text-red-600 font-bold';
                else if (day.status === 'åƒ…å–®æ¬¡æ‰“å¡') statusClass = 'text-purple-600 font-bold';
                // [æ”¹å–„] æ”¹ç”¨ .includes() åˆ¤æ–·ï¼Œè®“ "ä¼‘å‡;åŠ ç­[...]" é€™é¡è¤‡åˆç‹€æ…‹ä¹Ÿèƒ½æ­£ç¢ºé¡¯ç¤ºæ¨£å¼
                else if (displayStatus.includes('åŠ ç­')) statusClass = 'text-orange-600 font-bold';
                else if (displayStatus === 'ç‰¹ä¼‘') statusClass = 'text-blue-600 font-bold';
                else if (displayStatus === 'ç—…å‡') statusClass = 'text-yellow-600 font-bold';
                else if (displayStatus === 'äº‹å‡') statusClass = 'text-gray-500';
                else if (['è£œä¼‘', 'å…¬å‡', 'å©šå‡', 'å–ªå‡'].includes(displayStatus)) statusClass = 'text-indigo-600 font-bold';

                // ã€â­ï¸ æ ¸å¿ƒä¿®æ­£ï¼šå¾ mapPoints ä¸­æŸ¥æ‰¾å°æ‡‰çš„æ‰“å¡åœ°é» â­ï¸ã€‘
                let locationHtml = '';
                // [v2 ä¿®æ­£] å°‡ dateStr çš„ '-' æ›¿æ›ç‚º '/'ï¼Œä»¥åŒ¹é… mapPoints.time çš„æ ¼å¼ (e.g., '2025/10/01')
                const dateStrForSearch = dateStr.replace(/-/g, '/');

                // å°‹æ‰¾ä¸Šç­æ‰“å¡é»
                const checkInPoint = userData.mapPoints.find(p => p.eventType === 'ä¸Šç­' && p.time.startsWith(dateStrForSearch) && p.time.endsWith(day.checkIn));
                if (checkInPoint && checkInPoint.address) {
                    locationHtml += `<div class="text-xs">ä¸Šç­: ${checkInPoint.address}</div>`;
                }
                // å°‹æ‰¾ä¸‹ç­æ‰“å¡é»
                const checkOutPoint = userData.mapPoints.find(p => p.eventType === 'ä¸‹ç­' && p.time.startsWith(dateStrForSearch) && p.time.endsWith(day.checkOut));
                if (checkOutPoint && checkOutPoint.address) {
                    locationHtml += `<div class="text-xs">ä¸‹ç­: ${checkOutPoint.address}</div>`;
                }

                html += `<tr>
                    <td class="px-6 py-4 whitespace-nowrap font-medium">${userData.userName}</td>
                    <td class="px-6 py-4 whitespace-nowrap ${dateClass}">${dateStr} (${weekdays[dayOfWeek]})</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">${day.checkIn || '---'}</td> <!-- ä¸Šç­æ™‚é–“ç¶­æŒä¸è®Š -->
                    <td class="px-6 py-4 whitespace-nowrap text-center">${displayCheckOut}</td> <!-- ä½¿ç”¨è™•ç†éçš„ä¸‹ç­æ™‚é–“ -->
                    <td class="px-6 py-4 whitespace-nowrap ${statusClass}">${displayStatus}</td> <!-- ä½¿ç”¨è™•ç†éçš„ç‹€æ…‹ -->
                    <td class="px-6 py-4 whitespace-nowrap text-center ${lateClass}">${day.late}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center ${earlyClass}">${day.early}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${locationHtml || '---'}</td>
                </tr>`;
            }
        }
        html += '</tbody></table></div></div>';
        container.innerHTML = html;
    }

    function getMarkerIcon(eventType, status) {
        let color = '#707070'; 
        if (eventType === 'ä¸Šç­') {
            color = (status === 'é²åˆ°') ? '#F97316' : '#22C55E';
        } else if (eventType === 'ä¸‹ç­') {
            color = (status === 'æ—©é€€') ? '#EF4444' : '#3B82F6';
        }
        return {
            path: 'M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z',
            fillColor: color,
            fillOpacity: 0.9,
            strokeWeight: 0,
            rotation: 0,
            scale: 1.5,
            anchor: new google.maps.Point(12, 22),
        };
    }

    async function initMap(points) {
        const mapContainer = document.getElementById('map-container');
        if (!points || !Array.isArray(points) || points.length === 0 || 
            typeof points[0] !== 'object' || points[0] === null || 
            typeof points[0].lat !== 'number' || typeof points[0].lng !== 'number') {
            console.error('[DEBUG] æ”¶åˆ°çš„åœ°åœ–åº§æ¨™è³‡æ–™ç„¡æ•ˆæˆ–æ ¼å¼ä¸ç¬¦:', points);
            mapContainer.style.display = 'none';
            return; // çµæŸå‡½å¼
        }

        // [å„ªåŒ–] ä½¿ç”¨æ–°çš„ API è¼‰å…¥æ–¹å¼ï¼Œéœ€è¦éåŒæ­¥å¼•å…¥å‡½å¼åº«
        const { Map } = await google.maps.importLibrary("maps");
        const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
        const { InfoWindow } = await google.maps.importLibrary("maps");

        mapContainer.style.display = 'block';
        const map = new Map(document.getElementById("map"), {
            zoom: 15,
            center: { lat: points[0].lat, lng: points[0].lng },
            mapId: 'ATTENDANCE_MAP' // ç‚ºåœ°åœ–æŒ‡å®šä¸€å€‹ ID
        });
        const infoWindow = new InfoWindow();
        points.forEach(point => {
            const position = { lat: point.lat, lng: point.lng };
            const marker = new google.maps.Marker({ 
                position: position, 
                map: map,
                title: `${point.eventType} - ${point.time}`,
                icon: getMarkerIcon(point.eventType, point.status) 
            });
            marker.addListener('click', ({ domEvent, latLng }) => {
                const statusText = (point.status === 'æº–é»') ? '' : `<span class="font-bold" style="color: ${getMarkerIcon(point.eventType, point.status).fillColor};">(${point.status})</span>`;
                const contentString = `
                    <div class="p-1" style="max-width: 250px;">
                        <div class="font-bold">${point.eventType} ${statusText}</div>
                        <div class="text-sm text-gray-600">${point.time || 'ç„¡æ™‚é–“è³‡è¨Š'}</div>
                        <div class="text-xs text-gray-800 mt-1">${point.address || 'ç„¡åœ°å€è³‡è¨Š'}</div>
                    </div>`;
                infoWindow.setContent(contentString);
                infoWindow.open(marker.map, marker);
            });
        });
    }
</script>
</body>
</html>
