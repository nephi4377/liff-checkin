<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ·»å¿ƒè¨­è¨ˆ | å›å ±ç³»çµ±</title>

  <!-- UI / SDK -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js"></script>

  <script>
    // âš ï¸è«‹ç¢ºèªç‚ºæœ€æ–°è¨­å®š
    const LIFF_ID = '2007974938-gOrjlzna';
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwbEVAfoO9eRzcUSfESIwih1Poub657h_9jz5UcqTXbxsDQOZ3mjLm1nHZfn_WM2K8/exec';
  </script>
  
  <!-- [v467.0 æ–°å¢] è‡ªå‹•ç‰ˆæœ¬è™Ÿç”¢ç”Ÿå™¨ -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const now = new Date();
      const year = String(now.getFullYear()).slice(-2);
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      document.title += ` v${year}.${month}.${day}`;
    });
  </script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    .spinner { border-top-color: #3498db; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .file-input-label { display: inline-block; background-color: #3b82f6; color: white; border: 1px solid #3b82f6; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s; font-weight: 600; }
    .file-input-label:hover { background-color: #2563eb; }
    .file-input-label.selected { background-color: #6b7280; border-color: #6b7280; cursor: default; }
    /* ã€æ‚¨çš„è¦æ±‚ã€‘è¼”åŠ©æŒ‰éˆ•æ¨£å¼ */
    .helper-btn {
      background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db;
      padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem;
      transition: background-color 0.2s;
    }
    .helper-btn:hover { background-color: #e5e7eb; }
  </style>
</head>

<body class="bg-gray-100">
  <div class="container mx-auto p-4 max-w-lg">
    <div class="bg-white rounded-lg shadow-md p-6">
      <div class="text-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">æ·»å¿ƒè¨­è¨ˆï½œå›å ±ç³»çµ±</h1>
      </div>

      <!-- è¡¨å–® -->
      <form id="report-form" novalidate>
        <!-- æ¡ˆè™Ÿï¼šé™åˆ¶ç´”æ•¸å­— + ç¯„ä¾‹ + éæ¡ˆå ´=9999 -->
        <div class="mb-4">
          <label for="projectId" class="block text-gray-700 font-semibold mb-2">
            æ¡ˆè™Ÿ <span class="text-red-500">*</span>
          </label>
          <input
            type="tel"
            id="projectId"
            class="w-full px-3 py-2 border border-gray-300 rounded-md"
            inputmode="numeric"
            pattern="[0-9]+"
            placeholder="ä¾‹å¦‚ï¼š715ï¼›éæ¡ˆå ´è«‹å¡« 9999"
            required
          >
          <p class="text-sm text-gray-500 mt-1">
            åƒ…å…è¨±æ•¸å­—ï¼ˆä¾‹ï¼š<span class="font-semibold">715</span>ï¼‰ã€‚è‹¥ç‚ºéæ¡ˆå ´ï¼Œè«‹å¡« <span class="font-semibold">9999</span>ã€‚
          </p>
          <p id="projectIdError" class="text-sm text-red-600 mt-1 hidden"></p>
        </div>

        <div class="mb-4">
          <label for="workType" class="block text-gray-700 font-semibold mb-2">
            ä»Šæ—¥æ–½å·¥é …ç›® <span class="text-red-500">*</span>
          </label>
          <select id="workType" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white" required>
            <option value="" disabled selected>è«‹é¸æ“‡æ–½å·¥é …ç›®</option>
            <option value="ä¿è­·å·¥ç¨‹-é€²é€€å ´é …ç›®">1. ä¿è­·å·¥ç¨‹-é€²é€€å ´é …ç›®</option>
            <option value="æœ¨ä½œå·¥ç¨‹">2. æœ¨ä½œå·¥ç¨‹</option>
            <option value="ç³»çµ±å·¥ç¨‹">3. ç³»çµ±å·¥ç¨‹</option>
            <option value="æ°´é›»å·¥ç¨‹">4. æ°´é›»å·¥ç¨‹</option>
            <option value="æ²¹æ¼†å·¥ç¨‹">5. æ²¹æ¼†å·¥ç¨‹</option>
            <option value="æ³¥ä½œå·¥ç¨‹">6. æ³¥ä½œå·¥ç¨‹</option>
            <option value="æ¸…æ½”å·¥ç¨‹">7. æ¸…æ½”å·¥ç¨‹</option>
            <option value="ç»ç’ƒå·¥ç¨‹">8. ç»ç’ƒå·¥ç¨‹</option>
            <option value="å…¶ä»–å·¥ç¨‹">9. å…¶ä»–å·¥ç¨‹</option>
          </select>
        </div>

        <div class="mb-4">
          <label for="workDescription" class="block text-gray-700 font-semibold mb-2">ç•¶æ—¥æ–½å·¥å…§å®¹èªªæ˜</label>
          <textarea id="workDescription" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
          <!-- ã€æ‚¨çš„è¦æ±‚ã€‘æ–½å·¥å…§å®¹è¼”åŠ©æŒ‰éˆ•å®¹å™¨ -->
          <div id="workDescriptionHelpers" class="mt-2 flex flex-wrap gap-2">
            <!-- æŒ‰éˆ•å°‡ç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-gray-700 font-semibold mb-2">ç¾å ´ç…§ç‰‡ (å¯å¤šé¸)</label>
          <div class="flex items-center">
            <label for="sitePhotos" id="sitePhotosLabel" class="file-input-label">é¸æ“‡æª”æ¡ˆ</label>
            <span id="sitePhotosCount" class="ml-3 text-gray-600">æœªé¸å–æª”æ¡ˆ</span>
            <input type="file" id="sitePhotos" multiple accept="image/*" class="hidden" />
          </div>
        </div>

        <div class="mb-4">
          <label for="problemDescription" class="block text-gray-700 font-semibold mb-2">å•é¡Œå›å ±</label>
          <textarea id="problemDescription" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
          <!-- ã€æ‚¨çš„è¦æ±‚ã€‘å•é¡Œå›å ±è¼”åŠ©æŒ‰éˆ•å®¹å™¨ -->
          <div id="problemDescriptionHelpers" class="mt-2 flex flex-wrap gap-2">
            <!-- æŒ‰éˆ•å°‡ç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
          </div>
        </div>

        <div class="mb-6">
          <label class="block text-gray-700 font-semibold mb-2">å•é¡Œç…§ç‰‡ (å¯å¤šé¸)</label>
          <div class="flex items-center">
            <label for="problemPhotos" id="problemPhotosLabel" class="file-input-label">é¸æ“‡æª”æ¡ˆ</label>
            <span id="problemPhotosCount" class="ml-3 text-gray-600">æœªé¸å–æª”æ¡ˆ</span>
            <input type="file" id="problemPhotos" multiple accept="image/*" class="hidden" />
          </div>
        </div>

        <div class="flex items-center mb-4">
          <input id="compressImages" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"/>
          <label for="compressImages" class="ml-2 block text-sm text-gray-900">å£“ç¸®ç›¸ç‰‡ä»¥åŠ å¿«ä¸Šå‚³</label>
        </div>

        <!-- [v567.0 æ–°å¢] ä¸Šå‚³é€²åº¦æ¢ -->
        <div id="progress-container" class="w-full bg-gray-200 rounded-full h-6 mb-4 hidden">
            <div id="progress-bar" class="bg-blue-600 h-6 rounded-full text-center text-white text-sm leading-6 transition-all duration-500" style="width: 0%;">
                0%
            </div>
        </div>

        <div id="status-message" class="text-center mb-4 min-h-[24px]"></div>

        <button type="submit" id="submit-button" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-blue-700 disabled:bg-gray-400">
          <span id="button-text">æäº¤å›å ±</span>
          <div id="button-spinner" class="spinner w-6 h-6 border-4 border-white rounded-full mx-auto hidden"></div>
        </button>
      </form>

      <!-- [v454.0 UXå„ªåŒ–] æ–°å¢æˆåŠŸæäº¤ç•«é¢ -->
      <div id="success-screen" class="text-center hidden">
        <svg class="mx-auto h-16 w-16 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h2 class="mt-4 text-2xl font-bold text-gray-800">å›å ±å·²æˆåŠŸæäº¤ï¼</h2>
        <p class="mt-2 text-gray-600">å¾ŒçºŒè™•ç†å®Œæˆå¾Œæ‚¨æœƒæ”¶åˆ° LINE é€šçŸ¥ã€‚<br>æ­¤è¦–çª—å°‡åœ¨ 30 ç§’å¾Œè‡ªå‹•é—œé–‰ã€‚</p>
      </div>
    </div>
  </div>

  <!-- ã€v150.0 æ ¸å¿ƒä¿®æ­£ã€‘å¾¹åº•ä¿®æ­£å·¢ç‹€ script æ¨™ç±¤èˆ‡è¨»è§£èªæ³•éŒ¯èª¤ -->
  <script type="module">
    import { readFileAsBase64 } from '../../shared/js/utils.js'; // [v519.0 ä¿®æ­£] æ›´æ–°å…±ç”¨æ¨¡çµ„ utils.js çš„è·¯å¾‘

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('report-form');
      const submitButton = document.getElementById('submit-button');
      const buttonText = document.getElementById('button-text');
      const buttonSpinner = document.getElementById('button-spinner');
      const statusMessage = document.getElementById('status-message');
      // [v567.0 æ–°å¢] é€²åº¦æ¢å…ƒç´ 
      const progressContainer = document.getElementById('progress-container');
      const progressBar = document.getElementById('progress-bar');
      // [v575.0 æ–°å¢] æ“¬çœŸé€²åº¦æ¢ç›¸é—œè®Šæ•¸
      let progressInterval = null;
      let currentFakeProgress = 0;
      let userProfile = null;

      // === åˆå§‹åŒ– ===
      async function main() {
        // [v425.0 æ¶æ§‹å„ªåŒ–] æ”¯æ´æ··åˆæ¨¡å¼ (å¾ä¸»æ§å°å…§åµŒ æˆ– ç›´æ¥LIFFé–‹å•Ÿ)
        const isLocalTest = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
        const urlParams = new URLSearchParams(window.location.search);
        let uid = urlParams.get('uid');
        let name = urlParams.get('name');

        // [v570.0 æ–°å¢] æœ¬åœ°æ¸¬è©¦æ¨¡å¼
        if (isLocalTest && !uid) {
            console.warn('âš¡ï¸ æœ¬åœ°æ¸¬è©¦æ¨¡å¼å•Ÿç”¨ï¼Œä½¿ç”¨é è¨­ä½¿ç”¨è€…è³‡è¨Šã€‚');
            userProfile = { userId: 'Ud58333430513b7527106fa71d2e30151', displayName: 'æœ¬åœ°æ¸¬è©¦å“¡' };
            initializeEventListeners();
        } else if (uid && name) {
            // æ¨¡å¼ä¸€ï¼šå¾ä¸»æ§å°å…§åµŒï¼Œå·²å–å¾— uid å’Œ name
            console.log('âš¡ï¸ åµæ¸¬åˆ° uidï¼Œä»¥å…§åµŒæ¨¡å¼å•Ÿå‹•...');
            userProfile = { userId: uid, displayName: name };
            initializeEventListeners();
        } else {
            // æ¨¡å¼äºŒï¼šç›´æ¥é–‹å•Ÿï¼Œéœ€åŸ·è¡Œ LIFF é©—è­‰
            console.log('ğŸ”„ æœªåµæ¸¬åˆ° uidï¼Œä»¥ç¨ç«‹ LIFF æ¨¡å¼å•Ÿå‹•...');
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                userProfile = await liff.getProfile();
                initializeEventListeners();
            } catch (error) {
                console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
                updateStatus('é é¢åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹åœ¨ LINE ä¸­é–‹å•Ÿæˆ–é‡æ–°è¼‰å…¥ã€‚', 'error');
                submitButton.disabled = true;
            }
        }
      }

      // === ç¶å®š UI äº‹ä»¶ ===
      function initializeEventListeners() {
        setupFileInputUI('sitePhotos', 'sitePhotosLabel', 'sitePhotosCount');
        setupFileInputUI('problemPhotos', 'problemPhotosLabel', 'problemPhotosCount');

        // ã€æ‚¨çš„è¦æ±‚ã€‘åˆå§‹åŒ–è¼”åŠ©æŒ‰éˆ•
        initializeHelperButtons();

        // æ¡ˆè™Ÿè¼¸å…¥ï¼šå³æ™‚åªç•™æ•¸å­—ï¼›å¤±ç„¦å†æ¸…ä¸€æ¬¡
        const projectIdEl = document.getElementById('projectId');
        projectIdEl.addEventListener('input', () => enforceDigits(projectIdEl));
        projectIdEl.addEventListener('blur',  () => enforceDigits(projectIdEl));

        // ã€å„ªåŒ–å»ºè­°ã€‘è¨˜ä½ä¸¦é‚„åŸä¸Šæ¬¡é¸æ“‡çš„æ–½å·¥é …ç›®
        const workTypeSelect = document.getElementById('workType');
        const lastWorkType = localStorage.getItem('lastSelectedWorkType');
        if (lastWorkType) {
          workTypeSelect.value = lastWorkType;
          // ã€æ‚¨çš„è¦æ±‚ã€‘æ‰‹å‹•è§¸ç™¼ä¸€æ¬¡ change äº‹ä»¶ï¼Œä»¥ç¢ºä¿è¼”åŠ©æŒ‰éˆ•èƒ½è¢«æ­£ç¢ºæ¸²æŸ“
          // é€™æœƒæ¨¡æ“¬ä½¿ç”¨è€…æ‰‹å‹•é¸æ“‡çš„è¡Œç‚ºï¼Œè§¸ç™¼ initializeHelperButtons ä¸­ç¶å®šçš„ç›£è½å™¨
          workTypeSelect.dispatchEvent(new Event('change'));
        }
        workTypeSelect.addEventListener('change', () => localStorage.setItem('lastSelectedWorkType', workTypeSelect.value));

        form.addEventListener('submit', handleFormSubmit);
      }

      // ã€æ‚¨çš„è¦æ±‚ã€‘è¼”åŠ©æŒ‰éˆ•æ ¸å¿ƒé‚è¼¯
      function initializeHelperButtons() {
        const workTypeSelect = document.getElementById('workType');
        
        const workTypePhrases = {
          'ä¿è­·å·¥ç¨‹-é€²é€€å ´é …ç›®': ['é€²å ´ä¿è­·', 'é€€å ´æ¸…æ½”', 'é›»æ¢¯ä¿è­·', 'èµ°é“ä¿è­·', 'å»¢æ£„ç‰©æ¸…é‹', 'å®Œå·¥ä¿è­·'],
          'æœ¨ä½œå·¥ç¨‹': ['å¤©èŠ±æ¿æ–½å·¥', 'æ«ƒé«”çµ„è£', 'é–€ç‰‡å®‰è£', 'è§’æ–™ä¸‹æ–™', 'éš”é–“ç‰†æ–½å·¥', 'é€ å‹ç‰†', 'é›»è¦–ç‰†æ–½å·¥'],
          'ç³»çµ±å·¥ç¨‹': ['æ«ƒé«”å®‰è£', 'é–€ç‰‡èª¿æ•´', 'äº”é‡‘å®‰è£', 'æ”¶é‚Š', 'å±¤æ¿å®‰è£', 'æª¯é¢å®‰è£'],
          'æ°´é›»å·¥ç¨‹': ['é…ç®¡', 'æ‹‰ç·š', 'ç‡ˆå…·å®‰è£', 'é–‹é—œé¢æ¿', 'æ’åº§é¢æ¿', 'å¼±é›»ä½ˆç·š', 'çµ¦æ°´æ¸¬è©¦', 'æ’æ°´æ¸¬è©¦'],
          'æ²¹æ¼†å·¥ç¨‹': ['æ‰¹åœŸ', 'ç ”ç£¨', 'åº•æ¼†', 'é¢æ¼†', 'è·³è‰²', 'å™´æ¼†', 'æœ¨çš®ä¸Šæ¼†'],
          'æ³¥ä½œå·¥ç¨‹': ['ç Œç£š', 'æ‰“åº•', 'ç²‰å…‰', 'ç£ç£šé‹ªè²¼', 'é˜²æ°´æ–½ä½œ', 'åœ°åªå¢Šé«˜', 'é–€çª—å´ç¸«'],
          'æ¸…æ½”å·¥ç¨‹': ['ç²—æ¸…', 'ç´°æ¸…', 'åƒåœ¾æ¸…é‹', 'è£æ½¢å¾Œæ¸…æ½”'],
          'ç»ç’ƒå·¥ç¨‹': ['ç»ç’ƒå®‰è£', 'é¡é¢å®‰è£', 'çŸ½åˆ©åº·æ”¶é‚Š', 'æ·‹æµ´æ‹‰é–€'],
          'å…¶ä»–å·¥ç¨‹': ['ç¾å ´ä¸ˆé‡', 'è¨­è¨ˆåœ–è£½ä½œ', 'æ–½å·¥åœ–è£½ä½œ', 'èˆ‡å®¢æˆ¶è¨è«–', 'å» å•†æ´½è«‡', 'ææ–™ç¢ºèª']
        };

        const problemPhrases = ['ã€ç¼ºæ–™ã€‘', 'ã€å°ºå¯¸ä¸ç¬¦ã€‘', 'ã€åœ–é¢ç–‘å•ã€‘', 'ã€å“è³ªå•é¡Œã€‘', 'ã€éœ€èˆ‡è¨­è¨ˆå¸«ç¢ºèªã€‘', 'ã€éœ€èˆ‡å·¥å‹™ç¢ºèªã€‘', 'ã€å·¥åºè¡çªã€‘', 'ã€ç¾å ´ä¿è­·ä¸è¶³ã€‘', 'ã€å·¥å…·æå£ã€‘'];

        // æ¸²æŸ“å•é¡Œå›å ±çš„é€šç”¨æŒ‰éˆ•
        renderHelperButtons('problemDescriptionHelpers', problemPhrases, 'problemDescription');

        // æ ¹æ“šæ–½å·¥é …ç›®å‹•æ…‹æ¸²æŸ“æŒ‰éˆ•
        workTypeSelect.addEventListener('change', () => {
          const selectedType = workTypeSelect.value;
          renderHelperButtons('workDescriptionHelpers', workTypePhrases[selectedType] || [], 'workDescription');
        });

        // åˆå§‹è§¸ç™¼ä¸€æ¬¡
        renderHelperButtons('workDescriptionHelpers', [], 'workDescription');
      }

      function renderHelperButtons(containerId, phrases, targetTextareaId) {
        const container = document.getElementById(containerId);
        const textarea = document.getElementById(targetTextareaId);
        container.innerHTML = '';
        if (!phrases || phrases.length === 0) return;

        phrases.forEach(phrase => {
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'helper-btn';
          button.textContent = phrase;
          button.addEventListener('click', () => {
            // ã€æ‚¨çš„è¦æ±‚ã€‘æ™ºæ…§æ’å…¥ï¼šå¦‚æœæ–‡å­—æ¡†æ˜¯ç©ºçš„ï¼Œæˆ–çµå°¾æ˜¯ç©ºæ ¼/æ›è¡Œï¼Œå‰‡ç›´æ¥æ’å…¥ï¼›å¦å‰‡å…ˆè£œä¸€å€‹ç©ºæ ¼å†æ’å…¥ï¼Œç¢ºä¿æ–‡å­—æ¥çºŒã€‚
            const endsWithSpaceOrNewline = textarea.value === '' || /\s$/.test(textarea.value);
            const separator = endsWithSpaceOrNewline ? '' : ' ';
            textarea.value += separator + phrase;
            textarea.focus(); // å°‡ç„¦é»ç§»å›æ–‡å­—æ¡†
          });
          container.appendChild(button);
        });
      }

      // === åƒ…å…è¨±æ•¸å­—ï¼šå³æ™‚éæ¿¾ ===
      function enforceDigits(el) {
        const digits = (el.value || '').replace(/\D+/g, '');
        if (el.value !== digits) el.value = digits;
      }

      // === éŒ¯èª¤è¨Šæ¯é¡¯ç¤º/éš±è— ===
      function showProjectIdError(msg) {
        const err = document.getElementById('projectIdError');
        const input = document.getElementById('projectId');
        err.textContent = msg || 'æ¡ˆè™Ÿåƒ…èƒ½è¼¸å…¥æ•¸å­—ï¼›éæ¡ˆå ´è«‹å¡« 9999ã€‚';
        err.classList.remove('hidden');
        input.classList.add('border-red-500');
      }
      function hideProjectIdError() {
        const err = document.getElementById('projectIdError');
        const input = document.getElementById('projectId');
        err.textContent = '';
        err.classList.add('hidden');
        input.classList.remove('border-red-500');
      }

      // === å–å¾—ä¸¦é©—è­‰æ¡ˆè™Ÿï¼ˆé€šéå›å‚³ç´”æ•¸å­—å­—ä¸²ï¼›å¤±æ•—å›å‚³ nullï¼‰ ===
      function getValidProjectId() {
        const input = document.getElementById('projectId');
        enforceDigits(input);
        const v = (input.value || '').trim();
        if (!v || !/^\d+$/.test(v)) {
          showProjectIdError('è«‹è¼¸å…¥ç´”æ•¸å­—æ¡ˆè™Ÿï¼›éæ¡ˆå ´è«‹å¡« 9999ã€‚');
          return null;
        }
        hideProjectIdError();
        return v;
      }

      // === é€å‡ºè™•ç† ===
      async function handleFormSubmit(event) {
        event.preventDefault();
        setLoadingState(true);
        // [v567.0 æ–°å¢] é‡è¨­ä¸¦é¡¯ç¤ºé€²åº¦æ¢
        updateStatus('', 'info'); // æ¸…ç©ºèˆŠçš„ç‹€æ…‹è¨Šæ¯
        progressContainer.classList.remove('hidden');
        // [v575.0 æ–°å¢] é‡è¨­æ“¬çœŸé€²åº¦æ¢
        currentFakeProgress = 0;
        if (progressInterval) clearInterval(progressInterval);
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';

        if (!userProfile) {
          updateStatus('ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Šï¼Œè«‹é‡æ–°è¼‰å…¥é é¢ã€‚', 'error');
          setLoadingState(false);
          // [v567.0 æ–°å¢] ç™¼ç”ŸéŒ¯èª¤æ™‚éš±è—é€²åº¦æ¢
          progressContainer.classList.add('hidden');
          return;
        }

        // 1) å…ˆé©—è­‰æ¡ˆè™Ÿï¼ˆç´”æ•¸å­—ï¼›éæ¡ˆå ´è«‹å¡« 9999ï¼‰
        const cleanProjectId = getValidProjectId();
        if (!cleanProjectId) {
            setLoadingState(false);
            return; // ä¸­æ­¢æäº¤
        }

        const shouldCompress = document.getElementById('compressImages').checked;

        const siteFiles = Array.from(document.getElementById('sitePhotos').files);
        const problemFiles = Array.from(document.getElementById('problemPhotos').files);
        const allPhotosInfo = [
            ...siteFiles.map(file => ({ file, isProblem: false })),
            ...problemFiles.map(file => ({ file, isProblem: true }))
        ];

        const workDescription = document.getElementById('workDescription').value.trim();
        const problemDescription = document.getElementById('problemDescription').value.trim();
        if (allPhotosInfo.length === 0 && !workDescription && !problemDescription) {
            updateStatus('è«‹è‡³å°‘å¡«å¯«æ–½å·¥å…§å®¹æˆ–ä¸Šå‚³ç…§ç‰‡ã€‚', 'error');
            setLoadingState(false);
            // [v567.0 æ–°å¢] ç™¼ç”ŸéŒ¯èª¤æ™‚éš±è—é€²åº¦æ¢
            progressContainer.classList.add('hidden');
            return;
        }

        const batchId = `${userProfile.userId}-${Date.now()}`;
        const SUBMIT_CHUNK_SIZE = 8;
        const totalChunks = Math.ceil(allPhotosInfo.length / SUBMIT_CHUNK_SIZE) || 1;

        const baseFormData = {
            action: 'submitReport',
            batchId,
            totalChunks,
            userId: userProfile.userId,
            userName: userProfile.displayName,
            projectId: cleanProjectId,
            projectNameRaw: cleanProjectId,
            workType: document.getElementById('workType').value,
            workDescription: document.getElementById('workDescription').value,
            problemDescription: document.getElementById('problemDescription').value,
        };

        for (let i = 0; i < totalChunks; i++) {
            try {
                const chunkStart = i * SUBMIT_CHUNK_SIZE;
                const chunkEnd = chunkStart + SUBMIT_CHUNK_SIZE;
                const photoChunk = allPhotosInfo.slice(chunkStart, chunkEnd);

                updateStatus(`æ­£åœ¨è™•ç†ç¬¬ ${i + 1} / ${totalChunks} æ‰¹ç…§ç‰‡...`, 'info');
                const processedPhotos = await processPhotoChunk(photoChunk, shouldCompress);

                // [v575.0 æ–°å¢] ç‚ºç•¶å‰æ‰¹æ¬¡å•Ÿå‹•æ“¬çœŸé€²åº¦å‹•ç•«
                const chunkTargetProgress = Math.round(((i + 1) / totalChunks) * 100);
                startFakeProgress(chunkTargetProgress);
                const chunkFormData = { ...baseFormData, chunkIndex: i + 1, photos: processedPhotos };

                updateStatus(`æ­£åœ¨æäº¤ç¬¬ ${i + 1} / ${totalChunks} æ‰¹è³‡æ–™...`, 'info');
                
                // [v573.0 æ ¸å¿ƒä¿®æ­£] å›æ­¸åˆ°æœ€å¯é çš„ fetch + FormData æ¨¡å¼ï¼Œä»¥å¾¹åº•è§£æ±º CORS å•é¡Œã€‚
                // æ”¾æ£„å³æ™‚é€²åº¦ï¼Œæ”¹å›åˆ†æ‰¹æ¬¡æ›´æ–°é€²åº¦ã€‚
                // ã€æ•ˆèƒ½å„ªåŒ–ã€‘æ”¹é€² FormData å‚³é€æ–¹å¼ï¼Œé¿å… "å¼•æ•¸éå¤§" éŒ¯èª¤ã€‚
                // ä¸å†å°‡æ‰€æœ‰æ±è¥¿ stringify æˆå–®ä¸€ payloadï¼Œè€Œæ˜¯å°‡æ–‡å­—å’Œåœ–ç‰‡è³‡æ–™åˆ†é–‹æ¬„ä½ã€‚
                // é€™éœ€è¦å¾Œç«¯ GAS çš„ doPost å‡½å¼åšç›¸æ‡‰èª¿æ•´ä¾†è§£æã€‚
                const formData = new FormData();
                formData.append('payload', JSON.stringify(chunkFormData));
                // 1. å°‡éæª”æ¡ˆçš„æ–‡å­—è³‡æ–™é€ä¸€é™„åŠ 
                Object.keys(baseFormData).forEach(key => formData.append(key, baseFormData[key]));
                Object.keys(chunkFormData).forEach(key => {
                    if (key !== 'photos') formData.append(key, typeof chunkFormData[key] === 'object' ? JSON.stringify(chunkFormData[key]) : chunkFormData[key]);
                });
                formData.append('chunkIndex', i + 1);
                // 2. åªå°‡åœ–ç‰‡é™£åˆ—ï¼ˆBase64 å­—ä¸²ï¼‰å–®ç¨ stringify å¾Œé™„åŠ 
                formData.append('photos', JSON.stringify(processedPhotos));

                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(`ç¬¬ ${i + 1} æ‰¹è³‡æ–™æäº¤å¤±æ•—ï¼š${result.message || 'å¾Œç«¯å›å ±äº†ä¸€å€‹æœªçŸ¥çš„éŒ¯èª¤ã€‚'}`);
                }

                // [v575.0 ä¿®æ”¹] æ‰¹æ¬¡æˆåŠŸå¾Œï¼Œåœæ­¢å‹•ç•«ä¸¦å°‡é€²åº¦æ¢ç²¾ç¢ºè¨­å®šåˆ°é‡Œç¨‹ç¢‘ä½ç½®
                if (progressInterval) clearInterval(progressInterval);
                updateProgressBar(Math.min(99, chunkTargetProgress));

                // [v469.2 æ ¸å¿ƒä¿®æ­£] åœ¨æ¯å€‹æ‰¹æ¬¡æˆåŠŸæäº¤å¾Œï¼ŒåŠ å…¥ä¸€å€‹çŸ­æš«çš„å»¶é²ï¼Œä»¥é¿å…è§¸ç™¼å¾Œç«¯çš„ 429 é€Ÿç‡é™åˆ¶éŒ¯èª¤ã€‚
                if (i < totalChunks - 1) {
                    await new Promise(resolve => setTimeout(resolve, 500)); // å»¶é² 500 æ¯«ç§’
                }
            } catch (error) {
                console.error('è¡¨å–®è™•ç†å¤±æ•—', error);
                console.log('Caught error in chunk loop, calling setLoadingState(false) and returning.');
                updateStatus(`æäº¤å¤±æ•—ï¼š${error.message}`, 'error');
                // [v575.0 æ–°å¢] å‡ºéŒ¯æ™‚åœæ­¢å‹•ç•«
                if (progressInterval) clearInterval(progressInterval);
                setLoadingState(false);
                // [v567.0 æ–°å¢] ç™¼ç”ŸéŒ¯èª¤æ™‚éš±è—é€²åº¦æ¢
                progressContainer.classList.add('hidden');
                return; // ã€é—œéµä¿®æ­£ã€‘ä¸€æ—¦å‡ºéŒ¯ï¼Œç«‹å³çµ‚æ­¢æ•´å€‹å‡½å¼
            }
        }

        // æ‰€æœ‰æ‰¹æ¬¡éƒ½æˆåŠŸå¾Œï¼Œæ‰åŸ·è¡ŒæˆåŠŸè™•ç†
        console.log('All chunks processed successfully. Calling handleSuccess().');
        // [v568.0 æ–°å¢] åœ¨è·³è½‰åˆ°æˆåŠŸç•«é¢ä¹‹å‰ï¼Œå°‡é€²åº¦æ¢æ¨åˆ° 100%
        updateProgressBar(100);
        handleSuccess();
    }

    // === æˆåŠŸå¾Œè™•ç† ===
    function handleSuccess() {
      // [v454.0 UXå„ªåŒ–] é¡¯ç¤ºæˆåŠŸç•«é¢ï¼Œå–ä»£å–®ç´”çš„æ–‡å­—æç¤º
      console.log('handleSuccess() called. Hiding form and showing success screen.');
      document.getElementById('report-form').style.display = 'none';
      document.getElementById('success-screen').style.display = 'block';
      // submitButton.textContent = 'å·²å®Œæˆ'; // [v568.0] ç§»é™¤æ­¤è¡Œï¼Œå› ç‚ºæŒ‰éˆ•å·²è¢«éš±è—
      // [v567.0 æ–°å¢] æˆåŠŸå¾Œéš±è—é€²åº¦æ¢
      progressContainer.classList.add('hidden');
      submitButton.disabled = true;
      setTimeout(() => {
        if (liff && liff.isInClient()) {
          liff.closeWindow();
        }
      }, 30000); // [v455.0] æ ¹æ“šä½¿ç”¨è€…è¦æ±‚ï¼Œå»¶é•·é—œé–‰æ™‚é–“è‡³ 30 ç§’
    }

    // === å–®æ‰¹ç›¸ç‰‡è™•ç†ï¼ˆå£“ç¸®â†’è½‰ Base64ï¼‰ ===
    async function processPhotoChunk(photoInfoChunk, shouldCompress) {
      const photoArray = [];
      const options = { maxSizeMB: 1, maxWidthOrHeight: 1920, useWebWorker: true };
      for (const photoInfo of photoInfoChunk) {
        let processedFile = photoInfo.file;
        try {
          if (shouldCompress) {
            processedFile = await imageCompression(photoInfo.file, options);
            }
          // ã€v144.0 æ ¸å¿ƒä¿®æ­£ã€‘ç›´æ¥å‘¼å« import çš„å‡½å¼
          const base64 = await readFileAsBase64(processedFile);
          photoArray.push({
            name: photoInfo.file.name,
            type: processedFile.type,
            data: base64,
            isProblem: photoInfo.isProblem
          });
        } catch (error) { // [v456.0 æ ¸å¿ƒä¿®æ­£] å¢åŠ æ˜ç¢ºçš„éŒ¯èª¤å›å ±æ©Ÿåˆ¶
          console.error(`åœ–ç‰‡ ${photoInfo.file.name} è™•ç†å¤±æ•—:`, error);
          throw new Error(`è™•ç†åœ–ç‰‡ "${photoInfo.file.name}" æ™‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ˜¯å¦ææ¯€æˆ–éå¤§ã€‚`);
          }
        }
      return photoArray;
    }

    // === è¼‰å…¥ç‹€æ…‹ ===
    function setLoadingState(isLoading, message = 'è™•ç†ä¸­...') {
      submitButton.disabled = isLoading;
      if (isLoading) {
        buttonText.classList.add('hidden');
        buttonSpinner.classList.remove('hidden');
        updateStatus(message, 'info');
      } else {
        buttonText.classList.remove('hidden');
        buttonSpinner.classList.add('hidden');
        // ç§»é™¤æ­¤è¡Œï¼Œé¿å…åœ¨éŒ¯èª¤ç™¼ç”Ÿå¾Œæ¸…é™¤éŒ¯èª¤è¨Šæ¯ã€‚
        // ç‹€æ…‹è¨Šæ¯çš„æ¸…é™¤æˆ–æ›´æ–°æ‡‰ç”±å‘¼å«è€…æ˜ç¢ºè™•ç†ã€‚
      }
    }

    // [v575.0 æ–°å¢] å•Ÿå‹•æ“¬çœŸé€²åº¦æ¢å‹•ç•«çš„å‡½å¼
    function startFakeProgress(targetPercentage) {
        if (progressInterval) clearInterval(progressInterval);

        progressInterval = setInterval(() => {
            // è®“é€²åº¦ç·©æ…¢å¢åŠ ï¼Œä½†æ°¸é ä¸æœƒè¶…éç›®æ¨™çš„å‰ 1%
            if (currentFakeProgress < targetPercentage - 1) {
                currentFakeProgress++;
                updateProgressBar(currentFakeProgress);
            } else {
                clearInterval(progressInterval);
            }
        }, 250); // æ¯ 250 æ¯«ç§’æ›´æ–°ä¸€æ¬¡ï¼Œé€™å€‹é€Ÿåº¦çœ‹èµ·ä¾†æ¯”è¼ƒèˆ’æœ
    }

    // [v568.0 æ–°å¢] ç¨ç«‹çš„é€²åº¦æ¢æ›´æ–°å‡½å¼
    function updateProgressBar(percentage) {
        progressBar.style.width = `${percentage}%`;
        progressBar.textContent = `${percentage}%`;
    }

    // === ç‹€æ…‹é¡¯ç¤º ===
    function updateStatus(message, type) {
      statusMessage.className = 'text-center mb-4 min-h-[24px]';
      statusMessage.textContent = message;

      if (type === 'success') {
        statusMessage.classList.add('text-green-600', 'font-semibold');
      } else if (type === 'error') {
        statusMessage.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700', 'px-4', 'py-3', 'rounded-lg', 'font-bold');
      } else {
        statusMessage.classList.add('text-gray-600');
      }
    }

    // === æª”æ¡ˆé¸æ“‡ UI ===
    function setupFileInputUI(inputId, labelId, countId) {
      const input = document.getElementById(inputId);
      const label = document.getElementById(labelId);
      const count = document.getElementById(countId);
      input.addEventListener('change', () => {
        if (input.files.length > 0) {
          label.classList.add('selected');
          count.textContent = `å·²é¸æ“‡ ${input.files.length} å¼µç…§ç‰‡`;
        } else {
          label.classList.remove('selected');
          count.textContent = 'æœªé¸å–æª”æ¡ˆ';
        }
      });
    }

    main();
  });
</script>
</body>
</html>
