<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÊñΩÂ∑•Êó•Ë™åÁîüÊàêÂô® | TianXin Site Report</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0891b2', // Cyan 600
                        secondary: '#164e63', // Cyan 900
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }

        .canvas-preview {
            max-width: 100%;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { Camera, Image: ImageIcon, Download, Share2, Calendar, CloudSun, MapPin, Hammer, CheckSquare, Trash2, Plus, FileStack } = lucide;

        // --- È†êË®≠Ë≥áÊñô ---
        const DEFAULT_TAGS = ['ÊãÜÈô§Â∑•Á®ã', 'Ê∞¥ÈõªÈÖçÁÆ°', 'Ê≥•‰ΩúÊâìÂ∫ï', 'Èò≤Ê∞¥ÊñΩ‰Ωú', 'Êú®Â∑•ÈÄ≤Â†¥', 'Ê≤πÊºÜÁ≤âÂà∑', 'Á≥ªÁµ±Ê´ÉÂÆâË£ù', 'Ê∏ÖÊΩî', 'È©óÊî∂', 'ÊùêÊñôÈÄ≤Â†¥', 'ÊñΩÂ∑•‰øùË≠∑'];
        const WEATHER_OPTIONS = ['‚òÄÔ∏è Êô¥Êúó', '‚õÖ Â§öÈõ≤', '‚òÅÔ∏è Èô∞Â§©', 'üåßÔ∏è Èõ®Â§©', '‚õàÔ∏è Èõ∑Èõ®'];
        const PHOTOS_PER_PAGE = 4;

        function App() {
            // --- ÁãÄÊÖãÁÆ°ÁêÜ ---
            const [projectName, setProjectName] = useState(() => localStorage.getItem('site_report_project') || '');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [weather, setWeather] = useState('‚òÄÔ∏è Êô¥Êúó');
            const [stage, setStage] = useState('ÊñΩÂ∑•‰∏≠');
            const [photos, setPhotos] = useState([]); // Array of dataURLs
            const [tags, setTags] = useState([]);
            const [notes, setNotes] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);
            const [previewUrls, setPreviewUrls] = useState([]); // Array of generated page images

            // ÂÑ≤Â≠òÂ∏∏Áî®Ë®≠ÂÆö
            useEffect(() => {
                localStorage.setItem('site_report_project', projectName);
            }, [projectName]);

            // --- ÁÖßÁâáËôïÁêÜ ---
            const handlePhotoUpload = (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        setPhotos(prev => [...prev, ev.target.result]);
                    };
                    reader.readAsDataURL(file);
                });
            };

            const removePhoto = (index) => {
                setPhotos(prev => prev.filter((_, i) => i !== index));
            };

            // --- Ê®ôÁ±§ËôïÁêÜ ---
            const toggleTag = (tag) => {
                setTags(prev =>
                    prev.includes(tag) ? prev.filter(t => t !== tag) : [...prev, tag]
                );
            };

            // --- Ê†∏ÂøÉÔºöÁîüÊàêÂ§öÈ†ÅÂúñÁâá ---
            const generateReport = async () => {
                setIsGenerating(true);
                setPreviewUrls([]); // Clear previous

                // ÊâπÊ¨°ËôïÁêÜÔºöÂ∞áÁÖßÁâáÂàÜÈ†Å
                const pages = [];
                const photoChunks = [];

                if (photos.length === 0) {
                    photoChunks.push([]); // Á©∫È†Å
                } else {
                    for (let i = 0; i < photos.length; i += PHOTOS_PER_PAGE) {
                        photoChunks.push(photos.slice(i, i + PHOTOS_PER_PAGE));
                    }
                }

                // ‰æùÂ∫èÁîüÊàêÊØè‰∏ÄÈ†Å
                setTimeout(async () => {
                    try {
                        const totalPages = photoChunks.length;
                        const newUrls = [];

                        for (let i = 0; i < totalPages; i++) {
                            const dataUrl = await renderPageCanvas(photoChunks[i], i + 1, totalPages);
                            newUrls.push(dataUrl);
                        }

                        setPreviewUrls(newUrls);
                    } catch (e) {
                        console.error("Generate error:", e);
                        alert("ÁîüÊàêÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶");
                    } finally {
                        setIsGenerating(false);
                    }
                }, 100);
            };

            const renderPageCanvas = (pagePhotos, pageNum, totalPages) => {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const W = 1200;
                    const H = 1600;
                    canvas.width = W;
                    canvas.height = H;

                    // 1. ËÉåÊôØ
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, W, H);

                    // 2. Header
                    ctx.fillStyle = '#0891b2';
                    ctx.fillRect(0, 0, W, 120);

                    // Logo ÊñáÂ≠ó
                    ctx.fillStyle = '#ffffff';
                    ctx.font = 'bold 48px "Noto Sans TC"';
                    ctx.textAlign = 'left';
                    ctx.fillText('Ê∑ªÂøÉÂÆ§ÂÖßË£ù‰øÆË®≠Ë®à', 40, 75);

                    // Ê®ôÈ°å
                    ctx.font = '32px "Noto Sans TC"';
                    ctx.textAlign = 'right';
                    ctx.fillText('ÊñΩÂ∑•Êó•Â†±Ë°® Site Report', W - 40, 75);

                    // 3. Â∞àÊ°àË≥áË®äÊ¨Ñ
                    ctx.fillStyle = '#f0f9ff';
                    ctx.fillRect(40, 140, W - 80, 100);

                    ctx.fillStyle = '#164e63';
                    ctx.font = 'bold 36px "Noto Sans TC"';
                    ctx.textAlign = 'left';
                    ctx.fillText(projectName || 'Êú™ÂëΩÂêçÂ∞àÊ°à', 60, 200);

                    ctx.font = '28px "Noto Sans TC"';
                    ctx.fillStyle = '#555';
                    const infoText = `${date}  |  ${weather}  |  ${stage}`;
                    ctx.textAlign = 'right';
                    ctx.fillText(infoText, W - 60, 200);

                    // 4. ÁÖßÁâáÊãºË≤º
                    const photoAreaY = 260;
                    const photoAreaH = 900;
                    const gap = 20;

                    const drawStart = () => {
                        // 5. Â∫ïÈÉ®Ë≥áË®ä (ÂÉÖÂú®Á¨¨‰∏ÄÈ†ÅÈ°ØÁ§∫ÂÆåÊï¥Â∑•È†ÖÔºåÊàñÊØèÈ†ÅÈÉΩÈ°ØÁ§∫ÔºüÈÄôË£°ÈÅ∏ÊìáÊØèÈ†ÅÈÉΩÈ°ØÁ§∫‰ΩÜÊ®ôË®ªÈ†ÅÁ¢º)
                        drawFooter(ctx, W, H, pageNum, totalPages);
                        resolve(canvas.toDataURL('image/jpeg', 0.85));
                    };

                    if (pagePhotos.length > 0) {
                        const loadImg = (src) => new Promise(res => {
                            const img = new Image();
                            img.onload = () => res(img);
                            img.src = src;
                        });

                        Promise.all(pagePhotos.map(loadImg)).then(imgs => {
                            // Ê†πÊìöÊï∏ÈáèÊéíÁâà (ÊúÄÂ§ö4Âºµ)
                            if (imgs.length === 1) {
                                drawPhoto(ctx, imgs[0], 40, photoAreaY, W - 80, photoAreaH);
                            } else if (imgs.length === 2) {
                                const w = (W - 80 - gap) / 2;
                                drawPhoto(ctx, imgs[0], 40, photoAreaY, w, photoAreaH);
                                drawPhoto(ctx, imgs[1], 40 + w + gap, photoAreaY, w, photoAreaH);
                            } else if (imgs.length === 3) {
                                const w1 = (W - 80 - gap) * 0.6;
                                const w2 = (W - 80 - gap) * 0.4;
                                const h2 = (photoAreaH - gap) / 2;
                                drawPhoto(ctx, imgs[0], 40, photoAreaY, w1, photoAreaH);
                                drawPhoto(ctx, imgs[1], 40 + w1 + gap, photoAreaY, w2, h2);
                                drawPhoto(ctx, imgs[2], 40 + w1 + gap, photoAreaY + h2 + gap, w2, h2);
                            } else {
                                // 4ÂºµÁî∞Â≠óÂûã
                                const w = (W - 80 - gap) / 2;
                                const h = (photoAreaH - gap) / 2;
                                drawPhoto(ctx, imgs[0], 40, photoAreaY, w, h);
                                drawPhoto(ctx, imgs[1], 40 + w + gap, photoAreaY, w, h);
                                drawPhoto(ctx, imgs[2], 40, photoAreaY + h + gap, w, h);
                                drawPhoto(ctx, imgs[3], 40 + w + gap, photoAreaY + h + gap, w, h);
                            }
                            drawStart();
                        });
                    } else {
                        // ÁÑ°ÁÖßÁâá
                        ctx.fillStyle = '#eee';
                        ctx.fillRect(40, photoAreaY, W - 80, photoAreaH);
                        ctx.fillStyle = '#aaa';
                        ctx.font = '30px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('Ê≠§È†ÅÁÑ°ÁÖßÁâá', W / 2, photoAreaY + photoAreaH / 2);
                        drawStart();
                    }
                });
            };

            const drawPhoto = (ctx, img, x, y, w, h) => {
                ctx.save();
                ctx.beginPath();
                ctx.roundRect(x, y, w, h, 10);
                ctx.clip();

                const ratio = Math.max(w / img.width, h / img.height);
                const drawW = img.width * ratio;
                const drawH = img.height * ratio;
                const drawX = x + (w - drawW) / 2;
                const drawY = y + (h - drawH) / 2;

                ctx.drawImage(img, drawX, drawY, drawW, drawH);
                ctx.restore();

                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 4;
                ctx.strokeRect(x, y, w, h);
            };

            const drawFooter = (ctx, W, H, pageNum, totalPages) => {
                const footerY = 1200;

                // --- ‰ªäÊó•Â∑•È†Ö ---
                ctx.textAlign = 'left';
                ctx.fillStyle = '#0891b2';
                ctx.font = 'bold 32px "Noto Sans TC"';
                ctx.fillText('‚úÖ ‰ªäÊó•Â∑•È†Ö', 40, footerY + 40);

                ctx.font = '28px "Noto Sans TC"';
                ctx.fillStyle = '#333';
                const tagText = tags.length > 0 ? tags.join('„ÄÅ') : '‰ªäÊó•ÁÑ°ÁâπÊÆäÂ∑•È†ÖÁ¥ÄÈåÑ';
                wrapText(ctx, tagText, 40, footerY + 90, W - 80, 40);

                // --- ÂÇôË®ª ---
                ctx.fillStyle = '#0891b2';
                ctx.font = 'bold 32px "Noto Sans TC"';
                ctx.fillText('üìù ÊñΩÂ∑•ÂÇôË®ª', 40, footerY + 160);

                ctx.font = '28px "Noto Sans TC"';
                ctx.fillStyle = '#555';
                const noteText = notes || 'ÁÑ°Ë£úÂÖÖ‰∫ãÈ†Ö„ÄÇ';
                wrapText(ctx, noteText, 40, footerY + 210, W - 80, 40);

                // --- È†ÅÁ¢ºËàáÁâàÊ¨ä ---
                ctx.fillStyle = 'rgba(8, 145, 178, 0.1)';
                ctx.fillRect(0, H - 60, W, 60);

                ctx.fillStyle = '#0891b2';
                ctx.font = '20px "Noto Sans TC"';
                ctx.textAlign = 'center';
                ctx.fillText(`Powered by Ê∑ªÂøÉÊô∫ËÉΩÊó•Â†±Áî¢ÁîüÂô® | Page ${pageNum} of ${totalPages}`, W / 2, H - 22);
            };

            const wrapText = (ctx, text, x, y, maxWidth, lineHeight) => {
                const words = text.split('');
                let line = '';
                let currentY = y;
                for (let n = 0; n < words.length; n++) {
                    const testLine = line + words[n];
                    const metrics = ctx.measureText(testLine);
                    const testWidth = metrics.width;
                    if (testWidth > maxWidth && n > 0) {
                        ctx.fillText(line, x, currentY);
                        line = words[n];
                        currentY += lineHeight;
                    } else {
                        line = testLine;
                    }
                }
                ctx.fillText(line, x, currentY);
            };

            const downloadAll = () => {
                previewUrls.forEach((url, idx) => {
                    const link = document.createElement('a');
                    link.download = `${date}_ÊñΩÂ∑•Êó•Â†±_${projectName}_P${idx + 1}.jpg`;
                    link.href = url;
                    link.click();
                });
            };

            // ÂàùÂßãÂåñ Lucide icon
            useEffect(() => { lucide.createIcons(); }, [photos, tags, previewUrls, isGenerating]);

            return (
                <div className="max-w-md mx-auto min-h-screen bg-white shadow-2xl overflow-hidden">
                    {/* Header */}
                    <div className="bg-primary px-6 py-5 text-white flex justify-between items-center sticky top-0 z-50 shadow-md">
                        <h1 className="text-xl font-bold flex items-center gap-2">
                            <i data-lucide="file-stack" className="w-5 h-5"></i>
                            ÊñΩÂ∑•Êó•Â†±ÁîüÊàêÂô® V2
                        </h1>
                    </div>

                    <div className="p-5 space-y-6 pb-32">
                        {/* 1. Âü∫Êú¨Ë≥áË®ä */}
                        <section className="space-y-3">
                            <label className="block text-sm font-medium text-gray-700">Â∞àÊ°àÂêçÁ®±</label>
                            <input
                                type="text"
                                value={projectName}
                                onChange={(e) => setProjectName(e.target.value)}
                                placeholder="‰æãÂ¶ÇÔºöÂè∞ÂçóÈô≥ÂÖ¨È§®"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary outline-none"
                            />

                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Êó•Êúü</label>
                                    <input
                                        type="date"
                                        value={date}
                                        onChange={(e) => setDate(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Â§©Ê∞£</label>
                                    <select
                                        value={weather}
                                        onChange={(e) => setWeather(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                    >
                                        {WEATHER_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}
                                    </select>
                                </div>
                            </div>
                        </section>

                        {/* 2. ÁÖßÁâá‰∏äÂÇ≥ */}
                        <section>
                            <label className="block text-sm font-medium text-gray-700 mb-2 flex justify-between">
                                <span>ÊñΩÂ∑•ÁÖßÁâá ({photos.length})</span>
                                <span className="text-xs text-blue-500 bg-blue-50 px-2 py-0.5 rounded-full">
                                    {Math.ceil(photos.length / PHOTOS_PER_PAGE) || 1} È†Å
                                </span>
                            </label>

                            <div className="grid grid-cols-3 gap-2">
                                {photos.map((src, idx) => (
                                    <div key={idx} className="relative aspect-square rounded-lg overflow-hidden group shadow-sm bg-gray-100 border border-gray-200">
                                        <img src={src} className="w-full h-full object-cover" />
                                        <button
                                            onClick={() => removePhoto(idx)}
                                            className="absolute top-1 right-1 bg-red-500 text-white p-0.5 rounded-full opacity-90 shadow-lg"
                                        >
                                            <i data-lucide="trash-2" className="w-3 h-3"></i>
                                        </button>
                                        <div className="absolute bottom-0 left-0 bg-black/50 text-white text-[10px] px-1.5 py-0.5 rounded-tr-lg">
                                            P{Math.floor(idx / 4) + 1}
                                        </div>
                                    </div>
                                ))}

                                <label className="aspect-square border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center text-gray-400 cursor-pointer hover:border-primary hover:text-primary transition-colors bg-gray-50 hover:bg-white">
                                    <i data-lucide="plus" className="w-6 h-6 mb-1"></i>
                                    <span className="text-[10px]">Êñ∞Â¢û</span>
                                    <input type="file" accept="image/*" multiple className="hidden" onChange={handlePhotoUpload} />
                                </label>
                            </div>
                        </section>

                        {/* 3. ‰ªäÊó•Â∑•È†Ö */}
                        <section>
                            <label className="block text-sm font-medium text-gray-700 mb-2">‰ªäÊó•Â∑•È†Ö</label>
                            <div className="flex flex-wrap gap-2">
                                {DEFAULT_TAGS.map(tag => (
                                    <button
                                        key={tag}
                                        onClick={() => toggleTag(tag)}
                                        className={`px-3 py-1.5 rounded-full text-xs font-medium transition-all ${tags.includes(tag)
                                                ? 'bg-secondary text-white shadow-md'
                                                : 'bg-white border border-gray-200 text-gray-600 hover:bg-gray-50'
                                            }`}
                                    >
                                        {tag}
                                    </button>
                                ))}
                            </div>
                        </section>

                        {/* 4. ÂÇôË®ª */}
                        <section>
                            <label className="block text-sm font-medium text-gray-700 mb-2">ÊñΩÂ∑•ÂÇôË®ª</label>
                            <textarea
                                rows="3"
                                value={notes}
                                onChange={(e) => setNotes(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary outline-none"
                            ></textarea>
                        </section>

                        {/* 5. È†êË¶ΩËàá‰∏ãËºâ */}
                        <div className="border-t border-gray-200 pt-6">
                            <button
                                onClick={generateReport}
                                disabled={isGenerating}
                                className="w-full bg-secondary text-white py-3 rounded-xl font-bold text-lg shadow-lg hover:bg-opacity-90 active:scale-95 transition-all flex justify-center items-center gap-2"
                            >
                                {isGenerating ? 'Ê≠£Âú®ÊãºË≤º‰∏≠...' : `‚ú® ÁîüÊàê ${Math.ceil(photos.length / 4) || 1} ÂºµÊó•Â†±`}
                            </button>

                            {previewUrls.length > 0 && (
                                <div className="mt-8 space-y-8 animate-fade-in">
                                    <div className="flex justify-between items-center">
                                        <h3 className="font-bold text-gray-800">È†êË¶ΩÁµêÊûú ({previewUrls.length}È†Å)</h3>
                                        <button onClick={downloadAll} className="bg-green-600 text-white px-3 py-1.5 rounded-lg text-sm flex items-center gap-1 shadow-sm hover:bg-green-700">
                                            <i data-lucide="download" className="w-4 h-4"></i> ‰∏ãËºâÂÖ®ÈÉ®
                                        </button>
                                    </div>

                                    <div className="space-y-6">
                                        {previewUrls.map((url, idx) => (
                                            <div key={idx} className="bg-gray-100 p-2 rounded-xl border border-gray-200 shadow-inner">
                                                <div className="mb-2 flex justify-between px-1">
                                                    <span className="text-xs font-bold text-gray-500">Page {idx + 1}</span>
                                                </div>
                                                <img src={url} className="w-full rounded-lg shadow-md border border-white" />
                                                <a
                                                    href={url}
                                                    download={`${date}_ÊñΩÂ∑•Êó•Â†±_${projectName}_P${idx + 1}.jpg`}
                                                    className="mt-2 block w-full bg-white border border-gray-300 text-gray-700 text-center py-2 rounded-lg text-sm hover:bg-gray-50 font-medium"
                                                >
                                                    ‰∏ãËºâÊ≠§È†Å (Page {idx + 1})
                                                </a>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>