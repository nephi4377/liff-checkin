# 員工工作排程系統 (WMS) 完整開發計劃書

> 最後更新：2026-01-04 ｜ 圖例：✅ 已實現 ⏳ 開發中 ⬜ 未實現

## 1. 系統定位
專為「添心室內裝修」設計，解決多專案併行、工期聯動推移、以及人力資源重疊（並行任務）的調度平台。

---

## 2. 資料對接架構 (Existing System Integration)

系統不重新建立員工清單，而是透過 GAS 讀取原有的 Sheet。

| 功能 | 說明 | 狀態 |
|-----|------|:----:|
| **員工資料對接** | 透過 GAS 調用員工姓名、組別、職級（參考 `CheckinSystem`） | ⬜ |
| **案場資料對接** | 同步案場編號與地點，排程時下拉選取（參考 `project-console`） | ⬜ |

---

## 3. 核心概念設計 (Core Concepts)

### 🔷 雙層架構：負責案件 + 交辦任務

WMS 採用**雙層架構**來管理工作：

```
📁 負責案件 (Assignments)
│   └─ 員工被指派負責的專案
│   └─ 例如：黃俊豪 → 負責 #756 陳公館、#720 林宅
│
📋 交辦任務 (Tasks)
    └─ 具體的工作行程，有明確的時間地點
    └─ 例如：1/5 08:00-12:00 場勘丈量 @台南東區
```

### A. 負責案件 (Assignments)

| 項目 | 說明 | 狀態 |
|-----|------|:----:|
| **來源** | 從 project-console 的案場資料自動同步 | ⬜ |
| **指派方式** | 管理員指派員工負責某案場 | ⬜ |
| **顯示位置** | 頁面頂部的標籤列 (pill tags) | ⏳ 需調整 |
| **狀態** | 進行中 / 已完成 | ⬜ |
| **用途** | 快速查看「我負責哪些案子」 | ⏳ 需調整 |

### B. 交辦任務 (Tasks)

#### 🔄 新設計：開始日期 + 工作天數

任務**不記錄結束時間**，改為記錄「需要多少工作天」。結束日期由系統自動計算。

| 欄位 | 說明 | 狀態 |
|------|------|:----:|
| `startDate` | 任務開始日期 | ⬜ 需調整 |
| `workDays` | **需要的工作天數** (可含小數, 如 0.5) | ⬜ 新增 |
| ~~`endDate`~~ | ~~結束日期~~ → 由系統計算，不儲存 | ⬜ 移除 |
| `projectId` | 關聯案場 | ✅ |
| `type` | 任務類別（設計/工務/通用） | ✅ |
| `assignedTo` | 負責員工 | ✅ |
| `status` | 待處理 → 進行中 → 已完成 | ✅ |
| `notes` | 備註 | ✅ |

#### 📅 結束日期計算邏輯

```
實際結束日期 = 開始日期 + 工作天數 + 被插單的總時間
```

#### 🔀 插單順延機制

**情境**：#731 木作工程 (1/4 開始，需 10 工作天)，1/8 插單去 #747 協助 (0.5 天)

```
原計劃：
  1/4  1/5  1/6  1/7  1/8  1/9  ...  1/17 (10天)
  [#731 ─────────────────────────────────]

插單後：
  1/4  1/5  1/6  1/7  1/8       1/9  ...  1/17  1/18
  [#731 ───────────── ] [#747]  [#731 剩餘 ───────]
                        0.5天   自動順延
```

**計算結果**：
- #731 實際工時 = 10 天 (不變)
- #731 完成日 = 1/4 + 10 + 0.5 = 1/18 (順延半天)

#### ⚠️ 衝突判斷規則

| 情況 | 判定 | 處理方式 |
|------|------|---------|
| 開始日期 **相同** | **衝突** | 提示使用者決定順序 |
| 開始日期 **不同** | **插入** | 自動順延原任務 |

#### 📊 日曆顯示方式

- **多天任務**：每天顯示一個區塊，標示「進行中」
- **插單當天**：顯示插單任務，原任務暫停不顯示
- **顯示內容**：任務名稱 + 剩餘天數（如「木作工程 剩6天」）

---

### C. 任務類別詳細表

| 部門 | 類別 | 說明 |
|------|------|------|
| **設計** | 平面規劃 | 繪製平面配置圖 |
| **設計** | 3D繪圖 | 製作 3D 效果圖 |
| **設計** | 報價製作 | 製作估價單 |
| **設計** | 客戶溝通 | 與客戶討論需求/修改 |
| **設計** | 材料確認 | 確認建材樣式/顏色 |
| **工務** | 場勘 | 現場丈量與勘查 |
| **工務** | 放樣 | 現場放樣定位 |
| **工務** | 拆除 | 舊裝潢拆除 |
| **工務** | 水電 | 水電配管拉線 |
| **工務** | 木作 | 木工施作 |
| **工務** | 油漆 | 批土/上漆 |
| **工務** | 系統櫃 | 系統櫃安裝 |
| **工務** | 驗收 | 完工驗收/交屋 |
| **通用** | 會議 | 內部會議/外部協調 |
| **通用** | 採購 | 材料/設備採購 |
| **通用** | 其他 | 其他雜項 |

---

### D. 負責案件 vs 交辦任務 關係

```
員工 ──(1:N)──► 負責案件 ──(1:N)──► 交辦任務
                   │
                   └──► 可獨立查看「案件進度」
```

- **負責案件**：追蹤員工的工作範圍（負責哪些案子）
- **交辦任務**：追蹤具體行程（開始日期 + 工作天數）

---

## 4. 核心功能模組

### A. 智慧推移演算法 (Smart Shifting)

| 功能 | 說明 | 狀態 | 備註 |
|-----|------|:----:|------|
| **衝突偵測** | 偵測同一員工時間重疊的任務 | ✅ | 側欄警告列表 |
| **延誤預警** | 顯示已過預定時間的任務 | ✅ | |
| **推移建議** | 提供時間衝突的推移方案 | ✅ | 手動套用/全部套用 |
| **自動連鎖推移** | 插單後自動重算後續任務時間 | ⬜ | 目前需手動套用 |
| **跨日轉移** | 超過 18:00 自動轉至隔日 09:00 | ⬜ | |

### B. 視覺化界面

| 功能 | 說明 | 狀態 | 備註 |
|-----|------|:----:|------|
| **個人週視圖** | Apple 日曆風格，時間軸 + 任務長條 | ✅ | |
| **組別總覽** | 依組別分群顯示今日任務 | ✅ | |
| **甘特圖模式** | 依案場查看所有工種進度 | ✅ | |
| **熱點圖模式** | 查看員工負載，避免過度操勞 | ✅ | |
| **負責案件標籤列** | 長期任務簡潔顯示 | ✅ | +N 摺疊展開 |
| **歷史導出** | 一鍵導出案場工期記錄 CSV | ✅ | |

### C. 互動操作

| 功能 | 說明 | 狀態 | 備註 |
|-----|------|:----:|------|
| **新增/編輯/刪除任務** | Modal 表單完整流程 | ✅ | |
| **拖放變更日期** | 拖曳任務卡片到不同日期 | ✅ | HTML5 拖放 |
| **底部手柄調整時長** | 拉動調整結束時間 | ✅ | 15分鐘對齊、即時預覽 |
| **任務狀態切換** | 待處理→進行中→已完成 | ✅ | 點擊圖示切換 |
| **觸控拖放** | 手機/平板觸控支援 | ⬜ | HTML5 拖放不支援觸控 |

---

## 5. 技術實施路徑 (Roadmap)

### Phase 1: 環境配置

| 項目 | 狀態 |
|-----|:----:|
| 建立 Google Sheet 緩衝表（儲存任務記錄） | ⬜ |
| 編寫 GAS API 連接原有員工資料表 | ⬜ |
| 定義 JSON 資料交換格式 | ⬜ |

### Phase 2: 前端開發

| 項目 | 狀態 |
|-----|:----:|
| 開發響應式網頁（Vue.js） | ✅ |
| 實作「個人週視圖」與「組別總覽」 | ✅ |
| 設計「拖拉式」任務塊 | ✅ |
| 響應式優化（行動裝置） | ⬜ |

### Phase 3: 推移演算法與並行控制

| 項目 | 狀態 |
|-----|:----:|
| 處理 5 項任務並行的排版演算法 | ⬜ |
| 任務插入後的自動推移邏輯 | ⬜ |
| 週期性任務自動生成 | ✅ |

### Phase 4: 整合測試與上線

| 項目 | 狀態 |
|-----|:----:|
| 對接實際工作流 | ⬜ |
| 多裝置測試 | ⬜ |

---

## 6. 安全與權限控制

| 角色 | 權限說明 | 狀態 | 備註 |
|-----|---------|:----:|------|
| **管理員 (總監)** | 擁有全案場、全人員調度權 | ⬜ | 僅 UI 顯示，未驗證 |
| **組長** | 可調整該組內員工任務 | ⬜ | |
| **一般員工** | 僅查看、完成任務、上傳照片 | ⬜ | |
| **LINE LIFF 登入** | 身份驗證整合 | ⬜ | |

---

## 7. 未來擴展性

| 功能 | 說明 | 狀態 | 優先級 |
|-----|------|:----:|:-----:|
| **自動預警 Email** | 案場延誤超過 3 天自動通知 | ⬜ | 🟢 低 |
| **工時統計報表** | 計算每專案人力成本 | ⬜ | 🟢 低 |
| **任務完成上傳照片** | 施工現場快照 | ⬜ | 🟢 低 |