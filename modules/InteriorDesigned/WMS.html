<!DOCTYPE html>
<html lang="zh-TW">
<!-- WMS v1.0 - 2025-12-30 - å“¡å·¥å·¥ä½œæ’ç¨‹ç³»çµ± MVP -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·»å¿ƒè£ä¿® - å“¡å·¥å·¥ä½œæ’ç¨‹ç³»çµ± WMS</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
        }

        [v-cloak] {
            display: none !important;
        }

        .task-block {
            transition: all 0.2s;
            cursor: grab;
        }

        .task-block:active {
            cursor: grabbing;
        }

        .time-slot {
            min-height: 60px;
            border-bottom: 1px solid #e5e7eb;
        }

        .time-slot:hover {
            background-color: #f0f9ff;
        }

        .task-type-å ´å‹˜ {
            background: #fef3c7;
            border-left-color: #f59e0b;
        }

        .task-type-æ”¾æ¨£ {
            background: #dbeafe;
            border-left-color: #3b82f6;
        }

        .task-type-æ‹†é™¤ {
            background: #fee2e2;
            border-left-color: #ef4444;
        }

        .task-type-æ°´é›» {
            background: #d1fae5;
            border-left-color: #10b981;
        }

        .task-type-æœ¨ä½œ {
            background: #fce7f3;
            border-left-color: #ec4899;
        }

        .task-type-æ²¹æ¼† {
            background: #e0e7ff;
            border-left-color: #6366f1;
        }

        .task-type-ç³»çµ±æ«ƒ {
            background: #f3e8ff;
            border-left-color: #a855f7;
        }

        .task-type-é©—æ”¶ {
            background: #ccfbf1;
            border-left-color: #14b8a6;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <div id="app" v-cloak class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-4 shadow-lg">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <i class="ph ph-calendar-check text-3xl"></i>
                    <div>
                        <h1 class="text-xl font-bold">å“¡å·¥å·¥ä½œæ’ç¨‹ç³»çµ±</h1>
                        <span class="text-xs text-indigo-200">æ·»å¿ƒå®¤å…§è£ä¿® WMS v1.0</span>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <!-- è¦–åœ–åˆ‡æ› -->
                    <div class="flex bg-white/20 rounded-lg p-1">
                        <button v-for="v in ['week','team','gantt','heatmap']" :key="v" @click="currentView = v"
                            :class="currentView === v ? 'bg-white text-indigo-600' : 'text-white hover:bg-white/10'"
                            class="px-3 py-1 rounded text-sm font-medium transition-colors">
                            {{ {week:'é€±è¦–åœ–',team:'çµ„åˆ¥',gantt:'ç”˜ç‰¹åœ–',heatmap:'ç†±é»'}[v] }}
                        </button>
                    </div>
                    <!-- æ—¥æœŸé¸æ“‡ -->
                    <div class="flex items-center gap-2 bg-white/20 rounded-lg px-3 py-1">
                        <button @click="changeWeek(-1)" class="hover:bg-white/20 p-1 rounded"><i
                                class="ph ph-caret-left"></i></button>
                        <span class="text-sm font-medium">{{ weekLabel }}</span>
                        <button @click="changeWeek(1)" class="hover:bg-white/20 p-1 rounded"><i
                                class="ph ph-caret-right"></i></button>
                        <button @click="goToToday"
                            class="ml-2 text-xs bg-white/30 px-2 py-0.5 rounded hover:bg-white/40">ä»Šå¤©</button>
                    </div>
                    <!-- ç•¶å‰ç”¨æˆ¶ -->
                    <div class="flex items-center gap-2 bg-white/20 rounded-lg px-3 py-2">
                        <i class="ph ph-user-circle text-xl"></i>
                        <select v-model="currentUserId" class="bg-transparent text-sm font-medium outline-none">
                            <option v-for="emp in employees" :key="emp.id" :value="emp.id" class="text-gray-800">{{
                                emp.name }}</option>
                        </select>
                    </div>
                </div>
            </div>
        </header>

        <!-- é™¤éŒ¯é¢æ¿ -->
        <div v-if="debugMode" class="bg-gray-900 text-green-400 text-xs font-mono">
            <div class="flex items-center justify-between px-4 py-2 border-b border-gray-700">
                <span class="font-bold">ğŸ”§ API é™¤éŒ¯é¢æ¿</span>
                <div class="flex gap-2">
                    <span v-if="debugData.loading" class="text-yellow-400">â³ è¼‰å…¥ä¸­...</span>
                    <span v-else class="text-green-400">âœ… è¼‰å…¥å®Œæˆ</span>
                    <button @click="loadApiData"
                        class="px-2 py-0.5 bg-blue-600 text-white rounded hover:bg-blue-700">é‡æ–°è¼‰å…¥</button>
                    <button @click="debugMode = false"
                        class="px-2 py-0.5 bg-gray-600 text-white rounded hover:bg-gray-700">é—œé–‰</button>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 p-4 max-h-64 overflow-auto">
                <!-- å“¡å·¥è³‡æ–™ -->
                <div>
                    <div class="text-yellow-400 font-bold mb-1">ğŸ‘¥ å“¡å·¥è³‡æ–™ ({{ employees.length }} äºº)</div>
                    <pre
                        class="bg-gray-800 p-2 rounded overflow-auto max-h-48">{{ JSON.stringify(debugData.employeesRaw, null, 2) }}</pre>
                </div>
                <!-- æ¡ˆå ´è³‡æ–™ -->
                <div>
                    <div class="text-yellow-400 font-bold mb-1">ğŸ  æ¡ˆå ´è³‡æ–™ ({{ projects.length }} å€‹)</div>
                    <pre
                        class="bg-gray-800 p-2 rounded overflow-auto max-h-48">{{ JSON.stringify(debugData.projectsRaw, null, 2) }}</pre>
                </div>
            </div>
            <!-- éŒ¯èª¤è¨Šæ¯ -->
            <div v-if="debugData.errors.length" class="px-4 pb-2">
                <div class="text-red-400 font-bold">âŒ éŒ¯èª¤è¨Šæ¯</div>
                <div v-for="err in debugData.errors" :key="err" class="text-red-300">{{ err }}</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar -->
            <aside class="w-72 bg-white border-r border-gray-200 p-4 overflow-y-auto">
                <!-- æ¬Šé™é¡¯ç¤º -->
                <div class="mb-4 p-2 rounded-lg text-xs"
                    :class="currentUserRole === 'admin' ? 'bg-purple-100 text-purple-700' : currentUserRole === 'leader' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'">
                    <i class="ph ph-shield-check mr-1"></i>
                    {{ {admin: 'ç®¡ç†å“¡', leader: 'çµ„é•·', worker: 'ä¸€èˆ¬å“¡å·¥'}[currentUserRole] }}
                </div>

                <!-- æ–°å¢ä»»å‹™æŒ‰éˆ• -->
                <button @click="openTaskModal()" v-if="currentUserRole !== 'worker'"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold mb-4 flex items-center justify-center gap-2 shadow-md">
                    <i class="ph ph-plus-circle text-xl"></i> æ–°å¢ä»»å‹™
                </button>

                <!-- ç¯©é¸å€ -->
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">æ¡ˆå ´ç¯©é¸</label>
                        <select v-model="filterProject" class="w-full border rounded-lg p-2 text-sm">
                            <option value="">å…¨éƒ¨æ¡ˆå ´</option>
                            <option v-for="p in projects" :key="p.id" :value="p.id">{{ p.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">ä»»å‹™é¡å‹</label>
                        <div class="space-y-2">
                            <template v-for="(types, group) in taskTypeGroups" :key="group">
                                <div class="text-xs text-gray-400 font-medium">{{ group }}</div>
                                <div class="flex flex-wrap gap-1">
                                    <button v-for="t in types" :key="t" @click="toggleTypeFilter(t)"
                                        :class="filterTypes.includes(t) ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600'"
                                        class="px-2 py-1 rounded text-xs transition-colors">{{ t }}</button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- ä»Šæ—¥æ‘˜è¦ -->
                <div class="mt-6 p-4 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl">
                    <h3 class="font-bold text-indigo-800 mb-2"><i class="ph ph-chart-pie mr-1"></i>ä»Šæ—¥æ‘˜è¦</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span class="text-gray-600">å¾…è™•ç†</span><span
                                class="font-bold text-orange-600">{{ todaySummary.pending }}</span></div>
                        <div class="flex justify-between"><span class="text-gray-600">é€²è¡Œä¸­</span><span
                                class="font-bold text-blue-600">{{ todaySummary.inProgress }}</span></div>
                        <div class="flex justify-between"><span class="text-gray-600">å·²å®Œæˆ</span><span
                                class="font-bold text-green-600">{{ todaySummary.completed }}</span></div>
                    </div>
                </div>

                <!-- è¡çªè­¦å‘Š -->
                <div v-if="conflicts.length" class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                    <h4 class="font-bold text-red-700 text-sm mb-2"><i class="ph ph-warning mr-1"></i>æ™‚é–“è¡çª ({{
                        conflicts.length }})</h4>
                    <ul class="text-xs text-red-600 space-y-1">
                        <li v-for="c in conflicts.slice(0,3)" :key="c.id">{{ c.message }}</li>
                    </ul>
                </div>

                <!-- å»¶èª¤é è­¦ -->
                <div v-if="delayedTasks.length" class="mt-4 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                    <h4 class="font-bold text-orange-700 text-sm mb-2"><i class="ph ph-clock-countdown mr-1"></i>å»¶èª¤é è­¦
                        ({{ delayedTasks.length }})</h4>
                    <ul class="text-xs text-orange-600 space-y-1">
                        <li v-for="t in delayedTasks.slice(0,3)" :key="t.id">ã€Œ{{ t.title }}ã€å·²éé å®šæ™‚é–“</li>
                    </ul>
                </div>

                <!-- æ­·å²å°å‡º -->
                <div class="mt-6">
                    <button @click="exportHistory"
                        class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg text-sm flex items-center justify-center gap-2">
                        <i class="ph ph-download-simple"></i> å°å‡ºå·¥æœŸè¨˜éŒ„
                    </button>
                </div>
            </aside>

            <!-- Main View Area -->
            <main class="flex-1 overflow-auto p-4">
                <!-- é€±è¦–åœ– -->
                <div v-if="currentView === 'week'" class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="grid grid-cols-8 border-b bg-gray-50">
                        <div class="p-3 text-center text-xs font-bold text-gray-500 border-r">æ™‚é–“</div>
                        <div v-for="(day, idx) in weekDays" :key="idx" class="p-3 text-center border-r last:border-r-0"
                            :class="isToday(day.date) ? 'bg-indigo-100' : ''">
                            <div class="text-xs text-gray-500">{{ day.weekday }}</div>
                            <div class="font-bold" :class="isToday(day.date) ? 'text-indigo-600' : 'text-gray-800'">{{
                                day.day }}</div>
                        </div>
                    </div>
                    <!-- è² è²¬æ¡ˆä»¶æ¨™ç±¤åˆ— -->
                    <div v-if="getLongtermTasks().length" class="border-b bg-gradient-to-r from-purple-50 to-indigo-50">
                        <div class="flex items-center px-3 py-1.5 gap-2">
                            <span class="text-xs text-purple-600 font-medium whitespace-nowrap flex items-center gap-1">
                                <i class="ph ph-buildings"></i>è² è²¬æ¡ˆä»¶
                            </span>
                            <div class="flex flex-wrap gap-1.5 flex-1">
                                <!-- é¡¯ç¤ºå‰5å€‹æˆ–å…¨éƒ¨ï¼ˆå±•é–‹æ™‚ï¼‰ -->
                                <button
                                    v-for="task in (showAllLongterm ? getLongtermTasks() : getLongtermTasks().slice(0, 5))"
                                    :key="task.id" @click="openTaskModal(null, null, task)"
                                    class="px-2.5 py-0.5 rounded-full text-xs font-medium transition-all hover:scale-105 hover:shadow-sm"
                                    :class="getProjectPillClass(task.projectId)">
                                    {{ getProjectShortName(task) }}
                                </button>
                                <!-- +N æŒ‰éˆ• -->
                                <button v-if="getLongtermTasks().length > 5 && !showAllLongterm"
                                    @click="showAllLongterm = true"
                                    class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-600 hover:bg-gray-300 transition-colors">
                                    +{{ getLongtermTasks().length - 5 }}
                                </button>
                                <!-- æ”¶åˆæŒ‰éˆ• -->
                                <button v-if="showAllLongterm && getLongtermTasks().length > 5"
                                    @click="showAllLongterm = false"
                                    class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-500 hover:bg-gray-300 transition-colors">
                                    <i class="ph ph-caret-up"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- å·¥ä½œæ™‚é–“å€åŸŸ (Apple æ—¥æ›†é¢¨æ ¼) -->
                    <div class="relative" data-calendar-grid="true" style="height: calc(11 * 48px);">
                        <!-- æ™‚é–“æ ¼èƒŒæ™¯ -->
                        <div class="absolute inset-0 grid grid-cols-8">
                            <div class="border-r bg-gray-50"></div>
                            <div v-for="(day, idx) in weekDays" :key="'bg-'+idx" class="border-r last:border-r-0"
                                :class="isToday(day.date) ? 'bg-indigo-50/30' : ''"></div>
                        </div>
                        <!-- æ™‚é–“åˆ»åº¦ç·š -->
                        <div v-for="hour in workHours" :key="'line-'+hour" :data-hour="hour"
                            class="absolute left-0 right-0 border-t border-gray-200"
                            :style="{ top: ((hour - 8) * 48) + 'px' }">
                            <span class="absolute left-1 text-xs text-gray-400 -translate-y-1/2 bg-gray-50 px-1">{{ hour
                                }}:00</span>
                        </div>
                        <!-- ä»»å‹™é•·æ¢ -->
                        <div class="absolute grid grid-cols-8" style="inset: 0;">
                            <div></div><!-- æ™‚é–“æ¬„ä½”ä½ -->
                            <div v-for="(day, idx) in weekDays" :key="'day-'+idx"
                                class="relative border-r last:border-r-0" @click="openTaskModal(day.date, 9)"
                                @dragover.prevent @drop="onDrop($event, day.date, 9)">
                                <!-- è©²æ—¥çš„ä»»å‹™ -->
                                <div v-for="task in getDayTasks(day.date)" :key="task.id"
                                    class="absolute left-1 right-1 rounded-lg shadow-md cursor-pointer overflow-hidden border-l-4 transition-all hover:shadow-lg hover:z-10"
                                    :class="[
                                        'task-type-' + task.type,
                                        task.status === 'completed' ? 'opacity-60' : ''
                                    ]" :style="getTaskPosition(task)" draggable="true"
                                    @dragstart="onDragStart($event, task)"
                                    @click.stop="openTaskModal(null, null, task)">
                                    <div class="p-1.5 h-full flex flex-col">
                                        <div class="font-bold text-xs truncate">{{ task.title }}</div>
                                        <div class="text-[10px] text-gray-600 truncate">{{ task.projectName }}</div>
                                        <div class="text-[10px] text-gray-500 mt-auto">
                                            {{ formatTime(task.startTime) }} - {{ formatTime(task.endTime) }}
                                        </div>
                                    </div>
                                    <!-- åº•éƒ¨èª¿æ•´æ‰‹æŸ„ -->
                                    <div class="absolute bottom-0 left-0 right-0 h-3 bg-gradient-to-t from-gray-400/40 to-transparent hover:from-indigo-500 cursor-ns-resize flex items-end justify-center pb-0.5 group"
                                        @mousedown.stop="startResize($event, task)">
                                        <span class="w-8 h-0.5 bg-gray-500/50 rounded group-hover:bg-white"></span>
                                    </div>
                                    <!-- ç‹€æ…‹åœ–ç¤º -->
                                    <div class="absolute top-1 right-1">
                                        <button @click.stop="toggleStatus(task)"
                                            class="p-0.5 rounded hover:bg-white/50">
                                            <i v-if="task.status === 'completed'"
                                                class="ph ph-check-circle text-green-600 text-xs"></i>
                                            <i v-else-if="task.status === 'in_progress'"
                                                class="ph ph-play-circle text-blue-600 text-xs"></i>
                                            <i v-else class="ph ph-circle text-gray-400 text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- çµ„åˆ¥ç¸½è¦½ -->
                <div v-else-if="currentView === 'team'" class="space-y-4">
                    <div v-for="group in employeeGroups" :key="group.name"
                        class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="bg-gray-50 px-4 py-3 border-b font-bold text-gray-700">
                            <i class="ph ph-users-three mr-2"></i>{{ group.name }} ({{ group.members.length }}äºº)
                        </div>
                        <div class="p-4">
                            <div v-for="emp in group.members" :key="emp.id"
                                class="flex items-center gap-4 py-2 border-b last:border-b-0">
                                <div class="w-32 font-medium">{{ emp.name }}</div>
                                <div class="flex-1 flex gap-1 flex-wrap">
                                    <div v-for="task in getEmployeeTasks(emp.id)" :key="task.id"
                                        class="px-2 py-1 rounded text-xs border-l-2" :class="'task-type-' + task.type">
                                        {{ task.title }} ({{ formatTime(task.startTime) }})
                                    </div>
                                    <span v-if="!getEmployeeTasks(emp.id).length"
                                        class="text-gray-400 text-sm">ä»Šæ—¥ç„¡ä»»å‹™</span>
                                </div>
                                <div class="text-sm">
                                    <span class="px-2 py-1 rounded"
                                        :class="getParallelCount(emp.id) >= 4 ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600'">
                                        ä¸¦è¡Œ: {{ getParallelCount(emp.id) }}/5
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç”˜ç‰¹åœ– -->
                <div v-else-if="currentView === 'gantt'" class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="font-bold text-lg mb-4"><i class="ph ph-chart-bar-horizontal mr-2"></i>æ¡ˆå ´å·¥æœŸç”˜ç‰¹åœ–</h2>
                    <div class="space-y-4">
                        <div v-for="project in projects" :key="project.id" class="border rounded-lg p-4">
                            <div class="font-bold text-gray-800 mb-3">{{ project.name }}</div>
                            <div class="relative h-8 bg-gray-100 rounded overflow-hidden">
                                <div v-for="task in getProjectTasks(project.id)" :key="task.id"
                                    class="absolute h-full rounded flex items-center px-2 text-xs text-white font-medium"
                                    :style="getGanttStyle(task)" :class="getGanttBg(task.type)">
                                    {{ task.title }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç†±é»åœ– -->
                <div v-else-if="currentView === 'heatmap'" class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="font-bold text-lg mb-4"><i class="ph ph-fire mr-2"></i>äººåŠ›è² è¼‰ç†±é»</h2>
                    <div class="grid grid-cols-8 gap-1">
                        <div class="font-bold text-sm text-gray-500">å“¡å·¥</div>
                        <div v-for="day in weekDays" :key="day.date" class="text-center text-xs text-gray-500">{{
                            day.weekday }}</div>
                        <template v-for="emp in employees" :key="emp.id">
                            <div class="text-sm font-medium py-2">{{ emp.name }}</div>
                            <div v-for="day in weekDays" :key="day.date"
                                class="rounded p-2 text-center text-xs font-bold"
                                :class="getHeatmapClass(emp.id, day.date)">
                                {{ getTaskCount(emp.id, day.date) }}
                            </div>
                        </template>
                    </div>
                </div>
            </main>
        </div>

        <!-- Task Modal -->
        <div v-if="showModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
            @click.self="showModal = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-4">
                    <h2 class="text-lg font-bold">{{ editingTask ? 'ç·¨è¼¯ä»»å‹™' : 'æ–°å¢ä»»å‹™' }}</h2>
                </div>
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ¡ˆå ´</label>
                            <select v-model="taskForm.projectId" class="w-full border rounded-lg p-2">
                                <option v-for="p in projects" :key="p.id" :value="p.id">{{ p.name }}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ä»»å‹™é¡å‹</label>
                            <select v-model="taskForm.type" class="w-full border rounded-lg p-2">
                                <optgroup v-for="(types, group) in taskTypeGroups" :key="group" :label="group">
                                    <option v-for="t in types" :key="t" :value="t">{{ t }}</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                    <!-- ä»»å‹™æ¨¡å¼ -->
                    <div class="flex items-center gap-4 p-3 rounded-lg"
                        :class="taskForm.taskMode === 'instant' ? 'bg-blue-50' : 'bg-purple-50'">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" v-model="taskForm.taskMode" value="instant"
                                class="w-4 h-4 text-blue-600">
                            <span class="font-medium text-blue-700"><i class="ph ph-clock mr-1"></i>äº¤è¾¦ä»»å‹™</span>
                            <span class="text-xs text-gray-500">(æ’å…¥æ—¥æ›†ï¼Œæœ‰å…·é«”æ™‚é–“)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" v-model="taskForm.taskMode" value="longterm"
                                class="w-4 h-4 text-purple-600">
                            <span class="font-medium text-purple-700"><i class="ph ph-briefcase mr-1"></i>è² è²¬æ¡ˆä»¶</span>
                            <span class="text-xs text-gray-500">(è¿½è¹¤è² è²¬çš„å°ˆæ¡ˆ)</span>
                        </label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ä»»å‹™åç¨±</label>
                        <input v-model="taskForm.title" type="text" class="w-full border rounded-lg p-2"
                            placeholder="ä¾‹å¦‚ï¼šå®¢å»³å¤©èŠ±æ¿æ–½å·¥">
                    </div>
                    <!-- ä»»å‹™è³‡è¨Š -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ—¥æœŸ</label>
                            <input v-model="taskForm.startDate" type="date" class="w-full border rounded-lg p-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å·¥ä½œå¤©æ•¸</label>
                            <div class="flex gap-2 items-center">
                                <input v-model.number="taskForm.workDays" type="number" step="0.5" min="0.5"
                                    class="flex-1 border rounded-lg p-2" placeholder="1">
                                <span class="text-gray-500 text-sm">å¤©</span>
                            </div>
                            <div class="text-xs text-gray-400 mt-1">
                                ä¾‹å¦‚ï¼šåŠå¤©=0.5ï¼Œä¸€é€±=5
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è² è²¬äºº</label>
                        <select v-model="taskForm.assignedTo" class="w-full border rounded-lg p-2">
                            <option v-for="emp in employees" :key="emp.id" :value="emp.id">{{ emp.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å‚™è¨»</label>
                        <textarea v-model="taskForm.notes" rows="2" class="w-full border rounded-lg p-2"
                            placeholder="æ–½å·¥åœ–é€£çµæˆ–å…¶ä»–èªªæ˜"></textarea>
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-between">
                    <button v-if="editingTask" @click="deleteTask" class="text-red-600 hover:text-red-800 font-medium">
                        <i class="ph ph-trash mr-1"></i>åˆªé™¤
                    </button>
                    <div class="flex gap-2 ml-auto">
                        <button @click="showModal = false"
                            class="px-4 py-2 border rounded-lg hover:bg-gray-100">å–æ¶ˆ</button>
                        <button @click="saveTask"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold">
                            {{ editingTask ? 'å„²å­˜' : 'å»ºç«‹' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Shift Suggestion Modal -->
        <div v-if="showShiftModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
            @click.self="showShiftModal = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
                <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-6 py-4">
                    <h2 class="text-lg font-bold"><i class="ph ph-warning mr-2"></i>æ™‚é–“è¡çªåµæ¸¬</h2>
                </div>
                <div class="p-6">
                    <p class="text-gray-600 mb-4">ç³»çµ±åµæ¸¬åˆ°ä»¥ä¸‹ä»»å‹™æ™‚é–“è¡çªï¼Œå»ºè­°é€²è¡Œæ¨ç§»ï¼š</p>
                    <ul class="space-y-3">
                        <li v-for="s in shiftSuggestions" :key="s.id"
                            class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-gray-800">{{ s.taskTitle }}</div>
                                    <div class="text-xs text-gray-500">èˆ‡ã€Œ{{ s.conflictWith }}ã€è¡çª</div>
                                    <div class="text-sm text-orange-600 mt-1">{{ s.message }}</div>
                                </div>
                                <button @click="applyShift(s)"
                                    class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm">
                                    å¥—ç”¨
                                </button>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-between">
                    <button @click="showShiftModal = false" class="text-gray-500 hover:text-gray-700">ç¨å¾Œè™•ç†</button>
                    <button @click="applyAllShifts"
                        class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-bold">
                        <i class="ph ph-checks mr-1"></i>å…¨éƒ¨å¥—ç”¨
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div v-if="toast.show" class="fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg text-white font-medium z-50"
            :class="toast.type === 'success' ? 'bg-green-600' : 'bg-red-600'">
            {{ toast.message }}
        </div>
    </div>

    <script>
        // v1.1 - 2026-01-04 15:20 (Asia/Taipei)
        // ä¿®æ”¹å…§å®¹: æ–°å¢å¾Œç«¯ API é€£æ¥æ¸¬è©¦åŠŸèƒ½

        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                // === API è¨­å®š ===
                const API_CONFIG = {
                    // å°ˆæ¡ˆç®¡ç†å¾Œç«¯ (æ¡ˆå ´è³‡æ–™)
                    PROJECT_API: 'https://script.google.com/macros/s/AKfycbwbEVAfoO9eRzcUSfESIwih1Poub657h_9jz5UcqTXbxsDQOZ3mjLm1nHZfn_WM2K8/exec',
                    // å‡ºå‹¤ç³»çµ±å¾Œç«¯ (å“¡å·¥è³‡æ–™)
                    ATTENDANCE_API: 'https://script.google.com/macros/s/AKfycbz5-DUPNNciVdvE5wrOogNgxYt8EpDZppAe9f2cUh8pW9y3i29fB6n0RA5r-A5KuAiz/exec',
                };

                // === é™¤éŒ¯ç‹€æ…‹ ===
                const debugMode = ref(true); // é–‹å•Ÿé™¤éŒ¯é¢æ¿
                const debugData = ref({
                    loading: false,
                    employeesRaw: null,
                    projectsRaw: null,
                    errors: []
                });

                // === API å‘¼å«å‡½å¼ ===
                async function fetchEmployees() {
                    try {
                        console.log('[WMS] é–‹å§‹å–å¾—å“¡å·¥è³‡æ–™...');
                        const url = new URL(API_CONFIG.ATTENDANCE_API);
                        url.searchParams.append('page', 'attendance_api');
                        url.searchParams.append('action', 'get_hub_core_data');
                        // ä½¿ç”¨æ¸¬è©¦ç”¨çš„ userId
                        url.searchParams.append('userId', 'Ud58333430513b7527106fa71d2e30151');
                        url.searchParams.append('userName', 'æ¸¬è©¦ç”¨æˆ¶');

                        const response = await fetch(url);
                        const result = await response.json();
                        console.log('[WMS] å“¡å·¥è³‡æ–™å›å‚³:', result);
                        debugData.value.employeesRaw = result;

                        if (result.success && result.employees) {
                            // åªå–æ¬Šé™ >= 2 çš„åœ¨è·å“¡å·¥
                            const activeEmployees = result.employees.filter(e =>
                                e.permission >= 2 && e.èº«ä»½ !== 'é›¢è·' && e.èº«ä»½ !== 'å» å•†'
                            );
                            console.log(`[WMS] ç¯©é¸å¾Œå“¡å·¥: ${activeEmployees.length} äºº`);

                            // è½‰æ›æ ¼å¼
                            employees.value = activeEmployees.map(e => ({
                                id: e.userId,
                                name: e.userName,
                                group: e.çµ„åˆ¥ || 'æœªåˆ†é¡',
                                role: e.èº«ä»½ || 'å“¡å·¥'
                            }));

                            // è¨­å®šé è¨­ç•¶å‰ä½¿ç”¨è€…
                            if (employees.value.length > 0) {
                                currentUserId.value = employees.value[0].id;
                            }
                        }
                        return result;
                    } catch (error) {
                        console.error('[WMS] å–å¾—å“¡å·¥è³‡æ–™å¤±æ•—:', error);
                        debugData.value.errors.push(`å“¡å·¥APIéŒ¯èª¤: ${error.message}`);
                        return null;
                    }
                }

                async function fetchProjects() {
                    try {
                        console.log('[WMS] é–‹å§‹å–å¾—æ¡ˆå ´è³‡æ–™...');
                        const url = new URL(API_CONFIG.PROJECT_API);
                        url.searchParams.append('page', 'get_hub_projects_data');
                        url.searchParams.append('userId', 'Ud58333430513b7527106fa71d2e30151');
                        url.searchParams.append('userProfile', JSON.stringify({
                            userId: 'Ud58333430513b7527106fa71d2e30151',
                            userName: 'æ¸¬è©¦ç”¨æˆ¶',
                            permission: 5,
                            group: 'å°å—åº—'
                        }));

                        const response = await fetch(url);
                        const result = await response.json();
                        console.log('[WMS] æ¡ˆå ´è³‡æ–™å›å‚³:', result);
                        debugData.value.projectsRaw = result;

                        if (result.success && result.data && result.data.projects) {
                            console.log(`[WMS] æ¡ˆå ´æ•¸é‡: ${result.data.projects.length}`);

                            // è½‰æ›æ ¼å¼
                            projects.value = result.data.projects.map(p => ({
                                id: p.projectId || p.id,
                                name: p.projectName || p.name,
                                location: p.location || ''
                            }));
                        }
                        return result;
                    } catch (error) {
                        console.error('[WMS] å–å¾—æ¡ˆå ´è³‡æ–™å¤±æ•—:', error);
                        debugData.value.errors.push(`æ¡ˆå ´APIéŒ¯èª¤: ${error.message}`);
                        return null;
                    }
                }

                async function loadApiData() {
                    debugData.value.loading = true;
                    debugData.value.errors = [];

                    try {
                        await Promise.all([fetchEmployees(), fetchProjects()]);
                        console.log('[WMS] API è³‡æ–™è¼‰å…¥å®Œæˆ');
                    } catch (error) {
                        console.error('[WMS] API è¼‰å…¥å¤±æ•—:', error);
                    } finally {
                        debugData.value.loading = false;
                    }
                }

                // === è³‡æ–™ (åˆå§‹å€¼ç‚ºå‡è³‡æ–™ï¼ŒAPI æˆåŠŸå¾Œæœƒè¦†è“‹) ===
                const employees = ref([
                    { id: 'emp1', name: 'ç‹å¤§æ˜', group: 'æœ¨ä½œçµ„', role: 'çµ„é•·' },
                    { id: 'emp2', name: 'æå°è¯', group: 'æœ¨ä½œçµ„', role: 'å¸«å‚…' },
                    { id: 'emp3', name: 'å¼µå¿—è±ª', group: 'æ°´é›»çµ„', role: 'çµ„é•·' },
                    { id: 'emp4', name: 'é™³ç¾ç²', group: 'æ°´é›»çµ„', role: 'å¸«å‚…' },
                    { id: 'emp5', name: 'æ—å»ºå®', group: 'æ²¹æ¼†çµ„', role: 'å¸«å‚…' },
                ]);

                const projects = ref([
                    { id: 'proj1', name: 'å°å—æ±å€-é™³å…¬é¤¨', location: 'å°å—å¸‚æ±å€' },
                    { id: 'proj2', name: 'é«˜é›„å·¦ç‡Ÿ-æ—å®…', location: 'é«˜é›„å¸‚å·¦ç‡Ÿå€' },
                    { id: 'proj3', name: 'å°å—å®‰å¹³-ç‹å…¬é¤¨', location: 'å°å—å¸‚å®‰å¹³å€' },
                    { id: 'proj4', name: 'é«˜é›„é¼“å±±-è¨±å®…', location: 'é«˜é›„å¸‚é¼“å±±å€' },
                    { id: 'proj5', name: 'å°å—åŒ—å€-å¼µå…¬é¤¨', location: 'å°å—å¸‚åŒ—å€' },
                    { id: 'proj6', name: 'é«˜é›„ä¸‰æ°‘-æå®…', location: 'é«˜é›„å¸‚ä¸‰æ°‘å€' },
                    { id: 'proj7', name: 'å°å—ä¸­è¥¿-å³å…¬é¤¨', location: 'å°å—å¸‚ä¸­è¥¿å€' },
                ]);

                // === ä»»å‹™é¡åˆ¥ (åˆ†çµ„çµæ§‹) ===
                const taskTypeGroups = {
                    'è¨­è¨ˆ': ['å¹³é¢è¦åŠƒ', '3Dç¹ªåœ–', 'å ±åƒ¹è£½ä½œ', 'å®¢æˆ¶æºé€š', 'ææ–™ç¢ºèª'],
                    'å·¥å‹™': ['å ´å‹˜', 'æ”¾æ¨£', 'æ‹†é™¤', 'æ°´é›»', 'æœ¨ä½œ', 'æ²¹æ¼†', 'ç³»çµ±æ«ƒ', 'é©—æ”¶'],
                    'é€šç”¨': ['æœƒè­°', 'æ¡è³¼', 'å…¶ä»–']
                };
                // æ‰€æœ‰é¡åˆ¥çš„å¹³é¢åˆ—è¡¨ (å‘å¾Œç›¸å®¹)
                const taskTypes = Object.values(taskTypeGroups).flat();

                // æ™‚é–“æ§½ (15åˆ†é˜ç‚ºå–®ä½)
                const timeSlots = [];
                for (let h = 8; h <= 18; h++) {
                    ['00', '15', '30', '45'].forEach(m => {
                        if (h === 18 && m !== '00') return;
                        timeSlots.push(`${String(h).padStart(2, '0')}:${m}`);
                    });
                }

                const today = new Date();
                const formatDate = (d) => d.toISOString().split('T')[0];
                const todayStr = formatDate(today);

                const tasks = ref([
                    // äº¤è¾¦ä»»å‹™ï¼šæœ‰å…·é«”æ™‚é–“çš„å·¥ä½œ
                    { id: 't1', projectId: 'proj1', projectName: 'å°å—æ±å€-é™³å…¬é¤¨', type: 'å ´å‹˜', title: 'åˆæ¬¡å ´å‹˜', assignedTo: 'emp1', startDate: todayStr, workDays: 0.25, status: 'pending', notes: '' },
                    { id: 't2', projectId: 'proj1', projectName: 'å°å—æ±å€-é™³å…¬é¤¨', type: 'æœ¨ä½œ', title: 'å¤©èŠ±æ¿éª¨æ¶', assignedTo: 'emp1', startDate: todayStr, workDays: 10, status: 'in_progress', notes: 'é è¨ˆ10å·¥ä½œå¤©' },
                    { id: 't3', projectId: 'proj2', projectName: 'é«˜é›„å·¦ç‡Ÿ-æ—å®…', type: 'æ°´é›»', title: 'é…ç®¡æ‹‰ç·š', assignedTo: 'emp3', startDate: todayStr, workDays: 3, status: 'pending', notes: '' },
                    { id: 't4', projectId: 'proj2', projectName: 'é«˜é›„å·¦ç‡Ÿ-æ—å®…', type: 'æ‹†é™¤', title: 'èˆŠè£æ½¢æ‹†é™¤', assignedTo: 'emp2', startDate: todayStr, workDays: 2, status: 'in_progress', notes: '' },
                    { id: 't5', projectId: 'proj3', projectName: 'å°å—å®‰å¹³-ç‹å…¬é¤¨', type: 'æ²¹æ¼†', title: 'æ‰¹åœŸæ‰“åº•', assignedTo: 'emp5', startDate: todayStr, workDays: 5, status: 'pending', notes: '' },
                    // æ’å–®ä»»å‹™ç¯„ä¾‹ï¼š1/8 å»å”åŠ©åˆ¥çš„æ¡ˆå­
                    { id: 't6', projectId: 'proj4', projectName: 'é«˜é›„é¼“å±±-è¨±å®…', type: 'å ´å‹˜', title: 'ç·Šæ€¥å”åŠ©', assignedTo: 'emp1', startDate: formatDate(new Date(Date.now() + 4 * 24 * 60 * 60 * 1000)), workDays: 0.5, status: 'pending', notes: 'æ’å–®ä»»å‹™' },
                ]);

                // === ç‹€æ…‹ ===
                const currentView = ref('week');
                const currentUserId = ref('emp1');
                const currentUserRole = ref('admin'); // admin, leader, worker
                const currentWeekStart = ref(getMonday(new Date()));
                const filterProject = ref('');
                const filterTypes = ref([...taskTypes]);
                const showModal = ref(false);
                const showShiftModal = ref(false);
                const editingTask = ref(null);
                const shiftSuggestions = ref([]);
                const toast = ref({ show: false, message: '', type: 'success' });
                const showAllLongterm = ref(false); // æ§åˆ¶è² è²¬æ¡ˆä»¶æ¨™ç±¤æ˜¯å¦å…¨éƒ¨å±•é–‹

                const taskForm = ref({
                    projectId: 'proj1', type: 'æœ¨ä½œ', title: '',
                    startDate: todayStr,
                    workDays: 1, // å·¥ä½œå¤©æ•¸
                    assignedTo: 'emp1',
                    notes: ''
                });

                // === ç”Ÿå‘½é€±æœŸï¼šè¼‰å…¥ API è³‡æ–™ ===
                onMounted(() => {
                    console.log('[WMS] é é¢è¼‰å…¥ï¼Œé–‹å§‹å‘¼å« API...');
                    loadApiData();
                });

                // === è¨ˆç®—å±¬æ€§ ===
                const weekDays = computed(() => {
                    const days = [];
                    const start = new Date(currentWeekStart.value);
                    const weekdayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                    for (let i = 0; i < 7; i++) {
                        const d = new Date(start);
                        d.setDate(start.getDate() + i);
                        days.push({ date: formatDate(d), day: d.getDate(), weekday: `é€±${weekdayNames[d.getDay()]}` });
                    }
                    return days;
                });

                const weekLabel = computed(() => {
                    const start = new Date(currentWeekStart.value);
                    const end = new Date(start);
                    end.setDate(start.getDate() + 6);
                    return `${start.getMonth() + 1}/${start.getDate()} - ${end.getMonth() + 1}/${end.getDate()}`;
                });

                const workHours = computed(() => Array.from({ length: 11 }, (_, i) => i + 8)); // 08:00 - 18:00

                const employeeGroups = computed(() => {
                    const groups = {};
                    employees.value.forEach(e => {
                        if (!groups[e.group]) groups[e.group] = { name: e.group, members: [] };
                        groups[e.group].members.push(e);
                    });
                    return Object.values(groups);
                });

                const filteredTasks = computed(() => {
                    return tasks.value.filter(t => {
                        if (filterProject.value && t.projectId !== filterProject.value) return false;
                        if (!filterTypes.value.includes(t.type)) return false;
                        return true;
                    });
                });

                // === è¼”åŠ©å‡½å¼ï¼šåˆ¤æ–·ä»»å‹™æ˜¯å¦åœ¨æŸå¤©é€²è¡Œä¸­ ===
                function isTaskOnDate(task, dateStr) {
                    const taskStart = new Date(task.startDate);
                    const checkDate = new Date(dateStr);
                    // è¨ˆç®—ä»»å‹™çµæŸæ—¥æœŸï¼ˆå·¥ä½œå¤©æ•¸ä¸å«é€±æœ«ï¼Œç°¡åŒ–ç‚ºç›´æ¥åŠ å¤©æ•¸ï¼‰
                    const taskEnd = new Date(taskStart);
                    taskEnd.setDate(taskEnd.getDate() + Math.ceil(task.workDays) - 1);
                    // æª¢æŸ¥æ—¥æœŸæ˜¯å¦åœ¨ä»»å‹™ç¯„åœå…§
                    return checkDate >= taskStart && checkDate <= taskEnd;
                }

                // === è¨ˆç®—ä»»å‹™çµæŸæ—¥æœŸ ===
                function getTaskEndDate(task) {
                    const start = new Date(task.startDate);
                    const end = new Date(start);
                    end.setDate(end.getDate() + Math.ceil(task.workDays) - 1);
                    return formatDate(end);
                }

                const todaySummary = computed(() => {
                    const todayTasks = tasks.value.filter(t =>
                        isTaskOnDate(t, todayStr) && t.assignedTo === currentUserId.value
                    );
                    return {
                        pending: todayTasks.filter(t => t.status === 'pending').length,
                        inProgress: todayTasks.filter(t => t.status === 'in_progress').length,
                        completed: todayTasks.filter(t => t.status === 'completed').length
                    };
                });

                const conflicts = computed(() => {
                    const result = [];
                    // æª¢æ¸¬åŒä¸€é–‹å§‹æ—¥æœŸçš„ä»»å‹™ï¼ˆè¡çªï¼‰
                    const userTasks = tasks.value.filter(t => t.assignedTo === currentUserId.value);
                    for (let i = 0; i < userTasks.length; i++) {
                        for (let j = i + 1; j < userTasks.length; j++) {
                            if (userTasks[i].startDate === userTasks[j].startDate) {
                                result.push({
                                    id: `${userTasks[i].id}-${userTasks[j].id}`,
                                    message: `${userTasks[i].title} èˆ‡ ${userTasks[j].title} åŒä¸€å¤©é–‹å§‹`
                                });
                            }
                        }
                    }
                    return result;
                });

                const delayedTasks = computed(() => {
                    const now = new Date();
                    const todayDate = formatDate(now);
                    return tasks.value.filter(t => {
                        if (t.status === 'completed') return false;
                        const endDate = getTaskEndDate(t);
                        return endDate < todayDate;
                    });
                });

                // === æ–¹æ³• ===
                function getMonday(d) {
                    const date = new Date(d);
                    const day = date.getDay();
                    const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                    date.setDate(diff);
                    return formatDate(date);
                }

                function isToday(dateStr) { return dateStr === todayStr; }

                function changeWeek(delta) {
                    const d = new Date(currentWeekStart.value);
                    d.setDate(d.getDate() + delta * 7);
                    currentWeekStart.value = formatDate(d);
                }

                function goToToday() { currentWeekStart.value = getMonday(new Date()); }

                function toggleTypeFilter(type) {
                    const idx = filterTypes.value.indexOf(type);
                    if (idx >= 0) filterTypes.value.splice(idx, 1);
                    else filterTypes.value.push(type);
                }

                function getTasksAt(date, hour) {
                    // æ–°ç‰ˆæœ¬ï¼šæª¢æŸ¥ä»»å‹™æ˜¯å¦åœ¨è©²æ—¥é€²è¡Œä¸­
                    return filteredTasks.value.filter(t => {
                        if (t.assignedTo !== currentUserId.value) return false;
                        return isTaskOnDate(t, date);
                    });
                }

                // å–å¾—æŸæ—¥çš„æ‰€æœ‰ä»»å‹™
                function getDayTasks(date) {
                    return filteredTasks.value.filter(t => {
                        if (t.assignedTo !== currentUserId.value) return false;
                        return isTaskOnDate(t, date);
                    });
                }

                // è¨ˆç®—ä»»å‹™åœ¨æ—¥æ›†ä¸­çš„ä½ç½®å’Œé«˜åº¦ï¼ˆç°¡åŒ–ç‰ˆï¼šæ¯å¤©ä¸€å€‹å¡ç‰‡ï¼‰
                function getTaskPosition(task, date) {
                    // æ–°ç‰ˆæœ¬ï¼šæ¯å€‹ä»»å‹™åœ¨æ¯å¤©éƒ½é¡¯ç¤ºç‚ºå›ºå®šé«˜åº¦çš„å¡ç‰‡
                    const taskIndex = getDayTasks(date).indexOf(task);
                    const cardHeight = 60; // æ¯å€‹ä»»å‹™å¡ç‰‡é«˜åº¦
                    const top = taskIndex * (cardHeight + 4);
                    return {
                        top: top + 'px',
                        height: cardHeight + 'px',
                        minHeight: cardHeight + 'px'
                    };
                }

                function getEmployeeTasks(empId) {
                    return tasks.value.filter(t => {
                        if (t.assignedTo !== empId) return false;
                        // æª¢æŸ¥ä»»å‹™æ˜¯å¦åœ¨ä»Šå¤©é€²è¡Œä¸­
                        return isTaskOnDate(t, todayStr);
                    });
                }

                function getProjectTasks(projectId) {
                    return tasks.value.filter(t => t.projectId === projectId);
                }

                function getParallelCount(empId) {
                    return tasks.value.filter(t =>
                        t.assignedTo === empId &&
                        isTaskOnDate(t, todayStr) &&
                        t.status !== 'completed'
                    ).length;
                }

                function getTaskCount(empId, date) {
                    return tasks.value.filter(t =>
                        t.assignedTo === empId && isTaskOnDate(t, date)
                    ).length;
                }

                function getHeatmapClass(empId, date) {
                    const count = getTaskCount(empId, date);
                    if (count === 0) return 'bg-gray-100 text-gray-400';
                    if (count <= 2) return 'bg-green-100 text-green-700';
                    if (count <= 4) return 'bg-yellow-100 text-yellow-700';
                    return 'bg-red-100 text-red-700';
                }

                function getGanttStyle(task) {
                    const start = new Date(task.startDate);
                    const end = new Date(task.startDate);
                    end.setDate(end.getDate() + Math.ceil(task.workDays) - 1);

                    const weekStart = new Date(currentWeekStart.value);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 7);
                    const totalMs = weekEnd - weekStart;
                    const left = Math.max(0, (start - weekStart) / totalMs * 100);
                    const width = Math.min(100 - left, (end - start + 24 * 60 * 60 * 1000) / totalMs * 100);
                    return { left: `${left}%`, width: `${Math.max(5, width)}%` };
                }

                function getGanttBg(type) {
                    const colors = {
                        'å ´å‹˜': 'bg-amber-500', 'æ”¾æ¨£': 'bg-blue-500', 'æ‹†é™¤': 'bg-red-500',
                        'æ°´é›»': 'bg-emerald-500', 'æœ¨ä½œ': 'bg-pink-500', 'æ²¹æ¼†': 'bg-indigo-500',
                        'ç³»çµ±æ«ƒ': 'bg-purple-500', 'é©—æ”¶': 'bg-teal-500',
                        // è¨­è¨ˆéƒ¨é–€
                        'å¹³é¢è¦åŠƒ': 'bg-violet-500', '3Dç¹ªåœ–': 'bg-fuchsia-500',
                        'å ±åƒ¹è£½ä½œ': 'bg-lime-500', 'å®¢æˆ¶æºé€š': 'bg-sky-500', 'ææ–™ç¢ºèª': 'bg-orange-500',
                        // é€šç”¨
                        'æœƒè­°': 'bg-gray-500', 'æ¡è³¼': 'bg-yellow-500', 'å…¶ä»–': 'bg-slate-500'
                    };
                    return colors[type] || 'bg-gray-500';
                }

                // å–å¾—ç•¶å‰ç”¨æˆ¶çš„å¤šå¤©ä»»å‹™ï¼ˆå·¥ä½œå¤©æ•¸ > 1 ä¸”åœ¨æœ¬é€±ç¯„åœå…§ï¼‰
                function getLongtermTasks() {
                    const weekStart = new Date(currentWeekStart.value);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 7);

                    return filteredTasks.value.filter(t => {
                        if (t.assignedTo !== currentUserId.value) return false;
                        // åªé¡¯ç¤ºå·¥ä½œå¤©æ•¸ > 1 çš„ä»»å‹™ä½œç‚ºã€Œè² è²¬æ¡ˆä»¶ã€
                        if (t.workDays <= 1) return false;

                        const taskStart = new Date(t.startDate);
                        const taskEnd = new Date(t.startDate);
                        taskEnd.setDate(taskEnd.getDate() + Math.ceil(t.workDays) - 1);
                        // ä»»å‹™èˆ‡æœ¬é€±æœ‰äº¤é›†
                        return taskStart < weekEnd && taskEnd >= weekStart;
                    });
                }

                // è¨ˆç®—å¤šå¤©ä»»å‹™æ©«è·¨æ¢çš„æ¨£å¼
                function getLongtermStyle(task) {
                    const weekStart = new Date(currentWeekStart.value);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 7);

                    const taskStart = new Date(task.startDate);
                    const taskEnd = new Date(task.startDate);
                    taskEnd.setDate(taskEnd.getDate() + Math.ceil(task.workDays) - 1);

                    // è¨ˆç®—åœ¨æœ¬é€±å…§çš„èµ·é»å’Œçµ‚é»
                    const visibleStart = taskStart < weekStart ? weekStart : taskStart;
                    const visibleEnd = taskEnd > weekEnd ? weekEnd : taskEnd;

                    const dayWidth = 100 / 7; // æ¯å¤©ä½” 1/7
                    const startDay = (visibleStart - weekStart) / (24 * 60 * 60 * 1000);
                    const endDay = (visibleEnd - weekStart) / (24 * 60 * 60 * 1000) + 1;

                    const left = Math.max(0, startDay * dayWidth);
                    const width = Math.max(dayWidth * 0.5, (endDay - startDay) * dayWidth);

                    return { left: `${left}%`, width: `${Math.min(100 - left, width)}%` };
                }

                // å–å¾—æ¡ˆå ´è—¥ä¸¸æ¨™ç±¤çš„é¡è‰²æ¨£å¼
                const projectColors = [
                    'bg-purple-100 text-purple-700 border border-purple-300',
                    'bg-blue-100 text-blue-700 border border-blue-300',
                    'bg-emerald-100 text-emerald-700 border border-emerald-300',
                    'bg-amber-100 text-amber-700 border border-amber-300',
                    'bg-rose-100 text-rose-700 border border-rose-300',
                    'bg-cyan-100 text-cyan-700 border border-cyan-300',
                    'bg-indigo-100 text-indigo-700 border border-indigo-300',
                    'bg-orange-100 text-orange-700 border border-orange-300',
                    'bg-teal-100 text-teal-700 border border-teal-300',
                    'bg-pink-100 text-pink-700 border border-pink-300',
                ];

                function getProjectPillClass(projectId) {
                    const idx = projects.value.findIndex(p => p.id === projectId);
                    return projectColors[idx % projectColors.length] || projectColors[0];
                }

                // å–å¾—æ¡ˆå ´ç°¡ç¨±ï¼ˆæ¡ˆä»¶åç¨±æœ€å¤šå–7å€‹å­—ï¼ŒåŠ ä¸Šä»»å‹™é¡å‹ï¼‰
                function getProjectShortName(task) {
                    const project = projects.value.find(p => p.id === task.projectId);
                    if (!project) return task.title.slice(0, 8);
                    // å˜—è©¦æå–ç°¡çŸ­åç¨±ï¼šå¦‚ "å°å—æ±å€-é™³å…¬é¤¨" â†’ "é™³å…¬é¤¨"
                    const parts = project.name.split('-');
                    const shortName = parts.length > 1 ? parts[parts.length - 1] : project.name.slice(0, 6);
                    return shortName;
                }

                function formatTime(task) {
                    // æ–°ç‰ˆæœ¬ï¼šé¡¯ç¤ºå·¥ä½œå¤©æ•¸
                    if (!task || !task.workDays) return '';
                    return `${task.workDays}å¤©`;
                }

                // æª¢æŸ¥å…©å€‹ä»»å‹™æ˜¯å¦æœ‰æ—¥æœŸé‡ç–Šï¼ˆç”¨æ–¼æ’å–®é‚è¼¯ï¼‰
                function isOverlapping(t1, t2) {
                    const s1 = new Date(t1.startDate);
                    const e1 = new Date(t1.startDate);
                    e1.setDate(e1.getDate() + Math.ceil(t1.workDays) - 1);

                    const s2 = new Date(t2.startDate);
                    const e2 = new Date(t2.startDate);
                    e2.setDate(e2.getDate() + Math.ceil(t2.workDays) - 1);

                    return s1 <= e2 && s2 <= e1;
                }

                function openTaskModal(date = null, hour = null, task = null) {
                    if (task) {
                        editingTask.value = task;
                        taskForm.value = {
                            projectId: task.projectId,
                            type: task.type,
                            title: task.title,
                            startDate: task.startDate,
                            workDays: task.workDays,
                            assignedTo: task.assignedTo,
                            notes: task.notes || ''
                        };
                    } else {
                        editingTask.value = null;
                        const startDateVal = date || todayStr;
                        taskForm.value = {
                            projectId: projects.value[0]?.id || 'proj1',
                            type: 'æœ¨ä½œ',
                            title: '',
                            startDate: startDateVal,
                            workDays: 1,
                            assignedTo: currentUserId.value,
                            notes: ''
                        };
                    }
                    showModal.value = true;
                }

                function saveTask() {
                    if (!taskForm.value.title) { showToast('è«‹è¼¸å…¥ä»»å‹™åç¨±', 'error'); return; }
                    if (!taskForm.value.workDays || taskForm.value.workDays < 0.5) {
                        showToast('å·¥ä½œå¤©æ•¸è‡³å°‘ç‚º 0.5 å¤©', 'error');
                        return;
                    }

                    const project = projects.value.find(p => p.id === taskForm.value.projectId);

                    if (editingTask.value) {
                        // æ›´æ–°ç¾æœ‰ä»»å‹™
                        Object.assign(editingTask.value, {
                            projectId: taskForm.value.projectId,
                            projectName: project?.name || '',
                            type: taskForm.value.type,
                            title: taskForm.value.title,
                            startDate: taskForm.value.startDate,
                            workDays: taskForm.value.workDays,
                            assignedTo: taskForm.value.assignedTo,
                            notes: taskForm.value.notes
                        });
                        showToast('ä»»å‹™å·²æ›´æ–°', 'success');
                    } else {
                        // å»ºç«‹æ–°ä»»å‹™
                        const newTask = {
                            id: 't' + Date.now(),
                            projectId: taskForm.value.projectId,
                            projectName: project?.name || '',
                            type: taskForm.value.type,
                            title: taskForm.value.title,
                            assignedTo: taskForm.value.assignedTo,
                            startDate: taskForm.value.startDate,
                            workDays: taskForm.value.workDays,
                            status: 'pending',
                            notes: taskForm.value.notes
                        };
                        tasks.value.push(newTask);
                        showToast('ä»»å‹™å·²å»ºç«‹', 'success');
                    }

                    // æª¢æŸ¥è¡çªä¸¦å»ºè­°æ¨ç§»
                    checkAndSuggestShift();
                    showModal.value = false;
                }

                function generateRecurringTasks(baseTask) {
                    const intervals = { daily: 1, weekly: 7, monthly: 30 };
                    const interval = intervals[baseTask.recurrence] || 0;
                    if (!interval) return;

                    for (let i = 1; i <= 4; i++) {
                        const startDate = new Date(baseTask.startTime);
                        const endDate = new Date(baseTask.endTime);
                        startDate.setDate(startDate.getDate() + interval * i);
                        endDate.setDate(endDate.getDate() + interval * i);

                        tasks.value.push({
                            ...baseTask,
                            id: 't' + Date.now() + i,
                            startTime: startDate.toISOString().slice(0, 16),
                            endTime: endDate.toISOString().slice(0, 16),
                            recurrence: 'none' // ç”Ÿæˆçš„å­ä»»å‹™ä¸å†é€±æœŸ
                        });
                    }
                    showToast(`å·²ç”Ÿæˆ 4 å€‹é€±æœŸæ€§ä»»å‹™`, 'success');
                }

                function checkAndSuggestShift() {
                    const userTasks = tasks.value.filter(t => t.assignedTo === currentUserId.value);
                    const suggestions = [];

                    for (let i = 0; i < userTasks.length; i++) {
                        for (let j = i + 1; j < userTasks.length; j++) {
                            if (isOverlapping(userTasks[i], userTasks[j])) {
                                const higher = userTasks[i].priority <= userTasks[j].priority ? userTasks[i] : userTasks[j];
                                const lower = higher === userTasks[i] ? userTasks[j] : userTasks[i];
                                const shiftMinutes = Math.ceil((new Date(higher.endTime) - new Date(lower.startTime)) / 60000);

                                suggestions.push({
                                    id: lower.id,
                                    taskTitle: lower.title,
                                    conflictWith: higher.title,
                                    shiftMinutes,
                                    message: `å°‡ã€Œ${lower.title}ã€å¾€å¾Œæ¨ ${shiftMinutes} åˆ†é˜`
                                });
                            }
                        }
                    }

                    if (suggestions.length > 0) {
                        shiftSuggestions.value = suggestions;
                        showShiftModal.value = true;
                    }
                }

                function applyShift(suggestion) {
                    const task = tasks.value.find(t => t.id === suggestion.id);
                    if (!task) return;

                    const newStart = new Date(task.startTime);
                    const newEnd = new Date(task.endTime);
                    newStart.setMinutes(newStart.getMinutes() + suggestion.shiftMinutes);
                    newEnd.setMinutes(newEnd.getMinutes() + suggestion.shiftMinutes);

                    // æª¢æŸ¥æ˜¯å¦è¶…éä¸‹ç­æ™‚é–“ (18:00)
                    if (newEnd.getHours() >= 18) {
                        // è½‰åˆ°éš”å¤© 09:00
                        const nextDay = new Date(newStart);
                        nextDay.setDate(nextDay.getDate() + 1);
                        nextDay.setHours(9, 0, 0);
                        const duration = new Date(task.endTime) - new Date(task.startTime);
                        task.startTime = nextDay.toISOString().slice(0, 16);
                        task.endTime = new Date(nextDay.getTime() + duration).toISOString().slice(0, 16);
                        showToast(`ä»»å‹™å·²è½‰è‡³éš”æ—¥ 09:00`, 'success');
                    } else {
                        task.startTime = newStart.toISOString().slice(0, 16);
                        task.endTime = newEnd.toISOString().slice(0, 16);
                        showToast(`ä»»å‹™å·²å¾€å¾Œæ¨ç§» ${suggestion.shiftMinutes} åˆ†é˜`, 'success');
                    }

                    shiftSuggestions.value = shiftSuggestions.value.filter(s => s.id !== suggestion.id);
                    if (shiftSuggestions.value.length === 0) showShiftModal.value = false;
                }

                function applyAllShifts() {
                    shiftSuggestions.value.forEach(s => applyShift(s));
                }

                function deleteTask() {
                    if (editingTask.value) {
                        const idx = tasks.value.findIndex(t => t.id === editingTask.value.id);
                        if (idx >= 0) tasks.value.splice(idx, 1);
                        showToast('ä»»å‹™å·²åˆªé™¤', 'success');
                        showModal.value = false;
                    }
                }

                function showToast(message, type = 'success') {
                    toast.value = { show: true, message, type };
                    setTimeout(() => toast.value.show = false, 3000);
                }

                // æ‹–æ‹‰åŠŸèƒ½
                let draggedTask = null;
                function onDragStart(e, task) { draggedTask = task; }
                function onDrop(e, date, hour) {
                    if (!draggedTask) return;
                    const duration = new Date(draggedTask.endTime) - new Date(draggedTask.startTime);
                    draggedTask.startTime = `${date}T${String(hour).padStart(2, '0')}:00`;
                    const endDate = new Date(draggedTask.startTime);
                    endDate.setTime(endDate.getTime() + duration);
                    draggedTask.endTime = endDate.toISOString().slice(0, 16);
                    showToast('ä»»å‹™æ™‚é–“å·²èª¿æ•´', 'success');
                    draggedTask = null;
                }

                // æ™‚é•·æ‹–æ›³èª¿æ•´åŠŸèƒ½ï¼ˆå„ªåŒ–ç‰ˆï¼‰
                let resizingTask = null;
                let resizeStartY = 0;
                let resizeStartEndMinutes = 0;
                let pixelsPer15Min = 12; // æ¯ 15 åˆ†é˜çš„åƒç´ é«˜åº¦
                let lastPreviewTime = ''; // ä¸Šæ¬¡é è¦½çš„æ™‚é–“ï¼Œé¿å…é‡è¤‡æ›´æ–°
                let rafId = null; // requestAnimationFrame ID

                function startResize(e, task) {
                    e.preventDefault();
                    resizingTask = task;
                    resizeStartY = e.clientY;

                    // å¾æ™‚é–“å­—ä¸²è§£æçµæŸæ™‚é–“çš„åˆ†é˜æ•¸
                    const endTimePart = task.endTime.split('T')[1] || '11:00';
                    const [h, m] = endTimePart.split(':').map(Number);
                    resizeStartEndMinutes = h * 60 + (m || 0);

                    // å‹•æ…‹è¨ˆç®—æ¯ 15 åˆ†é˜çš„åƒç´ é«˜åº¦ï¼ˆæ›´ç²¾æº–ï¼‰
                    const calendarEl = document.querySelector('[data-calendar-grid=\"true\"]');
                    if (calendarEl) {
                        const gridHeight = calendarEl.offsetHeight;
                        const totalSlots = 11 * 4; // 11 å°æ™‚ * æ¯å°æ™‚ 4 æ ¼ = 44 æ ¼ï¼ˆæ¯æ ¼ 15 åˆ†é˜ï¼‰
                        pixelsPer15Min = gridHeight / totalSlots;
                    }

                    lastPreviewTime = '';
                    document.addEventListener('mousemove', onResizeMove, { passive: true });
                    document.addEventListener('mouseup', onResizeEnd);
                    document.body.style.cursor = 'ns-resize';
                    document.body.style.userSelect = 'none';
                }

                function onResizeMove(e) {
                    if (!resizingTask) return;

                    // ä½¿ç”¨ RAF ç¯€æµï¼Œé¿å…éåº¦æ¸²æŸ“
                    if (rafId) return;
                    rafId = requestAnimationFrame(() => {
                        rafId = null;
                        updateResizePosition(e.clientY);
                    });
                }

                function updateResizePosition(clientY) {
                    if (!resizingTask) return;

                    // è¨ˆç®—æ»‘é¼ ç§»å‹•çš„åƒç´ å·®
                    const deltaY = clientY - resizeStartY;

                    // è¨ˆç®—æ™‚é–“è®ŠåŒ–ï¼šæ¯ç§»å‹• pixelsPer15Min åƒç´  = 15 åˆ†é˜
                    const deltaSlots = Math.round(deltaY / pixelsPer15Min);
                    const deltaMinutes = deltaSlots * 15;

                    // è¨ˆç®—æ–°çš„çµæŸæ™‚é–“åˆ†é˜æ•¸ï¼ˆå°é½Šåˆ° 15 åˆ†é˜ï¼‰
                    let newEndMinutes = resizeStartEndMinutes + deltaMinutes;

                    // ç²å–é–‹å§‹æ™‚é–“
                    const startTimePart = resizingTask.startTime.split('T')[1] || '09:00';
                    const [sh, sm] = startTimePart.split(':').map(Number);
                    const startMinutes = sh * 60 + (sm || 0);

                    // ç¢ºä¿çµæŸæ™‚é–“ï¼šè‡³å°‘æ¯”é–‹å§‹æ™‚é–“æ™š 15 åˆ†é˜ã€ä¸æ—©æ–¼ 08:15ã€æœ€æ™š 18:00
                    const minEndMinutes = Math.max(8 * 60 + 15, startMinutes + 15); // è‡³å°‘ 08:15 æˆ–é–‹å§‹+15åˆ†é˜
                    const clampedMinutes = Math.max(minEndMinutes, Math.min(18 * 60, newEndMinutes));
                    const finalHour = Math.floor(clampedMinutes / 60);
                    const finalMins = clampedMinutes % 60;

                    // æ‹¼æ¥æ–°çš„çµæŸæ™‚é–“å­—ä¸²
                    const datePart = resizingTask.endTime.split('T')[0];
                    const endHours = String(finalHour).padStart(2, '0');
                    const endMins = String(finalMins).padStart(2, '0');
                    const newEndTime = `${datePart}T${endHours}:${endMins}`;

                    // åªæœ‰æ™‚é–“æ”¹è®Šæ™‚æ‰æ›´æ–°ï¼ˆæ¸›å°‘ Vue åæ‡‰å¼é–‹éŠ·ï¼‰
                    if (resizingTask.endTime !== newEndTime) {
                        resizingTask.endTime = newEndTime;

                        // å³æ™‚é è¦½åå¸ï¼ˆé¿å…é‡è¤‡é¡¯ç¤ºç›¸åŒæ™‚é–“ï¼‰
                        const timeStr = `${endHours}:${endMins}`;
                        if (timeStr !== lastPreviewTime) {
                            lastPreviewTime = timeStr;
                            toast.value = { show: true, message: `â± ${timeStr}`, type: 'success' };
                        }
                    }
                }

                function onResizeEnd() {
                    if (rafId) {
                        cancelAnimationFrame(rafId);
                        rafId = null;
                    }
                    if (resizingTask) {
                        showToast(`æ™‚é•·èª¿æ•´è‡³ ${formatTime(resizingTask.endTime)}`, 'success');
                    }
                    resizingTask = null;
                    lastPreviewTime = '';
                    document.removeEventListener('mousemove', onResizeMove);
                    document.removeEventListener('mouseup', onResizeEnd);
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }

                // ä»»å‹™ç‹€æ…‹åˆ‡æ›
                function toggleStatus(task) {
                    const statusFlow = { 'pending': 'in_progress', 'in_progress': 'completed', 'completed': 'pending' };
                    task.status = statusFlow[task.status] || 'pending';
                    showToast(`ä»»å‹™ç‹€æ…‹ï¼š${{ 'pending': 'å¾…è™•ç†', 'in_progress': 'é€²è¡Œä¸­', 'completed': 'å·²å®Œæˆ' }[task.status]}`, 'success');
                }

                // æ­·å²å°å‡º
                function exportHistory() {
                    const projectId = filterProject.value;
                    const exportTasks = projectId ? tasks.value.filter(t => t.projectId === projectId) : tasks.value;

                    let csv = 'ä»»å‹™åç¨±,æ¡ˆå ´,é¡å‹,è² è²¬äºº,é–‹å§‹æ™‚é–“,çµæŸæ™‚é–“,ç‹€æ…‹\n';
                    exportTasks.forEach(t => {
                        const emp = employees.value.find(e => e.id === t.assignedTo);
                        csv += `"${t.title}","${t.projectName}","${t.type}","${emp?.name || ''}","${t.startTime}","${t.endTime}","${t.status}"\n`;
                    });

                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `å·¥æœŸè¨˜éŒ„_${formatDate(new Date())}.csv`;
                    link.click();
                    showToast(`å·²å°å‡º ${exportTasks.length} ç­†è¨˜éŒ„`, 'success');
                }

                return {
                    employees, projects, taskTypes, taskTypeGroups, timeSlots, tasks, currentView, currentUserId, currentUserRole, currentWeekStart,
                    filterProject, filterTypes, showModal, showShiftModal, editingTask, taskForm, toast, showAllLongterm,
                    shiftSuggestions, weekDays, weekLabel, workHours, employeeGroups, filteredTasks, todaySummary, conflicts, delayedTasks,
                    isToday, changeWeek, goToToday, toggleTypeFilter, getTasksAt, getDayTasks, getTaskPosition, getEmployeeTasks,
                    getProjectTasks, getParallelCount, getTaskCount, getHeatmapClass, getGanttStyle,
                    getGanttBg, getLongtermTasks, getLongtermStyle, getProjectPillClass, getProjectShortName,
                    formatTime, openTaskModal, saveTask, deleteTask, onDragStart, onDrop, startResize,
                    applyShift, applyAllShifts, toggleStatus, exportHistory,
                    // é™¤éŒ¯åŠŸèƒ½
                    debugMode, debugData, loadApiData
                };
            }
        }).mount('#app');
    </script>
</body>

</html>