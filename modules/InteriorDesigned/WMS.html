<!DOCTYPE html>
<html lang="zh-TW">
<!-- WMS v1.0 - 2025-12-30 - 員工工作排程系統 MVP -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>添心裝修 - 員工工作排程系統 WMS</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
        }

        [v-cloak] {
            display: none !important;
        }

        .task-block {
            transition: all 0.2s;
            cursor: grab;
        }

        .task-block:active {
            cursor: grabbing;
        }

        .time-slot {
            min-height: 60px;
            border-bottom: 1px solid #e5e7eb;
        }

        .time-slot:hover {
            background-color: #f0f9ff;
        }

        .task-type-場勘 {
            background: #fef3c7;
            border-left-color: #f59e0b;
        }

        .task-type-放樣 {
            background: #dbeafe;
            border-left-color: #3b82f6;
        }

        .task-type-拆除 {
            background: #fee2e2;
            border-left-color: #ef4444;
        }

        .task-type-水電 {
            background: #d1fae5;
            border-left-color: #10b981;
        }

        .task-type-木作 {
            background: #fce7f3;
            border-left-color: #ec4899;
        }

        .task-type-油漆 {
            background: #e0e7ff;
            border-left-color: #6366f1;
        }

        .task-type-系統櫃 {
            background: #f3e8ff;
            border-left-color: #a855f7;
        }

        .task-type-驗收 {
            background: #ccfbf1;
            border-left-color: #14b8a6;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <div id="app" v-cloak class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-4 shadow-lg">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <i class="ph ph-calendar-check text-3xl"></i>
                    <div>
                        <h1 class="text-xl font-bold">員工工作排程系統</h1>
                        <span class="text-xs text-indigo-200">添心室內裝修 WMS v1.0</span>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <!-- 視圖切換 -->
                    <div class="flex bg-white/20 rounded-lg p-1">
                        <button v-for="v in ['week','team','gantt','heatmap']" :key="v" @click="currentView = v"
                            :class="currentView === v ? 'bg-white text-indigo-600' : 'text-white hover:bg-white/10'"
                            class="px-3 py-1 rounded text-sm font-medium transition-colors">
                            {{ {week:'週視圖',team:'組別',gantt:'甘特圖',heatmap:'熱點'}[v] }}
                        </button>
                    </div>
                    <!-- 日期選擇 -->
                    <div class="flex items-center gap-2 bg-white/20 rounded-lg px-3 py-1">
                        <button @click="changeWeek(-1)" class="hover:bg-white/20 p-1 rounded"><i
                                class="ph ph-caret-left"></i></button>
                        <span class="text-sm font-medium">{{ weekLabel }}</span>
                        <button @click="changeWeek(1)" class="hover:bg-white/20 p-1 rounded"><i
                                class="ph ph-caret-right"></i></button>
                        <button @click="goToToday"
                            class="ml-2 text-xs bg-white/30 px-2 py-0.5 rounded hover:bg-white/40">今天</button>
                    </div>
                    <!-- 當前用戶 -->
                    <div class="flex items-center gap-2 bg-white/20 rounded-lg px-3 py-2">
                        <i class="ph ph-user-circle text-xl"></i>
                        <select v-model="currentUserId" class="bg-transparent text-sm font-medium outline-none">
                            <option v-for="emp in employees" :key="emp.id" :value="emp.id" class="text-gray-800">{{
                                emp.name }}</option>
                        </select>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar -->
            <aside class="w-72 bg-white border-r border-gray-200 p-4 overflow-y-auto">
                <!-- 權限顯示 -->
                <div class="mb-4 p-2 rounded-lg text-xs"
                    :class="currentUserRole === 'admin' ? 'bg-purple-100 text-purple-700' : currentUserRole === 'leader' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'">
                    <i class="ph ph-shield-check mr-1"></i>
                    {{ {admin: '管理員', leader: '組長', worker: '一般員工'}[currentUserRole] }}
                </div>

                <!-- 新增任務按鈕 -->
                <button @click="openTaskModal()" v-if="currentUserRole !== 'worker'"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold mb-4 flex items-center justify-center gap-2 shadow-md">
                    <i class="ph ph-plus-circle text-xl"></i> 新增任務
                </button>

                <!-- 篩選區 -->
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">案場篩選</label>
                        <select v-model="filterProject" class="w-full border rounded-lg p-2 text-sm">
                            <option value="">全部案場</option>
                            <option v-for="p in projects" :key="p.id" :value="p.id">{{ p.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">任務類型</label>
                        <div class="flex flex-wrap gap-1">
                            <button v-for="t in taskTypes" :key="t" @click="toggleTypeFilter(t)"
                                :class="filterTypes.includes(t) ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600'"
                                class="px-2 py-1 rounded text-xs transition-colors">{{ t }}</button>
                        </div>
                    </div>
                </div>

                <!-- 今日摘要 -->
                <div class="mt-6 p-4 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl">
                    <h3 class="font-bold text-indigo-800 mb-2"><i class="ph ph-chart-pie mr-1"></i>今日摘要</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span class="text-gray-600">待處理</span><span
                                class="font-bold text-orange-600">{{ todaySummary.pending }}</span></div>
                        <div class="flex justify-between"><span class="text-gray-600">進行中</span><span
                                class="font-bold text-blue-600">{{ todaySummary.inProgress }}</span></div>
                        <div class="flex justify-between"><span class="text-gray-600">已完成</span><span
                                class="font-bold text-green-600">{{ todaySummary.completed }}</span></div>
                    </div>
                </div>

                <!-- 衝突警告 -->
                <div v-if="conflicts.length" class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                    <h4 class="font-bold text-red-700 text-sm mb-2"><i class="ph ph-warning mr-1"></i>時間衝突 ({{
                        conflicts.length }})</h4>
                    <ul class="text-xs text-red-600 space-y-1">
                        <li v-for="c in conflicts.slice(0,3)" :key="c.id">{{ c.message }}</li>
                    </ul>
                </div>

                <!-- 延誤預警 -->
                <div v-if="delayedTasks.length" class="mt-4 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                    <h4 class="font-bold text-orange-700 text-sm mb-2"><i class="ph ph-clock-countdown mr-1"></i>延誤預警
                        ({{ delayedTasks.length }})</h4>
                    <ul class="text-xs text-orange-600 space-y-1">
                        <li v-for="t in delayedTasks.slice(0,3)" :key="t.id">「{{ t.title }}」已過預定時間</li>
                    </ul>
                </div>

                <!-- 歷史導出 -->
                <div class="mt-6">
                    <button @click="exportHistory"
                        class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg text-sm flex items-center justify-center gap-2">
                        <i class="ph ph-download-simple"></i> 導出工期記錄
                    </button>
                </div>
            </aside>

            <!-- Main View Area -->
            <main class="flex-1 overflow-auto p-4">
                <!-- 週視圖 -->
                <div v-if="currentView === 'week'" class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="grid grid-cols-8 border-b bg-gray-50">
                        <div class="p-3 text-center text-xs font-bold text-gray-500 border-r">時間</div>
                        <div v-for="(day, idx) in weekDays" :key="idx" class="p-3 text-center border-r last:border-r-0"
                            :class="isToday(day.date) ? 'bg-indigo-100' : ''">
                            <div class="text-xs text-gray-500">{{ day.weekday }}</div>
                            <div class="font-bold" :class="isToday(day.date) ? 'text-indigo-600' : 'text-gray-800'">{{
                                day.day }}</div>
                        </div>
                    </div>
                    <!-- 負責案件標籤列 -->
                    <div v-if="getLongtermTasks().length" class="border-b bg-gradient-to-r from-purple-50 to-indigo-50">
                        <div class="flex items-center px-3 py-1.5 gap-2">
                            <span class="text-xs text-purple-600 font-medium whitespace-nowrap flex items-center gap-1">
                                <i class="ph ph-buildings"></i>負責案件
                            </span>
                            <div class="flex flex-wrap gap-1.5 flex-1">
                                <!-- 顯示前5個或全部（展開時） -->
                                <button
                                    v-for="task in (showAllLongterm ? getLongtermTasks() : getLongtermTasks().slice(0, 5))"
                                    :key="task.id" @click="openTaskModal(null, null, task)"
                                    class="px-2.5 py-0.5 rounded-full text-xs font-medium transition-all hover:scale-105 hover:shadow-sm"
                                    :class="getProjectPillClass(task.projectId)">
                                    {{ getProjectShortName(task) }}
                                </button>
                                <!-- +N 按鈕 -->
                                <button v-if="getLongtermTasks().length > 5 && !showAllLongterm"
                                    @click="showAllLongterm = true"
                                    class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-600 hover:bg-gray-300 transition-colors">
                                    +{{ getLongtermTasks().length - 5 }}
                                </button>
                                <!-- 收合按鈕 -->
                                <button v-if="showAllLongterm && getLongtermTasks().length > 5"
                                    @click="showAllLongterm = false"
                                    class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-500 hover:bg-gray-300 transition-colors">
                                    <i class="ph ph-caret-up"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- 工作時間區域 (Apple 日曆風格) -->
                    <div class="relative" data-calendar-grid="true" style="height: calc(11 * 48px);">
                        <!-- 時間格背景 -->
                        <div class="absolute inset-0 grid grid-cols-8">
                            <div class="border-r bg-gray-50"></div>
                            <div v-for="(day, idx) in weekDays" :key="'bg-'+idx" class="border-r last:border-r-0"
                                :class="isToday(day.date) ? 'bg-indigo-50/30' : ''"></div>
                        </div>
                        <!-- 時間刻度線 -->
                        <div v-for="hour in workHours" :key="'line-'+hour" :data-hour="hour"
                            class="absolute left-0 right-0 border-t border-gray-200"
                            :style="{ top: ((hour - 8) * 48) + 'px' }">
                            <span class="absolute left-1 text-xs text-gray-400 -translate-y-1/2 bg-gray-50 px-1">{{ hour
                                }}:00</span>
                        </div>
                        <!-- 任務長條 -->
                        <div class="absolute grid grid-cols-8" style="inset: 0;">
                            <div></div><!-- 時間欄佔位 -->
                            <div v-for="(day, idx) in weekDays" :key="'day-'+idx"
                                class="relative border-r last:border-r-0" @click="openTaskModal(day.date, 9)"
                                @dragover.prevent @drop="onDrop($event, day.date, 9)">
                                <!-- 該日的任務 -->
                                <div v-for="task in getDayTasks(day.date)" :key="task.id"
                                    class="absolute left-1 right-1 rounded-lg shadow-md cursor-pointer overflow-hidden border-l-4 transition-all hover:shadow-lg hover:z-10"
                                    :class="[
                                        'task-type-' + task.type,
                                        task.status === 'completed' ? 'opacity-60' : ''
                                    ]" :style="getTaskPosition(task)" draggable="true"
                                    @dragstart="onDragStart($event, task)"
                                    @click.stop="openTaskModal(null, null, task)">
                                    <div class="p-1.5 h-full flex flex-col">
                                        <div class="font-bold text-xs truncate">{{ task.title }}</div>
                                        <div class="text-[10px] text-gray-600 truncate">{{ task.projectName }}</div>
                                        <div class="text-[10px] text-gray-500 mt-auto">
                                            {{ formatTime(task.startTime) }} - {{ formatTime(task.endTime) }}
                                        </div>
                                    </div>
                                    <!-- 底部調整手柄 -->
                                    <div class="absolute bottom-0 left-0 right-0 h-3 bg-gradient-to-t from-gray-400/40 to-transparent hover:from-indigo-500 cursor-ns-resize flex items-end justify-center pb-0.5 group"
                                        @mousedown.stop="startResize($event, task)">
                                        <span class="w-8 h-0.5 bg-gray-500/50 rounded group-hover:bg-white"></span>
                                    </div>
                                    <!-- 狀態圖示 -->
                                    <div class="absolute top-1 right-1">
                                        <button @click.stop="toggleStatus(task)"
                                            class="p-0.5 rounded hover:bg-white/50">
                                            <i v-if="task.status === 'completed'"
                                                class="ph ph-check-circle text-green-600 text-xs"></i>
                                            <i v-else-if="task.status === 'in_progress'"
                                                class="ph ph-play-circle text-blue-600 text-xs"></i>
                                            <i v-else class="ph ph-circle text-gray-400 text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 組別總覽 -->
                <div v-else-if="currentView === 'team'" class="space-y-4">
                    <div v-for="group in employeeGroups" :key="group.name"
                        class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="bg-gray-50 px-4 py-3 border-b font-bold text-gray-700">
                            <i class="ph ph-users-three mr-2"></i>{{ group.name }} ({{ group.members.length }}人)
                        </div>
                        <div class="p-4">
                            <div v-for="emp in group.members" :key="emp.id"
                                class="flex items-center gap-4 py-2 border-b last:border-b-0">
                                <div class="w-32 font-medium">{{ emp.name }}</div>
                                <div class="flex-1 flex gap-1 flex-wrap">
                                    <div v-for="task in getEmployeeTasks(emp.id)" :key="task.id"
                                        class="px-2 py-1 rounded text-xs border-l-2" :class="'task-type-' + task.type">
                                        {{ task.title }} ({{ formatTime(task.startTime) }})
                                    </div>
                                    <span v-if="!getEmployeeTasks(emp.id).length"
                                        class="text-gray-400 text-sm">今日無任務</span>
                                </div>
                                <div class="text-sm">
                                    <span class="px-2 py-1 rounded"
                                        :class="getParallelCount(emp.id) >= 4 ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600'">
                                        並行: {{ getParallelCount(emp.id) }}/5
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 甘特圖 -->
                <div v-else-if="currentView === 'gantt'" class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="font-bold text-lg mb-4"><i class="ph ph-chart-bar-horizontal mr-2"></i>案場工期甘特圖</h2>
                    <div class="space-y-4">
                        <div v-for="project in projects" :key="project.id" class="border rounded-lg p-4">
                            <div class="font-bold text-gray-800 mb-3">{{ project.name }}</div>
                            <div class="relative h-8 bg-gray-100 rounded overflow-hidden">
                                <div v-for="task in getProjectTasks(project.id)" :key="task.id"
                                    class="absolute h-full rounded flex items-center px-2 text-xs text-white font-medium"
                                    :style="getGanttStyle(task)" :class="getGanttBg(task.type)">
                                    {{ task.title }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 熱點圖 -->
                <div v-else-if="currentView === 'heatmap'" class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="font-bold text-lg mb-4"><i class="ph ph-fire mr-2"></i>人力負載熱點</h2>
                    <div class="grid grid-cols-8 gap-1">
                        <div class="font-bold text-sm text-gray-500">員工</div>
                        <div v-for="day in weekDays" :key="day.date" class="text-center text-xs text-gray-500">{{
                            day.weekday }}</div>
                        <template v-for="emp in employees" :key="emp.id">
                            <div class="text-sm font-medium py-2">{{ emp.name }}</div>
                            <div v-for="day in weekDays" :key="day.date"
                                class="rounded p-2 text-center text-xs font-bold"
                                :class="getHeatmapClass(emp.id, day.date)">
                                {{ getTaskCount(emp.id, day.date) }}
                            </div>
                        </template>
                    </div>
                </div>
            </main>
        </div>

        <!-- Task Modal -->
        <div v-if="showModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
            @click.self="showModal = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-4">
                    <h2 class="text-lg font-bold">{{ editingTask ? '編輯任務' : '新增任務' }}</h2>
                </div>
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">案場</label>
                            <select v-model="taskForm.projectId" class="w-full border rounded-lg p-2">
                                <option v-for="p in projects" :key="p.id" :value="p.id">{{ p.name }}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">任務類型</label>
                            <select v-model="taskForm.type" class="w-full border rounded-lg p-2">
                                <option v-for="t in taskTypes" :key="t" :value="t">{{ t }}</option>
                            </select>
                        </div>
                    </div>
                    <!-- 任務模式 -->
                    <div class="flex items-center gap-4 p-3 rounded-lg"
                        :class="taskForm.taskMode === 'instant' ? 'bg-blue-50' : 'bg-purple-50'">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" v-model="taskForm.taskMode" value="instant"
                                class="w-4 h-4 text-blue-600">
                            <span class="font-medium text-blue-700"><i class="ph ph-clock mr-1"></i>即時任務</span>
                            <span class="text-xs text-gray-500">(佔用時間槽，同時只能1個)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" v-model="taskForm.taskMode" value="longterm"
                                class="w-4 h-4 text-purple-600">
                            <span class="font-medium text-purple-700"><i
                                    class="ph ph-calendar-dots mr-1"></i>長期任務</span>
                            <span class="text-xs text-gray-500">(背景進行，不佔時間槽)</span>
                        </label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">任務名稱</label>
                        <input v-model="taskForm.title" type="text" class="w-full border rounded-lg p-2"
                            placeholder="例如：客廳天花板施工">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">開始時間</label>
                            <div class="flex gap-1">
                                <input v-model="taskForm.startDate" type="date"
                                    class="flex-1 border rounded-lg p-2 text-sm">
                                <select v-model="taskForm.startSlot" class="w-24 border rounded-lg p-2 text-sm">
                                    <option v-for="slot in timeSlots" :key="slot" :value="slot">{{ slot }}</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">結束時間</label>
                            <div class="flex gap-1">
                                <input v-model="taskForm.endDate" type="date"
                                    class="flex-1 border rounded-lg p-2 text-sm">
                                <select v-model="taskForm.endSlot" class="w-24 border rounded-lg p-2 text-sm">
                                    <option v-for="slot in timeSlots" :key="slot" :value="slot">{{ slot }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">負責人</label>
                            <select v-model="taskForm.assignedTo" class="w-full border rounded-lg p-2">
                                <option v-for="emp in employees" :key="emp.id" :value="emp.id">{{ emp.name }}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">優先等級</label>
                            <select v-model="taskForm.priority" class="w-full border rounded-lg p-2">
                                <option v-for="i in 5" :key="i" :value="i">{{ i }} {{ i===1?'(緊急)':i===5?'(一般)':'' }}
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">前置任務</label>
                            <select v-model="taskForm.predecessorId" class="w-full border rounded-lg p-2">
                                <option value="">無</option>
                                <option v-for="t in tasks.filter(x => x.id !== editingTask?.id)" :key="t.id"
                                    :value="t.id">{{ t.title }}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">週期性</label>
                            <select v-model="taskForm.recurrence" class="w-full border rounded-lg p-2">
                                <option value="none">無</option>
                                <option value="daily">每日</option>
                                <option value="weekly">每週</option>
                                <option value="monthly">每月</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">備註</label>
                        <textarea v-model="taskForm.notes" rows="2" class="w-full border rounded-lg p-2"
                            placeholder="施工圖連結或其他說明"></textarea>
                    </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-between">
                    <button v-if="editingTask" @click="deleteTask" class="text-red-600 hover:text-red-800 font-medium">
                        <i class="ph ph-trash mr-1"></i>刪除
                    </button>
                    <div class="flex gap-2 ml-auto">
                        <button @click="showModal = false"
                            class="px-4 py-2 border rounded-lg hover:bg-gray-100">取消</button>
                        <button @click="saveTask"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold">
                            {{ editingTask ? '儲存' : '建立' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Shift Suggestion Modal -->
        <div v-if="showShiftModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
            @click.self="showShiftModal = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
                <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-6 py-4">
                    <h2 class="text-lg font-bold"><i class="ph ph-warning mr-2"></i>時間衝突偵測</h2>
                </div>
                <div class="p-6">
                    <p class="text-gray-600 mb-4">系統偵測到以下任務時間衝突，建議進行推移：</p>
                    <ul class="space-y-3">
                        <li v-for="s in shiftSuggestions" :key="s.id"
                            class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-gray-800">{{ s.taskTitle }}</div>
                                    <div class="text-xs text-gray-500">與「{{ s.conflictWith }}」衝突</div>
                                    <div class="text-sm text-orange-600 mt-1">{{ s.message }}</div>
                                </div>
                                <button @click="applyShift(s)"
                                    class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm">
                                    套用
                                </button>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-between">
                    <button @click="showShiftModal = false" class="text-gray-500 hover:text-gray-700">稍後處理</button>
                    <button @click="applyAllShifts"
                        class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-bold">
                        <i class="ph ph-checks mr-1"></i>全部套用
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div v-if="toast.show" class="fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg text-white font-medium z-50"
            :class="toast.type === 'success' ? 'bg-green-600' : 'bg-red-600'">
            {{ toast.message }}
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                // === 假資料 ===
                const employees = ref([
                    { id: 'emp1', name: '王大明', group: '木作組', role: '組長' },
                    { id: 'emp2', name: '李小華', group: '木作組', role: '師傅' },
                    { id: 'emp3', name: '張志豪', group: '水電組', role: '組長' },
                    { id: 'emp4', name: '陳美玲', group: '水電組', role: '師傅' },
                    { id: 'emp5', name: '林建宏', group: '油漆組', role: '師傅' },
                ]);

                const projects = ref([
                    { id: 'proj1', name: '台南東區-陳公館', location: '台南市東區' },
                    { id: 'proj2', name: '高雄左營-林宅', location: '高雄市左營區' },
                    { id: 'proj3', name: '台南安平-王公館', location: '台南市安平區' },
                    { id: 'proj4', name: '高雄鼓山-許宅', location: '高雄市鼓山區' },
                    { id: 'proj5', name: '台南北區-張公館', location: '台南市北區' },
                    { id: 'proj6', name: '高雄三民-李宅', location: '高雄市三民區' },
                    { id: 'proj7', name: '台南中西-吳公館', location: '台南市中西區' },
                ]);

                const taskTypes = ['場勘', '放樣', '拆除', '水電', '木作', '油漆', '系統櫃', '驗收'];

                // 時間槽 (15分鐘為單位)
                const timeSlots = [];
                for (let h = 8; h <= 18; h++) {
                    ['00', '15', '30', '45'].forEach(m => {
                        if (h === 18 && m !== '00') return;
                        timeSlots.push(`${String(h).padStart(2, '0')}:${m}`);
                    });
                }

                const today = new Date();
                const formatDate = (d) => d.toISOString().split('T')[0];
                const todayStr = formatDate(today);

                const tasks = ref([
                    { id: 't1', projectId: 'proj1', projectName: '台南東區-陳公館', type: '場勘', title: '初次場勘', assignedTo: 'emp1', startTime: `${todayStr}T09:00`, endTime: `${todayStr}T11:00`, priority: 1, status: 'pending', parallelIndex: 1, predecessorId: '', recurrence: 'none', taskMode: 'instant', notes: '' },
                    { id: 't2', projectId: 'proj1', projectName: '台南東區-陳公館', type: '木作', title: '天花板骨架', assignedTo: 'emp1', startTime: `${todayStr}T13:00`, endTime: `${todayStr}T17:00`, priority: 2, status: 'in_progress', parallelIndex: 1, predecessorId: 't1', recurrence: 'none', taskMode: 'instant', notes: '' },
                    { id: 't3', projectId: 'proj2', projectName: '高雄左營-林宅', type: '水電', title: '配管拉線', assignedTo: 'emp3', startTime: `${todayStr}T09:00`, endTime: `${todayStr}T12:00`, priority: 2, status: 'pending', parallelIndex: 1, predecessorId: '', recurrence: 'none', taskMode: 'instant', notes: '' },
                    { id: 't4', projectId: 'proj2', projectName: '高雄左營-林宅', type: '拆除', title: '舊裝潢拆除', assignedTo: 'emp2', startTime: `${todayStr}T09:00`, endTime: `${todayStr}T18:00`, priority: 1, status: 'in_progress', parallelIndex: 1, predecessorId: '', recurrence: 'none', taskMode: 'instant', notes: '' },
                    { id: 't5', projectId: 'proj3', projectName: '台南安平-王公館', type: '油漆', title: '批土打底', assignedTo: 'emp5', startTime: `${todayStr}T10:00`, endTime: `${todayStr}T16:00`, priority: 3, status: 'pending', parallelIndex: 1, predecessorId: '', recurrence: 'none', taskMode: 'instant', notes: '' },
                    // 長期任務範例（模擬多案負責）
                    { id: 't6', projectId: 'proj1', projectName: '台南東區-陳公館', type: '木作', title: '施工圖繪製', assignedTo: 'emp1', startTime: `${todayStr}T00:00`, endTime: `${formatDate(new Date(Date.now() + 7 * 24 * 60 * 60 * 1000))}T00:00`, priority: 2, status: 'in_progress', parallelIndex: 1, predecessorId: '', recurrence: 'none', taskMode: 'longterm', notes: '預計7工作天' },
                    { id: 't7', projectId: 'proj2', projectName: '高雄左營-林宅', type: '系統櫃', title: '報價確認', assignedTo: 'emp1', startTime: `${todayStr}T00:00`, endTime: `${formatDate(new Date(Date.now() + 5 * 24 * 60 * 60 * 1000))}T00:00`, priority: 2, status: 'pending', parallelIndex: 1, predecessorId: '', recurrence: 'none', taskMode: 'longterm', notes: '' },
                    { id: 't8', projectId: 'proj3', projectName: '台南安平-王公館', type: '水電', title: '管線確認', assignedTo: 'emp1', startTime: `${todayStr}T00:00`, endTime: `${formatDate(new Date(Date.now() + 3 * 24 * 60 * 60 * 1000))}T00:00`, priority: 3, status: 'in_progress', parallelIndex: 1, predecessorId: '', recurrence: 'none', taskMode: 'longterm', notes: '' },
                    { id: 't9', projectId: 'proj4', projectName: '高雄鼓山-許宅', type: '場勘', title: '現場丈量', assignedTo: 'emp1', startTime: `${todayStr}T00:00`, endTime: `${formatDate(new Date(Date.now() + 2 * 24 * 60 * 60 * 1000))}T00:00`, priority: 1, status: 'pending', parallelIndex: 1, predecessorId: '', recurrence: 'none', taskMode: 'longterm', notes: '' },
                    { id: 't10', projectId: 'proj5', projectName: '台南北區-張公館', type: '木作', title: '施工圖繪製', assignedTo: 'emp1', startTime: `${todayStr}T00:00`, endTime: `${formatDate(new Date(Date.now() + 10 * 24 * 60 * 60 * 1000))}T00:00`, priority: 2, status: 'in_progress', parallelIndex: 1, predecessorId: '', recurrence: 'none', taskMode: 'longterm', notes: '' },
                    { id: 't11', projectId: 'proj6', projectName: '高雄三民-李宅', type: '油漆', title: '材料採購', assignedTo: 'emp1', startTime: `${todayStr}T00:00`, endTime: `${formatDate(new Date(Date.now() + 4 * 24 * 60 * 60 * 1000))}T00:00`, priority: 3, status: 'pending', parallelIndex: 1, predecessorId: '', recurrence: 'none', taskMode: 'longterm', notes: '' },
                    { id: 't12', projectId: 'proj7', projectName: '台南中西-吳公館', type: '驗收', title: '交屋準備', assignedTo: 'emp1', startTime: `${todayStr}T00:00`, endTime: `${formatDate(new Date(Date.now() + 14 * 24 * 60 * 60 * 1000))}T00:00`, priority: 1, status: 'in_progress', parallelIndex: 1, predecessorId: '', recurrence: 'none', taskMode: 'longterm', notes: '' },
                ]);

                // === 狀態 ===
                const currentView = ref('week');
                const currentUserId = ref('emp1');
                const currentUserRole = ref('admin'); // admin, leader, worker
                const currentWeekStart = ref(getMonday(new Date()));
                const filterProject = ref('');
                const filterTypes = ref([...taskTypes]);
                const showModal = ref(false);
                const showShiftModal = ref(false);
                const editingTask = ref(null);
                const shiftSuggestions = ref([]);
                const toast = ref({ show: false, message: '', type: 'success' });
                const showAllLongterm = ref(false); // 控制負責案件標籤是否全部展開

                const taskForm = ref({
                    projectId: 'proj1', type: '木作', title: '',
                    startDate: todayStr, startSlot: '09:00',
                    endDate: todayStr, endSlot: '10:00',
                    assignedTo: 'emp1', priority: 3, predecessorId: '', recurrence: 'none',
                    taskMode: 'instant', notes: ''
                });

                // === 計算屬性 ===
                const weekDays = computed(() => {
                    const days = [];
                    const start = new Date(currentWeekStart.value);
                    const weekdayNames = ['日', '一', '二', '三', '四', '五', '六'];
                    for (let i = 0; i < 7; i++) {
                        const d = new Date(start);
                        d.setDate(start.getDate() + i);
                        days.push({ date: formatDate(d), day: d.getDate(), weekday: `週${weekdayNames[d.getDay()]}` });
                    }
                    return days;
                });

                const weekLabel = computed(() => {
                    const start = new Date(currentWeekStart.value);
                    const end = new Date(start);
                    end.setDate(start.getDate() + 6);
                    return `${start.getMonth() + 1}/${start.getDate()} - ${end.getMonth() + 1}/${end.getDate()}`;
                });

                const workHours = computed(() => Array.from({ length: 11 }, (_, i) => i + 8)); // 08:00 - 18:00

                const employeeGroups = computed(() => {
                    const groups = {};
                    employees.value.forEach(e => {
                        if (!groups[e.group]) groups[e.group] = { name: e.group, members: [] };
                        groups[e.group].members.push(e);
                    });
                    return Object.values(groups);
                });

                const filteredTasks = computed(() => {
                    return tasks.value.filter(t => {
                        if (filterProject.value && t.projectId !== filterProject.value) return false;
                        if (!filterTypes.value.includes(t.type)) return false;
                        return true;
                    });
                });

                const todaySummary = computed(() => {
                    const todayTasks = tasks.value.filter(t => t.startTime.startsWith(todayStr) && t.assignedTo === currentUserId.value);
                    return {
                        pending: todayTasks.filter(t => t.status === 'pending').length,
                        inProgress: todayTasks.filter(t => t.status === 'in_progress').length,
                        completed: todayTasks.filter(t => t.status === 'completed').length
                    };
                });

                const conflicts = computed(() => {
                    const result = [];
                    // 只檢測即時任務的衝突
                    const userTasks = tasks.value.filter(t => t.assignedTo === currentUserId.value && t.taskMode === 'instant');
                    for (let i = 0; i < userTasks.length; i++) {
                        for (let j = i + 1; j < userTasks.length; j++) {
                            if (isOverlapping(userTasks[i], userTasks[j])) {
                                result.push({ id: `${userTasks[i].id}-${userTasks[j].id}`, message: `${userTasks[i].title} 與 ${userTasks[j].title} 時間重疊` });
                            }
                        }
                    }
                    return result;
                });

                const delayedTasks = computed(() => {
                    const now = new Date();
                    return tasks.value.filter(t => {
                        if (t.status === 'completed') return false;
                        const end = new Date(t.endTime);
                        return end < now;
                    });
                });

                // === 方法 ===
                function getMonday(d) {
                    const date = new Date(d);
                    const day = date.getDay();
                    const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                    date.setDate(diff);
                    return formatDate(date);
                }

                function isToday(dateStr) { return dateStr === todayStr; }

                function changeWeek(delta) {
                    const d = new Date(currentWeekStart.value);
                    d.setDate(d.getDate() + delta * 7);
                    currentWeekStart.value = formatDate(d);
                }

                function goToToday() { currentWeekStart.value = getMonday(new Date()); }

                function toggleTypeFilter(type) {
                    const idx = filterTypes.value.indexOf(type);
                    if (idx >= 0) filterTypes.value.splice(idx, 1);
                    else filterTypes.value.push(type);
                }

                function getTasksAt(date, hour) {
                    return filteredTasks.value.filter(t => {
                        if (t.assignedTo !== currentUserId.value) return false;
                        // 長期任務在頂部橫跨條顯示，不在時間格顯示
                        if (t.taskMode === 'longterm') return false;

                        // 即時任務：按原邏輯顯示
                        const startDate = t.startTime.split('T')[0];
                        const startHour = parseInt(t.startTime.split('T')[1].split(':')[0]);
                        return startDate === date && startHour === hour;
                    });
                }

                // 取得某日的所有即時任務 (Apple 日曆風格用)
                function getDayTasks(date) {
                    return filteredTasks.value.filter(t => {
                        if (t.assignedTo !== currentUserId.value) return false;
                        if (t.taskMode === 'longterm') return false;
                        const startDate = t.startTime.split('T')[0];
                        return startDate === date;
                    });
                }

                // 計算任務在日曆中的位置和高度
                function getTaskPosition(task) {
                    // 直接從字串解析時間，避免 Date 的時區轉換問題
                    const parseTimeStr = (str) => {
                        const timePart = str.split('T')[1] || '00:00';
                        const [h, m] = timePart.split(':').map(Number);
                        return h + (m || 0) / 60;
                    };

                    const startHour = parseTimeStr(task.startTime);
                    const endHour = parseTimeStr(task.endTime);

                    // 每小時 48px
                    const hourHeight = 48;

                    // top: 從 08:00 開始算
                    const top = (startHour - 8) * hourHeight;
                    // height: 根據時長
                    const height = Math.max(24, (endHour - startHour) * hourHeight);

                    return {
                        top: top + 'px',
                        height: height + 'px',
                        minHeight: '24px'
                    };
                }

                function getEmployeeTasks(empId) {
                    return tasks.value.filter(t => {
                        if (t.assignedTo !== empId) return false;
                        // 即時任務：今日的任務
                        if (t.taskMode === 'instant') {
                            return t.startTime.startsWith(todayStr);
                        }
                        // 長期任務：進行中的都顯示
                        if (t.taskMode === 'longterm') {
                            const now = new Date();
                            const start = new Date(t.startTime);
                            const end = new Date(t.endTime);
                            return now >= start && now <= end;
                        }
                        return t.startTime.startsWith(todayStr);
                    });
                }

                function getProjectTasks(projectId) {
                    return tasks.value.filter(t => t.projectId === projectId);
                }

                function getParallelCount(empId) {
                    return tasks.value.filter(t => t.assignedTo === empId && t.startTime.startsWith(todayStr) && t.status !== 'completed').length;
                }

                function getTaskCount(empId, date) {
                    return tasks.value.filter(t => t.assignedTo === empId && t.startTime.startsWith(date)).length;
                }

                function getHeatmapClass(empId, date) {
                    const count = getTaskCount(empId, date);
                    if (count === 0) return 'bg-gray-100 text-gray-400';
                    if (count <= 2) return 'bg-green-100 text-green-700';
                    if (count <= 4) return 'bg-yellow-100 text-yellow-700';
                    return 'bg-red-100 text-red-700';
                }

                function getGanttStyle(task) {
                    const start = new Date(task.startTime);
                    const end = new Date(task.endTime);
                    const weekStart = new Date(currentWeekStart.value);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 7);
                    const totalMs = weekEnd - weekStart;
                    const left = Math.max(0, (start - weekStart) / totalMs * 100);
                    const width = Math.min(100 - left, (end - start) / totalMs * 100);
                    return { left: `${left}%`, width: `${Math.max(5, width)}%` };
                }

                function getGanttBg(type) {
                    const colors = { '場勘': 'bg-amber-500', '放樣': 'bg-blue-500', '拆除': 'bg-red-500', '水電': 'bg-emerald-500', '木作': 'bg-pink-500', '油漆': 'bg-indigo-500', '系統櫃': 'bg-purple-500', '驗收': 'bg-teal-500' };
                    return colors[type] || 'bg-gray-500';
                }

                // 取得當前用戶的長期任務（在本週範圍內）
                function getLongtermTasks() {
                    const weekStart = new Date(currentWeekStart.value);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 7);

                    return filteredTasks.value.filter(t => {
                        if (t.assignedTo !== currentUserId.value) return false;
                        if (t.taskMode !== 'longterm') return false;
                        const taskStart = new Date(t.startTime);
                        const taskEnd = new Date(t.endTime);
                        // 任務與本週有交集
                        return taskStart < weekEnd && taskEnd > weekStart;
                    });
                }

                // 計算長期任務橫跨條的樣式
                function getLongtermStyle(task) {
                    const weekStart = new Date(currentWeekStart.value);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 7);

                    const taskStart = new Date(task.startTime);
                    const taskEnd = new Date(task.endTime);

                    // 計算在本週內的起點和終點
                    const visibleStart = taskStart < weekStart ? weekStart : taskStart;
                    const visibleEnd = taskEnd > weekEnd ? weekEnd : taskEnd;

                    const dayWidth = 100 / 7; // 每天佔 1/7
                    const startDay = (visibleStart - weekStart) / (24 * 60 * 60 * 1000);
                    const endDay = (visibleEnd - weekStart) / (24 * 60 * 60 * 1000);

                    const left = Math.max(0, startDay * dayWidth);
                    const width = Math.max(dayWidth * 0.5, (endDay - startDay) * dayWidth);

                    return { left: `${left}%`, width: `${Math.min(100 - left, width)}%` };
                }

                // 取得案場藥丸標籤的顏色樣式
                const projectColors = [
                    'bg-purple-100 text-purple-700 border border-purple-300',
                    'bg-blue-100 text-blue-700 border border-blue-300',
                    'bg-emerald-100 text-emerald-700 border border-emerald-300',
                    'bg-amber-100 text-amber-700 border border-amber-300',
                    'bg-rose-100 text-rose-700 border border-rose-300',
                    'bg-cyan-100 text-cyan-700 border border-cyan-300',
                    'bg-indigo-100 text-indigo-700 border border-indigo-300',
                    'bg-orange-100 text-orange-700 border border-orange-300',
                    'bg-teal-100 text-teal-700 border border-teal-300',
                    'bg-pink-100 text-pink-700 border border-pink-300',
                ];

                function getProjectPillClass(projectId) {
                    const idx = projects.value.findIndex(p => p.id === projectId);
                    return projectColors[idx % projectColors.length] || projectColors[0];
                }

                // 取得案場簡稱（案件名稱最多取7個字，加上任務類型）
                function getProjectShortName(task) {
                    const project = projects.value.find(p => p.id === task.projectId);
                    if (!project) return task.title.slice(0, 8);
                    // 嘗試提取簡短名稱：如 "台南東區-陳公館" → "陳公館"
                    const parts = project.name.split('-');
                    const shortName = parts.length > 1 ? parts[parts.length - 1] : project.name.slice(0, 6);
                    return shortName;
                }

                function formatTime(datetime) {
                    if (!datetime) return '';
                    return datetime.split('T')[1]?.substring(0, 5) || '';
                }

                function isOverlapping(t1, t2) {
                    const s1 = new Date(t1.startTime), e1 = new Date(t1.endTime);
                    const s2 = new Date(t2.startTime), e2 = new Date(t2.endTime);
                    return s1 < e2 && s2 < e1;
                }

                function openTaskModal(date = null, hour = null, task = null) {
                    if (task) {
                        editingTask.value = task;
                        // 從 startTime/endTime 解析出日期和時段
                        const [sd, st] = task.startTime.split('T');
                        const [ed, et] = task.endTime.split('T');
                        taskForm.value = {
                            ...task,
                            startDate: sd,
                            startSlot: st?.substring(0, 5) || '09:00',
                            endDate: ed,
                            endSlot: et?.substring(0, 5) || '10:00'
                        };
                    } else {
                        editingTask.value = null;
                        const startDateVal = date || todayStr;
                        const startSlotVal = hour ? `${String(hour).padStart(2, '0')}:00` : '09:00';
                        const endHour = (hour || 9) + 1;
                        taskForm.value = {
                            projectId: 'proj1', type: '木作', title: '',
                            startDate: startDateVal, startSlot: startSlotVal,
                            endDate: startDateVal, endSlot: `${String(endHour).padStart(2, '0')}:00`,
                            assignedTo: currentUserId.value, priority: 3,
                            predecessorId: '', recurrence: 'none', taskMode: 'instant', notes: ''
                        };
                    }
                    showModal.value = true;
                }

                function saveTask() {
                    if (!taskForm.value.title) { showToast('請輸入任務名稱', 'error'); return; }
                    const project = projects.value.find(p => p.id === taskForm.value.projectId);

                    // 組合 startTime 和 endTime
                    const startTime = `${taskForm.value.startDate}T${taskForm.value.startSlot}`;
                    const endTime = `${taskForm.value.endDate}T${taskForm.value.endSlot}`;

                    // 檢查前置任務限制
                    if (taskForm.value.predecessorId) {
                        const pred = tasks.value.find(t => t.id === taskForm.value.predecessorId);
                        if (pred && new Date(startTime) < new Date(pred.endTime)) {
                            showToast('開始時間必須在前置任務結束之後', 'error');
                            return;
                        }
                    }

                    if (editingTask.value) {
                        Object.assign(editingTask.value, {
                            ...taskForm.value,
                            startTime, endTime,
                            projectName: project?.name || ''
                        });
                        showToast('任務已更新', 'success');
                    } else {
                        const newTask = {
                            id: 't' + Date.now(),
                            ...taskForm.value,
                            startTime, endTime,
                            projectName: project?.name || '',
                            status: 'pending',
                            parallelIndex: 1
                        };
                        tasks.value.push(newTask);

                        // 週期性任務生成
                        if (taskForm.value.recurrence !== 'none') {
                            generateRecurringTasks(newTask);
                        }

                        showToast('任務已建立', 'success');
                    }

                    // 檢查衝突並建議推移
                    checkAndSuggestShift();
                    showModal.value = false;
                }

                function generateRecurringTasks(baseTask) {
                    const intervals = { daily: 1, weekly: 7, monthly: 30 };
                    const interval = intervals[baseTask.recurrence] || 0;
                    if (!interval) return;

                    for (let i = 1; i <= 4; i++) {
                        const startDate = new Date(baseTask.startTime);
                        const endDate = new Date(baseTask.endTime);
                        startDate.setDate(startDate.getDate() + interval * i);
                        endDate.setDate(endDate.getDate() + interval * i);

                        tasks.value.push({
                            ...baseTask,
                            id: 't' + Date.now() + i,
                            startTime: startDate.toISOString().slice(0, 16),
                            endTime: endDate.toISOString().slice(0, 16),
                            recurrence: 'none' // 生成的子任務不再週期
                        });
                    }
                    showToast(`已生成 4 個週期性任務`, 'success');
                }

                function checkAndSuggestShift() {
                    const userTasks = tasks.value.filter(t => t.assignedTo === currentUserId.value);
                    const suggestions = [];

                    for (let i = 0; i < userTasks.length; i++) {
                        for (let j = i + 1; j < userTasks.length; j++) {
                            if (isOverlapping(userTasks[i], userTasks[j])) {
                                const higher = userTasks[i].priority <= userTasks[j].priority ? userTasks[i] : userTasks[j];
                                const lower = higher === userTasks[i] ? userTasks[j] : userTasks[i];
                                const shiftMinutes = Math.ceil((new Date(higher.endTime) - new Date(lower.startTime)) / 60000);

                                suggestions.push({
                                    id: lower.id,
                                    taskTitle: lower.title,
                                    conflictWith: higher.title,
                                    shiftMinutes,
                                    message: `將「${lower.title}」往後推 ${shiftMinutes} 分鐘`
                                });
                            }
                        }
                    }

                    if (suggestions.length > 0) {
                        shiftSuggestions.value = suggestions;
                        showShiftModal.value = true;
                    }
                }

                function applyShift(suggestion) {
                    const task = tasks.value.find(t => t.id === suggestion.id);
                    if (!task) return;

                    const newStart = new Date(task.startTime);
                    const newEnd = new Date(task.endTime);
                    newStart.setMinutes(newStart.getMinutes() + suggestion.shiftMinutes);
                    newEnd.setMinutes(newEnd.getMinutes() + suggestion.shiftMinutes);

                    // 檢查是否超過下班時間 (18:00)
                    if (newEnd.getHours() >= 18) {
                        // 轉到隔天 09:00
                        const nextDay = new Date(newStart);
                        nextDay.setDate(nextDay.getDate() + 1);
                        nextDay.setHours(9, 0, 0);
                        const duration = new Date(task.endTime) - new Date(task.startTime);
                        task.startTime = nextDay.toISOString().slice(0, 16);
                        task.endTime = new Date(nextDay.getTime() + duration).toISOString().slice(0, 16);
                        showToast(`任務已轉至隔日 09:00`, 'success');
                    } else {
                        task.startTime = newStart.toISOString().slice(0, 16);
                        task.endTime = newEnd.toISOString().slice(0, 16);
                        showToast(`任務已往後推移 ${suggestion.shiftMinutes} 分鐘`, 'success');
                    }

                    shiftSuggestions.value = shiftSuggestions.value.filter(s => s.id !== suggestion.id);
                    if (shiftSuggestions.value.length === 0) showShiftModal.value = false;
                }

                function applyAllShifts() {
                    shiftSuggestions.value.forEach(s => applyShift(s));
                }

                function deleteTask() {
                    if (editingTask.value) {
                        const idx = tasks.value.findIndex(t => t.id === editingTask.value.id);
                        if (idx >= 0) tasks.value.splice(idx, 1);
                        showToast('任務已刪除', 'success');
                        showModal.value = false;
                    }
                }

                function showToast(message, type = 'success') {
                    toast.value = { show: true, message, type };
                    setTimeout(() => toast.value.show = false, 3000);
                }

                // 拖拉功能
                let draggedTask = null;
                function onDragStart(e, task) { draggedTask = task; }
                function onDrop(e, date, hour) {
                    if (!draggedTask) return;
                    const duration = new Date(draggedTask.endTime) - new Date(draggedTask.startTime);
                    draggedTask.startTime = `${date}T${String(hour).padStart(2, '0')}:00`;
                    const endDate = new Date(draggedTask.startTime);
                    endDate.setTime(endDate.getTime() + duration);
                    draggedTask.endTime = endDate.toISOString().slice(0, 16);
                    showToast('任務時間已調整', 'success');
                    draggedTask = null;
                }

                // 時長拖曳調整功能（優化版）
                let resizingTask = null;
                let resizeStartY = 0;
                let resizeStartEndMinutes = 0;
                let pixelsPer15Min = 12; // 每 15 分鐘的像素高度
                let lastPreviewTime = ''; // 上次預覽的時間，避免重複更新
                let rafId = null; // requestAnimationFrame ID

                function startResize(e, task) {
                    e.preventDefault();
                    resizingTask = task;
                    resizeStartY = e.clientY;

                    // 從時間字串解析結束時間的分鐘數
                    const endTimePart = task.endTime.split('T')[1] || '11:00';
                    const [h, m] = endTimePart.split(':').map(Number);
                    resizeStartEndMinutes = h * 60 + (m || 0);

                    // 動態計算每 15 分鐘的像素高度（更精準）
                    const calendarEl = document.querySelector('[data-calendar-grid=\"true\"]');
                    if (calendarEl) {
                        const gridHeight = calendarEl.offsetHeight;
                        const totalSlots = 11 * 4; // 11 小時 * 每小時 4 格 = 44 格（每格 15 分鐘）
                        pixelsPer15Min = gridHeight / totalSlots;
                    }

                    lastPreviewTime = '';
                    document.addEventListener('mousemove', onResizeMove, { passive: true });
                    document.addEventListener('mouseup', onResizeEnd);
                    document.body.style.cursor = 'ns-resize';
                    document.body.style.userSelect = 'none';
                }

                function onResizeMove(e) {
                    if (!resizingTask) return;

                    // 使用 RAF 節流，避免過度渲染
                    if (rafId) return;
                    rafId = requestAnimationFrame(() => {
                        rafId = null;
                        updateResizePosition(e.clientY);
                    });
                }

                function updateResizePosition(clientY) {
                    if (!resizingTask) return;

                    // 計算滑鼠移動的像素差
                    const deltaY = clientY - resizeStartY;

                    // 計算時間變化：每移動 pixelsPer15Min 像素 = 15 分鐘
                    const deltaSlots = Math.round(deltaY / pixelsPer15Min);
                    const deltaMinutes = deltaSlots * 15;

                    // 計算新的結束時間分鐘數（對齊到 15 分鐘）
                    let newEndMinutes = resizeStartEndMinutes + deltaMinutes;

                    // 獲取開始時間
                    const startTimePart = resizingTask.startTime.split('T')[1] || '09:00';
                    const [sh, sm] = startTimePart.split(':').map(Number);
                    const startMinutes = sh * 60 + (sm || 0);

                    // 確保結束時間至少比開始時間晚 15 分鐘，最多 18:00
                    const clampedMinutes = Math.max(startMinutes + 15, Math.min(18 * 60, newEndMinutes));
                    const finalHour = Math.floor(clampedMinutes / 60);
                    const finalMins = clampedMinutes % 60;

                    // 拼接新的結束時間字串
                    const datePart = resizingTask.endTime.split('T')[0];
                    const endHours = String(finalHour).padStart(2, '0');
                    const endMins = String(finalMins).padStart(2, '0');
                    const newEndTime = `${datePart}T${endHours}:${endMins}`;

                    // 只有時間改變時才更新（減少 Vue 反應式開銷）
                    if (resizingTask.endTime !== newEndTime) {
                        resizingTask.endTime = newEndTime;

                        // 即時預覽吐司（避免重複顯示相同時間）
                        const timeStr = `${endHours}:${endMins}`;
                        if (timeStr !== lastPreviewTime) {
                            lastPreviewTime = timeStr;
                            toast.value = { show: true, message: `⏱ ${timeStr}`, type: 'success' };
                        }
                    }
                }

                function onResizeEnd() {
                    if (rafId) {
                        cancelAnimationFrame(rafId);
                        rafId = null;
                    }
                    if (resizingTask) {
                        showToast(`時長調整至 ${formatTime(resizingTask.endTime)}`, 'success');
                    }
                    resizingTask = null;
                    lastPreviewTime = '';
                    document.removeEventListener('mousemove', onResizeMove);
                    document.removeEventListener('mouseup', onResizeEnd);
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }

                // 任務狀態切換
                function toggleStatus(task) {
                    const statusFlow = { 'pending': 'in_progress', 'in_progress': 'completed', 'completed': 'pending' };
                    task.status = statusFlow[task.status] || 'pending';
                    showToast(`任務狀態：${{ 'pending': '待處理', 'in_progress': '進行中', 'completed': '已完成' }[task.status]}`, 'success');
                }

                // 歷史導出
                function exportHistory() {
                    const projectId = filterProject.value;
                    const exportTasks = projectId ? tasks.value.filter(t => t.projectId === projectId) : tasks.value;

                    let csv = '任務名稱,案場,類型,負責人,開始時間,結束時間,狀態\n';
                    exportTasks.forEach(t => {
                        const emp = employees.value.find(e => e.id === t.assignedTo);
                        csv += `"${t.title}","${t.projectName}","${t.type}","${emp?.name || ''}","${t.startTime}","${t.endTime}","${t.status}"\n`;
                    });

                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `工期記錄_${formatDate(new Date())}.csv`;
                    link.click();
                    showToast(`已導出 ${exportTasks.length} 筆記錄`, 'success');
                }

                return {
                    employees, projects, taskTypes, timeSlots, tasks, currentView, currentUserId, currentUserRole, currentWeekStart,
                    filterProject, filterTypes, showModal, showShiftModal, editingTask, taskForm, toast, showAllLongterm,
                    shiftSuggestions, weekDays, weekLabel, workHours, employeeGroups, filteredTasks, todaySummary, conflicts, delayedTasks,
                    isToday, changeWeek, goToToday, toggleTypeFilter, getTasksAt, getDayTasks, getTaskPosition, getEmployeeTasks,
                    getProjectTasks, getParallelCount, getTaskCount, getHeatmapClass, getGanttStyle,
                    getGanttBg, getLongtermTasks, getLongtermStyle, getProjectPillClass, getProjectShortName,
                    formatTime, openTaskModal, saveTask, deleteTask, onDragStart, onDrop, startResize,
                    applyShift, applyAllShifts, toggleStatus, exportHistory
                };
            }
        }).mount('#app');
    </script>
</body>

</html>