<!DOCTYPE html>
<html lang="zh-TW">
<!-- v2.0 - 2025-12-16 23:39 (Asia/Taipei) -->
<!-- ‰øÆÊîπÂÖßÂÆπ: ÂúñÁâáÈÅ∏ÊìáÂô®ÈáçÊßã - ÂæåÁ´ØÊêúÂ∞ã 20 Âºµ, ÂâçÁ´ØÁ∂≤Ê†ºÈ°ØÁ§∫ 5 Âºµ/È†Å, ÂàÜÈ†ÅÊéßÂà∂ -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê∑ªÂøÉË£ù‰øÆÂ∑•ÊñôÊ™¢Ê†∏Â∞èÂπ´Êâã v1.8</title>

    <!-- Ê†∏ÂøÉÂ∫´: Vue 3 & Tailwind -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ÂúñÊ®ôÂ∫´: Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Èö±ËóèÊç≤Ëª∏‰ΩÜ‰øùÁïôÂäüËÉΩ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Âú® Vue ÂÆåÊàêÊéõËºâÂâçÈö±ËóèÊï¥ÂÄã app */
        [v-cloak] {
            display: none !important;
        }

        /* Toast ÈÄöÁü•ÂãïÁï´ */
        .toast-enter-active,
        .toast-leave-active {
            transition: all 0.3s ease;
        }

        .toast-enter-from,
        .toast-leave-to {
            opacity: 0;
            transform: translateX(100%);
        }

        /* Skeleton Loading ÂãïÁï´ */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body>
    <div id="app" v-cloak class="min-h-screen flex flex-col">
        <!-- È†ÇÈÉ®Â∞éËà™ -->
        <header class="bg-indigo-600 text-white p-4 shadow-lg sticky top-0 z-50">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i class="ph ph-toolbox text-2xl"></i>
                    <h1 class="text-xl font-bold tracking-wide">Ë£ù‰øÆÂ∑•ÊñôÊ™¢Ê†∏Â∞èÂπ´Êâã</h1>
                    <span class="text-xs bg-indigo-500 px-2 py-0.5 rounded text-indigo-100">v1.8</span>
                </div>
                <!-- loading state -->
                <div v-if="loading" class="flex items-center gap-2 text-sm animate-pulse">
                    <i class="ph ph-spinner animate-spin"></i>
                    <span>Ë≥áÊñôËÆÄÂèñ‰∏≠...</span>
                </div>
                <button @click="setupDatabase" title="ÈáçÁΩÆË≥áÊñôÂ∫´ (Admin)"
                    class="ml-4 text-xs bg-red-800 text-red-200 px-2 py-1 rounded hover:bg-red-700 transition-colors">
                    <i class="ph ph-database"></i> ÈáçÁΩÆ DB
                </button>
            </div>
        </header>

        <!-- ‰∏ªÂÖßÂÆπÂçÄ -->
        <main class="flex-1 max-w-7xl w-full mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">

            <!-- Â∑¶ÂÅ¥ÔºöÊéßÂà∂ËàáËº∏ÂÖ•ÂçÄ (‰Ωî 4 Ê¨Ñ) -->
            <section class="lg:col-span-4 space-y-6">
                <!-- 1. Ê°àÂ†¥Ë®≠ÂÆö -->
                <div class="bg-white rounded-xl card-shadow p-5 border border-gray-100">
                    <h2 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="ph ph-house-line text-indigo-600"></i> Ê°àÂ†¥Ë®≠ÂÆö
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ê°àÂ†¥ÂêçÁ®±</label>
                            <input v-model="project.name" type="text" placeholder="‰æãÂ¶ÇÔºöÂè∞ÂçóÊù±ÂçÄ-Èô≥ÂÖ¨È§®"
                                class="w-full rounded-lg border-gray-300 border p-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-colors">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÊñΩÂ∑•ÈöéÊÆµ (ÁØ©ÈÅ∏Â∑•ÂÖ∑)</label>
                                <select v-model="project.phase"
                                    class="w-full rounded-lg border-gray-300 border p-2 bg-white">
                                    <option value="ALL">ÂÖ®ÈÉ®ÈöéÊÆµ</option>
                                    <option v-for="p in phases" :key="p" :value="p">{{ p }}</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Â∑•ÂÖ∑ÂàÜÈÖç</label>
                                <select v-model="project.allocMode"
                                    class="w-full rounded-lg border-gray-300 border p-2 bg-white">
                                    <option value="share">ÂÖ±Áî® (Âêà‰Ωµ)</option>
                                    <option value="individual">ÂàÜÈñãÁî±Â∏´ÂÇÖÂ∏∂</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Âä†ÂÖ•Â∑•È†Ö -->
                <div class="bg-white rounded-xl card-shadow p-5 border border-indigo-100 ring-1 ring-indigo-50">
                    <h2 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="ph ph-plus-circle text-indigo-600"></i> Êñ∞Â¢ûÂ∑•È†Ö
                    </h2>

                    <div class="space-y-4">
                        <!-- ÂàÜÈ°ûÁØ©ÈÅ∏ -->
                        <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                            <button v-for="cat in categories" :key="cat" @click="filterCategory = cat"
                                :class="{'bg-indigo-600 text-white': filterCategory === cat, 'bg-gray-100 text-gray-600 hover:bg-gray-200': filterCategory !== cat}"
                                class="px-3 py-1.5 rounded-full text-sm whitespace-nowrap transition-colors">
                                {{ cat }}
                            </button>
                        </div>

                        <!-- Â∑•È†ÖÈÅ∏Êìá (ÊêúÂ∞ã + Ê∏ÖÂñÆ) -->
                        <div class="relative">
                            <select v-model="selectedTask"
                                class="w-full rounded-lg border-gray-300 border p-2 bg-white h-12">
                                <option :value="null" disabled>Ë´ãÈÅ∏ÊìáÂ∑•È†Ö...</option>
                                <option v-for="task in filteredTasks" :key="task.task_id" :value="task">
                                    [{{ task.category }}] {{ task.task_name }} ({{ task.unit }})
                                </option>
                            </select>
                        </div>

                        <!-- Êï∏ÈáèËº∏ÂÖ• -->
                        <div class="flex gap-2 items-end" v-if="selectedTask">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">ÊñΩÂ∑•Êï∏Èáè ({{ selectedTask.unit }})</label>
                                <input v-model.number="inputQty" type="number" min="0" step="0.1"
                                    class="w-full text-2xl font-bold text-indigo-600 border-b-2 border-indigo-200 focus:border-indigo-600 focus:outline-none p-1 bg-transparent placeholder-indigo-200">
                            </div>
                            <button @click="addTask"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-bold shadow-md active:transform active:scale-95 transition-all flex items-center gap-2">
                                <i class="ph ph-check-bold"></i> Âä†ÂÖ•
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 3. Â∑≤ÈÅ∏Â∑•È†ÖÊ∏ÖÂñÆ (Ë≥ºÁâ©Ëªä) -->
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <div class="bg-gray-50 px-5 py-3 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="font-bold text-gray-700 text-sm">Â∑≤Ë¶èÂäÉÊ∏ÖÂñÆ</h3>
                        <span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full">{{ cart.length }}
                            È†Ö</span>
                    </div>
                    <div class="max-h-[300px] overflow-y-auto p-2">
                        <div v-if="cart.length === 0" class="text-center py-8 text-gray-400 text-sm">
                            Â∞öÊú™Âä†ÂÖ•‰ªª‰ΩïÂ∑•È†Ö
                        </div>
                        <ul class="space-y-2">
                            <li v-for="(item, idx) in cart" :key="idx"
                                class="flex justify-between items-center p-3 hover:bg-gray-50 rounded-lg group border border-transparent hover:border-gray-200 transition-all">
                                <div>
                                    <div class="font-bold text-gray-800">{{ item.task.task_name }}</div>
                                    <div class="text-xs text-gray-500">{{ item.task.category }} | <span
                                            class="text-indigo-600 font-bold">{{ item.qty }}</span> {{ item.task.unit }}
                                    </div>
                                </div>
                                <button @click="removeTask(idx)"
                                    class="text-gray-400 hover:text-red-500 p-2 transition-colors">
                                    <i class="ph ph-trash text-lg"></i>
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Âè≥ÂÅ¥ÔºöË®àÁÆóÁµêÊûúÂçÄ (‰Ωî 8 Ê¨Ñ) -->
            <section class="lg:col-span-8 space-y-6">

                <!-- Tab ÂàáÊèõ -->
                <div class="flex border-b border-gray-200">
                    <button @click="viewMode = 'materials'"
                        :class="{'border-indigo-600 text-indigo-600': viewMode === 'materials', 'border-transparent text-gray-500 hover:text-gray-700': viewMode !== 'materials'}"
                        class="px-6 py-3 border-b-2 font-medium transition-colors flex items-center gap-2">
                        <i class="ph ph-package"></i> ÊùêÊñôÁ∏ΩË°®
                    </button>
                    <button @click="viewMode = 'tools'"
                        :class="{'border-indigo-600 text-indigo-600': viewMode === 'tools', 'border-transparent text-gray-500 hover:text-gray-700': viewMode !== 'tools'}"
                        class="px-6 py-3 border-b-2 font-medium transition-colors flex items-center gap-2">
                        <i class="ph ph-wrench"></i> Â∑•ÂÖ∑Ê∏ÖÂñÆ
                    </button>
                    <button @click="viewMode = 'sop'"
                        :class="{'border-indigo-600 text-indigo-600': viewMode === 'sop', 'border-transparent text-gray-500 hover:text-gray-700': viewMode !== 'sop'}"
                        class="px-6 py-3 border-b-2 font-medium transition-colors flex items-center gap-2">
                        <i class="ph ph-clipboard-text"></i> ÊñΩÂ∑•ÈáçÈªû
                    </button>
                    <button @click="viewMode = 'recipes'"
                        :class="{'border-indigo-600 text-indigo-600': viewMode === 'recipes', 'border-transparent text-gray-500 hover:text-gray-700': viewMode !== 'recipes'}"
                        class="px-6 py-3 border-b-2 font-medium transition-colors flex items-center gap-2">
                        <i class="ph ph-note-pencil"></i> ÈÖçÊñπÁÆ°ÁêÜ
                    </button>
                    <button @click="viewMode = 'dataManager'"
                        :class="{'border-indigo-600 text-indigo-600': viewMode === 'dataManager', 'border-transparent text-gray-500 hover:text-gray-700': viewMode !== 'dataManager'}"
                        class="px-6 py-3 border-b-2 font-medium transition-colors flex items-center gap-2">
                        <i class="ph ph-database"></i> Ë≥áÊñôÁÆ°ÁêÜ
                    </button>
                </div>

                <!-- ÂÖßÂÆπÈ°ØÁ§∫ÂçÄ -->
                <div class="bg-white rounded-xl card-shadow min-h-[500px] p-6">

                    <!-- A. ÊùêÊñôË°® -->
                    <div v-show="viewMode === 'materials'">
                        <div class="flex justify-between mb-4">
                            <h3 class="font-bold text-lg">ÈúÄÊé°Ë≥ºÊùêÊñôÂΩôÊï¥</h3>
                            <button @click="copyToClipboard('materials')"
                                class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center gap-1">
                                <i class="ph ph-copy"></i> Ë§áË£ΩÊñáÂ≠ó
                            </button>
                        </div>

                        <!-- Á©∫ÁãÄÊÖãÊèêÁ§∫ -->
                        <div v-if="Object.keys(calculatedMaterials).length === 0"
                            class="text-center py-16 text-gray-400">
                            <i class="ph ph-package text-6xl mb-4 opacity-30"></i>
                            <p class="text-lg font-medium">Â∞öÁÑ°ÊùêÊñôÈúÄÊ±Ç</p>
                            <p class="text-sm mt-2">Ë´ãÂÖàÂú®Â∑¶ÂÅ¥Âä†ÂÖ•Â∑•È†ÖÔºåÁ≥ªÁµ±Â∞áËá™ÂãïË®àÁÆóÊâÄÈúÄÊùêÊñô</p>
                        </div>

                        <!-- ‰æù‰æõÊáâÂïÜÂàÜÈ°û -->
                        <div v-else>
                            <div v-for="(group, vendor) in calculatedMaterials" :key="vendor" class="mb-6">
                                <h4
                                    class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 border-l-4 border-indigo-400 pl-2 bg-gray-50 py-1">
                                    {{ vendor || 'Êú™ÊåáÂÆö‰æõÊáâÂïÜ' }}</h4>
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50 text-gray-700">
                                        <tr>
                                            <th class="text-left p-2 rounded-l">ÊùêÊñôÂêçÁ®±</th>
                                            <th class="text-left p-2">Ë¶èÊ†º</th>
                                            <th class="text-right p-2">È†ê‰º∞Êï∏Èáè</th>
                                            <th class="text-left p-2 rounded-r">ÂñÆ‰Ωç</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100">
                                        <tr v-for="mat in group" :key="mat.id" class="hover:bg-gray-50 group">
                                            <td class="p-2">
                                                <div class="font-medium text-indigo-600 hover:text-indigo-800 cursor-pointer hover:underline"
                                                    @click="openImageModal(mat)">
                                                    <i class="ph ph-image text-xs mr-1 opacity-50"></i>{{ mat.name }}
                                                </div>
                                                <!-- Êñ∞Â¢ûÔºöÊùêÊñôË™™Êòé -->
                                                <div v-if="mat.description"
                                                    class="text-xs text-gray-400 truncate max-w-[200px]"
                                                    :title="mat.description">
                                                    {{ mat.description }}
                                                </div>
                                            </td>
                                            <td class="p-2 text-gray-500">{{ mat.spec }}</td>
                                            <td class="p-2 text-right font-bold text-indigo-600">{{ mat.total_qty }}
                                            </td>
                                            <td class="p-2 text-gray-500">
                                                {{ mat.unit }}
                                                <span v-if="mat.pack_desc" :title="mat.pack_desc"
                                                    class="text-xs bg-yellow-100 text-yellow-800 px-1 rounded ml-1 cursor-help">
                                                    ÂåÖË£ù
                                                </span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- B. Â∑•ÂÖ∑Ë°® -->
                    <div v-show="viewMode === 'tools'">
                        <div class="flex justify-between mb-4 items-center">
                            <h3 class="font-bold text-lg">Â∑•ÂÖ∑Ê™¢Ê†∏Ë°®</h3>
                            <div class="flex gap-2 text-sm">
                                <span class="bg-green-100 text-green-800 px-2 py-0.5 rounded">Air = Ê∞£Âãï</span>
                                <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded">Batt = ÈõªÊ±†</span>
                            </div>
                        </div>

                        <!-- Á©∫ÁãÄÊÖãÊèêÁ§∫ -->
                        <div v-if="calculatedTools.power.length === 0 && calculatedTools.manual.length === 0"
                            class="text-center py-16 text-gray-400">
                            <i class="ph ph-wrench text-6xl mb-4 opacity-30"></i>
                            <p class="text-lg font-medium">Â∞öÁÑ°Â∑•ÂÖ∑ÈúÄÊ±Ç</p>
                            <p class="text-sm mt-2">Ë´ãÂÖàÂú®Â∑¶ÂÅ¥Âä†ÂÖ•Â∑•È†ÖÔºåÁ≥ªÁµ±Â∞áËá™ÂãïÂàóÂá∫ÊâÄÈúÄÂ∑•ÂÖ∑</p>
                        </div>

                        <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Â∑¶Ê¨ÑÔºöÊ©üÂÖ∑/ÈõªÂãïÂ∑•ÂÖ∑ -->
                            <div>
                                <h4 class="font-bold text-gray-700 mb-2 flex items-center gap-1">
                                    <i class="ph ph-lightning text-yellow-500"></i> Ê©üÂÖ∑/ÈõªÂãïÂ∑•ÂÖ∑
                                </h4>
                                <ul class="space-y-2">
                                    <li v-for="tool in calculatedTools.power" :key="tool.id"
                                        class="bg-gray-50 rounded hover:bg-gray-100 border border-transparent hover:border-gray-200 transition-all">
                                        <div class="flex items-start gap-2 p-2">
                                            <input type="checkbox" class="mt-1">
                                            <div class="flex-1">
                                                <div class="flex justify-between">
                                                    <span class="font-bold">{{ tool.name }}</span>
                                                    <span v-if="tool.qty > 1"
                                                        class="bg-gray-600 text-white text-xs px-1.5 rounded-full h-fit">x{{
                                                        tool.qty }}</span>
                                                </div>
                                                <div class="text-xs text-gray-500 flex items-center gap-2 mt-0.5">
                                                    <span v-if="tool.power_spec"
                                                        class="px-1.5 py-0.5 rounded text-[10px] font-bold"
                                                        :class="getPowerClass(tool.power_spec)">{{ tool.power_spec
                                                        }}</span>
                                                    <span v-if="tool.storage" class="text-gray-400">({{ tool.storage
                                                        }})</span>
                                                </div>

                                                <!-- Êñ∞Â¢ûÔºöÂ±ïÈñãÁ¥∞ÁØÄ (‰øùÈ§ä/ÊíáÊ≠•) -->
                                                <details class="mt-1 group/details">
                                                    <summary
                                                        class="text-[10px] text-indigo-500 cursor-pointer hover:text-indigo-700 list-none flex items-center gap-1">
                                                        <i
                                                            class="ph ph-caret-right group-open/details:rotate-90 transition-transform"></i>
                                                        Êü•Áúã‰øùÈ§äËàáÊíáÊ≠•
                                                    </summary>
                                                    <div
                                                        class="text-xs text-gray-600 mt-1 pl-2 border-l-2 border-indigo-100 space-y-1">
                                                        <div v-if="tool.maintenance">üîß <span
                                                                class="font-medium">‰øùÈ§äÔºö</span>{{ tool.maintenance }}
                                                        </div>
                                                        <div v-if="tool.usage_tips">üí° <span
                                                                class="font-medium">ÊíáÊ≠•Ôºö</span>{{ tool.usage_tips }}
                                                        </div>
                                                    </div>
                                                </details>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>

                            <!-- Âè≥Ê¨ÑÔºöÊâãÂ∑•ÂÖ∑/ËÄóÊùê -->
                            <div>
                                <h4 class="font-bold text-gray-700 mb-2 flex items-center gap-1">
                                    <i class="ph ph-hand text-gray-500"></i> ÊâãÂ∑•ÂÖ∑ & ÈÖç‰ª∂
                                </h4>
                                <ul class="space-y-2">
                                    <li v-for="tool in calculatedTools.manual" :key="tool.id"
                                        class="bg-gray-50 rounded hover:bg-gray-100 border border-transparent hover:border-gray-200 transition-all">
                                        <div class="flex items-start gap-2 p-2">
                                            <input type="checkbox" class="mt-1">
                                            <div class="flex-1">
                                                <div class="flex justify-between">
                                                    <span class="font-medium">{{ tool.name }}</span>
                                                    <span v-if="tool.qty > 1"
                                                        class="bg-gray-600 text-white text-xs px-1.5 rounded-full h-fit">x{{
                                                        tool.qty }}</span>
                                                </div>
                                                <div class="text-xs text-gray-400 mt-0.5">
                                                    <span>{{ tool.storage || 'Êú™ÊåáÂÆö‰ΩçÁΩÆ' }}</span>
                                                </div>
                                                <!-- Êñ∞Â¢ûÔºöÂ±ïÈñãÁ¥∞ÁØÄ (ÈõñÊòØÊâãÂ∑•ÂÖ∑Ôºå‰ΩÜ‰πüÂèØËÉΩÊúâ‰øùÈ§ä) -->
                                                <details v-if="tool.maintenance || tool.usage_tips"
                                                    class="mt-1 group/details">
                                                    <summary
                                                        class="text-[10px] text-gray-400 cursor-pointer hover:text-gray-600 list-none flex items-center gap-1">
                                                        <i
                                                            class="ph ph-caret-right group-open/details:rotate-90 transition-transform"></i>
                                                        Ë≥áË®ä
                                                    </summary>
                                                    <div
                                                        class="text-xs text-gray-600 mt-1 pl-2 border-l-2 border-gray-200 space-y-1">
                                                        <div v-if="tool.maintenance">üîß {{ tool.maintenance }}</div>
                                                        <div v-if="tool.usage_tips">üí° {{ tool.usage_tips }}</div>
                                                    </div>
                                                </details>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- C. ÊñΩÂ∑•ÈáçÈªû -->
                    <div v-show="viewMode === 'sop'">
                        <div v-if="cart.length === 0" class="text-center py-12 text-gray-400">
                            <i class="ph ph-clipboard-text text-6xl mb-4 opacity-30"></i>
                            <p>Ë´ãÂÖàÂä†ÂÖ•Â∑•È†ÖÔºåÂç≥ÂèØÊü•ÁúãÂ∞çÊáâÁöÑÊñΩÂ∑•SOPËàáÈ©óÊî∂ÈáçÈªû</p>
                        </div>
                        <div v-for="(item, idx) in cart" :key="idx"
                            class="mb-6 bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                            <!-- Header -->
                            <div
                                class="bg-gray-50 px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                                <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                                    <span class="bg-indigo-600 text-white text-xs px-2 py-0.5 rounded">{{
                                        item.task.category }}</span>
                                    {{ item.task.task_name }}
                                </h3>
                                <div class="text-sm text-gray-500">Êï∏Èáè: {{ item.qty }} {{ item.task.unit }}</div>
                            </div>

                            <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Â∑¶ÔºöÊñΩÂ∑•Ë¶ÅÈªû -->
                                <div>
                                    <h4 class="font-bold text-indigo-700 text-sm mb-2 flex items-center gap-2">
                                        <i class="ph ph-hammer"></i> ÊñΩÂ∑•Ë¶ÅÈªû (SOP)
                                    </h4>
                                    <div
                                        class="text-sm text-gray-600 whitespace-pre-wrap leading-relaxed pl-3 border-l-2 border-indigo-200 bg-indigo-50/30 p-2 rounded-r">
                                        {{ item.task.sop_construction || 'Â∞öÁÑ°Ë≥áÊñô' }}
                                    </div>
                                </div>

                                <!-- Âè≥ÔºöÈ©óÊî∂ÈáçÈªû -->
                                <div>
                                    <h4 class="font-bold text-green-700 text-sm mb-2 flex items-center gap-2">
                                        <i class="ph ph-magnifying-glass"></i> È©óÊî∂ÈáçÈªû
                                    </h4>
                                    <div
                                        class="text-sm text-gray-600 whitespace-pre-wrap leading-relaxed pl-3 border-l-2 border-green-200 bg-green-50/30 p-2 rounded-r">
                                        {{ item.task.inspection_key || 'Â∞öÁÑ°Ë≥áÊñô' }}
                                    </div>
                                </div>
                            </div>

                            <!-- Â∫ïÈÉ®ÔºöÊü•È©óÊ®ôÊ∫ñ (Ëã•Êúâ) -->
                            <div v-if="item.task.inspection_sample && item.task.inspection_sample !== 'ÁÑ°'"
                                class="px-5 pb-4">
                                <h4 class="font-bold text-gray-500 text-xs mb-1 uppercase tracking-wide">
                                    <i class="ph ph-info"></i> Ë£úÂÖÖÊ®ôÊ∫ñ/Ê®£Êú¨
                                </h4>
                                <div
                                    class="text-xs text-gray-500 whitespace-pre-wrap bg-gray-50 p-2 rounded border border-gray-100">
                                    {{ item.task.inspection_sample }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- D. ÈÖçÊñπÁÆ°ÁêÜ -->
                    <div v-show="viewMode === 'recipes'">
                        <div class="mb-4 flex justify-between items-center">
                            <h3 class="font-bold text-lg">Â∑•È†ÖÈÖçÊñπÁÆ°ÁêÜ</h3>
                            <select v-model="recipeManager.selectedTaskId" class="border rounded-lg px-3 py-2 w-64">
                                <option value="">-- ÈÅ∏ÊìáÂ∑•È†Ö --</option>
                                <option v-for="task in db.tasks" :key="task.task_id" :value="task.task_id">
                                    {{ task.task_name }} ({{ task.unit }})
                                </option>
                            </select>
                        </div>

                        <!-- ÈÅ∏ÊìáÂ∑•È†ÖÂæåÈ°ØÁ§∫ÈÖçÊñπ -->
                        <div v-if="recipeManager.selectedTaskId" class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                            <!-- ÊùêÊñôÈÖçÊñπ -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-bold text-indigo-700 flex items-center gap-2">
                                        <i class="ph ph-package"></i> ÊùêÊñôÈÖçÊñπ
                                    </h4>
                                    <div class="flex gap-2">
                                        <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded">
                                            {{ getTaskMaterials(recipeManager.selectedTaskId).length }} È†Ö
                                        </span>
                                        <button @click="openAddMaterialModal()"
                                            class="text-xs bg-indigo-600 text-white px-2 py-1 rounded hover:bg-indigo-700">
                                            <i class="ph ph-plus"></i> Êñ∞Â¢û
                                        </button>
                                    </div>
                                </div>
                                <table class="w-full text-sm">
                                    <thead class="bg-white text-gray-600">
                                        <tr>
                                            <th class="text-left p-2">ÊùêÊñô</th>
                                            <th class="text-right p-2 w-20">Êï∏Èáè</th>
                                            <th class="text-right p-2 w-20">ÊêçËÄó</th>
                                            <th class="text-center p-2 w-12">ËÄóÊùê</th>
                                            <th class="text-center p-2 w-12">Âà™Èô§</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        <tr v-for="(mat, idx) in getTaskMaterials(recipeManager.selectedTaskId)"
                                            :key="mat.mat_id + '-' + idx" class="hover:bg-white group">
                                            <td class="p-2">
                                                <div class="font-medium text-indigo-600 cursor-pointer hover:underline"
                                                    @click="showMaterialDetail(mat.mat_id)">
                                                    {{ getMatName(mat.mat_id) }}
                                                </div>
                                                <div class="text-xs text-gray-400">{{ mat.spec }}</div>
                                            </td>
                                            <td class="p-2 text-right">
                                                <input type="number" step="0.1" min="0" :value="mat.qty_per_unit"
                                                    @change="updateMatRecipe(mat, 'qty_per_unit', parseFloat($event.target.value))"
                                                    class="w-16 text-right border rounded px-1 py-0.5 text-sm">
                                            </td>
                                            <td class="p-2 text-right">
                                                <input type="number" step="0.01" min="1" :value="mat.loss_rate"
                                                    @change="updateMatRecipe(mat, 'loss_rate', parseFloat($event.target.value))"
                                                    class="w-16 text-right border rounded px-1 py-0.5 text-sm">
                                            </td>
                                            <td class="p-2 text-center">
                                                <input type="checkbox" :checked="mat.is_consumable === 'TRUE'"
                                                    @change="updateMatRecipe(mat, 'is_consumable', $event.target.checked ? 'TRUE' : 'FALSE')"
                                                    class="w-4 h-4 cursor-pointer">
                                            </td>
                                            <td class="p-2 text-center">
                                                <button @click="deleteMatRecipe(mat)"
                                                    class="text-red-500 hover:text-red-700 opacity-50 hover:opacity-100">
                                                    <i class="ph ph-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr v-if="getTaskMaterials(recipeManager.selectedTaskId).length === 0">
                                            <td colspan="5" class="p-4 text-center text-gray-400">
                                                Â∞öÁÑ°ÊùêÊñôÈÖçÊñπÔºåË´ãÈªûÊìä„ÄåÊñ∞Â¢û„ÄçÊåâÈàï
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Â∑•ÂÖ∑ÈÖçÊñπ -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-bold text-green-700 flex items-center gap-2">
                                        <i class="ph ph-wrench"></i> Â∑•ÂÖ∑ÈÖçÊñπ
                                    </h4>
                                    <div class="flex gap-2">
                                        <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">
                                            {{ getTaskTools(recipeManager.selectedTaskId).length }} È†Ö
                                        </span>
                                        <button @click="openAddToolModal()"
                                            class="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">
                                            <i class="ph ph-plus"></i> Êñ∞Â¢û
                                        </button>
                                    </div>
                                </div>
                                <table class="w-full text-sm">
                                    <thead class="bg-white text-gray-600">
                                        <tr>
                                            <th class="text-left p-2">Â∑•ÂÖ∑</th>
                                            <th class="text-center p-2 w-20">È°ûÂûã</th>
                                            <th class="text-right p-2 w-14">Êï∏Èáè</th>
                                            <th class="text-center p-2 w-24">ÂàÜÈÖç</th>
                                            <th class="text-center p-2 w-12">Âà™Èô§</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        <tr v-for="(tool, idx) in getTaskTools(recipeManager.selectedTaskId)"
                                            :key="tool.tool_id + '-' + idx" class="hover:bg-white group">
                                            <td class="p-2 font-medium">{{ getToolName(tool.tool_id) }}</td>
                                            <td class="p-2 text-center">
                                                <select :value="tool.type"
                                                    @change="updateToolRecipe(tool, 'type', $event.target.value)"
                                                    class="text-xs border rounded px-1 py-0.5"
                                                    :class="tool.type === 'ÂøÖÂÇô' ? 'bg-red-50 text-red-800' : 'bg-gray-50'">
                                                    <option value="ÂøÖÂÇô">ÂøÖÂÇô</option>
                                                    <option value="ÈÅ∏Áî®">ÈÅ∏Áî®</option>
                                                </select>
                                            </td>
                                            <td class="p-2 text-right">
                                                <input type="number" step="1" min="1" :value="tool.qty_avg"
                                                    @change="updateToolRecipe(tool, 'qty_avg', parseInt($event.target.value))"
                                                    class="w-12 text-right border rounded px-1 py-0.5 text-sm">
                                            </td>
                                            <td class="p-2 text-center">
                                                <select :value="tool.calc_method"
                                                    @change="updateToolRecipe(tool, 'calc_method', $event.target.value)"
                                                    class="text-xs border rounded px-1 py-0.5">
                                                    <option value="PerWorker">ÊØè‰∫∫‰∏ÄÂ•ó</option>
                                                    <option value="Fixed">Â∑•Âú∞Âõ∫ÂÆö</option>
                                                    <option value="Dynamic">‰æùÈáèË®àÁÆó</option>
                                                </select>
                                            </td>
                                            <td class="p-2 text-center">
                                                <button @click="deleteToolRecipe(tool)"
                                                    class="text-red-500 hover:text-red-700 opacity-50 hover:opacity-100">
                                                    <i class="ph ph-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr v-if="getTaskTools(recipeManager.selectedTaskId).length === 0">
                                            <td colspan="5" class="p-4 text-center text-gray-400">
                                                Â∞öÁÑ°Â∑•ÂÖ∑ÈÖçÊñπÔºåË´ãÈªûÊìä„ÄåÊñ∞Â¢û„ÄçÊåâÈàï
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Êú™ÈÅ∏ÊìáÂ∑•È†ÖÊôÇÁöÑÊèêÁ§∫ -->
                        <div v-else class="h-64 flex flex-col items-center justify-center text-gray-400">
                            <i class="ph ph-note-pencil text-6xl mb-4"></i>
                            <p>Ë´ãÂæû‰∏äÊñπÈÅ∏Êìá‰∏ÄÂÄãÂ∑•È†Ö‰æÜÊ™¢Ë¶ñÈÖçÊñπ</p>
                        </div>

                        <!-- ÈÖçÊñπÁµ±Ë®à -->
                        <div class="mt-6 p-4 bg-indigo-50 rounded-lg">
                            <div class="flex justify-around text-center">
                                <div>
                                    <div class="text-2xl font-bold text-indigo-700">{{ db.tasks.length }}</div>
                                    <div class="text-xs text-gray-500">Â∑•È†ÖÁ∏ΩÊï∏</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-indigo-700">{{ db.mapExMaterials.length }}</div>
                                    <div class="text-xs text-gray-500">ÊùêÊñôÈÖçÊñπ</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-indigo-700">{{ db.mapExTools.length }}</div>
                                    <div class="text-xs text-gray-500">Â∑•ÂÖ∑ÈÖçÊñπ</div>
                                </div>
                            </div>
                        </div>
                        <!-- ÂÑ≤Â≠òÊåâÈàï -->
                        <div class="mt-4 text-center">
                            <button @click="saveAllRecipes()" :disabled="loading || !recipeManager.hasChanges"
                                :class="loading ? 'bg-gray-400 cursor-wait' : (recipeManager.hasChanges ? 'bg-green-500 hover:bg-green-600 animate-pulse' : 'bg-gray-400 cursor-not-allowed')"
                                class="text-white px-6 py-2 rounded-lg font-bold transition-colors disabled:opacity-60">
                                <i v-if="loading" class="ph ph-spinner animate-spin mr-2"></i>
                                <i v-else class="ph ph-floppy-disk mr-2"></i>
                                {{ loading ? 'ÂÑ≤Â≠ò‰∏≠...' : (recipeManager.hasChanges ? 'ÂÑ≤Â≠òËÆäÊõ¥' : 'ÁÑ°ËÆäÊõ¥') }}
                            </button>
                            <p v-if="recipeManager.hasChanges" class="text-xs text-orange-500 mt-2">
                                ‚ö†Ô∏è ÊúâÊú™ÂÑ≤Â≠òÁöÑËÆäÊõ¥
                            </p>
                        </div>
                    </div>

                    <!-- E. Ë≥áÊñôÁÆ°ÁêÜ -->
                    <div v-show="viewMode === 'dataManager'">
                        <!-- Â≠êÂàÜÈ†ÅÂàáÊèõ -->
                        <div class="flex gap-2 mb-4 border-b pb-3">
                            <button v-for="tab in ['tasks', 'tools', 'materials']" :key="tab"
                                @click="dataManager.activeTab = tab"
                                :class="dataManager.activeTab === tab ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                                class="px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                {{ tab === 'tasks' ? 'Â∑•È†ÖÁÆ°ÁêÜ' : tab === 'tools' ? 'Â∑•ÂÖ∑ÁÆ°ÁêÜ' : 'ÊùêÊñôÁÆ°ÁêÜ' }}
                            </button>
                        </div>

                        <!-- Â∑•È†ÖÁÆ°ÁêÜ -->
                        <div v-if="dataManager.activeTab === 'tasks'" class="space-y-4">
                            <div class="flex justify-between items-center">
                                <h3 class="font-bold text-lg">Â∑•È†ÖÊ∏ÖÂñÆ ({{ db.tasks.length }} Á≠Ü)</h3>
                                <button @click="openTaskModal('create')"
                                    class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center gap-1">
                                    <i class="ph ph-plus"></i> Êñ∞Â¢ûÂ∑•È†Ö
                                </button>
                            </div>

                            <!-- ÊêúÂ∞ãËàáÁØ©ÈÅ∏ -->
                            <div class="flex gap-2">
                                <input v-model="dataManager.searchTask" type="text" placeholder="ÊêúÂ∞ãÂ∑•È†ÖÂêçÁ®±..."
                                    class="flex-1 border rounded-lg px-3 py-2">
                                <select v-model="dataManager.filterCategory" class="border rounded-lg px-3 py-2">
                                    <option value="">ÂÖ®ÈÉ®ÂàÜÈ°û</option>
                                    <option v-for="cat in categories" :key="cat" :value="cat">{{ cat }}</option>
                                </select>
                            </div>

                            <!-- Â∑•È†ÖË°®Ê†º -->
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="text-left p-3">Â∑•È†ÖÂêçÁ®±</th>
                                            <th class="text-left p-3">ÂàÜÈ°û</th>
                                            <th class="text-left p-3">ÈöéÊÆµ</th>
                                            <th class="text-left p-3">ÂñÆ‰Ωç</th>
                                            <th class="text-center p-3 w-24">Êìç‰Ωú</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y">
                                        <tr v-for="task in filteredDbTasks" :key="task.task_id"
                                            class="hover:bg-gray-50">
                                            <td class="p-3 font-medium">{{ task.task_name }}</td>
                                            <td class="p-3">{{ task.category }}</td>
                                            <td class="p-3">{{ task.phase }}</td>
                                            <td class="p-3">{{ task.unit }}</td>
                                            <td class="p-3 text-center">
                                                <button @click="openTaskModal('edit', task)"
                                                    class="text-indigo-600 hover:text-indigo-800 p-1">
                                                    <i class="ph ph-pencil"></i>
                                                </button>
                                                <button @click="deleteTask(task)"
                                                    class="text-red-500 hover:text-red-700 p-1 ml-1">
                                                    <i class="ph ph-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr v-if="filteredDbTasks.length === 0">
                                            <td colspan="5" class="p-8 text-center text-gray-400">
                                                ÁÑ°Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÂ∑•È†Ö
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Â∑•ÂÖ∑ÁÆ°ÁêÜ -->
                        <div v-if="dataManager.activeTab === 'tools'" class="space-y-4">
                            <div class="flex justify-between items-center">
                                <h3 class="font-bold text-lg">Â∑•ÂÖ∑Ê∏ÖÂñÆ ({{ db.tools.length }} Á≠Ü)</h3>
                                <button @click="openToolModal('create')"
                                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-1">
                                    <i class="ph ph-plus"></i> Êñ∞Â¢ûÂ∑•ÂÖ∑
                                </button>
                            </div>

                            <div class="flex gap-2">
                                <input v-model="dataManager.searchTool" type="text" placeholder="ÊêúÂ∞ãÂ∑•ÂÖ∑ÂêçÁ®±..."
                                    class="flex-1 border rounded-lg px-3 py-2">
                            </div>

                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="text-left p-3">Â∑•ÂÖ∑ÂêçÁ®±</th>
                                            <th class="text-left p-3">ÂàÜÈ°û</th>
                                            <th class="text-left p-3">ÂãïÂäõË¶èÊ†º</th>
                                            <th class="text-left p-3">Êî∂Á¥ç‰ΩçÁΩÆ</th>
                                            <th class="text-center p-3 w-24">Êìç‰Ωú</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y">
                                        <tr v-for="tool in filteredDbTools" :key="tool.tool_id"
                                            class="hover:bg-gray-50">
                                            <td class="p-3 font-medium">{{ tool.name }}</td>
                                            <td class="p-3">{{ tool.category }}</td>
                                            <td class="p-3">
                                                <span v-if="tool.power_spec" class="px-2 py-0.5 rounded text-xs"
                                                    :class="getPowerClass(tool.power_spec)">{{ tool.power_spec }}</span>
                                            </td>
                                            <td class="p-3 text-gray-500">{{ tool.storage_box }}</td>
                                            <td class="p-3 text-center">
                                                <button @click="openToolModal('edit', tool)"
                                                    class="text-green-600 hover:text-green-800 p-1">
                                                    <i class="ph ph-pencil"></i>
                                                </button>
                                                <button @click="deleteTool(tool)"
                                                    class="text-red-500 hover:text-red-700 p-1 ml-1">
                                                    <i class="ph ph-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr v-if="filteredDbTools.length === 0">
                                            <td colspan="5" class="p-8 text-center text-gray-400">
                                                ÁÑ°Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÂ∑•ÂÖ∑
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- ÊùêÊñôÁÆ°ÁêÜ -->
                        <div v-if="dataManager.activeTab === 'materials'" class="space-y-4">
                            <div class="flex justify-between items-center">
                                <h3 class="font-bold text-lg">ÊùêÊñôÊ∏ÖÂñÆ ({{ db.materials.length }} Á≠Ü)</h3>
                                <button @click="openMaterialModal('create')"
                                    class="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 flex items-center gap-1">
                                    <i class="ph ph-plus"></i> Êñ∞Â¢ûÊùêÊñô
                                </button>
                            </div>

                            <div class="flex gap-2">
                                <input v-model="dataManager.searchMaterial" type="text" placeholder="ÊêúÂ∞ãÊùêÊñôÂêçÁ®±..."
                                    class="flex-1 border rounded-lg px-3 py-2">
                            </div>

                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="text-left p-3">ÊùêÊñôÂêçÁ®±</th>
                                            <th class="text-left p-3">Ë¶èÊ†º</th>
                                            <th class="text-left p-3">ÂñÆ‰Ωç</th>
                                            <th class="text-left p-3">‰æõÊáâÂïÜ</th>
                                            <th class="text-center p-3 w-24">Êìç‰Ωú</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y">
                                        <tr v-for="mat in filteredDbMaterials" :key="mat.mat_id"
                                            class="hover:bg-gray-50">
                                            <td class="p-3 font-medium">{{ mat.name }}</td>
                                            <td class="p-3">{{ mat.spec || mat.spec_order }}</td>
                                            <td class="p-3">{{ mat.unit }}</td>
                                            <td class="p-3 text-gray-500">{{ mat.vendor_ref }}</td>
                                            <td class="p-3 text-center">
                                                <button @click="openMaterialModal('edit', mat)"
                                                    class="text-amber-600 hover:text-amber-800 p-1">
                                                    <i class="ph ph-pencil"></i>
                                                </button>
                                                <button @click="deleteMaterial(mat)"
                                                    class="text-red-500 hover:text-red-700 p-1 ml-1">
                                                    <i class="ph ph-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr v-if="filteredDbMaterials.length === 0">
                                            <td colspan="5" class="p-8 text-center text-gray-400">
                                                ÁÑ°Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÊùêÊñô
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </section>

            <!-- Êñ∞Â¢ûÊùêÊñôÈÖçÊñπ Modal -->
            <div v-if="recipeManager.addMatModal.show"
                class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"
                @click.self="recipeManager.addMatModal.show = false">
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                    <div class="bg-indigo-600 text-white p-4 rounded-t-xl">
                        <h3 class="font-bold text-lg">Êñ∞Â¢ûÊùêÊñôÈÖçÊñπ</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ÈÅ∏ÊìáÊùêÊñô</label>
                            <select v-model="recipeManager.addMatModal.selectedMatId"
                                class="w-full border rounded-lg px-3 py-2">
                                <option value="">-- Ë´ãÈÅ∏Êìá --</option>
                                <option v-for="mat in db.materials" :key="mat.mat_id" :value="mat.mat_id">
                                    {{ mat.name }} ({{ mat.spec }})
                                </option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Áî®ÈÄîË™™Êòé</label>
                            <input type="text" v-model="recipeManager.addMatModal.spec" placeholder="‰æãÂ¶ÇÔºöÂ§©Ëä±È™®Êû∂"
                                class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÊØèÂñÆ‰ΩçÊï∏Èáè</label>
                                <input type="number" step="0.1" min="0" v-model.number="recipeManager.addMatModal.qty"
                                    class="w-full border rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÊêçËÄóÁéá</label>
                                <input type="number" step="0.01" min="1" v-model.number="recipeManager.addMatModal.loss"
                                    class="w-full border rounded-lg px-3 py-2">
                            </div>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" v-model="recipeManager.addMatModal.isConsumable" class="w-4 h-4 mr-2"
                                id="isConsumable">
                            <label for="isConsumable" class="text-sm text-gray-700">ÈÄôÊòØËÄóÊùêÔºàÊØèÊ¨°‰ΩøÁî®ÁöÜÊ∂àËÄóÔºâ</label>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-b-xl flex justify-end gap-3">
                        <button @click="recipeManager.addMatModal.show = false"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800">ÂèñÊ∂à</button>
                        <button @click="addMaterialRecipe()"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Êñ∞Â¢û</button>
                    </div>
                </div>
            </div>

            <!-- Êñ∞Â¢ûÂ∑•ÂÖ∑ÈÖçÊñπ Modal -->
            <div v-if="recipeManager.addToolModal.show"
                class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"
                @click.self="recipeManager.addToolModal.show = false">
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                    <div class="bg-green-600 text-white p-4 rounded-t-xl">
                        <h3 class="font-bold text-lg">Êñ∞Â¢ûÂ∑•ÂÖ∑ÈÖçÊñπ</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ÈÅ∏ÊìáÂ∑•ÂÖ∑</label>
                            <select v-model="recipeManager.addToolModal.selectedToolId"
                                class="w-full border rounded-lg px-3 py-2">
                                <option value="">-- Ë´ãÈÅ∏Êìá --</option>
                                <option v-for="tool in db.tools" :key="tool.tool_id" :value="tool.tool_id">
                                    {{ tool.name }}
                                </option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">È°ûÂûã</label>
                                <select v-model="recipeManager.addToolModal.type"
                                    class="w-full border rounded-lg px-3 py-2">
                                    <option value="ÂøÖÂÇô">ÂøÖÂÇô</option>
                                    <option value="ÈÅ∏Áî®">ÈÅ∏Áî®</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Êï∏Èáè</label>
                                <input type="number" step="1" min="1" v-model.number="recipeManager.addToolModal.qty"
                                    class="w-full border rounded-lg px-3 py-2">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ÂàÜÈÖçÊñπÂºè</label>
                            <select v-model="recipeManager.addToolModal.calcMethod"
                                class="w-full border rounded-lg px-3 py-2">
                                <option value="PerWorker">ÊØè‰∫∫‰∏ÄÂ•ó (ÊØè‰ΩçÂ∏´ÂÇÖÂêÑÂ∏∂‰∏ÄÂ•ó)</option>
                                <option value="Fixed">Â∑•Âú∞Âõ∫ÂÆö (Êï¥ÂÄãÂ∑•Âú∞ÂÖ±Áî®)</option>
                                <option value="Dynamic">‰æùÈáèË®àÁÆó (Ê†πÊìöÂ∑•Á®ãÈáèÂãïÊÖãË®àÁÆó)</option>
                            </select>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-b-xl flex justify-end gap-3">
                        <button @click="recipeManager.addToolModal.show = false"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800">ÂèñÊ∂à</button>
                        <button @click="addToolRecipe()"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Êñ∞Â¢û</button>
                    </div>
                </div>
            </div>

            <!-- ÊùêÊñôË©≥ÊÉÖ Modal -->
            <div v-if="recipeManager.matDetailModal.show"
                class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"
                @click.self="recipeManager.matDetailModal.show = false">
                <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full">
                    <div class="bg-indigo-600 text-white p-4 rounded-t-xl flex justify-between items-center">
                        <h3 class="font-bold text-lg">{{ recipeManager.matDetailModal.material?.name }}</h3>
                        <button @click="recipeManager.matDetailModal.show = false"
                            class="text-white/70 hover:text-white">
                            <i class="ph ph-x text-xl"></i>
                        </button>
                    </div>
                    <div class="p-6" v-if="recipeManager.matDetailModal.material">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="text-gray-500">ÊùêÊñô‰ª£ËôüÔºö</span>{{ recipeManager.matDetailModal.material.mat_id
                                }}
                            </div>
                            <div><span class="text-gray-500">È°ûÂà•Ôºö</span>{{ recipeManager.matDetailModal.material.category
                                }}
                            </div>
                            <div><span class="text-gray-500">Ë¶èÊ†ºÔºö</span>{{ recipeManager.matDetailModal.material.spec }}
                            </div>
                            <div><span class="text-gray-500">ÂñÆ‰ΩçÔºö</span>{{ recipeManager.matDetailModal.material.unit }}
                            </div>
                            <div><span class="text-gray-500">ÂñÆÂÉπÔºö</span>${{ recipeManager.matDetailModal.material.price
                                }}</div>
                            <div><span class="text-gray-500">‰æõÊáâÂïÜÔºö</span>{{
                                recipeManager.matDetailModal.material.supplier }}
                            </div>
                            <div class="col-span-2"><span class="text-gray-500">ÊùêË≥™Ôºö</span>{{
                                recipeManager.matDetailModal.material.material_type }}</div>
                            <div class="col-span-2"><span class="text-gray-500">ÂÇôË®ªÔºö</span>{{
                                recipeManager.matDetailModal.material.notes || '-' }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÂúñÁâáÊêúÂ∞ã Modal (v2.0: Á∂≤Ê†ºÈ°ØÁ§∫) -->
            <div v-if="imageModal.show" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"
                @click.self="imageModal.show = false">
                <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full overflow-hidden animate-[fadeIn_0.2s]">
                    <!-- Modal Header -->
                    <div class="bg-indigo-600 text-white p-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-lg">{{ imageModal.material?.name }}</h3>
                                <p class="text-indigo-200 text-sm">{{ imageModal.material?.spec || 'ÈÅ∏ÊìáÊùêÊñôÂúñÁâá' }}</p>
                            </div>
                            <button @click="imageModal.show = false" class="text-white/70 hover:text-white">
                                <i class="ph ph-x text-2xl"></i>
                            </button>
                        </div>
                    </div>

                    <div class="p-6 space-y-4">
                        <!-- Â∑≤ÂÑ≤Â≠òÁöÑÂúñÁâáÂçÄ -->
                        <div v-if="imageModal.material?.image_url"
                            class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center gap-4">
                                <img :src="imageModal.material.image_url"
                                    class="w-20 h-20 object-cover rounded-lg border-2 border-green-400"
                                    @error="imageModal.material.image_url = null">
                                <div class="flex-1">
                                    <p class="text-green-700 font-medium"><i class="ph ph-check-circle mr-1"></i>Â∑≤ÂÑ≤Â≠òÂúñÁâá
                                    </p>
                                    <p class="text-green-600 text-xs truncate">{{ imageModal.material.image_url }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- ÊêúÂ∞ãÊåâÈàï -->
                        <button @click="searchImages" :disabled="imageModal.loading"
                            class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-wait">
                            <i v-if="imageModal.loading" class="ph ph-spinner animate-spin mr-2"></i>
                            <i v-else class="ph ph-magnifying-glass mr-2"></i>
                            {{ imageModal.loading ? 'ÊêúÂ∞ã‰∏≠...' : 'ÊêúÂ∞ãÁ∂≤Ë∑ØÂúñÁâá (20Âºµ)' }}
                        </button>

                        <!-- ÂúñÁâáÁ∂≤Ê†ºÂçÄ -->
                        <div v-if="imageModal.imagePool.length > 0" class="space-y-4">
                            <!-- Á∂≤Ê†ºÈ°ØÁ§∫ 5 Âºµ -->
                            <div class="grid grid-cols-5 gap-2">
                                <div v-for="(img, idx) in currentPageImages" :key="idx"
                                    @click="selectImage(getPoolIndex(idx))" :class="[
                                        'relative aspect-square rounded-lg overflow-hidden cursor-pointer border-3 transition-all',
                                        imageModal.selectedIndex === getPoolIndex(idx) 
                                            ? 'border-green-500 ring-2 ring-green-300 scale-105' 
                                            : 'border-transparent hover:border-indigo-300'
                                    ]">
                                    <img :src="img" class="w-full h-full object-cover"
                                        @error="$event.target.src='data:image/svg+xml,...'">
                                    <!-- ÈÅ∏‰∏≠Ê®ôË®ò -->
                                    <div v-if="imageModal.selectedIndex === getPoolIndex(idx)"
                                        class="absolute inset-0 bg-green-500/20 flex items-center justify-center">
                                        <i class="ph ph-check-circle text-green-500 text-3xl drop-shadow-lg"></i>
                                    </div>
                                    <!-- Â∫èËôü -->
                                    <div
                                        class="absolute bottom-1 right-1 bg-black/50 text-white text-xs px-1.5 py-0.5 rounded">
                                        {{ getPoolIndex(idx) + 1 }}
                                    </div>
                                </div>
                            </div>

                            <!-- ÂàÜÈ†ÅÊéßÂà∂ -->
                            <div class="flex items-center justify-between bg-gray-50 rounded-lg p-3">
                                <button @click="changePage(-1)" :disabled="imageModal.currentPage === 0"
                                    class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors disabled:opacity-30">
                                    <i class="ph ph-caret-left"></i> ‰∏ä‰∏ÄÈ†Å
                                </button>
                                <span class="text-sm text-gray-600">
                                    Á¨¨ {{ imageModal.currentPage + 1 }} / {{ totalPages }} È†Å
                                    <span class="text-gray-400 ml-2">(ÂÖ± {{ imageModal.imagePool.length }} Âºµ)</span>
                                </span>
                                <button @click="changePage(1)" :disabled="imageModal.currentPage >= totalPages - 1"
                                    class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors disabled:opacity-30">
                                    ‰∏ã‰∏ÄÈ†Å <i class="ph ph-caret-right"></i>
                                </button>
                            </div>

                            <!-- ÂÑ≤Â≠òÊåâÈàï -->
                            <button @click="saveSelectedImage"
                                :disabled="imageModal.selectedIndex === null || imageModal.loading"
                                class="w-full py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="ph ph-check-circle mr-2"></i>
                                {{ imageModal.selectedIndex !== null ? 'ÂÑ≤Â≠òÈÅ∏‰∏≠ÁöÑÂúñÁâá (#' + (imageModal.selectedIndex + 1) +
                                ')' : 'Ë´ãÂÖàÈªûÈÅ∏ÂúñÁâá' }}
                            </button>
                        </div>

                        <!-- ÁÑ°ÂúñÁâáÊèêÁ§∫ -->
                        <div v-else-if="!imageModal.loading && imageModal.imagePool.length === 0 && !imageModal.material?.image_url"
                            class="h-40 flex flex-col items-center justify-center text-gray-400">
                            <i class="ph ph-image text-5xl mb-2"></i>
                            <p>ÈªûÊìä‰∏äÊñπÊåâÈàïÊêúÂ∞ãÂúñÁâá</p>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div class="border-t p-3 bg-gray-50 text-center text-xs text-gray-400">
                        <i class="ph ph-info mr-1"></i>
                        ÂúñÁâá‰æÜÊ∫êÔºöGoogle ÂúñÁâáÊêúÂ∞ã | ÊØèÊó•ÂÖçË≤ª 100 Ê¨°
                    </div>
                </div>
            </div>

            <!-- Â∑•È†ÖÁ∑®ËºØ Modal -->
            <div v-if="dataManager.taskModal.show"
                class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"
                @mousedown.self="dataManager.taskModal.show = false">
                <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="bg-indigo-600 text-white p-4 rounded-t-xl flex justify-between items-center">
                        <h3 class="font-bold text-lg">
                            {{ dataManager.taskModal.mode === 'create' ? 'Êñ∞Â¢ûÂ∑•È†Ö' : 'Á∑®ËºØÂ∑•È†Ö' }}
                        </h3>
                        <button @click="dataManager.taskModal.show = false" class="text-white/80 hover:text-white">
                            <i class="ph ph-x text-xl"></i>
                        </button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Â∑•È†Ö‰ª£Ëôü *</label>
                                <input v-model="dataManager.taskModal.data.task_id" type="text"
                                    :disabled="dataManager.taskModal.mode === 'edit'"
                                    class="w-full border rounded-lg px-3 py-2 disabled:bg-gray-100"
                                    placeholder="‰æãÂ¶ÇÔºöt_ceiling_lv1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Â∑•È†ÖÂêçÁ®± *</label>
                                <input v-model="dataManager.taskModal.data.task_name" type="text"
                                    class="w-full border rounded-lg px-3 py-2" placeholder="‰æãÂ¶ÇÔºöÂπ≥ÈáòÂ§©Ëä±">
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÂàÜÈ°û</label>
                                <select v-model="dataManager.taskModal.data.category"
                                    class="w-full border rounded-lg px-3 py-2">
                                    <option v-for="cat in taskCategoryOptions" :key="cat" :value="cat">{{ cat }}
                                    </option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÈöéÊÆµ</label>
                                <select v-model="dataManager.taskModal.data.phase"
                                    class="w-full border rounded-lg px-3 py-2">
                                    <option v-for="p in phases" :key="p" :value="p">{{ p }}</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ë®àÁÆóÂñÆ‰Ωç</label>
                                <input v-model="dataManager.taskModal.data.unit" type="text"
                                    class="w-full border rounded-lg px-3 py-2" placeholder="Âù™ / Â∞∫ / Âºè">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ÊñΩÂ∑•Ë¶ÅÈªû (SOP)</label>
                            <textarea v-model="dataManager.taskModal.data.sop_construction" rows="3"
                                class="w-full border rounded-lg px-3 py-2" placeholder="Ëº∏ÂÖ•ÊñΩÂ∑•Ê≠•È©üËàáÊ≥®ÊÑè‰∫ãÈ†Ö..."></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">È©óÊî∂ÈáçÈªû</label>
                            <textarea v-model="dataManager.taskModal.data.inspection_key" rows="2"
                                class="w-full border rounded-lg px-3 py-2" placeholder="Ëº∏ÂÖ•È©óÊî∂Ê™¢Ê†∏È†ÖÁõÆ..."></textarea>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-b-xl flex justify-end gap-3">
                        <button @click="dataManager.taskModal.show = false"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800">ÂèñÊ∂à</button>
                        <button @click="saveTask()" :disabled="loading"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                            <i v-if="loading" class="ph ph-spinner animate-spin mr-1"></i>
                            {{ dataManager.taskModal.mode === 'create' ? 'Êñ∞Â¢û' : 'ÂÑ≤Â≠ò' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Â∑•ÂÖ∑Á∑®ËºØ Modal -->
            <div v-if="dataManager.toolModal.show"
                class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"
                @mousedown.self="dataManager.toolModal.show = false">
                <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="bg-green-600 text-white p-4 rounded-t-xl flex justify-between items-center">
                        <h3 class="font-bold text-lg">
                            {{ dataManager.toolModal.mode === 'create' ? 'Êñ∞Â¢ûÂ∑•ÂÖ∑' : 'Á∑®ËºØÂ∑•ÂÖ∑' }}
                        </h3>
                        <button @click="dataManager.toolModal.show = false" class="text-white/80 hover:text-white">
                            <i class="ph ph-x text-xl"></i>
                        </button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Â∑•ÂÖ∑‰ª£Ëôü *</label>
                                <input v-model="dataManager.toolModal.data.tool_id" type="text"
                                    :disabled="dataManager.toolModal.mode === 'edit'"
                                    class="w-full border rounded-lg px-3 py-2 disabled:bg-gray-100"
                                    placeholder="‰æãÂ¶ÇÔºöt_compressor">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Â∑•ÂÖ∑ÂêçÁ®± *</label>
                                <input v-model="dataManager.toolModal.data.name" type="text"
                                    class="w-full border rounded-lg px-3 py-2" placeholder="‰æãÂ¶ÇÔºöÁ©∫Â£ìÊ©ü">
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÂàÜÈ°û</label>
                                <select v-model="dataManager.toolModal.data.category"
                                    class="w-full border rounded-lg px-3 py-2">
                                    <option v-for="cat in toolCategoryOptions" :key="cat" :value="cat">{{ cat }}
                                    </option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÂãïÂäõË¶èÊ†º</label>
                                <select v-model="dataManager.toolModal.data.power_spec"
                                    class="w-full border rounded-lg px-3 py-2">
                                    <option value="">ÁÑ°</option>
                                    <option value="110V">110V</option>
                                    <option value="220V">220V</option>
                                    <option value="18V">18V ÈõªÊ±†</option>
                                    <option value="Air">Ê∞£Âãï</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Êî∂Á¥ç‰ΩçÁΩÆ</label>
                                <input v-model="dataManager.toolModal.data.storage_box" type="text"
                                    class="w-full border rounded-lg px-3 py-2" placeholder="‰æãÂ¶ÇÔºöÂ∑•ÂÖ∑ÁÆ± A">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‰øùÈ§äË™™Êòé</label>
                            <textarea v-model="dataManager.toolModal.data.maintenance" rows="2"
                                class="w-full border rounded-lg px-3 py-2" placeholder="‰æãÂ¶ÇÔºöÊØèÊó•Ê¥©Ê∞¥„ÄÅÂÆöÊúü‰∏äÊ≤π..."></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‰ΩøÁî®Ë¶ÅË®£</label>
                            <textarea v-model="dataManager.toolModal.data.usage_tips" rows="2"
                                class="w-full border rounded-lg px-3 py-2" placeholder="‰æãÂ¶ÇÔºöÂ£ìÂäõË®≠ÂÆö 8kg..."></textarea>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-b-xl flex justify-end gap-3">
                        <button @click="dataManager.toolModal.show = false"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800">ÂèñÊ∂à</button>
                        <button @click="saveTool()" :disabled="loading"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50">
                            <i v-if="loading" class="ph ph-spinner animate-spin mr-1"></i>
                            {{ dataManager.toolModal.mode === 'create' ? 'Êñ∞Â¢û' : 'ÂÑ≤Â≠ò' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- ÊùêÊñôÁ∑®ËºØ Modal -->
            <div v-if="dataManager.materialModal.show"
                class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"
                @mousedown.self="dataManager.materialModal.show = false">
                <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="bg-amber-600 text-white p-4 rounded-t-xl flex justify-between items-center">
                        <h3 class="font-bold text-lg">
                            {{ dataManager.materialModal.mode === 'create' ? 'Êñ∞Â¢ûÊùêÊñô' : 'Á∑®ËºØÊùêÊñô' }}
                        </h3>
                        <button @click="dataManager.materialModal.show = false" class="text-white/80 hover:text-white">
                            <i class="ph ph-x text-xl"></i>
                        </button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÊùêÊñô‰ª£Ëôü *</label>
                                <input v-model="dataManager.materialModal.data.mat_id" type="text"
                                    :disabled="dataManager.materialModal.mode === 'edit'"
                                    class="w-full border rounded-lg px-3 py-2 disabled:bg-gray-100"
                                    placeholder="‰æãÂ¶ÇÔºöm_silicate_6mm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÊùêÊñôÂêçÁ®± *</label>
                                <input v-model="dataManager.materialModal.data.name" type="text"
                                    class="w-full border rounded-lg px-3 py-2" placeholder="‰æãÂ¶ÇÔºöÁüΩÈÖ∏Èà£Êùø">
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ë¶èÊ†º</label>
                                <input v-model="dataManager.materialModal.data.spec_order" type="text"
                                    class="w-full border rounded-lg px-3 py-2" placeholder="‰æãÂ¶ÇÔºö3x6Â∞∫ 6mm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÂìÅÁâå</label>
                                <input v-model="dataManager.materialModal.data.brand" type="text"
                                    class="w-full border rounded-lg px-3 py-2" placeholder="‰æãÂ¶ÇÔºöÊó•Êú¨È∫ó‰ªï">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÂñÆ‰Ωç</label>
                                <input v-model="dataManager.materialModal.data.unit" type="text"
                                    class="w-full border rounded-lg px-3 py-2" placeholder="‰æãÂ¶ÇÔºöÂºµ„ÄÅÊîØ„ÄÅÁÆ±">
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ÂàÜÈ°û</label>
                                <select v-model="dataManager.materialModal.data.category"
                                    class="w-full border rounded-lg px-3 py-2">
                                    <option v-for="cat in materialCategoryOptions" :key="cat" :value="cat">{{ cat }}
                                    </option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">‰æõÊáâÂïÜ</label>
                                <input v-model="dataManager.materialModal.data.vendor_ref" type="text"
                                    class="w-full border rounded-lg px-3 py-2" placeholder="‰æãÂ¶ÇÔºöÂª∫ÊùêË°åA">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">È†ê‰º∞ÂñÆÂÉπ</label>
                                <input v-model.number="dataManager.materialModal.data.price_estimate" type="number"
                                    class="w-full border rounded-lg px-3 py-2" placeholder="0">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ÂåÖË£ùË¶èÊ†º</label>
                            <input v-model="dataManager.materialModal.data.pack_desc" type="text"
                                class="w-full border rounded-lg px-3 py-2" placeholder="‰æãÂ¶ÇÔºö‰∏ÄÁÆ± 8 Áâá">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ÂÇôË®ªË™™Êòé</label>
                            <textarea v-model="dataManager.materialModal.data.note" rows="2"
                                class="w-full border rounded-lg px-3 py-2" placeholder="ÂÖ∂‰ªñÂÇôË®ª..."></textarea>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-b-xl flex justify-end gap-3">
                        <button @click="dataManager.materialModal.show = false"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800">ÂèñÊ∂à</button>
                        <button @click="saveMaterial()" :disabled="loading"
                            class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50">
                            <i v-if="loading" class="ph ph-spinner animate-spin mr-1"></i>
                            {{ dataManager.materialModal.mode === 'create' ? 'Êñ∞Â¢û' : 'ÂÑ≤Â≠ò' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Toast ÈÄöÁü•ÂÆπÂô® -->
            <div class="fixed bottom-4 right-4 z-[100] flex flex-col gap-2">
                <transition-group name="toast">
                    <div v-for="toast in toasts" :key="toast.id" :class="[
                            'px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 min-w-[280px] max-w-sm',
                            toast.type === 'success' ? 'bg-green-500 text-white' : '',
                            toast.type === 'error' ? 'bg-red-500 text-white' : '',
                            toast.type === 'warning' ? 'bg-yellow-500 text-white' : '',
                            toast.type === 'info' ? 'bg-indigo-500 text-white' : ''
                        ]">
                        <i :class="[
                            'ph text-lg',
                            toast.type === 'success' ? 'ph-check-circle' : '',
                            toast.type === 'error' ? 'ph-x-circle' : '',
                            toast.type === 'warning' ? 'ph-warning' : '',
                            toast.type === 'info' ? 'ph-info' : ''
                        ]"></i>
                        <span class="flex-1 text-sm">{{ toast.message }}</span>
                        <button @click="removeToast(toast.id)" class="text-white/70 hover:text-white">
                            <i class="ph ph-x"></i>
                        </button>
                    </div>
                </transition-group>
            </div>
        </main>
    </div><!-- end #app -->

    <script>
        const { createApp, ref, computed, onMounted, reactive, watch } = Vue;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üìå ÊáâÁî®Á®ãÂºèÈÖçÁΩÆ (ÈõÜ‰∏≠ÁÆ°ÁêÜÔºå‰æøÊñºÁ∂≠Ë≠∑ËàáÁí∞Â¢ÉÂàáÊèõ)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const APP_CONFIG = {
            VERSION: '2.0',
            // Google Sheets Ë≥áÊñô‰æÜÊ∫ê
            SHEET_ID: '1EXy83IaR378dX68ppltYL0KdD76zZFf40we2AYXwUh8',
            // Google Apps Script ÂæåÁ´Ø API (ÂúñÁâáÊêúÂ∞ãÂ∑≤ÁßªËá≥ÂæåÁ´ØËôïÁêÜ)
            GAS_API_URL: 'https://script.google.com/macros/s/AKfycbyjDiSXzTDfakkzehN5eYPxJ-JDROgc7EBoTGSOmhBoustu6_n-7FVEn7Xfj9Sanr2h/exec'
        };
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        createApp({
            setup() {
                // ÁãÄÊÖã
                const loading = ref(true);
                const viewMode = ref('materials'); // materials, tools, sop
                const project = reactive({
                    name: '',
                    phase: 'ALL',
                    allocMode: 'share' // share, individual
                });

                // Ë≥áÊñôÂ∫´ (Raw Data)
                const db = reactive({
                    materials: [],      // DB_Materials
                    tools: [],          // DB_Tools
                    tasks: [],          // DB_Tasks
                    mapExMaterials: [], // Map_Task_Materials
                    mapExTools: []      // Map_Task_Tools
                });

                // UI ÁãÄÊÖã
                const filterCategory = ref('ÂÖ®ÈÉ®');
                const selectedTask = ref(null);
                const inputQty = ref(1);
                const cart = ref([]);

                // === Toast ÈÄöÁü•Á≥ªÁµ± ===
                const toasts = ref([]);
                let toastId = 0;

                const showToast = (message, type = 'info', duration = 3000) => {
                    const id = ++toastId;
                    toasts.value.push({ id, message, type });
                    if (duration > 0) {
                        setTimeout(() => removeToast(id), duration);
                    }
                };

                const removeToast = (id) => {
                    const idx = toasts.value.findIndex(t => t.id === id);
                    if (idx > -1) toasts.value.splice(idx, 1);
                };

                // === Ë≥áÊñôÁÆ°ÁêÜÁãÄÊÖã ===
                const phases = ['01_‰øùË≠∑', '02_ÊãÜÈô§', '03_Êú®‰Ωú', '04_Ê∞¥Èõª', '05_Ê≥•‰Ωú', '06_Ê≤πÊºÜ', '07_Á≥ªÁµ±Ê´É', '08_Ê∏ÖÊΩî'];

                const dataManager = reactive({
                    activeTab: 'tasks',
                    searchTask: '',
                    searchTool: '',
                    searchMaterial: '',
                    filterCategory: '',
                    taskModal: { show: false, mode: 'create', data: {} },
                    toolModal: { show: false, mode: 'create', data: {} },
                    materialModal: { show: false, mode: 'create', data: {} }
                });

                // ÁØ©ÈÅ∏ÂæåÁöÑÊ∏ÖÂñÆ
                const filteredDbTasks = computed(() => {
                    let list = db.tasks;
                    if (dataManager.searchTask) {
                        const keyword = dataManager.searchTask.toLowerCase();
                        list = list.filter(t => t.task_name?.toLowerCase().includes(keyword));
                    }
                    if (dataManager.filterCategory) {
                        list = list.filter(t => t.category === dataManager.filterCategory);
                    }
                    return list;
                });

                const filteredDbTools = computed(() => {
                    let list = db.tools;
                    if (dataManager.searchTool) {
                        const keyword = dataManager.searchTool.toLowerCase();
                        list = list.filter(t => t.name?.toLowerCase().includes(keyword));
                    }
                    return list;
                });

                const filteredDbMaterials = computed(() => {
                    let list = db.materials;
                    if (dataManager.searchMaterial) {
                        const keyword = dataManager.searchMaterial.toLowerCase();
                        list = list.filter(m => m.name?.toLowerCase().includes(keyword));
                    }
                    return list;
                });

                // ÂãïÂäõË¶èÊ†ºÈ°èËâ≤
                const getPowerClass = (power) => {
                    if (!power) return 'bg-gray-100 text-gray-600';
                    if (power.includes('110V') || power.includes('220V')) return 'bg-blue-100 text-blue-700';
                    if (power.includes('18V')) return 'bg-purple-100 text-purple-700';
                    if (power === 'Air') return 'bg-green-100 text-green-700';
                    return 'bg-gray-100 text-gray-600';
                };

                // === ÈÄöÁî®ÂáΩÂºèÔºöÂæûË≥áÊñô‰∏≠Êì∑ÂèñÂîØ‰∏ÄÈÅ∏È†Ö ===
                // Áî®ÊñºÂãïÊÖãÁîüÊàê‰∏ãÊãâÈÅ∏ÂñÆÔºåÈÅøÂÖçÁ°¨Á∑®Á¢ºÈÅ∏È†ÖËàáË≥áÊñô‰∏çÁ¨¶ÈÄ†ÊàêÁ©∫ÁôΩ
                const getUniqueOptions = (dataArray, fieldName, defaultOptions = []) => {
                    // ÂæûÁèæÊúâË≥áÊñô‰∏≠Êì∑ÂèñË©≤Ê¨Ñ‰ΩçÁöÑÊâÄÊúâÂîØ‰∏ÄÂÄº
                    const valuesFromData = new Set(
                        dataArray
                            .map(item => item[fieldName])
                            .filter(val => val !== undefined && val !== null && val !== '')
                    );
                    // Âêà‰ΩµÈ†êË®≠ÈÅ∏È†ÖÔºàÁ¢∫‰øùÊñ∞Âª∫ÊôÇÊúâÂü∫Êú¨ÈÅ∏È†ÖÔºâ
                    defaultOptions.forEach(opt => valuesFromData.add(opt));
                    // ÊéíÂ∫èÂæåÂõûÂÇ≥Èô£Âàó
                    return [...valuesFromData].sort();
                };

                // ÂãïÊÖãÈÅ∏ÂñÆ: Â∑•È†ÖÂàÜÈ°û
                const taskCategoryOptions = computed(() =>
                    getUniqueOptions(db.tasks, 'category', ['Êú®‰Ωú', 'Ê≤πÊºÜ', 'Ê∞¥Èõª', 'Ê≥•‰Ωú', 'Á≥ªÁµ±Ê´É', 'ÊãÜÈô§', '‰øùË≠∑', 'ÂÖ∂‰ªñ'])
                );

                // ÂãïÊÖãÈÅ∏ÂñÆ: Â∑•ÂÖ∑ÂàÜÈ°û
                const toolCategoryOptions = computed(() =>
                    getUniqueOptions(db.tools, 'category', ['ÈõªÂãïÂ∑•ÂÖ∑', 'Ê∞£ÂãïÂ∑•ÂÖ∑', 'ÊâãÂ∑•ÂÖ∑', 'ÈáèÊ∏¨Â∑•ÂÖ∑', '‰∫îÈáëÈÖç‰ª∂', 'ÂÖ∂‰ªñ'])
                );

                // ÂãïÊÖãÈÅ∏ÂñÆ: ÊùêÊñôÂàÜÈ°û
                const materialCategoryOptions = computed(() =>
                    getUniqueOptions(db.materials, 'category', ['ÊùøÊùê', 'ËßíÊùê', '‰∫îÈáë', 'Ê≤πÊºÜ', 'Â°´Á∏´Êñô', 'ÂÖ∂‰ªñ'])
                );

                // === GAS API Êï¥Âêà === (‰ΩøÁî® APP_CONFIG)
                const GAS_API_URL = APP_CONFIG.GAS_API_URL;

                const callBackend = async (action, payload = {}) => {
                    console.log(`[API] Call ${action}`, payload);
                    const postData = JSON.stringify({ action, ...payload });
                    try {
                        const res = await fetch(GAS_API_URL, {
                            method: 'POST',
                            redirect: 'follow', // GAS Web App Â∞éÂêë
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // ÈÅøÈñã CORS preflight
                            body: postData
                        });
                        const data = await res.json();
                        console.log(`[API] Result:`, data);
                        if (data.status === 'error') throw new Error(data.message);
                        return data;
                    } catch (e) {
                        console.error(`[API] Error:`, e);
                        if (e.name === 'SyntaxError') {
                            // CORS blocked response text usually causes SyntaxError on json()
                            // but headers might have succeeded.
                            console.warn('Response blocked by CORS, but request likely sent.');
                            return { status: 'unknown' };
                        }
                        throw e;
                    }
                };

                const setupDatabase = async () => {
                    if (!confirm("Á¢∫ÂÆöË¶ÅÈáçÁΩÆË≥áÊñôÂ∫´ÂóéÔºü\n\nË≠¶ÂëäÔºöÈÄôÂ∞áÊúÉÊ∏ÖÈô§ÊâÄÊúâÁèæÊúâË≥áÊñô‰∏¶ÈÇÑÂéüÁÇ∫È†êË®≠ÂÄºÔºÅ")) return;
                    loading.value = true;
                    try {
                        await callBackend('setup_db');
                        alert("ÂàùÂßãÂåñÊàêÂäüÔºÅË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢„ÄÇ");
                        location.reload();
                    } catch (e) {
                        alert("ÂàùÂßãÂåñÂ§±Êïó: " + e.message);
                        loading.value = false;
                    }
                };

                // === ÈÖçÊñπÁÆ°ÁêÜÂäüËÉΩ ===
                const recipeManager = reactive({
                    selectedTaskId: '',
                    // Êñ∞Â¢ûÊùêÊñô Modal
                    addMatModal: {
                        show: false,
                        selectedMatId: '',
                        spec: '',
                        qty: 1,
                        loss: 1.1,
                        isConsumable: false
                    },
                    // Êñ∞Â¢ûÂ∑•ÂÖ∑ Modal
                    addToolModal: {
                        show: false,
                        selectedToolId: '',
                        type: 'ÂøÖÂÇô',
                        qty: 1,
                        calcMethod: 'PerWorker'
                    },
                    // ÊùêÊñôË©≥ÊÉÖ Modal
                    matDetailModal: {
                        show: false,
                        material: null
                    },
                    // ‰øÆÊîπÊ®ôË®ò
                    hasChanges: false
                });

                // ÂèñÂæóÊåáÂÆöÂ∑•È†ÖÁöÑÊùêÊñôÈÖçÊñπ
                const getTaskMaterials = (taskId) => {
                    if (!taskId) return [];
                    return db.mapExMaterials.filter(m => m.task_id === taskId);
                };

                // ÂèñÂæóÊåáÂÆöÂ∑•È†ÖÁöÑÂ∑•ÂÖ∑ÈÖçÊñπ
                const getTaskTools = (taskId) => {
                    if (!taskId) return [];
                    return db.mapExTools.filter(t => t.task_id === taskId);
                };

                // Ê†πÊìö mat_id ÂèñÂæóÊùêÊñôÂêçÁ®±
                const getMatName = (matId) => {
                    const mat = db.materials.find(m => m.mat_id === matId);
                    return mat ? mat.name : matId;
                };

                // Ê†πÊìö tool_id ÂèñÂæóÂ∑•ÂÖ∑ÂêçÁ®±
                const getToolName = (toolId) => {
                    const tool = db.tools.find(t => t.tool_id === toolId);
                    return tool ? tool.name : toolId;
                };

                // === CRUD: ÊùêÊñôÈÖçÊñπ ===
                // Êõ¥Êñ∞ÊùêÊñôÈÖçÊñπ
                const updateMatRecipe = (mat, field, value) => {
                    mat[field] = value;
                    recipeManager.hasChanges = true;
                    console.log(`Êõ¥Êñ∞ÊùêÊñôÈÖçÊñπ: ${mat.mat_id}.${field} = ${value}`);
                };

                // Âà™Èô§ÊùêÊñôÈÖçÊñπ
                const deleteMatRecipe = (mat) => {
                    if (!confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§„Äå${getMatName(mat.mat_id)}„ÄçÂóé?`)) return;
                    const idx = db.mapExMaterials.findIndex(m =>
                        m.task_id === mat.task_id && m.mat_id === mat.mat_id);
                    if (idx > -1) {
                        db.mapExMaterials.splice(idx, 1);
                        recipeManager.hasChanges = true;
                    }
                };

                // ÈñãÂïüÊñ∞Â¢ûÊùêÊñô Modal
                const openAddMaterialModal = () => {
                    recipeManager.addMatModal.show = true;
                    recipeManager.addMatModal.selectedMatId = '';
                    recipeManager.addMatModal.spec = '';
                    recipeManager.addMatModal.qty = 1;
                    recipeManager.addMatModal.loss = 1.1;
                    recipeManager.addMatModal.isConsumable = false;
                };

                // Êñ∞Â¢ûÊùêÊñôÈÖçÊñπ
                const addMaterialRecipe = () => {
                    const m = recipeManager.addMatModal;
                    if (!m.selectedMatId) {
                        alert('Ë´ãÈÅ∏ÊìáÊùêÊñô');
                        return;
                    }
                    db.mapExMaterials.push({
                        task_id: recipeManager.selectedTaskId,
                        mat_id: m.selectedMatId,
                        spec: m.spec || getMatName(m.selectedMatId),
                        qty_per_unit: m.qty,
                        loss_rate: m.loss,
                        is_consumable: m.isConsumable ? 'TRUE' : 'FALSE',
                        linked_tool_id: ''
                    });
                    recipeManager.addMatModal.show = false;
                    recipeManager.hasChanges = true;
                };

                // È°ØÁ§∫ÊùêÊñôË©≥ÊÉÖ
                const showMaterialDetail = (matId) => {
                    const mat = db.materials.find(m => m.mat_id === matId);
                    if (mat) {
                        recipeManager.matDetailModal.material = mat;
                        recipeManager.matDetailModal.show = true;
                    }
                };

                // === CRUD: Â∑•ÂÖ∑ÈÖçÊñπ ===
                // Êõ¥Êñ∞Â∑•ÂÖ∑ÈÖçÊñπ
                const updateToolRecipe = (tool, field, value) => {
                    tool[field] = value;
                    recipeManager.hasChanges = true;
                    console.log(`Êõ¥Êñ∞Â∑•ÂÖ∑ÈÖçÊñπ: ${tool.tool_id}.${field} = ${value}`);
                };

                // Âà™Èô§Â∑•ÂÖ∑ÈÖçÊñπ
                const deleteToolRecipe = (tool) => {
                    if (!confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§„Äå${getToolName(tool.tool_id)}„ÄçÂóé?`)) return;
                    const idx = db.mapExTools.findIndex(t =>
                        t.task_id === tool.task_id && t.tool_id === tool.tool_id);
                    if (idx > -1) {
                        db.mapExTools.splice(idx, 1);
                        recipeManager.hasChanges = true;
                    }
                };

                // ÈñãÂïüÊñ∞Â¢ûÂ∑•ÂÖ∑ Modal
                const openAddToolModal = () => {
                    recipeManager.addToolModal.show = true;
                    recipeManager.addToolModal.selectedToolId = '';
                    recipeManager.addToolModal.type = 'ÂøÖÂÇô';
                    recipeManager.addToolModal.qty = 1;
                    recipeManager.addToolModal.calcMethod = 'PerWorker';
                };

                // Êñ∞Â¢ûÂ∑•ÂÖ∑ÈÖçÊñπ
                const addToolRecipe = () => {
                    const t = recipeManager.addToolModal;
                    if (!t.selectedToolId) {
                        alert('Ë´ãÈÅ∏ÊìáÂ∑•ÂÖ∑');
                        return;
                    }
                    db.mapExTools.push({
                        task_id: recipeManager.selectedTaskId,
                        tool_id: t.selectedToolId,
                        type: t.type,
                        qty_avg: t.qty,
                        calc_method: t.calcMethod
                    });
                    recipeManager.addToolModal.show = false;
                    recipeManager.hasChanges = true;
                };

                // ÂÑ≤Â≠òÊâÄÊúâÈÖçÊñπÂà∞ Sheet (v2.3 - ÁßªÈô§ confirm, ÈªûÊìäÁ´ãÂç≥Á¶ÅÁî®)
                const saveAllRecipes = async () => {
                    const taskId = recipeManager.selectedTaskId;
                    if (!taskId) {
                        showToast('Ë´ãÂÖàÈÅ∏Êìá‰∏ÄÂÄãÂ∑•È†Ö', 'warning');
                        return;
                    }

                    // Á´ãÂç≥Á¶ÅÁî®ÊåâÈàïÔºåÈò≤Ê≠¢ÈáçË§áÈªûÊìä
                    loading.value = true;
                    try {
                        // 1. Ê∫ñÂÇôË≥áÊñô - Ë§áË£Ω Pure Object
                        const currentMaterials = getTaskMaterials(taskId).map(m => ({
                            task_id: m.task_id,
                            mat_id: m.mat_id,
                            spec: m.spec,
                            qty_per_unit: m.qty_per_unit,
                            loss_rate: m.loss_rate,
                            is_consumable: m.is_consumable,
                            linked_tool_id: m.linked_tool_id || ''
                        }));

                        const currentTools = getTaskTools(taskId).map(t => ({
                            task_id: t.task_id,
                            tool_id: t.tool_id,
                            type: t.type,
                            qty_avg: t.qty_avg,
                            calc_method: t.calc_method
                        }));

                        console.log('[Save] Materials:', currentMaterials);
                        console.log('[Save] Tools:', currentTools);

                        // Helper: ÊâπÊ¨°Êñ∞Â¢û with fallback
                        const batchCreateWithFallback = async (sheetName, dataList) => {
                            if (dataList.length === 0) return;

                            try {
                                // ÂÑ™ÂÖàÂòóË©¶ batch_create
                                await callBackend('batch_create', { sheetName, data: dataList });
                                console.log(`[Save] batch_create ${sheetName} ÊàêÂäü`);
                            } catch (batchErr) {
                                // Â¶ÇÊûú batch_create Â§±ÊïóÔºåÊîπÁî®Âæ™Áí∞ create
                                console.warn(`[Save] batch_create ${sheetName} Â§±ÊïóÔºåÊîπÁî®Âæ™Áí∞ create:`, batchErr.message);
                                for (const item of dataList) {
                                    await callBackend('create', { sheetName, data: item });
                                }
                                console.log(`[Save] Âæ™Áí∞ create ${sheetName} ÂÆåÊàê`);
                            }
                        };

                        // 2. Âü∑Ë°å Material Êõ¥Êñ∞ (Delete All -> Batch Create or Loop Create)
                        await callBackend('delete', {
                            sheetName: 'Map_Task_Materials',
                            keyField: 'task_id',
                            keyValue: taskId
                        });
                        await batchCreateWithFallback('Map_Task_Materials', currentMaterials);

                        // 3. Âü∑Ë°å Tool Êõ¥Êñ∞
                        await callBackend('delete', {
                            sheetName: 'Map_Task_Tools',
                            keyField: 'task_id',
                            keyValue: taskId
                        });
                        await batchCreateWithFallback('Map_Task_Tools', currentTools);

                        showToast('ÈÖçÊñπÂÑ≤Â≠òÊàêÂäüÔºÅ', 'success');
                        recipeManager.hasChanges = false;

                    } catch (e) {
                        console.error('[Save] ÊúÄÁµÇÈåØË™§:', e);
                        showToast('ÂÑ≤Â≠òÂ§±Êïó: ' + e.message, 'error');
                    } finally {
                        loading.value = false;
                    }
                };


                // === ÂúñÁâáÊêúÂ∞ãÂäüËÉΩ === (Â∑≤ÁßªËá≥ÂæåÁ´ØËôïÁêÜÔºåÂâçÁ´Ø‰∏çÂÜçÊö¥Èú≤ API ÈáëÈë∞)

                // ÂúñÁâá Modal ÁãÄÊÖã (v2.0: ÂàÜÈ†ÅÈ°ØÁ§∫)
                const PAGE_SIZE = 5; // ÊØèÈ†ÅÈ°ØÁ§∫ 5 Âºµ
                const imageModal = reactive({
                    show: false,
                    loading: false,
                    material: null,        // Áï∂ÂâçÈÅ∏ÊìáÁöÑÊùêÊñôÁâ©‰ª∂
                    imagePool: [],         // ÊêúÂ∞ãÂà∞ÁöÑÊâÄÊúâÂúñÁâá URL (ÊúÄÂ§ö 20 Âºµ)
                    currentPage: 0,        // Áï∂ÂâçÈ†ÅÁ¢º (0-based)
                    selectedIndex: null    // Áï∂ÂâçÈÅ∏‰∏≠ÁöÑÂúñÁâáÁ¥¢Âºï (Âú® imagePool ‰∏≠ÁöÑ‰ΩçÁΩÆ)
                });

                // Ë®àÁÆóÂ±¨ÊÄßÔºöÁï∂ÂâçÈ†ÅÁöÑÂúñÁâáÈô£Âàó
                const currentPageImages = computed(() => {
                    const start = imageModal.currentPage * PAGE_SIZE;
                    return imageModal.imagePool.slice(start, start + PAGE_SIZE);
                });

                // Ë®àÁÆóÂ±¨ÊÄßÔºöÁ∏ΩÈ†ÅÊï∏
                const totalPages = computed(() => {
                    return Math.ceil(imageModal.imagePool.length / PAGE_SIZE);
                });

                // Ë®àÁÆóÂ±¨ÊÄßÔºöÂ∑≤ÊúâÂÑ≤Â≠òÂúñÁâá
                const hasSavedImage = computed(() => {
                    return imageModal.material?.image_url ? true : false;
                });

                // ÈñãÂïüÂúñÁâá Modal
                const openImageModal = (mat) => {
                    console.log('[ImageModal] Opening for:', mat?.name);
                    imageModal.material = mat;
                    imageModal.show = true;
                    imageModal.loading = false;
                    imageModal.imagePool = [];
                    imageModal.currentPage = 0;
                    imageModal.selectedIndex = null;

                    // Â¶ÇÊûúÂ∑≤ÊúâÂÑ≤Â≠òÁöÑÂúñÁâáÔºåÁõ¥Êé•È°ØÁ§∫
                    if (mat.image_url) {
                        console.log('[ImageModal] Has saved image:', mat.image_url);
                        // ‰∏çÈúÄË¶ÅÁ´ãÂç≥ÊêúÂ∞ãÔºåÁî®Êà∂ÂèØÊâãÂãïÈªûÊìäÈáçÊñ∞ÊêúÂ∞ã
                    }
                };

                // ÊêúÂ∞ãÂúñÁâá (ÈÄöÈÅéÂæåÁ´Ø GAS APIÔºå‰∏çÊö¥Èú≤ÈáëÈë∞)
                const searchImages = async () => {
                    if (!imageModal.material) return;

                    imageModal.loading = true;
                    imageModal.imagePool = [];
                    imageModal.currentPage = 0;
                    imageModal.selectedIndex = null;

                    const query = `${imageModal.material.name} ${imageModal.material.spec || ''}`.trim();
                    console.log(`[ImageSearch] Searching: ${query}`);

                    try {
                        const result = await callBackend('search_images', { query });

                        if (result.status === 'error') {
                            console.error('[ImageSearch] Backend Error:', result.message);
                            showToast(`ÊêúÂ∞ãÂ§±Êïó: ${result.message}`, 'error');
                        } else if (result.images && result.images.length > 0) {
                            imageModal.imagePool = result.images;
                            console.log(`[ImageSearch] Found ${result.images.length} images`);
                            showToast(`ÊâæÂà∞ ${result.images.length} ÂºµÂúñÁâá`, 'success');
                        } else {
                            showToast('Êâæ‰∏çÂà∞Áõ∏ÈóúÂúñÁâá', 'warning');
                        }
                    } catch (err) {
                        console.error('[ImageSearch] Exception:', err);
                        showToast('ÂúñÁâáÊêúÂ∞ãÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
                    }

                    imageModal.loading = false;
                };

                // ÁøªÈ†Å
                const changePage = (delta) => {
                    const newPage = imageModal.currentPage + delta;
                    if (newPage >= 0 && newPage < totalPages.value) {
                        imageModal.currentPage = newPage;
                    }
                };

                // ÈÅ∏ÊìáÂúñÁâá
                const selectImage = (poolIndex) => {
                    imageModal.selectedIndex = poolIndex;
                };

                // ÂèñÂæóÂúñÁâáÂú® imagePool ‰∏≠ÁöÑÂØ¶ÈöõÁ¥¢Âºï
                const getPoolIndex = (pageIndex) => {
                    return imageModal.currentPage * PAGE_SIZE + pageIndex;
                };

                // ÂÑ≤Â≠òÈÅ∏ÂÆöÁöÑÂúñÁâá
                const saveSelectedImage = async () => {
                    if (!imageModal.material || imageModal.selectedIndex === null) {
                        showToast('Ë´ãÂÖàÈÅ∏Êìá‰∏ÄÂºµÂúñÁâá', 'warning');
                        return;
                    }

                    const matId = imageModal.material.mat_id;
                    const newUrl = imageModal.imagePool[imageModal.selectedIndex];

                    // 1. Êõ¥Êñ∞Êú¨Âú∞Ë≥áÊñô
                    const matInDb = db.materials.find(m => m.mat_id === matId);
                    if (matInDb) {
                        matInDb.image_url = newUrl;
                    }

                    // 2. ÂëºÂè´ÂæåÁ´Ø
                    imageModal.loading = true;
                    try {
                        await callBackend('update', {
                            sheetName: 'DB_Materials',
                            keyField: 'mat_id',
                            keyValue: matId,
                            data: {
                                image_url: newUrl
                            }
                        });
                        showToast('ÂúñÁâáÂ∑≤ÂÑ≤Â≠òÔºÅ', 'success');
                        imageModal.show = false;
                    } catch (e) {
                        showToast('ÂÑ≤Â≠òÂ§±Êïó: ' + e.message, 'error');
                    } finally {
                        imageModal.loading = false;
                    }
                };

                // Â∑•È†ÖÂàÜÈ°û (ÂæûË≥áÊñôÂ∫´Ëá™ÂãïÁî¢Áîü)
                const categories = computed(() => {
                    if (!db.tasks || db.tasks.length === 0) return ['ÂÖ®ÈÉ®'];
                    const cats = new Set(db.tasks.map(t => t.category).filter(c => c));
                    return ['ÂÖ®ÈÉ®', ...Array.from(cats)];
                });

                // Â∑•È†ÖÁØ©ÈÅ∏
                const filteredTasks = computed(() => {
                    if (filterCategory.value === 'ÂÖ®ÈÉ®') return db.tasks;
                    return db.tasks.filter(t => t.category === filterCategory.value);
                });

                // Âä†ÂÖ•Ë≥ºÁâ©Ëªä
                const addTask = () => {
                    if (!selectedTask.value || inputQty.value <= 0) return;
                    cart.value.push({
                        task: selectedTask.value,
                        qty: inputQty.value
                    });
                    // Reset
                    selectedTask.value = null;
                    inputQty.value = 1;
                };

                const removeTask = (index) => {
                    cart.value.splice(index, 1);
                };

                // Ê†∏ÂøÉÔºöËÆÄÂèñ Google Sheets (‰ΩøÁî® APP_CONFIG)
                const SHEET_ID = APP_CONFIG.SHEET_ID;

                // JSONP Â∞ÅË£ù: Âà©Áî® <script> Ê®ôÁ±§ËºâÂÖ•Ë≥áÊñôÔºåÈÅøÈñãÁÄèË¶ΩÂô®Ë∑®ÂüüÈôêÂà∂
                const fetchSheet = (sheetName, query = 'SELECT *') => {
                    return new Promise((resolve, reject) => {
                        console.log(`[GViz] Requesting sheet: ${sheetName}...`); // Log Request

                        // Áî¢ÁîüÈö®Ê©ü Callback ÂêçÁ®±
                        const callbackName = 'gviz_callback_' + Math.floor(Math.random() * 100000);

                        // Ë®≠ÂÆöË∂ÖÊôÇÊ©üÂà∂ (15Áßí)ÔºåÈÅøÂÖçË´ãÊ±ÇÂç°Ê≠ª
                        const timeoutId = setTimeout(() => {
                            delete window[callbackName];
                            if (document.body.contains(script)) {
                                document.body.removeChild(script);
                            }
                            reject(new Error(`Request timeout for ${sheetName}`));
                        }, 15000);

                        // ÂÆöÁæ©ÂÖ®Âüü Callback
                        window[callbackName] = (data) => {
                            clearTimeout(timeoutId); // Ê∏ÖÈô§Ë∂ÖÊôÇË®àÊôÇÂô®
                            delete window[callbackName]; // Ê∏ÖÈô§
                            if (document.body.contains(script)) document.body.removeChild(script); // ÁßªÈô§Ê®ôÁ±§

                            if (data.status === 'error') {
                                console.error(`[GViz] Error for ${sheetName}:`, data.errors);
                                reject(data.errors);
                            } else {
                                const parsed = parseGVizData(data);
                                console.log(`[GViz] Success ${sheetName}: ${parsed.length} rows loaded.`);
                                resolve(parsed);
                            }
                        };

                        // Âª∫Á´ã Script Ê®ôÁ±§
                        const script = document.createElement('script');
                        // [Fix] Âä†ÂÖ• &headers=1 Âº∑Âà∂ÊåáÂÆöÁ¨¨‰∏ÄÂàóÁÇ∫Ê®ôÈ°åÔºåÈÅøÂÖç GViz Ë™§Âà§Â∞éËá¥ label ÁÇ∫Á©∫
                        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:${callbackName}&sheet=${sheetName}&tq=${encodeURIComponent(query)}&headers=1`;

                        script.src = url;
                        script.onerror = (err) => {
                            console.error(`[GViz] Network Error loading ${sheetName}. URL: ${url}`, err);
                            clearTimeout(timeoutId);
                            delete window[callbackName];
                            document.body.removeChild(script);
                            reject(new Error(`Network error loading ${sheetName}`));
                        };

                        document.body.appendChild(script);
                    });
                };

                // Ëß£Êûê GViz Data Table Ê†ºÂºèÁÇ∫ Array of Objects
                const parseGVizData = (data) => {
                    const cols = data.table.cols.map(c => c.label);
                    return data.table.rows.map(row => {
                        let obj = {};
                        row.c.forEach((cell, i) => {
                            // Ëã•Ê¨Ñ‰ΩçÁÇ∫Á©∫ÔºåÁµ¶‰∫àÈ†êË®≠ÂÄº
                            if (cols[i]) obj[cols[i]] = (cell && cell.v !== null) ? cell.v : '';
                        });
                        return obj;
                    });
                };

                // ÂàùÂßãÂåñ
                onMounted(async () => {
                    console.log("=== Start App Initialization ===");
                    try {
                        // ‰æùÂ∫èÊàñÂπ≥Ë°åËÆÄÂèñË≥áÊñôÔºåÈÄôË£°Áî®Âπ≥Ë°åËÆÄÂèñÂä†Âø´ÈÄüÂ∫¶
                        const [m, t, tk, mm, mt] = await Promise.all([
                            fetchSheet('DB_Materials'),
                            fetchSheet('DB_Tools'),
                            fetchSheet('DB_Tasks'),
                            fetchSheet('Map_Task_Materials'),
                            fetchSheet('Map_Task_Tools')
                        ]);

                        db.materials = m;
                        db.tools = t;
                        db.tasks = tk;
                        db.mapExMaterials = mm;
                        db.mapExTools = mt;

                        console.log("=== All DB Loaded Successfully ===");

                        // [DEBUG] Ë©≥Á¥∞Ëº∏Âá∫Ë≥áÊñôÁµêÊßãËàáÊ¨Ñ‰ΩçÂêçÁ®±
                        console.log("[DEBUG] Map_Task_Tools Keys:", mt[0] ? JSON.stringify(Object.keys(mt[0])) : 'Empty Array');
                        console.log("[DEBUG] DB_Tools Keys:", t[0] ? JSON.stringify(Object.keys(t[0])) : 'Empty Array');
                        console.log("[DEBUG] Sample Tool from DB_Tools:", t[0] ? JSON.stringify(t[0]) : 'None');

                    } catch (e) {
                        console.error("=== Database Load Failed ===", e);
                        alert("Ë≥áÊñôÂ∫´ËÆÄÂèñÂ§±ÊïóÔºÅË´ãÊåâ F12 ÊâìÈñã Console Êü•ÁúãË©≥Á¥∞ÈåØË™§Ë®äÊÅØ„ÄÇ\nÂèØËÉΩÂéüÂõ†ÔºöGoogle Sheet Êú™ÁôºÂ∏ÉÊàñ Sheet ÂêçÁ®±ÈåØË™§„ÄÇ");
                    } finally {
                        loading.value = false;
                    }
                });

                // --- Ê†∏ÂøÉÈÅãÁÆóÈÇèËºØ ---

                // 1. Ë®àÁÆóÊùêÊñôÈúÄÊ±Ç
                const calculatedMaterials = computed(() => {
                    const rawRequirements = {}; // mat_id -> { qty, ...info }

                    // ÈÅçÊ≠∑ÊâÄÊúâÂ∑≤ÈÅ∏Â∑•È†Ö
                    cart.value.forEach(item => {
                        const taskId = item.task.task_id;
                        const taskQty = item.qty;

                        // ÊâæÂá∫Ë©≤Â∑•È†ÖÁöÑÊâÄÊúâÈÖçÊñπ
                        const recipes = db.mapExMaterials.filter(r => r.task_id === taskId);

                        recipes.forEach(recipe => {
                            const matId = recipe.mat_id;
                            const qtyPerUnit = parseFloat(recipe.qty_per_unit || 0);
                            const lossRate = parseFloat(recipe.loss_rate || 1.0);

                            // Ë®àÁÆóÈúÄÊ±ÇÈáè = Â∑•È†ÖÊï∏Èáè * ÂñÆ‰ΩçÁî®Èáè * ÊêçËÄó
                            const requiredQty = taskQty * qtyPerUnit * lossRate;

                            if (!rawRequirements[matId]) {
                                // È¶ñÊ¨°Âä†ÂÖ•ÔºåÂæû DB_Materials ÊäìË©≥Á¥∞Ë≥áÊñô
                                const matInfo = db.materials.find(m => m.mat_id === matId) ||
                                    { name: matId, spec_order: 'Unknown', unit: '', vendor_ref: 'Unknown', description: '' };
                                rawRequirements[matId] = {
                                    id: matId,
                                    name: matInfo.name,
                                    spec: matInfo.spec_order,
                                    unit: matInfo.unit,
                                    vendor: matInfo.vendor_ref,
                                    pack_desc: matInfo.pack_desc,
                                    description: matInfo.description,
                                    total_qty: 0
                                };
                            }
                            rawRequirements[matId].total_qty += requiredQty;
                        });
                    });

                    // Êï¥ÁêÜ‰∏¶ÂàÜÁµÑ (‰æù‰æõÊáâÂïÜ)
                    const grouped = {};
                    Object.values(rawRequirements).forEach(item => {
                        // Êï∏ÈáèÂèñÂ∞èÊï∏ÈªûÂæå1‰Ωç
                        item.total_qty = Math.ceil(item.total_qty * 10) / 10;

                        const vendor = item.vendor || 'ÂÖ∂‰ªñ';
                        if (!grouped[vendor]) grouped[vendor] = [];
                        grouped[vendor].push(item);
                    });

                    return grouped;
                });

                // 2. Ë®àÁÆóÂ∑•ÂÖ∑ÈúÄÊ±Ç
                const calculatedTools = computed(() => {
                    const toolSet = new Set(); // Â≠òÊîæÈúÄË¶ÅÁöÑ tool_id
                    console.log('[DEBUG] calculatedTools: cart =', cart.value.length, 'items');

                    // ÈÅçÊ≠∑Â∑•È†ÖÊâæÂá∫ÊâÄÈúÄÂ∑•ÂÖ∑
                    cart.value.forEach(item => {
                        const taskId = item.task.task_id;
                        console.log('[DEBUG] Processing taskId:', taskId);

                        // Áõ¥Êé•Áî± Map_Task_Tools ÂÆöÁæ©ÁöÑÂ∑•ÂÖ∑
                        const directTools = db.mapExTools.filter(t => t.task_id === taskId);
                        console.log('[DEBUG] Found directTools:', directTools.length, 'for', taskId);
                        directTools.forEach(dt => toolSet.add(dt.tool_id));

                        // Áî± Map_Task_Materials ÈñìÊé•ÂÆöÁæ©ÁöÑÂ∑•ÂÖ∑ (linked_tool_id)
                        const materialRecipes = db.mapExMaterials.filter(r => r.task_id === taskId);
                        materialRecipes.forEach(mr => {
                            if (mr.linked_tool_id) toolSet.add(mr.linked_tool_id);
                        });
                    });

                    // ËΩâÊèõÁÇ∫Ë©≥Á¥∞Áâ©‰ª∂‰∏¶ÂàÜÈ°û
                    const result = {
                        power: [],
                        manual: []
                    };

                    toolSet.forEach(tid => {
                        const info = db.tools.find(t => t.tool_id === tid);
                        if (!info) return;

                        const toolObj = {
                            id: tid,
                            name: info.name,
                            power_spec: info.power_spec,
                            storage: info.storage_box,
                            qty: 1, // Êö´ÊôÇÁ∞°ÂåñÁÇ∫ 1 (ÈÄ≤ÈöéÈúÄÂØ¶‰Ωú alloc_rule)
                            maintenance: info.maintenance, // Êñ∞Â¢û‰øùÈ§ä
                            usage_tips: info.usage_tips    // Êñ∞Â¢ûÊíáÊ≠•
                        };

                        // Á∞°ÂñÆÂàÜÈ°ûÈÇèËºØ
                        if (['110V', '220V', '18V', '12V', 'Air', 'Battery'].some(k => info.power_spec?.includes(k))) {
                            result.power.push(toolObj);
                        } else {
                            result.manual.push(toolObj);
                        }
                    });

                    return result;
                });

                // Ë§áË£ΩÊñáÂ≠óÂäüËÉΩ
                const copyToClipboard = (type) => {
                    let text = "";
                    if (type === 'materials') {
                        text += "„ÄêË£ù‰øÆÊùêÊñôÊé°Ë≥ºÊ∏ÖÂñÆ„Äë\n\n";
                        for (const [vendor, items] of Object.entries(calculatedMaterials.value)) {
                            text += `== ${vendor} ==\n`;
                            items.forEach(m => {
                                text += `- ${m.name} (${m.spec}): ${m.total_qty} ${m.unit}\n`;
                            });
                            text += "\n";
                        }
                    }
                    navigator.clipboard.writeText(text).then(() => showToast("Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø", "success"));
                };

                // === Â∑•È†Ö CRUD ===
                const openTaskModal = (mode, task = null) => {
                    dataManager.taskModal.mode = mode;
                    dataManager.taskModal.data = mode === 'create' ? {
                        task_id: '',
                        task_name: '',
                        category: 'Êú®‰Ωú',
                        phase: '03_Êú®‰Ωú',
                        unit: 'Âù™',
                        labor_cost: 0,
                        sop_construction: '',
                        inspection_key: '',
                        inspection_sample: ''
                    } : { ...task };
                    dataManager.taskModal.show = true;
                };

                const saveTask = async () => {
                    const data = dataManager.taskModal.data;
                    if (!data.task_id || !data.task_name) {
                        showToast('Ë´ãÂ°´ÂØ´Â∑•È†Ö‰ª£ËôüËàáÂêçÁ®±', 'warning');
                        return;
                    }

                    loading.value = true;
                    try {
                        if (dataManager.taskModal.mode === 'create') {
                            if (db.tasks.some(t => t.task_id === data.task_id)) {
                                showToast('Â∑•È†Ö‰ª£ËôüÂ∑≤Â≠òÂú®', 'error');
                                loading.value = false;
                                return;
                            }
                            await callBackend('create', { sheetName: 'DB_Tasks', data: data });
                            db.tasks.push({ ...data });
                            showToast('Â∑•È†ÖÊñ∞Â¢ûÊàêÂäüÔºÅ', 'success');
                        } else {
                            await callBackend('update', {
                                sheetName: 'DB_Tasks',
                                keyField: 'task_id',
                                keyValue: data.task_id,
                                data: data
                            });
                            const idx = db.tasks.findIndex(t => t.task_id === data.task_id);
                            if (idx > -1) db.tasks[idx] = { ...data };
                            showToast('Â∑•È†ÖÊõ¥Êñ∞ÊàêÂäüÔºÅ', 'success');
                        }
                        dataManager.taskModal.show = false;
                    } catch (e) {
                        showToast('Â∑•È†ÖÂÑ≤Â≠òÂ§±Êïó: ' + e.message, 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const deleteTask = async (task) => {
                    if (!confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§„Äå${task.task_name}„ÄçÂóéÔºü\n\nÊ≥®ÊÑèÔºöÁõ∏ÈóúÁöÑÈÖçÊñπ‰πüÂ∞á‰∏Ä‰ΩµÂà™Èô§ÔºÅ`)) return;

                    loading.value = true;
                    try {
                        await callBackend('delete', { sheetName: 'DB_Tasks', keyField: 'task_id', keyValue: task.task_id });
                        await callBackend('delete', { sheetName: 'Map_Task_Materials', keyField: 'task_id', keyValue: task.task_id });
                        await callBackend('delete', { sheetName: 'Map_Task_Tools', keyField: 'task_id', keyValue: task.task_id });

                        db.tasks = db.tasks.filter(t => t.task_id !== task.task_id);
                        db.mapExMaterials = db.mapExMaterials.filter(m => m.task_id !== task.task_id);
                        db.mapExTools = db.mapExTools.filter(t => t.task_id !== task.task_id);

                        showToast('Â∑•È†ÖÂ∑≤Âà™Èô§', 'success');
                    } catch (e) {
                        showToast('Âà™Èô§Â§±Êïó: ' + e.message, 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                // === Â∑•ÂÖ∑ CRUD ===
                const openToolModal = (mode, tool = null) => {
                    dataManager.toolModal.mode = mode;
                    dataManager.toolModal.data = mode === 'create' ? {
                        tool_id: '',
                        name: '',
                        category: 'ÈõªÂãïÂ∑•ÂÖ∑',
                        power_spec: '',
                        alloc_rule: 'Site',
                        storage_box: '',
                        maintenance: '',
                        usage_tips: ''
                    } : { ...tool };
                    dataManager.toolModal.show = true;
                };

                const saveTool = async () => {
                    const data = dataManager.toolModal.data;
                    if (!data.tool_id || !data.name) {
                        showToast('Ë´ãÂ°´ÂØ´Â∑•ÂÖ∑‰ª£ËôüËàáÂêçÁ®±', 'warning');
                        return;
                    }

                    loading.value = true;
                    try {
                        if (dataManager.toolModal.mode === 'create') {
                            if (db.tools.some(t => t.tool_id === data.tool_id)) {
                                showToast('Â∑•ÂÖ∑‰ª£ËôüÂ∑≤Â≠òÂú®', 'error');
                                loading.value = false;
                                return;
                            }
                            await callBackend('create', { sheetName: 'DB_Tools', data: data });
                            db.tools.push({ ...data });
                            showToast('Â∑•ÂÖ∑Êñ∞Â¢ûÊàêÂäüÔºÅ', 'success');
                        } else {
                            await callBackend('update', {
                                sheetName: 'DB_Tools',
                                keyField: 'tool_id',
                                keyValue: data.tool_id,
                                data: data
                            });
                            const idx = db.tools.findIndex(t => t.tool_id === data.tool_id);
                            if (idx > -1) db.tools[idx] = { ...data };
                            showToast('Â∑•ÂÖ∑Êõ¥Êñ∞ÊàêÂäüÔºÅ', 'success');
                        }
                        dataManager.toolModal.show = false;
                    } catch (e) {
                        showToast('Â∑•ÂÖ∑ÂÑ≤Â≠òÂ§±Êïó: ' + e.message, 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const deleteTool = async (tool) => {
                    if (!confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§„Äå${tool.name}„ÄçÂóéÔºü`)) return;

                    loading.value = true;
                    try {
                        await callBackend('delete', { sheetName: 'DB_Tools', keyField: 'tool_id', keyValue: tool.tool_id });
                        db.tools = db.tools.filter(t => t.tool_id !== tool.tool_id);
                        showToast('Â∑•ÂÖ∑Â∑≤Âà™Èô§', 'success');
                    } catch (e) {
                        showToast('Âà™Èô§Â§±Êïó: ' + e.message, 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                // === ÊùêÊñô CRUD ===
                const openMaterialModal = (mode, material = null) => {
                    dataManager.materialModal.mode = mode;
                    dataManager.materialModal.data = mode === 'create' ? {
                        mat_id: '',
                        name: '',
                        category: 'ÊùøÊùê',
                        spec_order: '',
                        brand: '',
                        unit: 'Âºµ',
                        vendor_ref: '',
                        price_estimate: 0,
                        pack_desc: '',
                        note: ''
                    } : { ...material };
                    dataManager.materialModal.show = true;
                };

                const saveMaterial = async () => {
                    const data = dataManager.materialModal.data;
                    if (!data.mat_id || !data.name) {
                        showToast('Ë´ãÂ°´ÂØ´ÊùêÊñô‰ª£ËôüËàáÂêçÁ®±', 'warning');
                        return;
                    }

                    loading.value = true;
                    try {
                        if (dataManager.materialModal.mode === 'create') {
                            if (db.materials.some(m => m.mat_id === data.mat_id)) {
                                showToast('ÊùêÊñô‰ª£ËôüÂ∑≤Â≠òÂú®', 'error');
                                loading.value = false;
                                return;
                            }
                            await callBackend('create', { sheetName: 'DB_Materials', data: data });
                            db.materials.push({ ...data });
                            showToast('ÊùêÊñôÊñ∞Â¢ûÊàêÂäüÔºÅ', 'success');
                        } else {
                            await callBackend('update', {
                                sheetName: 'DB_Materials',
                                keyField: 'mat_id',
                                keyValue: data.mat_id,
                                data: data
                            });
                            const idx = db.materials.findIndex(m => m.mat_id === data.mat_id);
                            if (idx > -1) db.materials[idx] = { ...data };
                            showToast('ÊùêÊñôÊõ¥Êñ∞ÊàêÂäüÔºÅ', 'success');
                        }
                        dataManager.materialModal.show = false;
                    } catch (e) {
                        showToast('ÊùêÊñôÂÑ≤Â≠òÂ§±Êïó: ' + e.message, 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const deleteMaterial = async (material) => {
                    if (!confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§„Äå${material.name}„ÄçÂóéÔºü`)) return;

                    loading.value = true;
                    try {
                        await callBackend('delete', { sheetName: 'DB_Materials', keyField: 'mat_id', keyValue: material.mat_id });
                        db.materials = db.materials.filter(m => m.mat_id !== material.mat_id);
                        showToast('ÊùêÊñôÂ∑≤Âà™Èô§', 'success');
                    } catch (e) {
                        showToast('Âà™Èô§Â§±Êïó: ' + e.message, 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                return {
                    loading, project, viewMode, cart,
                    categories, filterCategory, filteredTasks, selectedTask, inputQty,
                    addTask, removeTask,
                    calculatedMaterials, calculatedTools,
                    phases, getPowerClass, copyToClipboard,
                    // Toast ÈÄöÁü•
                    toasts, showToast, removeToast,
                    // Ë≥áÊñôÁÆ°ÁêÜ
                    dataManager, filteredDbTasks, filteredDbTools, filteredDbMaterials,
                    taskCategoryOptions, toolCategoryOptions, materialCategoryOptions, // ÂãïÊÖãÈÅ∏ÂñÆ
                    openTaskModal, saveTask, deleteTask,
                    openToolModal, saveTool, deleteTool,
                    openMaterialModal, saveMaterial, deleteMaterial,
                    // ÂúñÁâáÊêúÂ∞ãÂäüËÉΩ (v2.0: ÂàÜÈ†ÅÈ°ØÁ§∫)
                    imageModal, openImageModal, searchImages, saveSelectedImage,
                    currentPageImages, totalPages, changePage, selectImage, getPoolIndex,
                    // ÈÖçÊñπÁÆ°ÁêÜÂäüËÉΩ
                    db, recipeManager, getTaskMaterials, getTaskTools, getMatName, getToolName,
                    // ÈÖçÊñπ CRUD
                    updateMatRecipe, deleteMatRecipe, openAddMaterialModal, addMaterialRecipe,
                    updateToolRecipe, deleteToolRecipe, openAddToolModal, addToolRecipe,
                    showMaterialDetail, saveAllRecipes,
                    setupDatabase // Admin
                };
            }
        }).mount('#app');
    </script>
</body>

</html>