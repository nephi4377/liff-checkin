<!-- 
  Version: 1.0.7
  Last Modified: 2025-12-05 (Asia/Taipei)
  Author: Gemini (Technical Partner)
  Description: 
    å¤šäººé›†çµæ™‚é–“è¨ˆç®—å™¨ (Rally Dispatcher) - V1.0.7
    
    ä¿®æ”¹é‡é»ï¼š
    1. ä¿®æ­£è¼¸å‡ºæ ¼å¼é‚è¼¯ï¼š
       - å°‡å‰ªè²¼ç°¿è¼¸å‡ºçš„æ™‚é–“æ ¼å¼ç”± "HH MM SS" æ”¹ç‚ºæ¨™æº–çš„ "HH:MM:SS" (åŠ ä¸Šå†’è™Ÿ)ã€‚
       - åŒ…å«ã€ŒæŠµé”æ™‚é–“ã€èˆ‡ã€Œå‡ºç™¼æ™‚é–“ã€çš„è¼¸å‡ºå­—ä¸²çš†åŒæ­¥èª¿æ•´ã€‚
    2. ç¶­æŒ V1.0.6 çš„ä»‹é¢å„ªåŒ–èˆ‡å®¢è£½åŒ–é è¨­å€¼ã€‚
    
    æ ¸å¿ƒé‚è¼¯ï¼š
    1. æ™‚é–“æ ¼å¼ç‚º UTC 24å°æ™‚åˆ¶ã€‚
    2. ç¶­æŒç´”æ•¸å­¸é‹ç®—ï¼Œä¸ä¾è³´ç³»çµ±æ™‚å€ã€‚
    3. ä¿®æ­£å‰ªè²¼ç°¿è¤‡è£½åŠŸèƒ½ï¼Œå…¼å®¹ iframe ç’°å¢ƒã€‚
-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Castle Rally Dispatcher</title>
<style>
  :root {
    --bg-color: #121212;
    --container-bg: #1e1e1e;
    --text-color: #e0e0e0;
    --accent-color: #4CAF50; /* ç¶ è‰²ï¼Œä»£è¡¨è¡Œå‹• */
    --danger-color: #ff5252;  /* ç´…è‰²ï¼Œä»£è¡¨åˆªé™¤ */
    --input-bg: #333;
    --border-color: #555;
    --info-color: #2196F3; /* è—è‰²ï¼Œç”¨æ–¼ä¸€èˆ¬è³‡è¨Š */
    --card-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    display: flex;
    justify-content: center;
    padding-top: 80px; /* å¢åŠ é ‚éƒ¨ç©ºé–“çµ¦é€šçŸ¥ */
    min-height: 100vh;
    box-sizing: border-box;
    margin: 0;
  }

  .container {
    background-color: var(--container-bg);
    padding: 25px;
    border-radius: 12px;
    box-shadow: var(--card-shadow);
    width: 100%;
    max-width: 550px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  h2 {
    text-align: center;
    color: var(--accent-color);
    margin: 0 0 10px 0;
    font-size: 1.5rem;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  label {
    font-weight: 600;
    font-size: 0.95rem;
    color: #ccc;
  }

  /* è¼¸å…¥æ¡†é€šç”¨æ¨£å¼ */
  input[type="text"],
  input[type="number"] {
    background-color: var(--input-bg);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    padding: 12px;
    border-radius: 6px;
    width: 100%;
    box-sizing: border-box;
    font-size: 1rem;
    transition: border-color 0.2s;
    text-align: center; /* è®“æ•¸å­—ç½®ä¸­æ›´å¥½çœ‹ */
  }

  input:focus {
    outline: none;
    border-color: var(--accent-color);
  }

  /* é‡å°æŠµé”æ™‚é–“çš„ Flex ä½ˆå±€ (åŠ å…¥å†’è™Ÿ) */
  .time-inputs {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .time-inputs input {
    flex: 1; /* æ¯å€‹è¼¸å…¥æ¡†å¹³å‡åˆ†é…å¯¬åº¦ */
    font-family: 'Consolas', monospace; /* ä½¿ç”¨ç­‰å¯¬å­—é«”è®“æ•¸å­—å°é½Š */
    font-size: 1.2rem;
    letter-spacing: 1px;
    padding: 10px;
  }

  .time-separator {
    font-size: 1.5rem;
    font-weight: bold;
    color: #888;
    margin-top: -4px; /* å¾®èª¿å‚ç›´å°é½Š */
  }

  .helper-text {
    font-size: 0.8rem;
    color: #888;
    font-style: italic;
  }

  /* æˆå“¡åˆ—è¡¨å€å¡Š */
  .members-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap; /* å…è¨±æ›è¡Œ */
    gap: 10px; /* æŒ‰éˆ•é–“è· */
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
  }

  .members-header .title {
    flex-grow: 1; /* è®“æ¨™é¡Œä½”æ“šå¤šé¤˜ç©ºé–“ */
  }

  .btn-small {
    padding: 6px 12px;
    margin-left: 5px;
    font-size: 0.85rem;
    background-color: #444;
    color: white;
    border: 1px solid #666;
    border-radius: 4px;
    cursor: pointer;
  }
  .btn-small:hover { background-color: #555; }

  #members-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 400px;
    overflow-y: auto;
    padding-right: 5px;
  }

  /* å–®å€‹æˆå“¡åˆ—çš„ Grid ä½ˆå±€ */
  .member-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr auto; /* ID, Min, Sec, Delete */
    gap: 8px;
    align-items: center;
    background-color: #2a2a2a;
    padding: 8px;
    border-radius: 6px;
  }

  .member-row input {
    padding: 8px;
    text-align: center;
  }
  
  /* è®“ ID æ¬„ä½é å·¦å°é½Šï¼Œæ¯”è¼ƒåƒæ–‡å­—è¼¸å…¥ */
  .member-row input.mem-id {
    text-align: left;
    padding-left: 10px;
  }

  .btn-icon {
    background: none;
    border: none;
    color: var(--danger-color);
    font-size: 1.2rem;
    cursor: pointer;
    padding: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
  }
  .btn-icon:hover {
    background-color: rgba(255, 82, 82, 0.1);
  }

  /* åº•éƒ¨æŒ‰éˆ•å€ */
  .actions {
    display: flex; /* æ”¹ç‚º flex ä½ˆå±€ */
    justify-content: center; /* ç½®ä¸­è¨ˆç®—æŒ‰éˆ• */
    margin-top: 10px;
  }

  button.main-btn {
    padding: 14px;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.1s, opacity 0.2s;
  }

  .btn-primary { background-color: var(--accent-color); color: #000; }
  .btn-primary:hover { opacity: 0.9; }
  .btn-secondary { background-color: #444; color: white; }
  .btn-secondary:hover { background-color: #555; }
  
  button:active { transform: scale(0.98); }

  /* è¼¸å‡ºçµæœå€ */
  #output-container {
    display: none; /* é è¨­éš±è— */
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  textarea {
    width: 100%;
    height: 120px;
    background-color: #111;
    border: 1px solid var(--accent-color);
    color: var(--accent-color);
    padding: 10px;
    border-radius: 6px;
    font-family: 'Consolas', 'Monaco', monospace;
    resize: vertical;
    font-size: 0.9rem;
  }

  /* æ–°å¢ï¼šé€šçŸ¥å…ƒä»¶æ¨£å¼ */
  .notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 12px 20px;
    border-radius: 6px;
    color: white;
    font-weight: 600;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s, transform 0.3s;
    pointer-events: none;
  }
  .notification.show { opacity: 1; transform: translate(-50%, 10px); }
  .notification.success { background-color: var(--accent-color); }
  .notification.error { background-color: var(--danger-color); }
  .notification.info { background-color: var(--info-color); }

  /* éŸ¿æ‡‰å¼èª¿æ•´ */
  @media (max-width: 400px) {
    .member-row {
      grid-template-columns: 1fr 1fr 1fr auto;
    }
    .member-row input::placeholder {
      font-size: 0.8rem;
    }
  }
</style>
</head>
<body>

<!-- æ–°å¢ï¼šé€šçŸ¥é¡¯ç¤ºå€å¡Š -->
<div id="notification" class="notification"></div>

<div class="container">
  <h2>ğŸ° Rally Dispatcher</h2>

  <!-- 1. è¨­å®šç›®æ¨™æ™‚é–“ (åŠ å…¥å†’è™Ÿåˆ†éš”ç¬¦) -->
  <div class="control-group">
    <label>Target Arrival Time (UTC 24H)</label>
    <div class="time-inputs">
      <input type="number" id="targetHH" placeholder="HH" min="0" max="23">
      <span class="time-separator">:</span>
      <input type="number" id="targetMM" placeholder="MM" min="0" max="59">
      <span class="time-separator">:</span>
      <input type="number" id="targetSS" placeholder="SS" min="0" max="59">
    </div>
    <div class="helper-text">Logic: Arrival Time - Walk Time - 5 mins (Assembly)</div>
  </div>

  <!-- 2. æˆå“¡åˆ—è¡¨ -->
  <div class="control-group">
    <div class="members-header">
      <label class="title">Squad Members</label>
      <div>
        <button class="btn-small" onclick="loadSquad()">Load Squad</button>
        <button class="btn-small" onclick="saveSquad()">Save Squad</button>
        <button class="btn-small" onclick="addMemberRow()">+ Add Member</button>
      </div>
    </div>
    <div id="members-list">
      <!-- JavaScript æœƒå‹•æ…‹ç”¢ç”Ÿè¼¸å…¥åˆ— -->
    </div>
  </div>

  <!-- 3. æ“ä½œæŒ‰éˆ• -->
  <div class="actions">
    <button class="main-btn btn-primary" onclick="calculateAndCopy()" style="width: 100%;">Calculate & Copy</button>
  </div>

  <!-- 4. çµæœé¡¯ç¤º -->
  <div id="output-container">
    <label style="margin-bottom:5px; display:block;">Result (Auto-copied):</label>
    <textarea id="output-text" readonly></textarea>
  </div>
</div>

<script>
  /**
   * å¸¸æ•¸è¨­å®šï¼šé›†çµæ™‚é–“ç‚º 5 åˆ†é˜ (300ç§’)
   */
  const ASSEMBLY_TIME_SECONDS = 5 * 60; 
  const SQUAD_STORAGE_KEY = 'rallyDispatcher_squad';

  /**
   * æ–°å¢ï¼šé¡¯ç¤ºé€šçŸ¥çš„å‡½å¼
   */
  let notificationTimer;
  function showNotification(message, type = 'info', duration = 3000) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type}`; // æ¸…é™¤èˆŠçš„ type
    
    clearTimeout(notificationTimer);
    notification.classList.add('show');
    notificationTimer = setTimeout(() => {
      notification.classList.remove('show');
    }, duration);
  }

  /**
   * å·¥å…·å‡½å¼ï¼šå°‡ç¸½ç§’æ•¸æ ¼å¼åŒ–ç‚º HH:MM:SS å­—ä¸² (ä¿®æ”¹å¾Œ)
   * åŒ…å«è™•ç†è·¨æ—¥é‚è¼¯ (è² æ•¸ç§’æ•¸è½‰ç‚ºå‰ä¸€å¤©)
   * ç¢ºä¿æ°¸é è¼¸å‡º 24 å°æ™‚åˆ¶ï¼Œä¸”ä½¿ç”¨å†’è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚ 13:00:00
   */
  function formatSecondsToTimeStr(totalSeconds) {
    let secs = totalSeconds;
    
    // è™•ç†è·¨æ—¥ï¼šå¦‚æœç§’æ•¸å°æ–¼ 0ï¼ŒåŠ ä¸Šä¸€å¤©çš„ç§’æ•¸ (86400) ç›´åˆ°è®Šç‚ºæ­£æ•¸
    while (secs < 0) secs += 86400; 
    // ç¢ºä¿ç§’æ•¸åœ¨ä¸€å¤©å…§
    secs %= 86400; 

    const hh = String(Math.floor(secs / 3600)).padStart(2, '0');
    const mm = String(Math.floor((secs % 3600) / 60)).padStart(2, '0');
    const ss = String(secs % 60).padStart(2, '0');
    // ä¿®æ”¹è™•ï¼šå°‡ç©ºæ ¼æ”¹ç‚ºå†’è™Ÿ
    return `${hh}:${mm}:${ss}`;
  }

  /**
   * UI æ“ä½œï¼šæ–°å¢ä¸€è¡Œæˆå“¡è¼¸å…¥æ¡†
   * Modified: å¢åŠ åƒæ•¸ä»¥æ”¯æ´åˆå§‹å€¼è¨­å®š
   */
  function addMemberRow(initialId = '', initialMin = '', initialSec = '') {
    const list = document.getElementById('members-list');
    const row = document.createElement('div');
    row.className = 'member-row';
    row.innerHTML = `
      <input type="text" placeholder="ID / Name" class="mem-id">
      <input type="number" placeholder="Min" min="0" class="mem-min">
      <input type="number" placeholder="Sec" min="0" max="59" class="mem-sec">
      <button class="btn-icon" onclick="this.parentElement.remove()" title="Remove">âœ•</button>
    `;
    
    // å¦‚æœæœ‰æä¾›åˆå§‹å€¼ï¼Œå‰‡å¡«å…¥
    if (initialId) row.querySelector('.mem-id').value = initialId;
    // æ•¸å­— 0 ä¹Ÿæ˜¯æœ‰æ•ˆå€¼ï¼Œæ‰€ä»¥ç”¨ undefined æª¢æŸ¥æˆ–è½‰å­—ä¸²åˆ¤æ–·
    if (initialMin !== '') row.querySelector('.mem-min').value = initialMin;
    if (initialSec !== '') row.querySelector('.mem-sec').value = initialSec;

    list.appendChild(row);
  }

  /**
   * æ–°å¢ï¼šå¿«å–ç®¡ç†å‡½å¼ - å„²å­˜è³‡æ–™ä¸¦è¨­å®šåˆ°æœŸæ—¥
   * @param {string} key - å¿«å–çš„éµå€¼
   * @param {any} data - è¦å¿«å–çš„è³‡æ–™
   * @param {number} [days=30] - å¿«å–æœ‰æ•ˆå¤©æ•¸ï¼Œé è¨­ç‚º 30 å¤©
   */
  function saveCache(key, data, days = 30) {
    const cache = {
      data: data,
      expires: Date.now() + days * 24 * 60 * 60 * 1000
    };
    localStorage.setItem(key, JSON.stringify(cache));
  }

  /**
   * æ–°å¢ï¼šå¿«å–ç®¡ç†å‡½å¼ - è®€å–è³‡æ–™ä¸¦æª¢æŸ¥åˆ°æœŸæ—¥
   */
  function loadCache(key) {
    const cached = localStorage.getItem(key);
    if (!cached) return null;
    const cache = JSON.parse(cached);
    if (cache.expires < Date.now()) {
      localStorage.removeItem(key);
      return null;
    }
    return cache.data;
  }

  /**
   * æ ¸å¿ƒåŠŸèƒ½ï¼šè¨ˆç®—æ™‚é–“ä¸¦è¤‡è£½
   */
  function calculateAndCopy() {
    // å–å¾—æŠµé”æ™‚é–“çš„ä¸‰å€‹æ¬„ä½å€¼
    const hhVal = document.getElementById('targetHH').value;
    const mmVal = document.getElementById('targetMM').value;
    const ssVal = document.getElementById('targetSS').value;

    // æª¢æŸ¥æ˜¯å¦æœ‰è¼¸å…¥ (è‡³å°‘éœ€è¦æ™‚å’Œåˆ†)
    if (hhVal === '' || mmVal === '') {
      showNotification("Please enter Target Arrival Time (HH and MM).", 'error');
      return;
    }

    const hh = parseInt(hhVal) || 0;
    const mm = parseInt(mmVal) || 0;
    const ss = parseInt(ssVal) || 0;

    // è¨ˆç®—ç›®æ¨™ç¸½ç§’æ•¸
    const arrivalSeconds = (hh * 3600) + (mm * 60) + ss;
    
    // æ ¼å¼åŒ–ç›®æ¨™æ™‚é–“ç”¨æ–¼é¡¯ç¤º (è£œé›¶)
    // ä¿®æ”¹è™•ï¼šå°‡ç©ºæ ¼æ”¹ç‚ºå†’è™Ÿ
    const arrivalTimeFormatted = `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;

    // å»ºç«‹è¼¸å‡ºå­—ä¸²çš„æ¨™é ­
    let output = `Arrive time: ${arrivalTimeFormatted}\nStart time list`;
    let memberCount = 0;
    let hasValidMember = false;

    // å–å¾—æ‰€æœ‰æˆå“¡åˆ—
    const rows = document.querySelectorAll('.member-row');
    
    rows.forEach(row => {
      const id = row.querySelector('.mem-id').value.trim();
      
      // åªæœ‰ç•¶ ID æ¬„ä½æœ‰å€¼æ™‚æ‰é€²è¡Œè¨ˆç®—
      if (id) {
        memberCount++;
        hasValidMember = true;
        
        const min = parseInt(row.querySelector('.mem-min').value) || 0;
        const sec = parseInt(row.querySelector('.mem-sec').value) || 0;
        const walkSeconds = (min * 60) + sec;

        // è¨ˆç®—å…¬å¼ï¼šç›®æ¨™ - é›†çµ(300s) - è¡Œèµ°
        const departureSeconds = arrivalSeconds - ASSEMBLY_TIME_SECONDS - walkSeconds;
        const departureTimeFormatted = formatSecondsToTimeStr(departureSeconds);

        // ä¸²æ¥çµæœå­—ä¸²
        output += `\n#${memberCount} ${id} ${departureTimeFormatted}`;
      }
    });

    if (!hasValidMember) {
      showNotification("Please enter at least one member's ID.", 'error');
      return;
    }

    // é¡¯ç¤ºçµæœå€åŸŸ
    const container = document.getElementById('output-container');
    const outputTextarea = document.getElementById('output-text');
    
    container.style.display = 'block';
    outputTextarea.value = output;
    
    // åŸ·è¡Œè¤‡è£½
    copyToClipboard(output, outputTextarea);
  }

  /**
   * è¤‡è£½é‚è¼¯ï¼šä½¿ç”¨ document.execCommand ('copy') ç¢ºä¿ç›¸å®¹æ€§
   */
  function copyToClipboard(text, textareaElement) {
    // 1. é¸å–æ–‡å­—
    textareaElement.select();
    textareaElement.setSelectionRange(0, 99999); // æ‰‹æ©Ÿç‰ˆç›¸å®¹

    // 2. å˜—è©¦ä½¿ç”¨ execCommand è¤‡è£½
    try {
      const successful = document.execCommand('copy');
      if (successful) {
        showNotification("Copied to clipboard!", 'success');
      } else {
        showNotification("Auto-copy failed. Please copy manually.", 'error');
      }
    } catch (err) {
      console.error('Fallback copy failed', err);
      showNotification("Copy failed. Please copy manually.", 'error');
    }
  }

  /**
   * æ–°å¢ï¼šå„²å­˜å¸¸ç”¨æˆå“¡åˆ—è¡¨åˆ° localStorage
   */
  function saveSquad() {
    const rows = document.querySelectorAll('.member-row');
    const squadData = [];

    rows.forEach(row => {
      const id = row.querySelector('.mem-id').value.trim();
      const min = row.querySelector('.mem-min').value;
      const sec = row.querySelector('.mem-sec').value;

      // åªå„²å­˜æœ‰ ID çš„æˆå“¡
      if (id) {
        squadData.push({
          id: id,
          min: min,
          sec: sec
        });
      }
    });

    if (squadData.length === 0) {
      showNotification("No members to save.", 'error');
      return;
    }

    saveCache(SQUAD_STORAGE_KEY, squadData, 30); // ä½¿ç”¨æ–°çš„å¿«å–å‡½å¼ï¼Œè¨­å®š 30 å¤©
    showNotification("Squad saved successfully!", 'success');
  }

  /**
   * æ–°å¢ï¼šå¾ localStorage è®€å–ä¸¦è¼‰å…¥æˆå“¡åˆ—è¡¨
   */
  function loadSquad() {
    const savedData = loadCache(SQUAD_STORAGE_KEY); // ä½¿ç”¨æ–°çš„å¿«å–å‡½å¼
    if (!savedData) {
      showNotification("No saved squad found.", 'info');
      return;
    }

    if (!confirm("This will overwrite the current list. Continue?")) {
      return;
    }

    const squadData = savedData; // loadCache å·²è™•ç† JSON.parse
    const listContainer = document.getElementById('members-list');
    listContainer.innerHTML = ''; // æ¸…ç©ºç¾æœ‰åå–®

    squadData.forEach(member => {
      addMemberRow(member.id, member.min, member.sec);
    });

    showNotification("Squad loaded successfully!", 'success');
  }


  // åˆå§‹åŒ–ï¼šé é¢è¼‰å…¥æ™‚è¨­å®šé è¨­å€¼
  window.onload = function() {
      // 1. è¨­å®šé è¨­æŠµé”æ™‚é–“ 14:30:00
      document.getElementById('targetHH').value = 14;
      document.getElementById('targetMM').value = 30;
      document.getElementById('targetSS').value = '00';

      // 2. è¨­å®šé è¨­æˆå“¡èˆ‡è¡Œèµ°æ™‚é–“
      const defaultMembers = ["VKING", "CROWN", "ALYCIA", "BANGOKO", "ARDAM"];
      defaultMembers.forEach(name => {
          // name, min=0, sec=45
          addMemberRow(name, 0, 45);
      });
  };
</script>

</body>
</html>